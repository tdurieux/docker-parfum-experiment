{
  "startTime": 1674250052974,
  "endTime": 1674250053520,
  "originalSmells": [
    {
      "rule": "curlUseFlagF",
      "position": {
        "lineStart": 32,
        "lineEnd": 32,
        "columnStart": 28,
        "columnEnd": 71
      }
    },
    {
      "rule": "curlUseFlagF",
      "position": {
        "lineStart": 124,
        "lineEnd": 124,
        "columnStart": 7,
        "columnEnd": 187
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "# Copyright (c) 2018 Red Hat, Inc.\n# This program and the accompanying materials are made\n# available under the terms of the Eclipse Public License 2.0\n# which is available at https://www.eclipse.org/legal/epl-2.0/\n#\n# SPDX-License-Identifier: EPL-2.0\n#\n# Contributors:\n#   Red Hat, Inc. - initial API and implementation\n\n###\n# Builder Image\n#\nFROM ${BUILD_ORGANIZATION}/${BUILD_PREFIX}-theia-dev:${BUILD_TAG} as builder\nWORKDIR ${HOME}\n\n# define in env variable GITHUB_TOKEN only if it is defined\n# else check if github rate limit is enough, else will abort requiring to set GITHUB_TOKEN value\nARG GITHUB_TOKEN\n\nARG THEIA_GITHUB_REPO=theia-ide/theia\n\n# Define upstream version of theia to use\nARG THEIA_VERSION=master\n\nENV NODE_OPTIONS=\"--max-old-space-size=4096\"\n\n# Check github limit\nRUN if [ ! -z \"${GITHUB_TOKEN-}\" ];then \\\n      export GITHUB_TOKEN=$GITHUB_TOKEN; \\\n      echo \"Setting GITHUB_TOKEN value as provided\"; \\\n    elif \\\n\n\n      [ \"${GITHUB_LIMIT}\" -lt 10 ]; then \\\n      export GITHUB_LIMIT=$( curl -f -s 'https://api.github.com/rate_limit' | jq '.rate .remaining'); \\\n      echo \"Current API rate limit https://api.github.com is ${GITHUB_LIMIT}\"; \\\n      if [ \"${GITHUB_LIMIT}\" -lt 10 ]; then \\\n        printf \"\\033[0;31m\\n\\n\\nRate limit on https://api.github.com is reached so in order to build this image, \"; \\\n        printf \"the build argument GITHUB_TOKEN needs to be provided so build will not fail.\\n\\n\\n\\033[0m\"; \\\n        exit 1; \\\n      else \\\n        echo \"GITHUB_TOKEN variable is not set but https://api.github.com rate limit has enough slots\"; \\\n      fielse \\\n        echo \"GITHUB_TOKEN variable is not set but https://api.github.com rate limit has enough slots\"; \\\n      fi \\\n    fi\n\n#invalidate cache\nADD https://${GITHUB_TOKEN}:x-oauth-basic@api.github.com/repos/${THEIA_GITHUB_REPO}/git/${GIT_REF} /tmp/branch_info.json\n\n# Clone theia\nRUN git clone --branch ${GIT_BRANCH_NAME}  --single-branch --depth 1 https://github.com/${THEIA_GITHUB_REPO} ${HOME}/theia-source-code\n\n# Add patches\nADD src/patches ${HOME}/patches\n\n# Apply patches\nRUN if [ -d \"${HOME}/patches/${THEIA_VERSION}\" ]; then \\\n      echo \"Applying patches for Theia version ${THEIA_VERSION}\"; \\\n      for file in $(find \"${HOME}/patches/${THEIA_VERSION}\" -name '*.patch'); do \\\n        echo \"Patching with ${file}\"; \\\n        cd ${HOME}/theia-source-code && patch -p1 < ${file}; \\\n      done \\\n    fi\n\n# Generate che-theia\nARG CDN_PREFIX=\"\"\nARG MONACO_CDN_PREFIX=\"\"\nWORKDIR ${HOME}/theia-source-code\n\nCOPY che-theia/che-theia-init-sources.yml ${HOME}/che-theia-init-sources.yml\n\n#invalidate cache for che-theia extensions\nADD https://${GITHUB_TOKEN}:x-oauth-basic@api.github.com/repos/eclipse/che-theia/git/${GIT_REF} /tmp/this_branch_info.json\n\nRUN che:theia init -c ${HOME}/che-theia-init-sources.yml\n\nRUN che:theia cdn --theia=\"${CDN_PREFIX}\" --monaco=\"${MONACO_CDN_PREFIX}\"\n\n# Compile Theia\nRUN yarn\n\n# Run into production mode\nRUN che:theia production\n\n# FIX ME, temporary fix to restore build\nRUN cd che/che-theia && git reset --hard\n\n# Compile plugins\nRUN cd plugins && ./foreach_yarn\n\n# change permissions\nRUN find production -exec sh -c \"chgrp 0 {}; chmod g+rwX {}\" \\; 2>log.txt\n\n\n###\n# Runtime Image\n#\n# Use node image\nFROM node:10.16-alpine as runtime\nENV USE_LOCAL_GIT=true \\\n    HOME=/home/theia \\\n    THEIA_DEFAULT_PLUGINS=local-dir:///default-theia-plugins \\\n    # Specify the directory of git (avoid to search at init of Theia)\n    LOCAL_GIT_DIRECTORY=/usr \\\n    GIT_EXEC_PATH=/usr/libexec/git-core \\\n    # Ignore from port plugin the default hosted mode port\n    PORT_PLUGIN_EXCLUDE_3130=TRUE\n\nEXPOSE 3100 3130\n\nCOPY --from=builder /home/theia-dev/theia-source-code/production/plugins /default-theia-plugins\n\n# Install sudo\n# Install git\n# Install bzip2 to unpack files\n# Install which tool in order to search git\n# Install curl and bash\n# Install ssh for cloning ssh-repositories\n# Install less for handling git diff properly\nRUN apk add --update --no-cache sudo git bzip2 which bash curl openssh openssh-keygen less\nRUN adduser -D -S -u 1001 -G root -h ${HOME} -s /bin/sh theia \\\n    && echo \"%wheel ALL=(ALL) NOPASSWD: ALL\" >> /etc/sudoers \\\n    # Create /projects for Che\n    && mkdir /projects \\\n    # Create root node_modules in order to not use node_modules in each project folder\n    && mkdir /node_modules \\\n    # Download yeoman generator plug-in \\\n    && curl -f -L -o /default-theia-plugins/theia_yeoman_plugin.theia https://github.com/eclipse/theia-yeoman-plugin/releases/download/untagged-04f28ee329e479cc465b/theia_yeoman_plugin.theia \\\n    && for f in \"${HOME}\" \"/etc/passwd\" \"/etc/group /node_modules /default-theia-plugins /projects\"; do\\\n           sudo chgrp -R 0 ${f} && \\\n           sudo chmod -R g+rwX ${f}; \\\n       done \\\n    && cat /etc/passwd | sed s#root:x.*#root:x:\\${USER_ID}:\\${GROUP_ID}::\\${HOME}:/bin/bash#g > ${HOME}/passwd.template \\\n    && cat /etc/group | sed s#root:x:0:#root:x:0:0,\\${USER_ID}:#g > ${HOME}/group.template \\\n    # Add yeoman, theia plugin generator and typescript (to have tsc/typescript working)\n    && yarn global add yo @theia/generator-plugin@0.0.1-1540209403 typescript@2.9.2 \\\n    && mkdir -p ${HOME}/.config/insight-nodejs/ \\\n    && chmod -R 777 ${HOME}/.config/ \\\n    # Disable the statistics for yeoman\n    && echo '{\"optOut\": true}' > $HOME/.config/insight-nodejs/insight-yo.json \\\n    # Link yarn global modules for yeoman\n    && mv /usr/local/lib/node_modules/* /usr/local/share/.config/yarn/global/node_modules && rm -rf /usr/local/lib/node_modules && ln -s /usr/local/share/.config/yarn/global/node_modules /usr/local/lib/ \\\n    # Cleanup tmp folder\n    && rm -rf /tmp/* \\\n    # Cleanup yarn cache\n    && yarn cache clean \\\n    # Change permissions to allow editing of files for openshift user\n    && find ${HOME} -exec sh -c \"chgrp 0 {}; chmod g+rwX {}\" \\;\n\nCOPY --chown=theia:root --from=builder /home/theia-dev/theia-source-code/production /home/theia\nUSER theia\nWORKDIR /projects\nADD src/entrypoint.sh /entrypoint.sh\nENTRYPOINT [\"/entrypoint.sh\"]\n"
}