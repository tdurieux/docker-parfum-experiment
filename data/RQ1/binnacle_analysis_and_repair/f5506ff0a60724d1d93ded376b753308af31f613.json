{
  "startTime": 1674252009284,
  "endTime": 1674252010231,
  "originalSmells": [
    {
      "rule": "pipUseNoCacheDir",
      "position": {
        "lineStart": 73,
        "lineEnd": 73,
        "columnStart": 5,
        "columnEnd": 37
      }
    },
    {
      "rule": "pipUseNoCacheDir",
      "position": {
        "lineStart": 74,
        "lineEnd": 82,
        "columnStart": 4,
        "columnEnd": 10
      }
    },
    {
      "rule": "pipUseNoCacheDir",
      "position": {
        "lineStart": 104,
        "lineEnd": 104,
        "columnStart": 4,
        "columnEnd": 54
      }
    },
    {
      "rule": "pipUseNoCacheDir",
      "position": {
        "lineStart": 105,
        "lineEnd": 105,
        "columnStart": 4,
        "columnEnd": 59
      }
    },
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 38,
        "lineEnd": 71,
        "columnStart": 22,
        "columnEnd": 14
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "# © Copyright IBM Corporation 2017, 2018.\n# LICENSE: Apache License, Version 2.0 (http://www.apache.org/licenses/LICENSE-2.0)\n\n########## Dockerfile for Keystone version 14.0.1 #########\n#\n# This Dockerfile builds a basic installation of Keystone.\n#\n# Keystone is an OpenStack service that provides API client authentication, service discovery, and distributed\n# multi-tenant authorization by implementing OpenStack’s Identity API.\n#\n# To build this image, from the directory containing this Dockerfile.\n# (assuming that the file is named Dockerfile):\n# docker build -t <image_name> .\n#\n# To start Keystone run the below command:\n# docker run --name <container_name> -p 35357:<host_port> -p 5000:<host_port> -d <image> \n#\n# Reference:\n# https://docs.openstack.org/keystone/pike/\n#\n##################################################################################\n\n# Base Image\nFROM s390x/ubuntu:16.04\n\n# The author\nMAINTAINER  LoZ Open Source Ecosystem (https://www.ibm.com/developerworks/community/groups/community/lozopensource)\n\nENV SOURCE_DIR=/tmp/source DEBIAN_FRONTEND=noninteractive OS_KEYSTONE_CONFIG_DIR=/etc/keystone \\\n\tOS_USERNAME=admin \\\n\tOS_PASSWORD=ADMIN_PASS \\\n\tOS_PROJECT_NAME=admin \\\n\tOS_USER_DOMAIN_NAME=Default \\\n\tOS_PROJECT_DOMAIN_NAME=Default \\\n\tOS_AUTH_URL=http://127.0.0.1:35357/v3 \\\n\tOS_IDENTITY_API_VERSION=3\n\n# Install dependencies\nRUN apt-get update && apt-get install --no-install-recommends -y \\\n\t\tapache2 \\\n\t\tapache2-dev \\\n\t\tbison \\\n\t\tbuild-essential \\\n\t\tcmake \\\n\t\tcurl \\\n\t\tdh-autoreconf \\\n\t\tgcc \\\n\t\tgit \\\n\t\tlibapache2-mod-wsgi \\\n\t\tlibboost-dev \\\n\t\tlibboost-program-options-dev \\\n\t\tlibffi-dev \\\n\t\tlibncurses-dev \\\n\t\tlibpcre3-dev \\\n\t\tlibpq-dev \\\n\t\tlibssl-dev \\\n\t\tlibxslt-dev \\\n\t\tmake \\\n\t\tmysql-server \\\n\t\tnet-tools \\\n\t\topenssl \\\n\t\tpython-dev \\\n\t\tpython-ldap \\\n\t\tpython-lxml \\\n\t\tpython-mysqldb \\\n\t\tpython-pkgconfig \\\n\t\tpython-setuptools \\\n\t\tscons \\\n\t\ttar \\\n\t\twget \\\n\t\tpython3-dev \\\n\t\tlibsasl2-dev \\\n\t&& easy_install pip \\\n\t&& pip install --no-cache-dir --upgrade setuptools \\\n\t&& pip install --no-cache-dir \\\n\t\ttox \\\n\t\tcryptography \\\n\t\tfunctools32 \\\n\t\tmod_wsgi \\\n\t\tpika==0.10.0 \\\n\t\tpython-memcached \\\n\t\tpython-openstackclient \\\n\t\trequests \\\n\n# Configure and start MariaDB server\n\t&& mkdir -p  /var/log/mysql \\\n\t&& /usr/sbin/mysqld --initialize --user=mysql --datadir=/var/lib/mysql/data \\\n\t&& sleep 60s \\\n\t&& mkdir -p /var/run/mysqld \\\n\t&& chown -R mysql:mysql /var/run/mysqld \\\n\t&& service mysql start \\\n\t&& sleep 60s \\\n\n# Create user and grant privileges on Keystone database\n\t&& /usr/bin/mysql -e \"CREATE DATABASE keystone\" \\\n\t&& /usr/bin/mysql -e \"GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'%' IDENTIFIED BY 'keystone'\" \\\n\t&& /usr/bin/mysql -e \"GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'localhost' IDENTIFIED BY 'keystone'\" \\\n\n# Download source code and install Keystone\n\t&& mkdir -p $SOURCE_DIR \\\n\t&& cd $SOURCE_DIR \\\n\t&& git clone https://github.com/openstack/keystone.git \\\n\t&& cd keystone/ \\\n\t&& git checkout 14.0.1 \\\n\t&& pip install --no-cache-dir --ignore-installed -r requirements.txt \\\n\t&& pip install --no-cache-dir --ignore-installed -r test-requirements.txt \\\n\t&& python setup.py install \\\n\t&& tox -egenconfig \\\n\n# Configure Keystone\n\t&& cp -r etc/ /etc/keystone \\\n\t&& cd /etc/keystone/ \\\n\t&& mv keystone.conf.sample keystone.conf \\\n\t&& mv logging.conf.sample logging.conf \\\n\n# Edit keystone.conf file as shown below\n\t&& sed -i \"742i connection = mysql://keystone:keystone@127.0.0.1/keystone\" /etc/keystone/keystone.conf \\\n\t&& sed -i \"2828i provider = fernet\" /etc/keystone/keystone.conf \\\n\n# Populate Keystone database\n\t&& keystone-manage db_sync \\\n\n# Initialize fernet key repository\n\t&& useradd -m keystone \\\n\t&& usermod -aG keystone keystone \\\n\t&& mkdir -p /etc/keystone/fernet-keys \\\n\t&& chown -R keystone:keystone fernet-keys \\\n\t&& keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone \\\n\t&& keystone-manage credential_setup --keystone-user keystone --keystone-group keystone \\\n\n# Bootstrap the Identity service\n\t&& keystone-manage bootstrap --bootstrap-password ADMIN_PASS \\\n\t\t--bootstrap-admin-url http://127.0.0.1:35357/v3/ \\\n\t\t--bootstrap-internal-url http://127.0.0.1:5000/v3/ \\\n\t\t--bootstrap-public-url http://127.0.0.1:5000/v3/ \\\n\t\t--bootstrap-region-id RegionOne \\\n\n# Add below content at end of /etc/apache2/apache2.conf file\n\t&& sed -i \"\\$a ServerName 127.0.0.1\" /etc/apache2/apache2.conf \\\n\n# Add wsgi-keystone.conf\n\t&& cd /etc/apache2/ \\\n\t&& mkdir -p sites-available \\\n\t&& mkdir -p sites-enabled \\\n\t&& cd sites-available/ \\\n\t&& touch wsgi-keystone.conf \\\n\n\t&& echo \"Listen 5000\" >> ~/wsgi-keystone.conf \\\n\t&& echo \"Listen 35357\" >> ~/wsgi-keystone.conf \\\n\t&& echo \"\" >> ~/wsgi-keystone.conf \\\n\t&& echo \"<VirtualHost *:5000>\" >> ~/wsgi-keystone.conf \\\n\t&& echo \"WSGIDaemonProcess keystone-public processes=5 threads=1 user=keystone group=keystone display-name=%{GROUP}\" >> ~/wsgi-keystone.conf \\\n\t&& echo \"WSGIProcessGroup keystone-public\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"WSGIScriptAlias / /usr/local/bin/keystone-wsgi-public\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"WSGIApplicationGroup %{GLOBAL}\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"WSGIPassAuthorization On\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"LimitRequestBody 114688\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"<IfVersion >= 2.4>\" >> ~/wsgi-keystone.conf \\\n\t&& echo  '\tErrorLogFormat \"%{cu}t %M\"' >> ~/wsgi-keystone.conf \\\n\t&& echo  \"</IfVersion>\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"ErrorLog /var/log/apache2/keystone.log\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"CustomLog /var/log/apache2/keystone_access.log combined\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"<Directory /usr/local/bin>\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"\t  <IfVersion >= 2.4>\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"\t\t  Require all granted\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"\t  </IfVersion>\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"\t  <IfVersion < 2.4>\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"\t\t  Order allow,deny\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"\t\t  Allow from all\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"\t  </IfVersion>\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"</Directory>\" >> ~/wsgi-keystone.conf \\\n\t&& echo \"</VirtualHost>\" >> ~/wsgi-keystone.conf \\\n\t&& echo \"\" >> ~/wsgi-keystone.conf \\\n\t&& echo \"<VirtualHost *:35357>\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"WSGIDaemonProcess keystone-admin processes=5 threads=1 user=keystone group=keystone display-name=%{GROUP}\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"WSGIProcessGroup keystone-admin\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"WSGIScriptAlias / /usr/local/bin/keystone-wsgi-admin\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"WSGIApplicationGroup %{GLOBAL}\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"WSGIPassAuthorization On\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"LimitRequestBody 114688\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"<IfVersion >= 2.4>\" >> ~/wsgi-keystone.conf \\\n\t&& echo  '\tErrorLogFormat \"%{cu}t %M\"' >> ~/wsgi-keystone.conf \\\n\t&& echo  \"</IfVersion>\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"ErrorLog /var/log/apache2/keystone.log\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"CustomLog /var/log/apache2/keystone_access.log combined\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"<Directory /usr/local/bin>\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"\t  <IfVersion >= 2.4>\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"\t\t  Require all granted\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"\t  </IfVersion>\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"\t  <IfVersion < 2.4>\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"\t\t  Order allow,deny\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"\t\t  Allow from all\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"\t  </IfVersion>\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"</Directory>\" >> ~/wsgi-keystone.conf \\\n\t&& echo \"</VirtualHost>\" >> ~/wsgi-keystone.conf \\\n\t&& echo \"\" >> ~/wsgi-keystone.conf \\\n\t&& echo \"Alias /identity /usr/local/bin/keystone-wsgi-public\" >> ~/wsgi-keystone.conf \\\n\t&& echo \"<Location /identity>\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"SetHandler wsgi-script\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"Options +ExecCGI\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"WSGIProcessGroup keystone-public\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"WSGIApplicationGroup %{GLOBAL}\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"WSGIPassAuthorization On\" >> ~/wsgi-keystone.conf \\\n\t&& echo \"</Location>\" >> ~/wsgi-keystone.conf \\\n\t&& echo \"\" >> ~/wsgi-keystone.conf \\\n\t&& echo \"Alias /identity_admin /usr/local/bin/keystone-wsgi-admin\" >> ~/wsgi-keystone.conf \\\n\t&& echo \"<Location /identity_admin>\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"SetHandler wsgi-script\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"Options +ExecCGI\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"WSGIProcessGroup keystone-admin\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"WSGIApplicationGroup %{GLOBAL}\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"WSGIPassAuthorization On\" >> ~/wsgi-keystone.conf \\\n\t&& echo  \"</Location>\" >> ~/wsgi-keystone.conf \\\n\n# Enable the Identity service virtual host\n\t&& cp ~/wsgi-keystone.conf . \\\n\t&& ln -s /etc/apache2/sites-available/wsgi-keystone.conf /etc/apache2/sites-enabled \\\n\n# Clean up cache data and remove dependencies which are not required\n\t&& apt-get -y remove \\\n\t\tgcc \\\n\t\tgit \\\n\t\tcmake \\\n\t\tcurl \\\n\t\tmake \\\n\t\twget \\\n\t&& apt-get autoremove -y \\\n\t&& apt autoremove -y \\\n\t&& rm -rf $SOURCE_DIR \\\n\t&& apt-get clean \\\n\t&& rm -rf /var/lib/apt/lists/*\n\nVOLUME /etc/keystone\n\nEXPOSE 35357 5000\n\nCMD service apache2 start && /usr/bin/mysqld_safe --user=mysql\n\n# End of Dockerfile\n"
}