{
  "startTime": 1674234140093,
  "endTime": 1674234140382,
  "originalSmells": [
    {
      "rule": "curlUseFlagF",
      "position": {
        "lineStart": 18,
        "lineEnd": 18,
        "columnStart": 7,
        "columnEnd": 134
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "# This is using API Platform's Dockerfile\n\n# the different stages of this Dockerfile are meant to be built into separate images\n# https://docs.docker.com/develop/develop-images/multistage-build/#stop-at-a-specific-build-stage\n# https://docs.docker.com/compose/compose-file/#target\n\n\n# https://docs.docker.com/engine/reference/builder/#understand-how-arg-and-from-interact\nARG PHP_VERSION=7.3\nARG NGINX_VERSION=1.17\nARG VARNISH_VERSION=6.2\n\n\n# \"php\" stage\nFROM php:${PHP_VERSION}-fpm-alpine AS sbwa_php\n\n# Enable Blackfire probe\nRUN version=$(php -r \"echo PHP_MAJOR_VERSION.PHP_MINOR_VERSION;\") \\\n    && curl -f -A \"Docker\" -o /tmp/blackfire-probe.tar.gz -D - -L -s https://blackfire.io/api/v1/releases/probe/php/alpine/amd64/$version \\\n    && mkdir -p /tmp/blackfire \\\n    && tar zxpf /tmp/blackfire-probe.tar.gz -C /tmp/blackfire \\\n    && mv /tmp/blackfire/blackfire-*.so $(php -r \"echo ini_get('extension_dir');\")/blackfire.so \\\n    && printf \"extension=blackfire.so\\nblackfire.agent_socket=tcp://blackfire:8707\\n\" > $PHP_INI_DIR/conf.d/blackfire.ini \\\n    && rm -rf /tmp/blackfire /tmp/blackfire-probe.tar.gz\n\n\n# persistent / runtime deps\nRUN apk add --no-cache \\\n  acl \\\n  file \\\n  gettext \\\n  git \\\n  imagemagick \\\n  freetype \\\n  libpng \\\n  libjpeg-turbo \\\n  yarn \\\n  # for intl\n  icu-libs\n\nARG APCU_VERSION=5.1.17\n\nRUN set -eux; \\\n\tapk add --no-cache --virtual .build-deps \\\n\t\t$PHPIZE_DEPS \\\n\t\ticu-dev \\\n\t\tlibzip-dev \\\n\t\tpostgresql-dev \\\n\t\tzlib-dev \\\n    imagemagick-dev \\\n    freetype-dev \\\n    libpng-dev \\\n    libjpeg-turbo-dev \\\n    libssh-dev \\\n\t; \\\n\t\\\n\tdocker-php-ext-configure zip --with-libzip; \\\n\tdocker-php-ext-configure gd \\\n    --with-gd \\\n    --with-freetype-dir=/usr/include/ \\\n    --with-png-dir=/usr/include/ \\\n    --with-jpeg-dir=/usr/include/; \\\n\tdocker-php-ext-install -j$(nproc) \\\n\t\tintl \\\n\t\tpdo_mysql \\\n\t\tzip \\\n\t\texif \\\n\t\tbcmath \\\n\t\tsockets \\\n\t\tgd \\\n\t; \\\n\tpecl install \\\n\t\tapcu-${APCU_VERSION} \\\n\t\txdebug \\\n\t; \\\n\tpecl install imagick ; \\\n\tpecl clear-cache; \\\n\tdocker-php-ext-enable \\\n\t\tapcu \\\n\t\topcache \\\n\t\timagick \\\n\t; \\\n\t\\\n\trunDeps=\"$( \\\n\t\tscanelf --needed --nobanner --format '%n#p' --recursive /usr/local/lib/php/extensions \\\n\t\t\t| tr ',' '\\n' \\\n\t\t\t| sort -u \\\n\t\t\t| awk 'system(\"[ -e /usr/local/lib/\" $1 \" ]\") == 0 { next } { print \"so:\" $1 }' \\\n\t)\"; \\\n\tapk add --no-cache --virtual .api-phpexts-rundeps $runDeps; \\\n\t\\\n\tapk del .build-deps\n\nCOPY --from=composer:latest /usr/bin/composer /usr/bin/composer\nRUN ln -s $PHP_INI_DIR/php.prod.ini $PHP_INI_DIR/php.ini\nCOPY _docker/php/mods-available/* $PHP_INI_DIR/mods-available/\nCOPY _docker/php/conf.d/silverback-web-apps.ini $PHP_INI_DIR/conf.d/silverback-web-apps.ini\n\n# https://getcomposer.org/doc/03-cli.md#composer-allow-superuser\nENV COMPOSER_ALLOW_SUPERUSER=1\n# install Symfony Flex globally to speed up download of Composer packages (parallelized prefetching)\nRUN set -eux; \\\n\tcomposer global require \"symfony/flex\" --prefer-dist --no-progress --no-suggest --classmap-authoritative; \\\n\tcomposer clear-cache\nENV PATH=\"${PATH}:/root/.composer/vendor/bin\"\n\nWORKDIR /srv/api\n\n# build for production\nARG APP_ENV=prod\n\n# prevent the reinstallation of vendors at every changes in the source code\nCOPY composer.* symfony.lock ./\n\n# do not use .env files in production\nRUN echo '<?php return [];' > .env.local.php\nRUN set -eux; \\\n\tcomposer install --prefer-dist --no-dev --no-autoloader --no-scripts --no-progress --no-suggest; \\\n\tcomposer clear-cache\n\n# copy only specifically what we need\nCOPY bin bin/\nCOPY config config/\nCOPY public public/\nCOPY src src/\nCOPY assets assets/\nCOPY templates templates/\n\nRUN set -eux; \\\n\tmkdir -p var/cache var/log; \\\n\tcomposer dump-autoload --classmap-authoritative --no-dev; \\\n\tsync\nVOLUME /srv/api/var\n\nCOPY _docker/php/docker-entrypoint.sh /usr/local/bin/docker-entrypoint\nRUN chmod +x /usr/local/bin/docker-entrypoint\n\n# Enable configured cron jobs\nCOPY _docker/php/crontab /etc/cron.d/app-cron\nRUN chmod 0644 /etc/cron.d/app-cron; \\\n    crontab /etc/cron.d/app-cron; \\\n    touch /var/log/cron.log\nCMD [\"cron\"]\n\nENTRYPOINT [\"docker-entrypoint\"]\nCMD [\"php-fpm\"]\n\n\n# \"nginx\" stage\n# depends on the \"php\" stage above\nFROM nginx:${NGINX_VERSION}-alpine AS sbwa_nginx\n\nENV CORS_ALLOW_ORIGIN=\"https?://localhost:?[0-9]*\"\nENV UPSTREAM_CONTAINER=\"php\"\nENV UPSTREAM_PORT=9000\n\nCOPY _docker/nginx/conf.d/custom.conf /etc/nginx/conf.d/custom.conf\nCOPY _docker/nginx/conf.d/default.conf /srv/api/tmp/default.conf\n\nWORKDIR /srv/api\n\nCOPY --from=sbwa_php /srv/api/public public/\n\nCOPY _docker/nginx/start.sh /usr/local/bin/start\nRUN chmod +x /usr/local/bin/start\nENTRYPOINT [\"start\"]\n\nCMD [\"nginx\", \"-g\", \"daemon off;\"]\n\n# \"varnish\" stage\n# does not depend on any of the above stages, but placed here to keep everything in one Dockerfile\nFROM cooptilleuls/varnish:${VARNISH_VERSION}-alpine AS sbwa_varnish\n\nENV VARNISH_CONFIG='default.vcl'\nCOPY _docker/varnish/conf /usr/local/etc/varnish/available/\nCOPY _docker/varnish/errors /var/www/errors/\nRUN ln -s \"/usr/local/etc/varnish/available/${VARNISH_CONFIG}\" /usr/local/etc/varnish/default.vcl\n\nCMD [\"varnishd\", \"-F\", \"-f\", \"/usr/local/etc/varnish/default.vcl\", \"-p\", \"http_resp_hdr_len=256000\"]\n"
}