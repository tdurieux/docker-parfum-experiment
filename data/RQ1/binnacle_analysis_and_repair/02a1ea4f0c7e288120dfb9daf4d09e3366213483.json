{
  "startTime": 1674242601821,
  "endTime": 1674242602688,
  "originalSmells": [
    {
      "rule": "configureShouldUseBuildFlag",
      "position": {
        "lineStart": 288,
        "lineEnd": 288,
        "columnStart": 5,
        "columnEnd": 57
      }
    },
    {
      "rule": "configureShouldUseBuildFlag",
      "position": {
        "lineStart": 289,
        "lineEnd": 292,
        "columnStart": 5,
        "columnEnd": 41
      }
    },
    {
      "rule": "tarSomethingRmTheSomething",
      "position": {
        "lineStart": 284,
        "lineEnd": 284,
        "columnStart": 5,
        "columnEnd": 43
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "FROM --platform=$TARGETPLATFORM alpine:3.10 as php\n\nLABEL maintainer=\"khs1994-docker/lnmp <khs1994@khs1994.com>\"\n\nENV TZ=Asia/Shanghai \\\n    APP_ENV=development\n\n# ARG PHP_VERSION=\n\nARG ALPINE_URL=dl-cdn.alpinelinux.org\n\nARG PHP_EXTENSION_EXTRA\n\nARG PECL_EXTENSION_EXTRA\n\nARG APK_EXTRA\n\nARG APK_DEV_EXTRA\n\n# dependencies required for running \"phpize\"\n# these get automatically installed and removed by \"docker-php-ext-*\" (unless they're already installed)\nENV PHPIZE_DEPS \\\n      autoconf \\\n      dpkg-dev dpkg \\\n      file \\\n      g++ \\\n      gcc \\\n      libc-dev \\\n      make \\\n      pkgconf \\\n      re2c \\\n      bison\n\n# persistent / runtime deps\nRUN set -ex \\\n      && sed -i \"s/dl-cdn.alpinelinux.org/${ALPINE_URL}/g\" /etc/apk/repositories \\\n      && apk add --no-cache \\\n                 curl \\\n                 tar \\\n                 xz \\\n# https://github.com/docker-library/php/issues/494\n                 openssl \\\n                 bash \\\n                 tzdata \\\n# ensure www-data user exists\n# RUN set -x \\\n      && addgroup -g 82 -S www-data \\\n      && adduser -u 82 -D -S -G www-data www-data\n# 82 is the standard uid/gid for \"www-data\" in Alpine\n# http://git.alpinelinux.org/cgit/aports/tree/main/apache2/apache2.pre-install?h=v3.3.2\n# http://git.alpinelinux.org/cgit/aports/tree/main/lighttpd/lighttpd.pre-install?h=v3.3.2\n# http://git.alpinelinux.org/cgit/aports/tree/main/nginx-initscripts/nginx-initscripts.pre-install?h=v3.3.2\n\nENV PHP_INI_DIR /usr/local/etc/php\n# RUN mkdir -p $PHP_INI_DIR/conf.d\n\n##<autogenerated>##\nENV PHP_EXTRA_CONFIGURE_ARGS \\\n        --disable-phpdbg \\\n        # --enable-fpm \\\n        # --with-fpm-user=www-data \\\n        # --with-fpm-group=www-data \\\n        # https://github.com/docker-library/php/issues/510\n        --enable-embed=shared \\\n        --disable-cgi \\\n        --with-gettext=shared \\\n        --with-gd=shared \\\n            --with-freetype-dir=/usr \\\n            --disable-gd-jis-conv \\\n            --with-jpeg-dir=/usr \\\n            --with-png-dir=/usr \\\n            --with-webp-dir=/usr \\\n            --with-xpm-dir=/usr \\\n        --with-pcre-regex \\\n        --with-pdo-mysql=shared \\\n        --with-pdo-pgsql=shared \\\n        --with-xsl=shared \\\n        --enable-bcmath=shared \\\n        --enable-libxml \\\n        --enable-inline-optimization \\\n        --enable-mbregex \\\n        --enable-pcntl=shared \\\n        --enable-shmop=shared \\\n        --enable-soap=shared \\\n        --enable-sockets=shared \\\n        --enable-sysvmsg=shared \\\n        --enable-sysvsem=shared \\\n        --enable-sysvshm=shared \\\n        --enable-xml \\\n        --enable-zip \\\n            --with-libzip \\\n        --enable-calendar=shared \\\n        --enable-intl=shared \\\n        --enable-exif=shared \\\n        --with-bz2=shared \\\n        --with-tidy=shared \\\n        --with-gmp=shared \\\n        --with-imap=shared \\\n            --with-kerberos \\\n            --with-imap-ssl \\\n        --with-icu-dir=/usr \\\n        --with-xmlrpc=shared \\\n        --with-pic \\\n        --with-enchant=shared \\\n        --enable-fileinfo=shared \\\n        --with-ldap=shared \\\n            --with-ldap-sasl \\\n        --enable-phar \\\n        --enable-posix=shared \\\n        --with-pspell=shared \\\n        --enable-shmop=shared \\\n        --with-snmp=shared \\\n        --with-mysqli=shared \\\n        --with-pgsql=shared\n##</autogenerated>##\n\n# Apply stack smash protection to functions using local buffers and alloca()\n# Make PHP's main executable position-independent (improves ASLR security mechanism, and has no performance impact on x86_64)\n# Enable optimization (-O2)\n# Enable linker optimization (this sorts the hash buckets to improve cache locality, and is non-default)\n# Adds GNU HASH segments to generated executables (this is used if present, and is much faster than sysv hash; in this configuration, sysv hash is also generated)\n# https://github.com/docker-library/php/issues/272\nENV PHP_CFLAGS=\"-fstack-protector-strong -fpic -fpie -O2\"\nENV PHP_CPPFLAGS=\"$PHP_CFLAGS\"\nENV PHP_LDFLAGS=\"-Wl,-O1 -Wl,--hash-style=both -pie\"\n\n# ENV GPG_KEYS 1729F83938DA44E27BA0F4D3DBDB397470D12172 B1B44D8F021E4E2D6021E995DC9FF8D3EE5AF27F\n\nENV PHP_VERSION 7.3.6\nENV NGINX_UNIT_VERSION 1.9.0\n# ENV PHP_URL=\"https://www.php.net/get/php-7.3.6.tar.xz/from/this/mirror\" PHP_ASC_URL=\"https://www.php.net/get/php-7.3.6.tar.xz.asc/from/this/mirror\"\n# ENV PHP_SHA256=\"da1a705c0bc46410e330fc6baa967666c8cd2985378fb9707c01a8e33b01d985\" PHP_MD5=\"\"\n\n# COPY --from=php:alpine /usr/local/bin/docker-php-* /usr/local/bin/\n\n# COPY --from=php:alpine /usr/local/bin/docker-php-source /usr/local/bin/\n# COPY --from=php:alpine /usr/local/bin/docker-php-entrypoint /usr/local/bin/\n# COPY --from=php:alpine /usr/local/bin/docker-php-ext-configure /usr/local/bin/\n# COPY --from=php:alpine /usr/local/bin/docker-php-ext-enable /usr/local/bin/\n# COPY --from=php:alpine /usr/local/bin/docker-php-ext-install /usr/local/bin/\n\nRUN --mount=type=bind,from=php:7.3.6-alpine,source=/usr/src,target=/usr/src,rw \\\n    --mount=type=bind,from=php:7.3.6-alpine,source=/usr/local/bin,target=/opt/bin,rw \\\n  set -xe \\\n  && export PATH=$PATH:/opt/bin \\\n  ; mkdir -p $PHP_INI_DIR/conf.d \\\n\t&& apk add --no-cache --virtual .build-deps \\\n          $PHPIZE_DEPS \\\n          coreutils \\\n          curl-dev \\\n          libedit-dev \\\n          openssl-dev \\\n          libsodium-dev \\\n          libxml2-dev \\\n          sqlite-dev \\\n          argon2-dev \\\n          cyrus-sasl-dev \\\n          postgresql-dev \\\n          libzip-dev \\\n          zlib-dev \\\n          libpng-dev \\\n          freetype-dev \\\n          libjpeg-turbo-dev \\\n          libxpm-dev \\\n          libwebp-dev \\\n          libexif-dev \\\n          libxslt-dev \\\n          gmp-dev \\\n          xmlrpc-c-dev \\\n          bzip2-dev \\\n          enchant-dev \\\n          imap-dev \\\n          gettext-dev \\\n          icu-dev \\\n          krb5-dev \\\n          aspell-dev \\\n          openldap-dev \\\n          pcre-dev \\\n          tidyhtml-dev \\\n          net-snmp-dev \\\n          openldap-dev \\\n          ${APK_DEV_EXTRA:-} \\\n\t\\\n\t&& export CFLAGS=\"$PHP_CFLAGS\" \\\n\t\t        CPPFLAGS=\"$PHP_CPPFLAGS\" \\\n\t\t        LDFLAGS=\"$PHP_LDFLAGS\" \\\n\t&& docker-php-source extract \\\n\t&& cd /usr/src/php \\\n\t&& gnuArch=\"$(dpkg-architecture --query DEB_BUILD_GNU_TYPE)\" \\\n\t&& ./configure \\\n\t\t--build=\"$gnuArch\" \\\n\t\t--with-config-file-path=\"$PHP_INI_DIR\" \\\n\t\t--with-config-file-scan-dir=\"$PHP_INI_DIR/conf.d\" \\\n\t\t\\\n# make sure invalid --configure-flags are fatal errors intead of just warnings\n\t\t--enable-option-checking=fatal \\\n\t\t\\\n# https://github.com/docker-library/php/issues/439\n\t\t--with-mhash \\\n\t\t\\\n# --enable-ftp is included here because ftp_ssl_connect() needs ftp to be compiled statically (see https://github.com/docker-library/php/issues/236)\n\t\t--enable-ftp \\\n# --enable-mbstring is included here because otherwise there's no way to get pecl to use it properly (see https://github.com/docker-library/php/issues/195)\n\t\t--enable-mbstring \\\n# --enable-mysqlnd is included here because it's harder to compile after the fact than extensions are (since it's a plugin for several extensions, not an extension in itself)\n\t\t--enable-mysqlnd \\\n# https://wiki.php.net/rfc/libsodium\n\t\t--with-sodium=shared \\\n\t\t\\\n\t\t--with-curl \\\n\t\t--with-libedit \\\n\t\t--with-openssl \\\n\t\t--with-zlib \\\n# https://wiki.php.net/rfc/argon2_password_hash (7.2+)\n\t\t--with-password-argon2 \\\n\t\t\\\n# bundled pcre does not support JIT on s390x\n# https://manpages.debian.org/stretch/libpcre3-dev/pcrejit.3.en.html#AVAILABILITY_OF_JIT_SUPPORT\n\t\t$(test \"$gnuArch\" = 's390x-linux-gnu' && echo '--without-pcre-jit') \\\n\t\t\\\n\t\t$PHP_EXTRA_CONFIGURE_ARGS \\\n\t&& make -j \"$(nproc)\" \\\n  && find -type f -name '*.a' -delete \\\n\t&& make install \\\n\t&& { find /usr/local/bin /usr/local/sbin -type f -perm +0111 -exec strip --strip-all '{}' + || true; } \\\n# && docker-php-source delete \\\n  \\\n  && docker-php-ext-enable bcmath \\\n                           bz2 \\\n                           calendar \\\n                           enchant \\\n                           exif \\\n                           fileinfo \\\n                           gd \\\n                           gettext \\\n                           gmp \\\n                           imap \\\n                           intl \\\n                           mysqli \\\n                           pcntl \\\n                           pdo_mysql \\\n                           pdo_pgsql \\\n                           pgsql \\\n                           posix \\\n                           pspell \\\n                           shmop \\\n                           snmp \\\n                           soap \\\n                           sodium \\\n                           sockets \\\n                           sysvmsg \\\n                           sysvsem \\\n                           sysvshm \\\n                           tidy \\\n                           xmlrpc \\\n                           xsl \\\n                           # opcache 已默认安装，需要自行载入\n                           opcache \\\n                           ${PHP_EXTENSION_EXTRA:-} \\\n\t&& runDeps=\"$( \\\n\t\tscanelf --needed --nobanner --format '%n#p' --recursive /usr/local \\\n\t\t\t| tr ',' '\\n' \\\n\t\t\t| sort -u \\\n\t\t\t| awk 'system(\"[ -e /usr/local/lib/\" $1 \" ]\") == 0 { next } { print \"so:\" $1 }' \\\n\t)\" \\\n\t&& apk add --no-cache $runDeps \\\n  \\\n  && strip --strip-all /usr/local/lib/libphp7.so \\\n  && { find $(php-config --extension-dir) -type f -perm +0111 -exec strip --strip-all '{}' + || true; } \\\n  && apk del --no-network --no-cache .build-deps \\\n# https://github.com/docker-library/php/issues/443\n  && pecl update-channels \\\n\t&& rm -rf /tmp/pear ~/.pearrc \\\n  \\\n# sodium was built as a shared module (so that it can be replaced later if so desired), so let's enable it too (https://github.com/docker-library/php/issues/598)\n# RUN docker-php-ext-enable sodium\n  \\\n# 创建日志文件夹\n  && ln -sf /dev/stderr /var/log/xdebug-remote.log\n  # && rm -rf /usr/src/*\n\nRUN cd /usr/src \\\n  && wget https://github.com/nginx/unit/archive/${NGINX_UNIT_VERSION}.tar.gz \\\n  && tar -zxvf ${NGINX_UNIT_VERSION}.tar.gz \\\n  && mv unit-${NGINX_UNIT_VERSION} unit \\\n  && cd /usr/src/unit \\\n  && apk add --no-cache --virtual .build-deps $PHPIZE_DEPS openssl-dev \\\n  && ./configure --build=\"$(dpkg-architecture --query DEB_BUILD_GNU_TYPE)\" --prefix=/usr/local/nginx-unit --openssl \\\n  && ./configure --build=\"$(dpkg-architecture --query DEB_BUILD_GNU_TYPE)\" php \\\n       --module=php73 \\\n       --lib-path=/usr/local/lib \\\n       --config=/usr/local/bin/php-config \\\n  && make \\\n  && make install \\\n  && strip --strip-all /usr/local/nginx-unit/sbin/unitd \\\n  && mkdir -p /usr/local/sbin \\\n  && ln -sf /usr/local/nginx-unit/sbin/unitd /usr/local/sbin/unitd \\\n  && apk del --no-network --no-cache .build-deps \\\n  && rm -rf /usr/src/* \\\n  && mkdir -p /var/log/nginx-unit \\\n  && ln -sf /dev/stdout /var/log/nginx-unit/nginx-unit.log && rm ${NGINX_UNIT_VERSION}.tar.gz\n\nENV PECL_BUILD_DEPS \\\n      libmemcached-dev \\\n      yaml-dev \\\n      zlib-dev\n\nENV PECL_RUN_DEPS \\\n      libmemcached-libs \\\n      yaml \\\n      zlib\n\nENV PECL_EXTENSION \\\n      mongodb \\\n      igbinary \\\n      redis \\\n      memcached \\\n      # xdebug \\\n      yaml \\\n      ${PECL_EXTENSION_EXTRA:-}\n\nRUN --mount=type=bind,from=php:7.3.6-alpine,source=/usr/local/bin,target=/opt/bin,rw \\\n      set -x \\\n      && export PATH=$PATH:/opt/bin \\\n      && apk add --no-cache --virtual .pecl_build_deps $PECL_BUILD_DEPS $PHPIZE_DEPS \\\n      && apk add --no-cache --virtual .pecl_run_deps $PECL_RUN_DEPS \\\n      && for extension in $PECL_EXTENSION;do \\\n           pecl install $extension \\\n           && docker-php-ext-enable $(echo ${extension} | cut -d '-' -f 1) || echo \"pecl ${extension} install error\" \\\n           && rm -rf /usr/local/lib/php/doc/$(echo ${extension} | cut -d '-' -f 1) \\\n           && rm -rf /usr/local/lib/php/test/$(echo ${extension} | cut -d '-' -f 1) \\\n           && rm -rf /usr/local/include/php/ext/$(echo ${extension} | cut -d '-' -f 1) \\\n           && strip --strip-all $(php-config --extension-dir)/$(echo ${extension} | cut -d '-' -f 1).so ; \\\n         done \\\n      ; apk del --no-network --no-cache .pecl_build_deps \\\n# 默认不启用 xdebug\n      # && mv /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini \\\n      #      /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini.default \\\n      && rm -rf /tmp/* \\\n      && rm -rf /usr/local/lib/php/.registry/.channel.pecl.php.net/*\n\nENV PS1=\"[\\u@\\h \\w]# \"\n\nENTRYPOINT [\"unitd\"]\n\nCMD [\"--no-daemon\",\"--user\",\"root\",\"--group\",\"root\",\"--log\",\"/var/log/nginx-unit/nginx-unit.log\"]\n\nWORKDIR /app\n"
}