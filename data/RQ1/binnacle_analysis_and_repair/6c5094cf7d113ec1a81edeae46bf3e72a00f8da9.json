{
  "startTime": 1674251505277,
  "endTime": 1674251505416,
  "originalSmells": [
    {
      "rule": "aptGetInstallThenRemoveAptLists",
      "position": {
        "lineStart": 31,
        "lineEnd": 31,
        "columnStart": 22,
        "columnEnd": 88
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "# Licensed to the Apache Software Foundation (ASF) under one or more\n# contributor license agreements.  See the NOTICE file distributed with\n# this work for additional information regarding copyright ownership.\n# The ASF licenses this file to You under the Apache License, Version 2.0\n# (the \"License\"); you may not use this file except in compliance with\n# the License.  You may obtain a copy of the License at\n#\n#     http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\n\n# Base image is built from integration-tests/docker-base in the Druid repo\nFROM imply/druiditbase:0.2\n\nRUN echo \"[mysqld]\\ncharacter-set-server=utf8\\ncollation-server=utf8_bin\\n\" >> /etc/mysql/my.cnf\n\n# Setup metadata store\n# touch is needed because OverlayFS's copy-up operation breaks POSIX standards. See https://github.com/docker/for-linux/issues/72.\nRUN find /var/lib/mysql -type f -exec touch {} \\; && /etc/init.d/mysql start \\\n      && echo \"CREATE USER 'druid'@'%' IDENTIFIED BY 'diurd'; GRANT ALL ON druid.* TO 'druid'@'%'; CREATE database druid DEFAULT CHARACTER SET utf8mb4;\" | mysql -u root \\\n      && /etc/init.d/mysql stop\n\n# Add Druid jars\nADD lib/* /usr/local/druid/lib/\n\n# Download the MySQL Java connector\nENV DEBIAN_FRONTEND=noninteractive\nRUN apt-get update && apt-get install -y --no-install-recommends apt-utils libmysql-java && rm -rf /var/lib/apt/lists/*;\nRUN ln -sf /usr/share/java/mysql-connector-java.jar /usr/local/druid/lib/mysql-connector-java.jar\n\n# Add sample data\n# touch is needed because OverlayFS's copy-up operation breaks POSIX standards. See https://github.com/docker/for-linux/issues/72.\nRUN find /var/lib/mysql -type f -exec touch {} \\; && service mysql start \\\n      && java -cp \"/usr/local/druid/lib/*\" -Ddruid.metadata.storage.type=mysql org.apache.druid.cli.Main tools metadata-init --connectURI=\"jdbc:mysql://localhost:3306/druid\" --user=druid --password=diurd \\\n      && /etc/init.d/mysql stop\nADD sample-data.sql sample-data.sql\n# touch is needed because OverlayFS's copy-up operation breaks POSIX standards. See https://github.com/docker/for-linux/issues/72.\nRUN find /var/lib/mysql -type f -exec touch {} \\; && service mysql start \\\n      && cat sample-data.sql | mysql -u root druid \\\n      && /etc/init.d/mysql stop\n\n# Setup supervisord\nADD supervisord.conf /etc/supervisor/conf.d/supervisord.conf\n\n# mysql\nADD run-mysql.sh /run-mysql.sh\n\n# internal docker_ip:9092 endpoint is used to access Kafka from other Docker containers\n# external docker ip:9093 endpoint is used to access Kafka from test code\n# run this last to avoid rebuilding the image every time the ip changes\nADD docker_ip docker_ip\nRUN perl -pi -e \"s/#listeners=.*/listeners=INTERNAL:\\/\\/172.172.172.2:9092,EXTERNAL:\\/\\/172.172.172.2:9093/\" /usr/local/kafka/config/server.properties\nRUN perl -pi -e \"s/#advertised.listeners=.*/advertised.listeners=INTERNAL:\\/\\/172.172.172.2:9092,EXTERNAL:\\/\\/$(cat docker_ip):9093/\" /usr/local/kafka/config/server.properties\nRUN perl -pi -e \"s/#listener.security.protocol.map=.*/listener.security.protocol.map=INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT\\ninter.broker.listener.name=INTERNAL/\" /usr/local/kafka/config/server.properties\nRUN perl\n\n# Add directory with TLS support files\nADD tls tls\n\nADD client_tls client_tls\n\n# Expose ports:\n# - 8081, 8281: HTTP, HTTPS (coordinator)\n# - 8082, 8282: HTTP, HTTPS (broker)\n# - 8083, 8283: HTTP, HTTPS (historical)\n# - 8090, 8290: HTTP, HTTPS (overlord)\n# - 8091, 8291: HTTP, HTTPS (middlemanager)\n# - 8888-8891, 9088-9091: HTTP, HTTPS (routers)\n# - 3306: MySQL\n# - 2181 2888 3888: ZooKeeper\n# - 8100 8101 8102 8103 8104 8105 : peon ports\n# - 8300 8301 8302 8303 8304 8305 : peon HTTPS ports\nEXPOSE 8081 8281\nEXPOSE 8082 8282\nEXPOSE 8083 8283\nEXPOSE 8090 8290\nEXPOSE 8091 8291\nEXPOSE 3306\nEXPOSE 2181 2888 3888\nEXPOSE 8100 8101 8102 8103 8104 8105\nEXPOSE 8300 8301 8302 8303 8304 8305\nEXPOSE 9092 9093\n\nWORKDIR /var/lib/druid\nENTRYPOINT export HOST_IP=\"$(resolveip -s $HOSTNAME)\" && /tls/generate-server-certs-and-keystores.sh && exec /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf\n"
}