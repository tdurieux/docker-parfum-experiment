{
  "startTime": 1674242765906,
  "endTime": 1674242766241,
  "originalSmells": [
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 46,
        "lineEnd": 46,
        "columnStart": 4,
        "columnEnd": 191
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 46,
        "lineEnd": 46,
        "columnStart": 4,
        "columnEnd": 191
      }
    },
    {
      "rule": "aptGetInstallThenRemoveAptLists",
      "position": {
        "lineStart": 46,
        "lineEnd": 46,
        "columnStart": 4,
        "columnEnd": 191
      }
    }
  ],
  "repairedSmells": [
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 46,
        "lineEnd": 46,
        "columnStart": 4,
        "columnEnd": 215
      }
    }
  ],
  "repairedDockerfile": "# Dockerfile for setting up auto-flowspec contoller\n#\n# To install docker run:\n# sudo apt-get install -y docker.io\n#\n# To make the docker daemon start at boot:\n# sudo systemctl enable docker\n#\n# Edit the Dockerfile environment variables below\n# vi Dockerfile\n#\n# To build the container run:\n# sudo docker build -t auto-flowspec .\n#\n# Create a shared directory for log files from the container called /var/log/auto-flowspec with the command:\n# sudo mkdir /var/log/auto-flowspec\n#\n# To start the container run:\n# sudo docker run --name auto-flowspec -v /var/log/auto-flowspec:/var/log/auto-flowspec -d --restart unless-stopped -p 179:179 -p 514:514/udp -p 9001:9001  --network host auto-flowspec\n#\n# Log in to the Supervisor http server with the username of admin and specified password to view the status and STDOUT of the relevant processes at http://<Host IP>:9001\n\nFROM ubuntu:16.04\n\n# Dockerfile created by Rich Compton rich.compton@charter.com 1-24-18\n\n#Set this if the Docker container is behind a proxy:\n#ENV http_proxy http://<PROXY IP>:80\n#ENV https_proxy http://<PROXY IP>:80\n#ENV no_proxy=localhost,172.16.0.0/12,127.0.0.0/8,127.0.1.1,127.0.1.1*,local.home\n#ENV NO_PROXY=localhost,172.16.0.0/12,127.0.0.0/8,127.0.1.1,127.0.1.1*,local.home\n\n# Upgrade the OS\nRUN apt-get update && apt-get upgrade -y\n\n### Configure all the ENVironment variables below before building the container:\n\n# Define mysql root\nENV MYSQL_ROOT_PASS=mysqlrootpassword\n\n# Set the mysql root password\nRUN echo \"mysql-server mysql-server/root_password password $MYSQL_ROOT_PASS\" | debconf-set-selections\nRUN echo \"mysql-server mysql-server/root_password_again password $MYSQL_ROOT_PASS\" | debconf-set-selections\n\n\n# Install necessary packages\nRUN DEBIAN_FRONTEND=noninteractive apt-get --no-install-recommends install -y python-setuptools python-flask curl wget python-requests git supervisor mysql-server python-minimal python-mysql.connector vim lsof unzip && rm -rf /var/lib/apt/lists/*;\n\n# Define the user for the Supervisor web interface\nENV SUPERVISOR_USER=admin\n\n# Define the pass for the Supervisor web interface\nENV SUPERVISOR_PASS=supervisorpassword\n\n# Define the password for the flowspecuser\nENV FLOWSPEC_USER_PASS=flowspecpassword\n\n# Define the Exabgp Neighbor #1 IP\nENV NEIGHBOR1_IP=192.0.2.1\n\n# Define the Exabgp Neighbor #1 description (no spaces)\nENV NEIGHBOR1_DESC=flowspec-rtr01\n\n# Define the MD5 password for Neighbor 1\nENV NEIGHBOR1_MD5=md5password1\n\n# Define the Exabgp Neighbor 1 Peer ASN\nENV PEER1_AS=65206\n\n# Define the Exabgp Neighbor #2 IP\nENV NEIGHBOR2_IP=192.0.2.2\n\n# Define the Exabgp Neighbor #2 description (no spaces)\nENV NEIGHBOR2_DESC=flowspec-rtr02\n\n# Define the MD5 password for Neighbor 2\nENV NEIGHBOR2_MD5=md5password2\n\n# Define the Exabgp Neighbor 1 Peer ASN\nENV PEER2_AS=65000\n\n# Definie the Exabgp Router ID (normally the IPv4 IP of the host OS)\nENV ROUTER_ID=192.0.2.3\n\n# Define the Exabgp Local Address (Normally the same IP as the ROUTER_ID, the IPv4 IP of the host OS)\nENV LOCAL_ADDRESS=192.0.2.3\n\n# Define the Exabgp Local ASN\nENV LOCAL_AS=65206\n\n# Define the BGP Community to tag Flowspec routes with\nENV COMMUNITY=64777:00020\n\n# Define the DNS rate limit speed in Bytes for inbound traffic with UDP source port 53\nENV DNS_RATE_LIMIT=3750\n\n# Define the ICMP rate limit speed in Bytes for inbound traffic with IP Proto 1\nENV ICMP_RATE_LIMIT=3750\n\n# Define the SYN rate limit speed in Bytes for inbound traffic with the SYN flag sent\nENV SYN_RATE_LIMIT=3750\n\n# Define the maximum speed in Bytes for all othe traffic to the victim\nENV MAX_SPEED=12500000\n\n# Define the maximum time in hours for Flowspec rules to remain active.  After this time, the rules will be removed even if no syslog message has been received stating that the attack has finished.\nENV MAX_RULE_AGE=6\n\n# Define the syslog string to look for to identify a DDoS start message\nENV DDOS_START_MESSAGE=\"start\"\n\n# Define the syslog string to look for to identify the Managed Objects that you want to mitigate with Flowspec rules\nENV DDOS_CUTSOMER_MATCH=\"Residential\"\n\n# Define the syslog string to look for to identify a DDoS stop message\nENV DDOS_STOP_MESSAGE=\" is now done,\"\n\n# Define the syslog string to look for to identify a high level alert.  \"importance 2\" is a high level alert in Arbor SP.\nENV DDOS_HIGH_IMPORTANCE=\"importance 2\"\n\n# That's it.  No more changes are necessary after this point.\n\n# Change the working directory\nWORKDIR /opt/\n\n# Make a directory called opt/auto-flowspec/\nRUN mkdir /opt/auto-flowspec/\n\n# Copy over the contents of the auto-flowspec directory over\nCOPY flowspec/auto-flowspec/* /opt/auto-flowspec/\n\n# Get ExaBGP 3.4 code from GitHub\nWORKDIR /tmp/\nRUN wget https://github.com/Exa-Networks/exabgp/archive/3.4.zip\nRUN unzip 3.4.zip\nRUN mv /tmp/exabgp-3.4/ /opt/exabgp/\n\n\n# Make an auto-flowspec log directory to stick all the logs in.  This diretory will be mounted on the host OS.\nRUN mkdir /var/log/auto-flowspec/\n\n# Set up supervisord to have a web page for viewing the status\nCOPY flowspec/supervisord.conf  /etc/supervisor/supervisord.conf\n\n# Define the supervisord username\nRUN sed -i -e \"s/SUPERVISOR_USER/$SUPERVISOR_USER/g\" /etc/supervisor/supervisord.conf\n\n# Create the SHA1 password for supervisord and replace the default one\nRUN HASH_PASS=`python -c \"import hashlib; m = hashlib.sha1(); m.update('$SUPERVISOR_PASS'); print m.hexdigest()\"` && sed -i -e \"s/HASH_PASS/$HASH_PASS/g\" /etc/supervisor/supervisord.conf \n\n# Set up supervisord to run Auto-Flowspec Python Script\nCOPY flowspec/auto-flowspec-supervisor.conf /etc/supervisor/conf.d/auto-flowspec-supervisor.conf\n\n# Set up supervisord to run Auto-Cleanup Shell Script (runs and then sleeps one hour and then runs again)\nCOPY flowspec/auto-cleanup-supervisor.conf /etc/supervisor/conf.d/auto-cleanup-supervisor.conf\n\n# Set up supervisord to run ExaBGP\nCOPY flowspec/exabgp-supervisor.conf /etc/supervisor/conf.d/exabgp-supervisor.conf\n\n# Set up supervisord to run MySQL\nCOPY flowspec/mysql-supervisor.conf /etc/supervisor/conf.d/mysql-supervisor.conf\n\n## Create ExaBGP config file\nCOPY flowspec/exabgp.conf /opt/exabgp/etc/exabgp/exabgp.conf\n\n# Create the exabgp.env file\nCOPY flowspec/exabgp.env /opt/exabgp/etc/exabgp/exabgp.env\n\n# Modify auto-flowspec.py file and replace password with specified password\nRUN   sed -i -e \"s/FLOWSPEC_USER_PASS/$FLOWSPEC_USER_PASS/g\" /opt/auto-flowspec/auto-flowspec.py\n\n# Modify auto-flow-cleanup.py file and replace password with specified password\nRUN   sed -i -e \"s/FLOWSPEC_USER_PASS/$FLOWSPEC_USER_PASS/g\" /opt/auto-flowspec/auto-flow-cleanup.py\n\n\n# Modify exabgp.conf file and replace values with specified values\nRUN   sed -i -e \"s/NEIGHBOR1_IP/$NEIGHBOR1_IP/g\" /opt/exabgp/etc/exabgp/exabgp.conf\nRUN   sed -i -e \"s/NEIGHBOR1_DESC/$NEIGHBOR1_DESC/g\" /opt/exabgp/etc/exabgp/exabgp.conf\nRUN   sed -i -e \"s/PEER1_AS/$PEER1_AS/g\" /opt/exabgp/etc/exabgp/exabgp.conf\nRUN   sed -i -e \"s/NEIGHBOR1_MD5/$NEIGHBOR1_MD5/g\" /opt/exabgp/etc/exabgp/exabgp.conf\nRUN   sed -i -e \"s/NEIGHBOR2_IP/$NEIGHBOR2_IP/g\" /opt/exabgp/etc/exabgp/exabgp.conf\nRUN   sed -i -e \"s/NEIGHBOR2_DESC/$NEIGHBOR2_DESC/g\" /opt/exabgp/etc/exabgp/exabgp.conf\nRUN   sed -i -e \"s/NEIGHBOR2_MD5/$NEIGHBOR2_MD5/g\" /opt/exabgp/etc/exabgp/exabgp.conf\nRUN   sed -i -e \"s/PEER2_AS/$PEER2_AS/g\" /opt/exabgp/etc/exabgp/exabgp.conf\nRUN   sed -i -e \"s/ROUTER_ID/$ROUTER_ID/g\" /opt/exabgp/etc/exabgp/exabgp.conf\nRUN   sed -i -e \"s/LOCAL_AS/$LOCAL_AS/g\" /opt/exabgp/etc/exabgp/exabgp.conf\nRUN   sed -i -e \"s/LOCAL_ADDRESS/$LOCAL_ADDRESS/g\" /opt/exabgp/etc/exabgp/exabgp.conf\n\n# Modify the auto-flowspec.py and auto-flow-cleanup.py files to define the COMMUNITY that the Flowspec rules will be tagged with\nRUN   sed -i -e \"s/DNS_RATE_LIMIT/$DNS_RATE_LIMIT/g\" /opt/auto-flowspec/auto-flowspec.py\nRUN   sed -i -e \"s/DNS_RATE_LIMIT/$DNS_RATE_LIMIT/g\" /opt/auto-flowspec/auto-flow-cleanup.py\nRUN   sed -i -e \"s/ICMP_RATE_LIMIT/$ICMP_RATE_LIMIT/g\" /opt/auto-flowspec/auto-flowspec.py\nRUN   sed -i -e \"s/ICMP_RATE_LIMIT/$ICMP_RATE_LIMIT/g\" /opt/auto-flowspec/auto-flow-cleanup.py\nRUN   sed -i -e \"s/SYN_RATE_LIMIT/$SYN_RATE_LIMIT/g\" /opt/auto-flowspec/auto-flowspec.py\nRUN   sed -i -e \"s/SYN_RATE_LIMIT/$SYN_RATE_LIMIT/g\" /opt/auto-flowspec/auto-flow-cleanup.py\nRUN   sed -i -e \"s/MAX_SPEED/$MAX_SPEED/g\" /opt/auto-flowspec/auto-flowspec.py\nRUN   sed -i -e \"s/MAX_SPEED/$MAX_SPEED/g\" /opt/auto-flowspec/auto-flow-cleanup.py\n\n# Modify the auto-flowspec.py and auto-flow-cleanup.py files to define the rate limit speeds\nRUN   sed -i -e \"s/COMMUNITY/$COMMUNITY/g\" /opt/auto-flowspec/auto-flowspec.py\nRUN   sed -i -e \"s/COMMUNITY/$COMMUNITY/g\" /opt/auto-flowspec/auto-flow-cleanup.py\n\n# Modify the auto-flow-cleanup.py file to specify the maximum age that flowspec rules can have\nRUN   sed -i -e \"s/MAX_RULE_AGE/$MAX_RULE_AGE/g\" /opt/auto-flowspec/auto-flow-cleanup.py\n\n# Modify the auto-flowspec.py scipt to define the string matches for starting/stopping a high level attack with the specified Managed Object name\nRUN   sed -i -e \"s/DDOS_START_MESSAGE/$DDOS_START_MESSAGE/g\" /opt/auto-flowspec/auto-flowspec.py\nRUN   sed -i -e \"s/DDOS_CUTSOMER_MATCH/$DDOS_CUTSOMER_MATCH/g\" /opt/auto-flowspec/auto-flowspec.py\nRUN   sed -i -e \"s/DDOS_STOP_MESSAGE/$DDOS_STOP_MESSAGE/g\" /opt/auto-flowspec/auto-flowspec.py\nRUN   sed -i -e \"s/DDOS_HIGH_IMPORTANCE/$DDOS_HIGH_IMPORTANCE/g\" /opt/auto-flowspec/auto-flowspec.py\n\n# Create the Flask API for ExaBGP and make it executable\nCOPY flowspec/exabgp-app.py /opt/exabgp/run/\nRUN chmod 755 /opt/exabgp/run/exabgp-app.py\n\n\n# Modify the flowspec user password for access to the flowspecdb in MySQL\nRUN   sed -i -e \"s/FLOWSPEC_USER_PASS/$FLOWSPEC_USER_PASS/g\" /opt/auto-flowspec/flowspecdb-schema.sql\n\n# Create a directory for mysqld to put it's PID and then make the mysql user the owner of the directory so that user can write to the directory\nRUN mkdir /var/run/mysqld\nRUN chown mysql /var/run/mysqld\n\n# Start up the mysql database so we can create the database\n# This is all one line because mysql will stop if it's on seperate lines\n# sleep 5 give the mysql daemon a few seconds to start up before we create the database and create the tables\nRUN /bin/bash -c \"/usr/bin/mysqld_safe &\" && \\\nsleep 5 && \\\nmysql -u root -p$MYSQL_ROOT_PASS  -e \"CREATE DATABASE flowspecdb\" && \\\nmysql -u root -p$MYSQL_ROOT_PASS flowspecdb < /opt/auto-flowspec/flowspecdb-schema.sql\n\n# Copy over the run-mysql.sh script which will start mysql and create the flowspecdb if it doesn't exist yet\n#COPY flowspec/run-mysql.sh /opt/auto-flowspec/\n# Make the script executable\n#RUN chmod 755 /opt/auto-flowspec/run-mysql.sh\n\n# Expose BGP port for ExaBGP\nEXPOSE 179\n# Expose Syslog Port for collecting Syslog messages from ArborSP\nEXPOSE 514/udp\n# Expose Supervisord HTTP Server port\nEXPOSE 9001\n\n# Run the supervisord daemon which will start mysql, auto-flowspec, and auto-clean-up.py\nCMD [\"/usr/bin/supervisord\", \"-n\", \"-c\", \"/etc/supervisor/supervisord.conf\"]\n\n\n"
}