{
  "startTime": 1674241019636,
  "endTime": 1674241020214,
  "originalSmells": [
    {
      "rule": "apkAddUseNoCache",
      "position": {
        "lineStart": 181,
        "lineEnd": 181,
        "columnStart": 1,
        "columnEnd": 51
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "FROM maven:3.6.0-jdk-8-alpine\n\n#####ELASTICSEARCH#####\n\n# ensure elasticsearch user exists\nRUN addgroup -S elasticsearch && adduser -S -G elasticsearch elasticsearch\n\n# grab su-exec for easy step-down from root\n# and bash for \"bin/elasticsearch\" among others\nRUN apk add --no-cache 'su-exec>=0.2' bash procps\n\n# https://artifacts.elastic.co/GPG-KEY-elasticsearch\nENV GPG_KEY 46095ACC8548582C1A2699A9D27D666CD88E42B4\n\nWORKDIR /usr/share/elasticsearch\nENV PATH /usr/share/elasticsearch/bin:$PATH\n\nENV ELASTICSEARCH_VERSION 5.6.14\nENV ELASTICSEARCH_TARBALL=\"https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.6.14.tar.gz\" \\\n\tELASTICSEARCH_TARBALL_ASC=\"https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.6.14.tar.gz.asc\" \\\n\tELASTICSEARCH_TARBALL_SHA1=\"392e98ebd549aba91f3041c59fe0d7be1abbd229\"\n\nRUN set -ex; \\\n\t\\\n\tapk add --no-cache --virtual .fetch-deps \\\n\t\tca-certificates \\\n\t\tgnupg \\\n\t\topenssl \\\n\t\ttar \\\n\t; \\\n\t\\\n\twget -O elasticsearch.tar.gz \"$ELASTICSEARCH_TARBALL\"; \\\n\t\\\n\tif [ \"$ELASTICSEARCH_TARBALL_SHA1\" ]; then \\\n\t\techo \"$ELASTICSEARCH_TARBALL_SHA1 *elasticsearch.tar.gz\" | sha1sum -c -; \\\n\tfi; \\\n\t\\\n\tif [ \"$ELASTICSEARCH_TARBALL_ASC\" ]; then \\\n\t\twget -O elasticsearch.tar.gz.asc \"$ELASTICSEARCH_TARBALL_ASC\"; \\\n\t\texport GNUPGHOME=\"$(mktemp -d)\"; \\\n\t\tgpg --batch --keyserver ha.pool.sks-keyservers.net --recv-keys \"$GPG_KEY\"; \\\n\t\tgpg --batch --verify elasticsearch.tar.gz.asc elasticsearch.tar.gz; \\\n\t\trm -rf \"$GNUPGHOME\" elasticsearch.tar.gz.asc; \\\n\tfi; \\\n\t\\\n\ttar -xf elasticsearch.tar.gz --strip-components=1; \\\n\trm elasticsearch.tar.gz; \\\n\t\\\n\tapk del .fetch-deps; \\\n\t\\\n\tmkdir -p ./plugins; \\\n\tfor path in \\\n\t\t./data \\\n\t\t./logs \\\n\t\t./config \\\n\t\t./config/scripts \\\n\t; do \\\n\t\tmkdir -p \"$path\"; \\\n\t\tchown -R elasticsearch:elasticsearch \"$path\"; \\\n\tdone; \\\n\t\\\n# we shouldn't need much RAM to test --version (default is 2gb, which gets Jenkins in trouble sometimes)\n\texport ES_JAVA_OPTS='-Xms32m -Xmx32m'; \\\n\tif [ \"${ELASTICSEARCH_VERSION%%.*}\" -gt 1 ]; then \\\n\t\telasticsearch --version; \\\n\telse \\\n# elasticsearch 1.x doesn't support --version\n# but in 5.x, \"-v\" is verbose (and \"-V\" is --version)\n\t\telasticsearch -v; \\\n\tfi\n\n#####TOMCAT#####\n\nENV CATALINA_HOME /usr/local/tomcat\nENV PATH $CATALINA_HOME/bin:$PATH\nRUN mkdir -p \"$CATALINA_HOME\"\nWORKDIR $CATALINA_HOME\n\n# let \"Tomcat Native\" live somewhere isolated\nENV TOMCAT_NATIVE_LIBDIR $CATALINA_HOME/native-jni-lib\nENV LD_LIBRARY_PATH ${LD_LIBRARY_PATH:+$LD_LIBRARY_PATH:}$TOMCAT_NATIVE_LIBDIR\n\n# see https://www.apache.org/dist/tomcat/tomcat-$TOMCAT_MAJOR/KEYS\n# see also \"update.sh\" (https://github.com/docker-library/tomcat/blob/master/update.sh)\nENV GPG_KEYS 05AB33110949707C93A279E3D3EFE6B686867BA6 07E48665A34DCAFAE522E5E6266191C37C037D42 47309207D818FFD8DCD3F83F1931D684307A10A5 541FBE7D8F78B25E055DDEE13C370389288584E7 61B832AC2F1C5A90F0F9B00A1C506407564C17A3 79F7026C690BAA50B92CD8B66A3AD3F4F22C4FED 9BA44C2621385CB966EBA586F72C284D731FABEE A27677289986DB50844682F8ACB77FC2E86E29AC A9C5DF4D22E99998D9875A5110C01C5A2F6059E7 DCFD35E0BF8CA7344752DE8B6FB21E8933C60243 F3A04C595DB5B6A5F1ECA43E3B7BBB100D811BBE F7DA48BB64BCB84ECBA7EE6935CD23C10D498E23\n\nENV TOMCAT_MAJOR 9\nENV TOMCAT_VERSION 9.0.16\nENV TOMCAT_SHA512 3e398e2343d1afc16a5f0cbfa8516db9db59ea8686d7d817eafa11c1465b71b711ccb2cae8437d5c32442b3a3f6cd3dbf15285eb35a28fcdb42c19793e0ff64e\n\nENV TOMCAT_TGZ_URLS \\\n# https://issues.apache.org/jira/browse/INFRA-8753?focusedCommentId=14735394#comment-14735394\n\thttps://www.apache.org/dyn/closer.cgi?action=download&filename=tomcat/tomcat-$TOMCAT_MAJOR/v$TOMCAT_VERSION/bin/apache-tomcat-$TOMCAT_VERSION.tar.gz \\\n# if the version is outdated, we might have to pull from the dist/archive :/\n\thttps://www-us.apache.org/dist/tomcat/tomcat-$TOMCAT_MAJOR/v$TOMCAT_VERSION/bin/apache-tomcat-$TOMCAT_VERSION.tar.gz \\\n\thttps://www.apache.org/dist/tomcat/tomcat-$TOMCAT_MAJOR/v$TOMCAT_VERSION/bin/apache-tomcat-$TOMCAT_VERSION.tar.gz \\\n\thttps://archive.apache.org/dist/tomcat/tomcat-$TOMCAT_MAJOR/v$TOMCAT_VERSION/bin/apache-tomcat-$TOMCAT_VERSION.tar.gz\n\nENV TOMCAT_ASC_URLS \\\n\thttps://www.apache.org/dyn/closer.cgi?action=download&filename=tomcat/tomcat-$TOMCAT_MAJOR/v$TOMCAT_VERSION/bin/apache-tomcat-$TOMCAT_VERSION.tar.gz.asc \\\n# not all the mirrors actually carry the .asc files :'(\n\thttps://www-us.apache.org/dist/tomcat/tomcat-$TOMCAT_MAJOR/v$TOMCAT_VERSION/bin/apache-tomcat-$TOMCAT_VERSION.tar.gz.asc \\\n\thttps://www.apache.org/dist/tomcat/tomcat-$TOMCAT_MAJOR/v$TOMCAT_VERSION/bin/apache-tomcat-$TOMCAT_VERSION.tar.gz.asc \\\n\thttps://archive.apache.org/dist/tomcat/tomcat-$TOMCAT_MAJOR/v$TOMCAT_VERSION/bin/apache-tomcat-$TOMCAT_VERSION.tar.gz.asc\n\nRUN set -eux; \\\n\n\tapk add --no-cache --virtual .fetch-deps \\\n\t\tgnupg \\\n\t\t\\\n\t\tca-certificates \\\n\t\topenssl \\\n\t; \\\n\n\texport GNUPGHOME=\"$(mktemp -d)\"; \\\n\tfor key in $GPG_KEYS; do \\\n\t\tgpg --batch --keyserver ha.pool.sks-keyservers.net --recv-keys \"$key\"; \\\n\tdone; \\\n\n\tsuccess=; \\\n\tfor url in $TOMCAT_TGZ_URLS; do \\\n\t\tif wget -O tomcat.tar.gz \"$url\"; then \\\n\t\t\tsuccess=1; \\\n\t\t\tbreak; \\\n\t\tfi; \\\n\tdone; \\\n\t[ -n \"$success\" ]; \\\n\n\techo \"$TOMCAT_SHA512 *tomcat.tar.gz\" | sha512sum -c -; \\\n\n\tsuccess=; \\\n\tfor url in $TOMCAT_ASC_URLS; do \\\n\t\tif wget -O tomcat.tar.gz.asc \"$url\"; then \\\n\t\t\tsuccess=1; \\\n\t\t\tbreak; \\\n\t\tfi; \\\n\tdone; \\\n\t[ -n \"$success\" ]; \\\n\n\tgpg --batch --verify tomcat.tar.gz.asc tomcat.tar.gz; \\\n\ttar -xvf tomcat.tar.gz --strip-components=1; \\\n\trm bin/*.bat; \\\n\trm tomcat.tar.gz*; \\\n\tcommand -v gpgconf && gpgconf --kill all || :; \\\n\trm -rf \"$GNUPGHOME\"; \\\n\n\tnativeBuildDir=\"$(mktemp -d)\"; \\\n\ttar -xvf bin/tomcat-native.tar.gz -C \"$nativeBuildDir\" --strip-components=1; \\\n\tapk add --no-cache --virtual .native-build-deps \\\n\t\tapr-dev \\\n\t\tcoreutils \\\n\t\tdpkg-dev dpkg \\\n\t\tgcc \\\n\t\tlibc-dev \\\n\t\tmake \\\n\t\t\"openjdk${JAVA_VERSION%%[-~bu]*}\"=\"$JAVA_ALPINE_VERSION\" \\\n\t\topenssl-dev \\\n\t; \\\n\t( \\\n\t\texport CATALINA_HOME=\"$PWD\"; \\\n\t\tcd \"$nativeBuildDir/native\"; \\\n\t\tgnuArch=\"$(dpkg-architecture --query DEB_BUILD_GNU_TYPE)\"; \\\n\t\t./configure \\\n\t\t\t--build=\"$gnuArch\" \\\n\t\t\t--libdir=\"$TOMCAT_NATIVE_LIBDIR\" \\\n\t\t\t--prefix=\"$CATALINA_HOME\" \\\n\t\t\t--with-apr=\"$(which apr-1-config)\" \\\n\t\t\t--with-java-home=\"$(docker-java-home)\" \\\n\t\t\t--with-ssl=yes; \\\n\t\tmake -j \"$(nproc)\"; \\\n\t\tmake install; \\\n\t); \\\n\trm -rf \"$nativeBuildDir\"; \\\n\trm bin/tomcat-native.tar.gz; \\\n\n\trunDeps=\"$( \\\n\t\tscanelf --needed --nobanner --format '%n#p' --recursive \"$TOMCAT_NATIVE_LIBDIR\" \\\n\t\t\t| tr ',' '\\n' \\\n\t\t\t| sort -u \\\n\t\t\t| awk 'system(\"[ -e /usr/local/lib/\" $1 \" ]\") == 0 { next } { print \"so:\" $1 }' \\\n\t)\"; \\\n\tapk add --no-cache --virtual .tomcat-native-rundeps $runDeps; \\\n\tapk del .fetch-deps .native-build-deps; \\\n\n# sh removes env vars it doesn't support (ones with periods)\n# https://github.com/docker-library/tomcat/issues/77\n\tapk add --no-cache bash; \\\n\tfind ./bin/ -name '*.sh' -exec sed -ri 's|^#!/bin/sh$|#!/usr/bin/env bash|' '{}' +; \\\n\n# fix permissions (especially for running as non-root)\n# https://github.com/docker-library/tomcat/issues/35\n\tchmod -R +rX .; \\\n\tchmod 777 logs work\n\n# verify Tomcat Native is working properly\nRUN set -e \\\n\t&& nativeLines=\"$(catalina.sh configtest 2>&1)\" \\\n\t&& nativeLines=\"$(echo \"$nativeLines\" | grep 'Apache Tomcat Native')\" \\\n\t&& nativeLines=\"$(echo \"$nativeLines\" | sort -u)\" \\\n\t&& if ! echo \"$nativeLines\" | grep 'INFO: Loaded APR based Apache Tomcat Native library' >&2; then \\\n\t\techo >&2 \"$nativeLines\"; \\\n\t\texit 1; \\\n\tfi\n\nRUN apk add --no-cache git\n"
}