{
  "startTime": 1674246096953,
  "endTime": 1674246097174,
  "originalSmells": [
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 31,
        "lineEnd": 31,
        "columnStart": 2,
        "columnEnd": 77
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "FROM debian:jessie-slim\nEXPOSE 443\n\nLABEL maintainer \"infrastructure@orangebus.co.uk\"\n\nENV HTTP_PORT=9180 \\\n    HTTPS_PORT=9143 \\\n    MPM_STARTSERVERS=2 \\\n    MPM_MINSPARETHREADS=25 \\\n    MPM_MAXSPARETHREADS=75 \\\n    MPM_THREADLIMIT=64 \\\n    MPM_THREADSPERCHILD=25 \\\n    MPM_MAXREQUESTWORKERS=150 \\\n    MPM_MAXCONNECTIONSPERCHILD=0 \\\n    SP_DOMAIN=ifs.local-dev \\\n    IDP_DOMAIN=idp \\\n    IDP_PORT=8443 \\\n    SP_PROXY_KEY=\"@auth_sp_proxy_key@\" \\\n    SP_PROXY_CERTIFICATE=\"@auth_sp_proxy_certificate@\" \\\n    SP_PROXY_CACERTIFICATE=\"@auth_sp_proxy_cacertificate@\" \\\n    IDP_SIGNING_CERTIFICATE=\"@auth_idp_signing_certificate@\" \\\n    IDP_ENCRYPTION_CERTIFICATE=\"@auth_idp_encryption_certificate@\" \\\n    MEMCACHE_ENDPOINT=\n\nWORKDIR /usr/local/bin\n\nCOPY files /usr/local/files/\n\nRUN apt-get update --fix-missing && \\\n\n# install apache and shibboleth sp module \\\n  apt-get -y --no-install-recommends install curl apache2 libapache2-modsecurity libapache2-mod-shib2 && \\\n  apt-get autoclean && apt-get --purge -y autoremove && rm -rf /var/lib/apt/lists/* && \\\n\n# directory for certificates, added in entrypoint \\\n  mkdir /etc/apache2/certs && \\\n\n# configure apache \\\n  rm -f /etc/apache2/sites-enabled/000-default.conf && \\\n  a2enmod shib2 socache_shmcb ssl status proxy_ajp proxy headers rewrite proxy_http reqtimeout && \\\n  a2disconf other-vhosts-access-log && \\\n  mv /usr/local/files/apache2/mpm_event.conf /etc/apache2/mods-available/ && \\\n  sed -i -e 's/Listen 80/Listen ${HTTP_PORT}/' -e 's/Listen 443/Listen ${HTTPS_PORT}/' /etc/apache2/ports.conf && \\\n  mv /usr/local/files/apache2/z-defaults.conf /etc/apache2/conf-available/ && a2enconf z-defaults.conf && \\\n\n# put holding pages in place. A dedicated container is probably a better idea \\\n  mv /usr/local/files/apache2/locking /var/www/html/ && \\\n  mv /usr/local/files/scripts/* /usr/local/bin/ && \\\n\n# configure ifs virtual host \\\n  mv \"/usr/local/files/apache2/ifs-services.conf.ajp\" /etc/apache2/sites-available/ifs-services.conf && a2ensite ifs-services && \\\n\n# put static files in place \\\n  mkdir -p /var/www/html/files && \\\n  mv /usr/local/files/files/* /var/www/html/files/ && \\\n\n# run apache as its own user \\\n  mkdir -p /var/run/apache2 /run/lock/apache2 && \\\n  chown -R www-data:0 /etc/apache2 /var/cache/apache2 /run/lock/apache2 /var/run/apache2 /var/cache/modsecurity /var/www/html/ && \\\n  chmod -R u=rwX,g=rwX,o= /etc/apache2 /var/cache/apache2 /run/lock/apache2 /var/run/apache2 /var/cache/modsecurity /var/www/html/ && \\\n\n# configure shibboleth module \\\n  mv /usr/local/files/sp/* /etc/shibboleth/ && \\\n  mkdir /var/www/html/Logout && mv /usr/local/files/apache2/index.html /var/www/html/Logout/ && \\\n  sed -i \"/^log4j\\.appender/d\" /etc/shibboleth/shibd.logger && cat /etc/shibboleth/appenders.shibd.logger >> /etc/shibboleth/shibd.logger && rm /etc/shibboleth/appenders.shibd.logger && \\\n# see also certificates and substitutions in entrypoint script \\\n\n# run shibboleth sp as its own user (same as apache) \\\n  mkdir -p /var/run/shibboleth && \\\n  chown -R www-data:0 /etc/shibboleth /var/cache/shibboleth /var/www/html/Logout /var/run/shibboleth && \\\n  chmod -R u=rwX,g=rwX,o= /etc/shibboleth /var/cache/shibboleth /var/www/html/Logout /var/run/shibboleth && \\\n\n  rm -Rf /usr/local/files/\n\n#USER www-data\nHEALTHCHECK --interval=15s --timeout=8s \\\n  CMD curl -k -f https://localhost:443/Shibboleth.sso/Metadata || exit 1\nENTRYPOINT [ \"run-shibboleth-sp.sh\" ]\n"
}