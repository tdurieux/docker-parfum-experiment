{
  "startTime": 1674239979809,
  "endTime": 1674239980609,
  "originalSmells": [
    {
      "rule": "curlUseFlagF",
      "position": {
        "lineStart": 73,
        "lineEnd": 73,
        "columnStart": 2,
        "columnEnd": 63
      }
    },
    {
      "rule": "curlUseFlagF",
      "position": {
        "lineStart": 208,
        "lineEnd": 208,
        "columnStart": 4,
        "columnEnd": 124
      }
    },
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 19,
        "lineEnd": 19,
        "columnStart": 2,
        "columnEnd": 28
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "FROM debian:stretch-slim\nLABEL maintainer=\"Thomas VIAL\"\n\nENV DEBIAN_FRONTEND noninteractive\nENV VIRUSMAILS_DELETE_DELAY=7\nENV ONE_DIR=0\nENV ENABLE_POSTGREY=0\nENV FETCHMAIL_POLL=300\nENV POSTGREY_DELAY=300\nENV POSTGREY_MAX_AGE=35\nENV POSTGREY_AUTO_WHITELIST_CLIENTS=5\nENV POSTGREY_TEXT=\"Delayed by postgrey\"\n\nENV SASLAUTHD_MECHANISMS=pam\nENV SASLAUTHD_MECH_OPTIONS=\"\"\n\n# Packages\nRUN apt-get update -q --fix-missing && \\\n  apt-get -y upgrade && \\\n  apt-get -y --no-install-recommends install postfix && \\\n  apt-get -y install --no-install-recommends \\\n    amavisd-new \\\n    arj \\\n    binutils \\\n    bzip2 \\\n    ca-certificates \\\n    cabextract \\\n    clamav \\\n    clamav-daemon \\\n    cpio \\\n    curl \\\n    ed \\\n    fail2ban \\\n    fetchmail \\\n    file \\\n    gamin \\\n    gzip \\\n    gnupg \\\n    iproute2 \\\n    iptables \\\n    locales \\\n    liblz4-tool \\\n    libmail-spf-perl \\\n    libnet-dns-perl \\\n    libsasl2-modules \\\n    lrzip \\\n    lzop \\\n    netcat-openbsd \\\n    nomarch \\\n    opendkim \\\n    opendkim-tools \\\n    opendmarc \\\n    pax \\\n    pflogsumm \\\n    p7zip-full \\\n    postfix-ldap \\\n    postfix-pcre \\\n    postfix-policyd-spf-python \\\n    postsrsd \\\n    pyzor \\\n    razor \\\n    ripole \\\n    rpm2cpio \\\n    rsyslog \\\n    sasl2-bin \\\n    spamassassin \\\n    supervisor \\\n    postgrey \\\n    unrar-free \\\n    unzip \\\n    xz-utils \\\n    zoo \\\n    && \\\n  curl -f https://packages.elasticsearch.org/GPG-KEY-elasticsearch | apt-key add - && \\\n  echo \"deb http://packages.elastic.co/beats/apt stable main\" | tee -a /etc/apt/sources.list.d/beats.list && \\\n  echo \"deb http://ftp.debian.org/debian stretch-backports main\" | tee -a /etc/apt/sources.list.d/stretch-bp.list && \\\n  apt-get update -q --fix-missing && \\\n  apt-get -y upgrade \\\n    filebeat \\\n    && \\\n  apt-get -t stretch-backports -y install --no-install-recommends \\\n    dovecot-core \\\n    dovecot-imapd \\\n    dovecot-ldap \\\n    dovecot-lmtpd \\\n    dovecot-managesieved \\\n    dovecot-pop3d \\\n    dovecot-sieve \\\n    && \\\n  apt-get autoclean && \\\n  rm -rf /var/lib/apt/lists/* && \\\n  rm -rf /usr/share/locale/* && \\\n  rm -rf /usr/share/man/* && \\\n  rm -rf /usr/share/doc/* && \\\n  touch /var/log/auth.log && \\\n  update-locale && \\\n  rm -f /etc/cron.weekly/fstrim && \\\n  rm -f /etc/postsrsd.secret\n\nRUN echo \"0 0,6,12,18 * * * /usr/bin/freshclam --quiet\" > /etc/cron.d/clamav-freshclam && \\\n  chmod 644 /etc/clamav/freshclam.conf && \\\n  freshclam && \\\n  sed -i 's/Foreground false/Foreground true/g' /etc/clamav/clamd.conf && \\\n  sed -i 's/AllowSupplementaryGroups false/AllowSupplementaryGroups true/g' /etc/clamav/clamd.conf && \\\n  mkdir /var/run/clamav && \\\n  chown -R clamav:root /var/run/clamav\n\n# Configures Dovecot\nCOPY target/dovecot/auth-passwdfile.inc target/dovecot/??-*.conf /etc/dovecot/conf.d/\nRUN sed -i -e 's/include_try \\/usr\\/share\\/dovecot\\/protocols\\.d/include_try \\/etc\\/dovecot\\/protocols\\.d/g' /etc/dovecot/dovecot.conf && \\\n  sed -i -e 's/#mail_plugins = \\$mail_plugins/mail_plugins = \\$mail_plugins sieve/g' /etc/dovecot/conf.d/15-lda.conf && \\\n  sed -i -e 's/^.*lda_mailbox_autocreate.*/lda_mailbox_autocreate = yes/g' /etc/dovecot/conf.d/15-lda.conf && \\\n  sed -i -e 's/^.*lda_mailbox_autosubscribe.*/lda_mailbox_autosubscribe = yes/g' /etc/dovecot/conf.d/15-lda.conf && \\\n  sed -i -e 's/^.*postmaster_address.*/postmaster_address = '${POSTMASTER_ADDRESS:=\"postmaster@domain.com\"}'/g' /etc/dovecot/conf.d/15-lda.conf && \\\n  sed -i 's/#imap_idle_notify_interval = 2 mins/imap_idle_notify_interval = 29 mins/' /etc/dovecot/conf.d/20-imap.conf && \\\n  # stretch-backport of dovecot needs this folder\n  mkdir /etc/dovecot/ssl && \\\n  chmod 755 /etc/dovecot/ssl  && \\\n  cd /usr/share/dovecot && \\\n  ./mkcert.sh  && \\\n  mkdir -p /usr/lib/dovecot/sieve-pipe /usr/lib/dovecot/sieve-filter /usr/lib/dovecot/sieve-global && \\\n  chmod 755 -R /usr/lib/dovecot/sieve-pipe /usr/lib/dovecot/sieve-filter /usr/lib/dovecot/sieve-global\n\n# Configures LDAP\nCOPY target/dovecot/dovecot-ldap.conf.ext /etc/dovecot\nCOPY target/postfix/ldap-users.cf target/postfix/ldap-groups.cf target/postfix/ldap-aliases.cf target/postfix/ldap-domains.cf /etc/postfix/\n\n# Enables Spamassassin CRON updates and update hook for supervisor\nRUN sed -i -r 's/^(CRON)=0/\\1=1/g' /etc/default/spamassassin && \\\n    sed -i -r 's/^\\$INIT restart/supervisorctl restart amavis/g' /etc/spamassassin/sa-update-hooks.d/amavisd-new\n\n# Enables Postgrey\nCOPY target/postgrey/postgrey /etc/default/postgrey\nCOPY target/postgrey/postgrey.init /etc/init.d/postgrey\nRUN chmod 755 /etc/init.d/postgrey && \\\n  mkdir /var/run/postgrey && \\\n  chown postgrey:postgrey /var/run/postgrey\n\n# Copy PostSRSd Config\nCOPY target/postsrsd/postsrsd /etc/default/postsrsd\n\n# Enables Amavis\nCOPY target/amavis/conf.d/* /etc/amavis/conf.d/\nRUN sed -i -r 's/#(@|   \\\\%)bypass/\\1bypass/g' /etc/amavis/conf.d/15-content_filter_mode && \\\n  adduser clamav amavis && \\\n  adduser amavis clamav && \\\n  # no syslog user in debian compared to ubuntu\n  adduser --system syslog && \\\n  useradd -u 5000 -d /home/docker -s /bin/bash -p $(echo docker | openssl passwd -1 -stdin) docker && \\\n  (echo \"0 4 * * * /usr/local/bin/virus-wiper\" ; crontab -l) | crontab -\n\n# Configure Fail2ban\nCOPY target/fail2ban/jail.conf /etc/fail2ban/jail.conf\nCOPY target/fail2ban/filter.d/dovecot.conf /etc/fail2ban/filter.d/dovecot.conf\nRUN echo \"ignoreregex =\" >> /etc/fail2ban/filter.d/postfix-sasl.conf && mkdir /var/run/fail2ban\n\n# Enables Pyzor and Razor\nUSER amavis\nRUN razor-admin -create && \\\n  razor-admin -register\nUSER root\n\n# Configure DKIM (opendkim)\n# DKIM config files\nCOPY target/opendkim/opendkim.conf /etc/opendkim.conf\nCOPY target/opendkim/default-opendkim /etc/default/opendkim\n\n# Configure DMARC (opendmarc)\nCOPY target/opendmarc/opendmarc.conf /etc/opendmarc.conf\nCOPY target/opendmarc/default-opendmarc /etc/default/opendmarc\nCOPY target/opendmarc/ignore.hosts /etc/opendmarc/ignore.hosts\n\n# Configure fetchmail\nCOPY target/fetchmail/fetchmailrc /etc/fetchmailrc_general\nRUN sed -i 's/START_DAEMON=no/START_DAEMON=yes/g' /etc/default/fetchmail\nRUN mkdir /var/run/fetchmail && chown fetchmail /var/run/fetchmail\n\n# Configures Postfix\nCOPY target/postfix/main.cf target/postfix/master.cf /etc/postfix/\nCOPY target/postfix/header_checks.pcre target/postfix/sender_header_filter.pcre target/postfix/sender_login_maps.pcre /etc/postfix/maps/\nRUN echo \"\" > /etc/aliases && \\\n  openssl dhparam -out /etc/postfix/dhparams.pem 2048 && \\\n  echo \"@weekly FILE=`mktemp` ; openssl dhparam -out $FILE 2048 > /dev/null 2>&1 && mv -f $FILE /etc/postfix/dhparams.pem\" > /etc/cron.d/dh2048\n\n\n# Configuring Logs\nRUN sed -i -r \"/^#?compress/c\\compress\\ncopytruncate\" /etc/logrotate.conf && \\\n  mkdir -p /var/log/mail && \\\n  chown syslog:root /var/log/mail && \\\n  touch /var/log/mail/clamav.log && \\\n  chown -R clamav:root /var/log/mail/clamav.log && \\\n  touch /var/log/mail/freshclam.log && \\\n  chown -R clamav:root /var/log/mail/freshclam.log && \\\n  sed -i -r 's|/var/log/mail|/var/log/mail/mail|g' /etc/rsyslog.conf && \\\n  sed -i -r 's|;auth,authpriv.none|;mail.none;mail.error;auth,authpriv.none|g' /etc/rsyslog.conf && \\\n  sed -i -r 's|LogFile /var/log/clamav/|LogFile /var/log/mail/|g' /etc/clamav/clamd.conf && \\\n  sed -i -r 's|UpdateLogFile /var/log/clamav/|UpdateLogFile /var/log/mail/|g' /etc/clamav/freshclam.conf && \\\n  sed -i -r 's|/var/log/clamav|/var/log/mail|g' /etc/logrotate.d/clamav-daemon && \\\n  sed -i -r 's|/var/log/clamav|/var/log/mail|g' /etc/logrotate.d/clamav-freshclam && \\\n  sed -i -r 's|/var/log/mail|/var/log/mail/mail|g' /etc/logrotate.d/rsyslog && \\\n  sed -i -r '/\\/var\\/log\\/mail\\/mail.log/d' /etc/logrotate.d/rsyslog && \\\n  # prevent syslog logrotate warnings \\\n  sed -i -e 's/\\(printerror \"could not determine current runlevel\"\\)/#\\1/' /usr/sbin/invoke-rc.d && \\\n  sed -i -e 's/^\\(POLICYHELPER=\\).*/\\1/' /usr/sbin/invoke-rc.d && \\\n  # prevent email when /sbin/init or init system is not existing \\\n  sed -i -e 's/invoke-rc.d rsyslog rotate > \\/dev\\/null/invoke-rc.d rsyslog --quiet rotate > \\/dev\\/null/g' /etc/logrotate.d/rsyslog\n\n# Get LetsEncrypt signed certificate\nRUN curl -f -s https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem > /etc/ssl/certs/lets-encrypt-x3-cross-signed.pem\n\nCOPY ./target/bin /usr/local/bin\n# Start-mailserver script\nCOPY ./target/check-for-changes.sh ./target/start-mailserver.sh ./target/fail2ban-wrapper.sh ./target/postfix-wrapper.sh ./target/postsrsd-wrapper.sh ./target/docker-configomat/configomat.sh /usr/local/bin/\nRUN chmod +x /usr/local/bin/*\n\n# Configure supervisor\nCOPY target/supervisor/supervisord.conf /etc/supervisor/supervisord.conf\nCOPY target/supervisor/conf.d/* /etc/supervisor/conf.d/\n\nEXPOSE 25 587 143 465 993 110 995 4190\n\nCMD [\"supervisord\", \"-c\", \"/etc/supervisor/supervisord.conf\"]\n\nADD target/filebeat.yml.tmpl /etc/filebeat/filebeat.yml.tmpl\n"
}