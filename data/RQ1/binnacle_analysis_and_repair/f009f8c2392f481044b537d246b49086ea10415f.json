{
  "startTime": 1674245811846,
  "endTime": 1674245812226,
  "originalSmells": [
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 20,
        "lineEnd": 21,
        "columnStart": 5,
        "columnEnd": 13
      }
    },
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 22,
        "lineEnd": 37,
        "columnStart": 5,
        "columnEnd": 17
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "FROM debian:wheezy\nMAINTAINER Semen Pisarev <s.a.pisarev@gmail.com>\n\nENV DEBIAN_FRONTEND noninteractive\nRUN echo \"APT::Install-Recommends 0;\" >> /etc/apt/apt.conf.d/01norecommends \\\n  && echo \"APT::Install-Suggests 0;\" >> /etc/apt/apt.conf.d/01norecommends\n\nENV IREDMAIL_VERSION 0.9.0\n\n# TODO: Replace hostname\nENV HOSTNAME mx.example.com\nENV DOCKER_LDAP_DN dc=example,dc=com\n\n# Local sources (for speed-up)\nCOPY ./sources.list.ru /etc/apt/sources.list\n# Install some necessary packages\nRUN echo 'deb http://inverse.ca/debian wheezy wheezy' > \\\n    /etc/apt/sources.list.d/00-inverse-ca.list \\\n  && apt-key adv --keyserver keys.gnupg.net --recv-key 0x810273C4 \\\n  && apt-get -q update \\\n  && apt-get install --no-install-recommends -y -q \\\n    apt-utils \\\n  && apt-get install --no-install-recommends -y -q \\\n    curl \\\n    wget \\\n    bzip2 \\\n    dialog \\\n    openssl \\\n    rsync \\\n    rsyslog \\\n    dovecot-core \\\n    dovecot-imapd \\\n    dovecot-ldap \\\n    dovecot-lmtpd \\\n    dovecot-managesieved \\\n    dovecot-mysql \\\n    dovecot-pop3d \\\n    dovecot-sieve \\\n  && apt-get clean \\\n  && rm -rf /var/lib/apt/lists/* \\\n  && rm -f /etc/apt/sources.list.d/00-inverse-ca.list\n\n# Set working directory\nWORKDIR /opt/iredmail\n\n# Copy files, extract iRedMail, remove archive, copy & configure tools\nCOPY ./files ./\n\nRUN wget -O - --no-check-certificate \\\n    https://bitbucket.org/zhb/iredmail/downloads/iRedMail-\"${IREDMAIL_VERSION}\".tar.bz2 | \\\n    tar xvj \\\n  && cp -rl iRedMail-\"${IREDMAIL_VERSION}\"/* . \\\n  && rm -rf iRedMail-\"${IREDMAIL_VERSION}\"* \\\n  && mkdir -p /opt/itools \\\n  && cp ./tools/* /opt/itools \\\n  && mkdir -p /var/vmail/backup \\\n  && mv ./backup.sh /var/vmail/backup \\\n  && sed -i 's/dc=example,dc=com/'\"$DOCKER_LDAP_DN\"'/' \\\n    /opt/itools/create_mail_user_OpenLDAP.py\n\n# Fake `uname` and `hostname`\nRUN mv /bin/uname /bin/uname_ \\\n  && mv /bin/hostname /bin/hostname_ \\\n  && cp -l ./hostname ./uname /bin/\n\n# Set hostname\nRUN echo $HOSTNAME > /etc/hostname \\\n  && echo $HOSTNAME > /etc/mailname \\\n  && mkdir -p /etc/apache2/ \\\n  && echo 'ServerName '$HOSTNAME > /etc/apache2/httpd.conf\n\n# Make link to Apache log files\nRUN rm -rf /var/www/apache2/ \\\n  && mkdir -p /var/log/apache2/www/ /var/www/ \\\n  && ln -s /var/log/apache2/www/ /var/www/apache2 \\\n  && chown -R www-data:www-data /var/www/ /var/log/apache2/\n\n# Make ClamAV socket file (to avoid installation warning)\nRUN touch /tmp/clamd.socket \\\n  && chmod -Rf 766 /tmp/clamd.socket\n\n# Avoid getty errors in log files\nRUN sed -ri 's/^[1-6]:[2-6]{2,4}:.*/#\\0/' /etc/inittab\n\n# Enable services startup during install,\n#   run iRedMail installation & remove unneeded,\n#   disable services startup during install\nRUN sed -i 's/ 101/ 0/' /usr/sbin/policy-rc.d \\\n  && IREDMAIL_DEBUG='NO' \\\n    AUTO_USE_EXISTING_CONFIG_FILE=y \\\n    AUTO_INSTALL_WITHOUT_CONFIRM=y \\\n    AUTO_CLEANUP_REMOVE_SENDMAIL=y \\\n    AUTO_CLEANUP_REMOVE_MOD_PYTHON=y \\\n    AUTO_CLEANUP_REPLACE_FIREWALL_RULES=n \\\n    AUTO_CLEANUP_RESTART_IPTABLES=y \\\n    AUTO_CLEANUP_REPLACE_MYSQL_CONFIG=y \\\n    AUTO_CLEANUP_RESTART_POSTFIX=n \\\n    bash iRedMail.sh \\\n  && apt-get purge -y -q dialog apt-utils \\\n  && apt-get autoremove -y -q \\\n  && apt-get clean -y -q \\\n  && rm -rf /var/lib/apt/lists/* \\\n  && sed -i 's/ 0/ 101/' /usr/sbin/policy-rc.d\n\n# Create directory for LDIF files\nRUN mkdir -p ldifs\n\n# Create users from mail_users.csv\nRUN if [ -e mail_users.csv ]; \\\n    then \\\n      python /opt/itools/create_mail_user_OpenLDAP.py ./mail_users.csv \\\n      && mv ./mail_users.csv.ldif ldifs/20_mail_users.ldif; \\\n    fi\n\n# Run slapd as root\nRUN rm -rf /etc/ldap/slapd.d \\\n  && sed -i 's/openldap/root/g' /etc/default/slapd\n\n# Limit slapd memory (see https://github.com/cema-sp/iredmail-docker/issues/3)\nRUN sed -ri 's/^PATH/ulimit -n 1024\\nPATH/' /etc/init.d/slapd\n\n# TODO: Replace ldap password (LDAP_ROOTPW)\n# Copy initial ldif and add all ldifs to ldap\nRUN cp /opt/iredmail/conf/ldap_init.ldif ldifs/00_ldap_init.ldif \\\n  && service slapd start \\\n  && for f in ldifs/*.ldif; \\\n  do \\\n    ( ldapadd -D 'cn=Manager,'\"$DOCKER_LDAP_DN\" -w password_ldap -f \"$f\" || \\\n    ldapmodify -v -D 'cn=Manager,'\"$DOCKER_LDAP_DN\" -w password_ldap -f \"$f\" ); \\\n  done\n\n# Encrypy iRedMail.tips\n# TODO: Replace tips password (random)\nRUN echo 'password' | \\\n    openssl enc -in /opt/iredmail/iRedMail.tips -out /opt/iRedMail.tips.enc \\\n    -e -aes256 -pass stdin\n\n# Schedule backup script\nRUN (crontab -l 2>/dev/null; \\\n  echo \"0   4   *   *   *   /bin/bash /var/vmail/backup/backup.sh\") | \\\n  crontab -\n\n# Force users to change passwords\nRUN echo \"plugins.append('ldap_force_change_password_in_days')\" \\\n    >> /opt/iredapd/settings.py \\\n  && echo \"CHANGE_PASSWORD_DAYS = 365\" >> /opt/iredapd/settings.py \\\n  && echo \"CHANGE_PASSWORD_MESSAGE = 'Please change your password in webmail: https://$HOSTNAME/mail/'\" \\\n    >> /opt/iredapd/settings.py\n\nWORKDIR /opt\n\n# Remove distr, return `uname` and `hostname`\nRUN rm -rf /opt/iredmail /root/.bash_history \\\n  && rm -f /bin/uname /bin/hostname \\\n  && mv /bin/uname_ /bin/uname \\\n  && mv /bin/hostname_ /bin/hostname\n\n# Open Ports:\n# Apache: 80/tcp, 443/tcp Postfix: 25/tcp, 587/tcp\n# Dovecot: 110/tcp, 143/tcp, 993/tcp, 995/tcp OpenLDAP: 389/tcp, 636/tcp\nEXPOSE 80 443 25 587 110 143 993 995 389 636\n\n# Volume for backups\nVOLUME /backups\n\n# Start all services\nCMD [\"/sbin/init\",\"2\"]\n"
}