{
  "startTime": 1674248051337,
  "endTime": 1674248051953,
  "originalSmells": [
    {
      "rule": "configureShouldUseBuildFlag",
      "position": {
        "lineStart": 142,
        "lineEnd": 161,
        "columnStart": 4,
        "columnEnd": 20
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "FROM registry.access.redhat.com/rhel7\nMAINTAINER Alexey Pustovalov <alexey.pustovalov@zabbix.com>\n\nARG YUM_FLAGS_COMMON=\"-y\"\nARG YUM_FLAGS_PERSISTENT=\"${YUM_FLAGS_COMMON}\"\nARG YUM_FLAGS_DEV=\"${YUM_FLAGS_COMMON}\"\nENV TERM=xterm MIBDIRS=/usr/share/snmp/mibs:/var/lib/zabbix/mibs MIBS=+ALL \\\n    ZBX_TYPE=server ZBX_DB_TYPE=mysql ZBX_OPT_TYPE=nginx \\\n    MYSQL_ALLOW_EMPTY_PASSWORD=true ZBX_ADD_SERVER=true ZBX_ADD_WEB=true DB_SERVER_HOST=localhost MYSQL_USER=zabbix ZBX_ADD_JAVA_GATEWAY=true ZBX_JAVAGATEWAY_ENABLE=true ZBX_JAVAGATEWAY=localhost\n\nARG BUILD_DATE\nARG VCS_REF\n\nARG MAJOR_VERSION=4.2\nARG RELEASE=3\nARG ZBX_VERSION=${MAJOR_VERSION}.3\n\nARG ZBX_SOURCES=https://git.zabbix.com/scm/zbx/zabbix.git\nENV ZBX_VERSION=${ZBX_VERSION} ZBX_SOURCES=${ZBX_SOURCES}\n\nLABEL name=\"zabbix/zabbix-appliance\" \\\n      maintainer=\"alexey.pustovalov@zabbix.com\" \\\n      vendor=\"Zabbix LLC\" \\\n      version=\"${MAJOR_VERSION}\" \\\n      release=\"${RELEASE}\" \\\n      summary=\"Zabbix appliance with MySQL database support and ${ZBX_OPT_TYPE} web-server\" \\\n      description=\"Zabbix appliance contains MySQL database server, Zabbix server, Zabbix Java Gateway and Zabbix frontend based on Nginx web-server.\" \\\n      url=\"https://www.zabbix.com/\" \\\n      run=\"docker run --name zabbix-appliance -p 80:80 -p 10051:10051 -d registry.connect.redhat.com/zabbix/zabbix-appliance:${ZBX_VERSION}\" \\\n      io.k8s.description=\"Zabbix appliance with MySQL database support and ${ZBX_OPT_TYPE} web-server\" \\\n      io.k8s.display-name=\"Zabbix Appliance\" \\\n      io.openshift.expose-services=\"http:http,https:https,10051:10051\" \\\n      io.openshift.tags=\"zabbix,zabbix-appliance,mysql,nginx\" \\\n      org.label-schema.name=\"zabbix-appliance-rhel\" \\\n      org.label-schema.vendor=\"Zabbix LLC\" \\\n      org.label-schema.url=\"https://zabbix.com/\" \\\n      org.label-schema.description=\"Zabbix appliance with MySQL database support and ${ZBX_OPT_TYPE} web-server\" \\\n      org.label-schema.vcs-ref=\"${VCS_REF}\" \\\n      org.label-schema.build-date=\"${BUILD_DATE}\" \\\n      org.label-schema.schema-version=\"1.0\" \\\n      org.label-schema.license=\"GPL v2.0\" \\\n      org.label-schema.usage=\"https://www.zabbix.com/documentation/${MAJOR_VERSION}/manual/installation/containers\" \\\n      org.label-schema.version=\"${ZBX_VERSION}\" \\\n      org.label-schema.vcs-url=\"${ZBX_SOURCES}\" \\\n      org.label-schema.docker.cmd=\"docker run --name zabbix-appliance -p 80:80 -p 10051:10051 -d registry.connect.redhat.com/zabbix/zabbix-appliance:${ZBX_VERSION}\"\n\nSTOPSIGNAL SIGTERM\n\nCOPY [\"conf/etc/yum.repo.d/nginx.repo\", \"/etc/yum.repos.d/nginx.repo\"]\n\n### add licenses to this directory\nCOPY [\"licenses\", \"/licenses\"]\n\n### Add necessary Red Hat repos here\nRUN INSTALL_PKGS=\"OpenIPMI-libs \\\n            curl \\\n            fping \\\n            iksemel \\\n            java-1.8.0-openjdk-headless \\\n            libcurl \\\n            libevent \\\n            libxml2 \\\n            mariadb \\\n            mariadb-server \\\n            net-snmp-libs \\\n            nginx \\\n            openldap \\\n            openssl-libs \\\n            pcre \\\n            php-bcmath \\\n            php-fpm \\\n            php-gd \\\n            php-ldap \\\n            php-mbstring \\\n            python-setuptools \\\n            php-mysql \\\n            php-xml \\\n            unixODBC\" && \\\n    rpm -ivh https://repo.zabbix.com/zabbix/${MAJOR_VERSION}/rhel/7/x86_64/zabbix-release-${MAJOR_VERSION}-1.el7.noarch.rpm && \\\n    REPOLIST=\"rhel-7-server-rpms,rhel-7-server-optional-rpms,zabbix-non-supported,nginx\" && \\\n    yum -y update-minimal --disablerepo \"*\" --enablerepo rhel-7-server-rpms --setopt=tsflags=nodocs \\\n      --security --sec-severity=Important --sec-severity=Critical && \\\n    echo ${REPOLIST} && \\\n    yum -y install --disablerepo \"*\" --enablerepo \"${REPOLIST}\" --setopt=tsflags=nodocs ${INSTALL_PKGS} && \\\n    groupadd --system zabbix && \\\n    adduser -r --shell /sbin/nologin \\\n            -g zabbix -G dialout \\\n            -d /var/lib/zabbix/ \\\n        zabbix && \\\n    mkdir -p /etc/zabbix && \\\n    mkdir -p /var/lib/zabbix && \\\n    mkdir -p /usr/lib/zabbix/alertscripts && \\\n    mkdir -p /var/lib/zabbix/enc && \\\n    mkdir -p /usr/lib/zabbix/externalscripts && \\\n    mkdir -p /var/lib/zabbix/mibs && \\\n    mkdir -p /var/lib/zabbix/modules && \\\n    mkdir -p /var/lib/zabbix/snmptraps && \\\n    mkdir -p /var/lib/zabbix/ssh_keys && \\\n    mkdir -p /var/lib/zabbix/ssl && \\\n    mkdir -p /var/lib/zabbix/ssl/certs && \\\n    mkdir -p /var/lib/zabbix/ssl/keys && \\\n    mkdir -p /var/lib/zabbix/ssl/ssl_ca && \\\n    chown --quiet -R zabbix:root /var/lib/zabbix && \\\n    mkdir -p /usr/share/doc/zabbix-${ZBX_TYPE}-${ZBX_DB_TYPE}/ && \\\n    rm -f /etc/php-fpm.d/www.conf && \\\n    mkdir -p /var/lib/php/ && \\\n    chown --quiet -R nginx:nginx /var/lib/php/ && \\\n    easy_install supervisor && \\\n    mkdir -p /etc/supervisor/conf.d/ && \\\n    yum ${YUM_FLAGS_COMMON} clean all && \\\n    rm -rf /var/cache/yum && \\\n    rm -rf /var/lib/yum/yumdb/* && \\\n    rm -rf /usr/lib/udev/hwdb.d/*\n\nRUN REPOLIST=\"rhel-7-server-rpms,rhel-7-server-optional-rpms,zabbix-non-supported\" && \\\n    INSTALL_PKGS=\"autoconf \\\n            automake \\\n            gcc \\\n            gettext \\\n            iksemel-devel \\\n            java-1.8.0-openjdk-devel \\\n            libcurl-devel \\\n            libevent-devel \\\n            libssh2-devel \\\n            libxml2-devel \\\n            make \\\n            mariadb-devel \\\n            net-snmp-devel \\\n            OpenIPMI-devel \\\n            openldap-devel \\\n            git \\\n            unixODBC-devel\" && \\\n    yum -y install --disablerepo \"*\" --enablerepo \"${REPOLIST}\" --setopt=tsflags=nodocs ${INSTALL_PKGS} && \\\n    cd /tmp/ && \\\n    git clone ${ZBX_SOURCES} --branch ${ZBX_VERSION} --depth 1 --single-branch zabbix-${ZBX_VERSION} && \\\n    cd /tmp/zabbix-${ZBX_VERSION} && \\\n    zabbix_revision=`git rev-parse --short HEAD` && \\\n    sed -i \"s/{ZABBIX_REVISION}/$zabbix_revision/g\" include/version.h && \\\n    sed -i \"s/{ZABBIX_REVISION}/$zabbix_revision/g\" include/version.h && \\\n    sed -i \"s/{ZABBIX_REVISION}/$zabbix_revision/g\" src/zabbix_java/src/com/zabbix/gateway/GeneralInformation.java && \\\n    ./bootstrap.sh && \\\n    export CFLAGS=\"-fPIC -pie -Wl,-z,relro -Wl,-z,now\" && \\\n    ./configure --build=\"$(dpkg-architecture --query DEB_BUILD_GNU_TYPE)\" \\\n            --datadir=/usr/lib \\\n            --libdir=/usr/lib/zabbix \\\n            --prefix=/usr \\\n            --sysconfdir=/etc/zabbix \\\n            --enable-agent \\\n            --enable-${ZBX_TYPE} \\\n            --with-${ZBX_DB_TYPE} \\\n            --with-jabber \\\n            --with-ldap \\\n            --with-libcurl \\\n            --with-libxml2 \\\n            --enable-java \\\n            --with-net-snmp \\\n            --with-openipmi \\\n            --with-openssl \\\n            --with-ssh2 \\\n            --with-unixodbc \\\n            --enable-ipv6 \\\n            --silent && \\\n    make -j\"$(nproc)\" -s dbschema && \\\n    make -j\"$(nproc)\" -s && \\\n    cp src/zabbix_${ZBX_TYPE}/zabbix_${ZBX_TYPE} /usr/sbin/zabbix_${ZBX_TYPE} && \\\n    cp src/zabbix_get/zabbix_get /usr/bin/zabbix_get && \\\n    cp src/zabbix_sender/zabbix_sender /usr/bin/zabbix_sender && \\\n    cp conf/zabbix_${ZBX_TYPE}.conf /etc/zabbix/zabbix_${ZBX_TYPE}.conf && \\\n    chown --quiet -R zabbix:root /etc/zabbix && \\\n    cat database/${ZBX_DB_TYPE}/schema.sql > database/${ZBX_DB_TYPE}/create.sql && \\\n    cat database/${ZBX_DB_TYPE}/images.sql >> database/${ZBX_DB_TYPE}/create.sql && \\\n    cat database/${ZBX_DB_TYPE}/data.sql >> database/${ZBX_DB_TYPE}/create.sql && \\\n    gzip database/${ZBX_DB_TYPE}/create.sql && \\\n    cp database/${ZBX_DB_TYPE}/create.sql.gz /usr/share/doc/zabbix-${ZBX_TYPE}-${ZBX_DB_TYPE}/ && \\\n    mkdir -p /usr/sbin/zabbix_java/ && \\\n    cp -r src/zabbix_java/bin /usr/sbin/zabbix_java/ && \\\n    cp -r src/zabbix_java/lib /usr/sbin/zabbix_java/ && \\\n    rm -rf /usr/sbin/zabbix_java/lib/*.xml && \\\n    cd /tmp/ && \\\n    rm -rf /tmp/zabbix-${ZBX_VERSION}/ && \\\n    cd /usr/share/ && \\\n    git clone ${ZBX_SOURCES} --branch ${ZBX_VERSION} --depth 1 --single-branch zabbix-${ZBX_VERSION} && \\\n    mkdir /usr/share/zabbix/ && \\\n    cp -R /usr/share/zabbix-${ZBX_VERSION}/frontends/php/* /usr/share/zabbix/ && \\\n    rm -rf /usr/share/zabbix-${ZBX_VERSION}/ && \\\n    cd /usr/share/zabbix/ && \\\n    rm -f conf/zabbix.conf.php && \\\n    rm -rf tests && \\\n    ./locale/make_mo.sh && \\\n    yum ${YUM_FLAGS_COMMON} history undo `yum history | sed -n 4p |column -t | cut -d' ' -f1` && \\\n    yum ${YUM_FLAGS_COMMON} clean all && \\\n    rm -rf /var/cache/yum && \\\n    rm -rf /var/lib/yum/yumdb/* && \\\n    rm -rf /usr/lib/udev/hwdb.d/* && \\\n    rm -rf /etc/udev/hwdb.bin && \\\n    rm -rf /root/.pki\n\nEXPOSE 80/TCP 443/TCP 10051/TCP\n\nWORKDIR /var/lib/zabbix\n\nVOLUME [\"/etc/ssl/nginx\"]\nVOLUME [\"/usr/lib/zabbix/alertscripts\", \"/usr/lib/zabbix/externalscripts\", \"/var/lib/zabbix/enc\", \"/var/lib/zabbix/mibs\", \"/var/lib/zabbix/modules\"]\nVOLUME [\"/var/lib/zabbix/snmptraps\", \"/var/lib/zabbix/ssh_keys\", \"/var/lib/zabbix/ssl/certs\", \"/var/lib/zabbix/ssl/keys\", \"/var/lib/zabbix/ssl/ssl_ca\"]\nVOLUME [\"/var/lib/mysql/\"]\n\nCOPY [\"conf/etc/supervisor/\", \"/etc/supervisor/\"]\nCOPY [\"conf/etc/zabbix/nginx.conf\", \"/etc/zabbix/\"]\nCOPY [\"conf/etc/zabbix/nginx_ssl.conf\", \"/etc/zabbix/\"]\nCOPY [\"conf/etc/zabbix/web/zabbix.conf.php\", \"/etc/zabbix/web/\"]\nCOPY [\"conf/etc/nginx/nginx.conf\", \"/etc/nginx/\"]\nCOPY [\"conf/etc/php-fpm.conf\", \"/etc/php-fpm.conf\"]\nCOPY [\"conf/etc/php.d/99-zabbix.ini\", \"/etc/php.d/99-zabbix.ini\"]\nCOPY [\"conf/etc/zabbix/zabbix_java_gateway_logback.xml\", \"/etc/zabbix/\"]\nCOPY [\"conf/usr/sbin/zabbix_java_gateway\", \"/usr/sbin/\"]\nCOPY [\"docker-entrypoint.sh\", \"/usr/bin/\"]\n\nENV ZBX_TYPE=appliance\n\nENTRYPOINT [\"docker-entrypoint.sh\"]\n"
}