{
  "startTime": 1674234693529,
  "endTime": 1674234694091,
  "originalSmells": [
    {
      "rule": "configureShouldUseBuildFlag",
      "position": {
        "lineStart": 49,
        "lineEnd": 68,
        "columnStart": 4,
        "columnEnd": 20
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "FROM ubuntu:bionic as builder\n\nARG APT_FLAGS_COMMON=\"-y\"\nARG APT_FLAGS_DEV=\"${APT_FLAGS_COMMON} --no-install-recommends\"\n\nARG MAJOR_VERSION=4.2\nARG ZBX_VERSION=${MAJOR_VERSION}.3\nARG ZBX_SOURCES=https://git.zabbix.com/scm/zbx/zabbix.git\nENV ZBX_VERSION=${ZBX_VERSION} ZBX_SOURCES=${ZBX_SOURCES} \\\n    LANG=en_US.UTF-8 LANGUAGE=en_US:en LC_ALL=en_US.UTF-8 TERM=xterm \\\n    MIBDIRS=/var/lib/snmp/mibs/ietf:/var/lib/snmp/mibs/iana:/usr/share/snmp/mibs:/var/lib/zabbix/mibs MIBS=+ALL \\\n    ZBX_TYPE=server ZBX_DB_TYPE=mysql ZBX_OPT_TYPE=nginx \\\n    MYSQL_ALLOW_EMPTY_PASSWORD=true ZBX_ADD_SERVER=true ZBX_ADD_WEB=true DB_SERVER_HOST=localhost MYSQL_USER=zabbix ZBX_ADD_JAVA_GATEWAY=true ZBX_JAVAGATEWAY_ENABLE=true ZBX_JAVAGATEWAY=localhost\n\nRUN set -eux && \\\n    apt-get ${APT_FLAGS_COMMON} update && \\\n    DEBIAN_FRONTEND=noninteractive apt-get ${APT_FLAGS_DEV} install locales && \\\n    locale-gen $LC_ALL && \\\n    apt-get ${APT_FLAGS_COMMON} update && \\\n    DEBIAN_FRONTEND=noninteractive apt-get ${APT_FLAGS_DEV} install \\\n            autoconf \\\n            automake \\\n            gcc \\\n            gettext \\\n            libc6-dev \\\n            libcurl4-openssl-dev \\\n            libevent-dev \\\n            libiksemel-dev \\\n            libldap2-dev \\\n            libmysqlclient-dev \\\n            libopenipmi-dev \\\n            libpcre3-dev \\\n            libsnmp-dev \\\n            libssh2-1-dev \\\n            libxml2-dev \\\n            make \\\n            openjdk-8-jdk \\\n            pkg-config \\\n            git \\\n            unixodbc-dev && \\\n    cd /tmp/ && \\\n    git clone ${ZBX_SOURCES} --branch ${ZBX_VERSION} --depth 1 --single-branch zabbix-${ZBX_VERSION} && \\\n    cd /tmp/zabbix-${ZBX_VERSION} && \\\n    zabbix_revision=`git rev-parse --short HEAD` && \\\n    sed -i \"s/{ZABBIX_REVISION}/$zabbix_revision/g\" include/version.h && \\\n    sed -i \"s/{ZABBIX_REVISION}/$zabbix_revision/g\" include/version.h && \\\n    sed -i \"s/{ZABBIX_REVISION}/$zabbix_revision/g\" src/zabbix_java/src/com/zabbix/gateway/GeneralInformation.java && \\\n    ./bootstrap.sh && \\\n    export CFLAGS=\"-fPIC -pie -Wl,-z,relro -Wl,-z,now\" && \\\n    ./configure --build=\"$(dpkg-architecture --query DEB_BUILD_GNU_TYPE)\" \\\n            --datadir=/usr/lib \\\n            --libdir=/usr/lib/zabbix \\\n            --prefix=/usr \\\n            --sysconfdir=/etc/zabbix \\\n            --enable-agent \\\n            --enable-${ZBX_TYPE} \\\n            --with-${ZBX_DB_TYPE} \\\n            --with-jabber \\\n            --with-ldap \\\n            --with-libcurl \\\n            --with-libxml2 \\\n            --enable-java \\\n            --with-net-snmp \\\n            --with-openipmi \\\n            --with-openssl \\\n            --with-ssh2 \\\n            --with-unixodbc \\\n            --enable-ipv6 \\\n            --silent && \\\n    make -j\"$(nproc)\" -s dbschema && \\\n    make -j\"$(nproc)\" -s && \\\n    cat database/${ZBX_DB_TYPE}/schema.sql > database/${ZBX_DB_TYPE}/create.sql && \\\n    cat database/${ZBX_DB_TYPE}/images.sql >> database/${ZBX_DB_TYPE}/create.sql && \\\n    cat database/${ZBX_DB_TYPE}/data.sql >> database/${ZBX_DB_TYPE}/create.sql && \\\n    gzip database/${ZBX_DB_TYPE}/create.sql && \\\n    rm -rf /tmp/zabbix-${ZBX_VERSION}/src/zabbix_java/lib/*.xml && \\\n    cd frontends/php/ && \\\n    rm -f conf/zabbix.conf.php && \\\n    rm -rf tests && \\\n    ./locale/make_mo.sh\n\nFROM ubuntu:bionic\nLABEL maintainer=\"Alexey Pustovalov <alexey.pustovalov@zabbix.com>\"\n\nARG BUILD_DATE\nARG VCS_REF\n\nARG APT_FLAGS_COMMON=\"-y\"\nARG APT_FLAGS_PERSISTENT=\"${APT_FLAGS_COMMON} --no-install-recommends\"\nARG MAJOR_VERSION=4.2\nARG ZBX_VERSION=${MAJOR_VERSION}.3\nARG ZBX_SOURCES=https://git.zabbix.com/scm/zbx/zabbix.git\nENV ZBX_VERSION=${ZBX_VERSION} ZBX_SOURCES=${ZBX_SOURCES} \\\n    LANG=en_US.UTF-8 LANGUAGE=en_US:en LC_ALL=en_US.UTF-8 TERM=xterm \\\n    MIBDIRS=/var/lib/snmp/mibs/ietf:/var/lib/snmp/mibs/iana:/usr/share/snmp/mibs:/var/lib/zabbix/mibs MIBS=+ALL \\\n    ZBX_TYPE=server ZBX_DB_TYPE=mysql ZBX_OPT_TYPE=nginx \\\n    MYSQL_ALLOW_EMPTY_PASSWORD=true ZBX_ADD_SERVER=true ZBX_ADD_WEB=true DB_SERVER_HOST=localhost MYSQL_USER=zabbix ZBX_ADD_JAVA_GATEWAY=true ZBX_JAVAGATEWAY_ENABLE=true ZBX_JAVAGATEWAY=localhost\nENV TINI_VERSION v0.18.0\n\nLABEL org.label-schema.name=\"zabbix-${ZBX_TYPE}-${ZBX_DB_TYPE}-ubuntu\" \\\n      org.label-schema.vendor=\"Zabbix LLC\" \\\n      org.label-schema.url=\"https://zabbix.com/\" \\\n      org.label-schema.description=\"Zabbix appliance with MySQL database support and ${ZBX_OPT_TYPE} web-server\" \\\n      org.label-schema.vcs-ref=\"${VCS_REF}\" \\\n      org.label-schema.build-date=\"${BUILD_DATE}\" \\\n      org.label-schema.schema-version=\"1.0\" \\\n      org.label-schema.license=\"GPL v2.0\" \\\n      org.label-schema.usage=\"https://www.zabbix.com/documentation/${MAJOR_VERSION}/manual/installation/containers\" \\\n      org.label-schema.version=\"${ZBX_VERSION}\" \\\n      org.label-schema.vcs-url=\"${ZBX_SOURCES}\" \\\n      org.label-schema.docker.cmd=\"docker run --name zabbix-appliance -p 80:80 -p 10051:10051 -d zabbix-appliance:ubuntu-${ZBX_VERSION}\"\n\nSTOPSIGNAL SIGTERM\n\nCOPY --from=builder /tmp/zabbix-${ZBX_VERSION}/src/zabbix_${ZBX_TYPE}/zabbix_${ZBX_TYPE} /usr/sbin/zabbix_${ZBX_TYPE}\nCOPY --from=builder /tmp/zabbix-${ZBX_VERSION}/src/zabbix_get/zabbix_get /usr/bin/zabbix_get\nCOPY --from=builder /tmp/zabbix-${ZBX_VERSION}/src/zabbix_sender/zabbix_sender /usr/bin/zabbix_sender\nCOPY --from=builder /tmp/zabbix-${ZBX_VERSION}/conf/zabbix_${ZBX_TYPE}.conf /etc/zabbix/zabbix_${ZBX_TYPE}.conf\nCOPY --from=builder /tmp/zabbix-${ZBX_VERSION}/database/${ZBX_DB_TYPE}/create.sql.gz /usr/share/doc/zabbix-${ZBX_TYPE}-${ZBX_DB_TYPE}/create.sql.gz\n\nCOPY --from=builder /tmp/zabbix-${ZBX_VERSION}/src/zabbix_java/bin/ /usr/sbin/zabbix_java/bin/\nCOPY --from=builder /tmp/zabbix-${ZBX_VERSION}/src/zabbix_java/lib/ /usr/sbin/zabbix_java/lib/\n\nCOPY --from=builder /tmp/zabbix-${ZBX_VERSION}/frontends/php/ /usr/share/zabbix/\nADD https://github.com/krallin/tini/releases/download/${TINI_VERSION}/tini /sbin/tini\n\nRUN set -eux && \\\n    apt-get ${APT_FLAGS_COMMON} update && \\\n    DEBIAN_FRONTEND=noninteractive apt-get ${APT_FLAGS_PERSISTENT} install locales gnupg2 ca-certificates && \\\n    locale-gen $LC_ALL && \\\n    echo \"#!/bin/sh\\nexit 0\" > /usr/sbin/policy-rc.d && \\\n    addgroup --system --quiet zabbix && \\\n    adduser --quiet \\\n            --system --disabled-login \\\n            --ingroup zabbix \\\n            --home /var/lib/zabbix/ \\\n            --no-create-home \\\n        zabbix && \\\n    mkdir -p /etc/zabbix && \\\n    mkdir -p /var/lib/zabbix && \\\n    mkdir -p /usr/lib/zabbix/alertscripts && \\\n    mkdir -p /var/lib/zabbix/enc && \\\n    mkdir -p /usr/lib/zabbix/externalscripts && \\\n    mkdir -p /var/lib/zabbix/mibs && \\\n    mkdir -p /var/lib/zabbix/modules && \\\n    mkdir -p /var/lib/zabbix/snmptraps && \\\n    mkdir -p /var/lib/zabbix/ssh_keys && \\\n    mkdir -p /var/lib/zabbix/ssl && \\\n    mkdir -p /var/lib/zabbix/ssl/certs && \\\n    mkdir -p /var/lib/zabbix/ssl/keys && \\\n    mkdir -p /var/lib/zabbix/ssl/ssl_ca && \\\n    chown --quiet -R zabbix:root /var/lib/zabbix && \\\n    mkdir -p /usr/share/doc/zabbix-${ZBX_TYPE}-${ZBX_DB_TYPE}/ && \\\n    apt-get ${APT_FLAGS_COMMON} update && \\\n    NGINX_GPGKEY=573BFD6B3D8FBC641079A6ABABF5BD827BD9BF62; \\\n    found=''; \\\n    for server in \\\n        ha.pool.sks-keyservers.net \\\n        hkp://keyserver.ubuntu.com:80 \\\n        hkp://p80.pool.sks-keyservers.net:80 \\\n        pgp.mit.edu \\\n    ; do \\\n        echo \"Fetching GPG key $NGINX_GPGKEY from $server\"; \\\n        apt-key adv --keyserver \"$server\" --keyserver-options timeout=10 --recv-keys \"$NGINX_GPGKEY\" && found=yes && break; \\\n    done; \\\n    test -z \"$found\" && echo >&2 \"error: failed to fetch GPG key $NGINX_GPGKEY\" && exit 1; \\\n    DISTRIB_CODENAME=$(/bin/bash -c 'source /etc/lsb-release && echo $DISTRIB_CODENAME') && \\\n    echo \"deb https://nginx.org/packages/ubuntu/ $DISTRIB_CODENAME nginx\" >> /etc/apt/sources.list.d/nginx.list && \\\n    apt-get ${APT_FLAGS_COMMON} update && \\\n    DEBIAN_FRONTEND=noninteractive apt-get ${APT_FLAGS_PERSISTENT} install \\\n            iputils-ping \\\n            traceroute \\\n            curl \\\n            fping \\\n            libcurl4 \\\n            libevent-2.1 \\\n            libiksemel3 \\\n            libmysqlclient20 \\\n            libopenipmi0 \\\n            libpcre3 \\\n            libsnmp30 \\\n            libssh2-1 \\\n            libssl1.1 \\\n            libxml2 \\\n            mysql-client \\\n            mysql-server \\\n            nginx \\\n            openjdk-8-jre-headless \\\n            php7.2-bcmath \\\n            php7.2-fpm \\\n            php7.2-gd \\\n            php7.2-json \\\n            php7.2-ldap \\\n            php7.2-mbstring \\\n            php7.2-mysql \\\n            php7.2-xml \\\n            snmp-mibs-downloader \\\n            supervisor \\\n            unixodbc && \\\n    mkdir -p /var/lib/locales/supported.d/ && \\\n    rm -f /var/lib/locales/supported.d/local && \\\n    cat /usr/share/zabbix/include/locales.inc.php | grep display | grep true | awk '{$1=$1};1' | \\\n                cut -d\"'\" -f 2 | sort | \\\n                xargs -I '{}' bash -c 'echo \"{}.UTF-8 UTF-8\" >> /var/lib/locales/supported.d/local' && \\\n    chown --quiet -R www-data:www-data /usr/share/zabbix && \\\n    dpkg-reconfigure locales && \\\n    apt-get ${APT_FLAGS_COMMON} autoremove && \\\n    apt-get ${APT_FLAGS_COMMON} clean && \\\n    mkdir -p /var/lib/php7 && \\\n    chown --quiet -R www-data:www-data /var/lib/php7 && \\\n    rm -rf /var/cache/nginx/* && \\\n    rm -rf /var/lib/apt/lists/* && \\\n    chmod +x /sbin/tini\n\nEXPOSE 80/TCP 443/TCP 10051/TCP\n\nWORKDIR /var/lib/zabbix\n\nVOLUME [\"/etc/ssl/nginx\"]\nVOLUME [\"/usr/lib/zabbix/alertscripts\", \"/usr/lib/zabbix/externalscripts\", \"/var/lib/zabbix/enc\", \"/var/lib/zabbix/mibs\", \"/var/lib/zabbix/modules\"]\nVOLUME [\"/var/lib/zabbix/snmptraps\", \"/var/lib/zabbix/ssh_keys\", \"/var/lib/zabbix/ssl/certs\", \"/var/lib/zabbix/ssl/keys\", \"/var/lib/zabbix/ssl/ssl_ca\"]\nVOLUME [\"/var/lib/mysql/\"]\n\nCOPY [\"conf/etc/supervisor/\", \"/etc/supervisor/\"]\nCOPY [\"conf/etc/zabbix/nginx.conf\", \"/etc/zabbix/\"]\nCOPY [\"conf/etc/zabbix/nginx_ssl.conf\", \"/etc/zabbix/\"]\nCOPY [\"conf/etc/zabbix/web/zabbix.conf.php\", \"/etc/zabbix/web/\"]\nCOPY [\"conf/etc/nginx/nginx.conf\", \"/etc/nginx/\"]\nCOPY [\"conf/etc/php/7.2/fpm/conf.d/99-zabbix.ini\", \"/etc/php/7.2/fpm/conf.d/\"]\nCOPY [\"conf/etc/zabbix/zabbix_java_gateway_logback.xml\", \"/etc/zabbix/\"]\nCOPY [\"conf/usr/sbin/zabbix_java_gateway\", \"/usr/sbin/\"]\nCOPY [\"docker-entrypoint.sh\", \"/usr/bin/\"]\n\nENV ZBX_TYPE=appliance\n\nENTRYPOINT [\"/sbin/tini\", \"--\", \"/usr/bin/docker-entrypoint.sh\"]\n"
}