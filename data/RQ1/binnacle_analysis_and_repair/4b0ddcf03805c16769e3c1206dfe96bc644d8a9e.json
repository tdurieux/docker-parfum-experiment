{
  "startTime": 1674235621307,
  "endTime": 1674235621693,
  "originalSmells": [
    {
      "rule": "aptGetInstallThenRemoveAptLists",
      "position": {
        "lineStart": 59,
        "lineEnd": 80,
        "columnStart": 7,
        "columnEnd": 12
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "# Dockerfile - Ubuntu Cosmic Cuttlefish\n#\n# Installs Solarflare's OpenOnload into Ubuntu Cosmic.\n#\n# OpenOnload web page:\n#    https://www.openonload.org/\n#\n# To expose the host and onload to this container, run like this:\n#\n#   docker run --net=host --device=/dev/onload --device=/dev/onload_epoll --device=/dev/onload_cplane -it ONLOAD_ENABLED_IMAGE_ID [COMMAND] [ARG...]\n#\n# NOTE: The host's OpenOnload version must be the same as the container's.\n#\n# Copyright (c) 2019 Neomantra BV\n# Released under the MIT License, see LICENSE.txt\n#\n\nARG ONLOAD_DEBIAN_BASE=\"ubuntu\"\nARG ONLOAD_DEBIAN_TAG=\"cosmic\"\n\nFROM ${ONLOAD_DEBIAN_BASE}:${ONLOAD_DEBIAN_TAG}\n\nARG ONLOAD_DEBIAN_BASE=\"ubuntu\"\nARG ONLOAD_DEBIAN_TAG=\"cosmic\"\n\n# Onload version and its md5sum\nARG ONLOAD_VERSION=\"201811\"\nARG ONLOAD_MD5SUM=\"fde70da355e11c8b4114b54114a35de1\"\n\n# When ONLOAD_WITHZF is non-empty, the build includes Solarflare's TCPDirect library.\n# Default is to exclude it.\nARG ONLOAD_WITHZF\n\n# When ONLOAD_DISABLE_SYSCALL_HOOK is non-empty, then the build disables hooking the syscall function from libc.\n# Default is empty, enabling the OpenOnload's default hooking the syscall function.\n#\n# This only works with OpenOnload 201811 and newer.\n#\n# Some libraries, such as jemalloc need to invoke syscalls at startup.\n# This can cause infinite loops because the OpenOnload acceleration also needs malloc (via dlsym)\n#    https://github.com/jemalloc/jemalloc/issues/443\n#    https://github.com/jemalloc/jemalloc/issues/1426\nARG ONLOAD_DISABLE_SYSCALL_HOOK\n\n# When ONLOAD_USERSPACE_ID is non-empty, it sets the userspace build md5sum ID.\n# Default is empty, using the actual build md5sum ID\n#\n# This is necessary when the OpenOnload build is patched (for example with ONLOAD_DISABLE_SYSCALL_HOOK).\n# The OpenOnload system checks for version and ID matches between userspace and the driver;\n# thus one may need to spoof the userspace ID.\nARG ONLOAD_USERSPACE_ID\n\n# 1) Install OpenOnload build dependencies\n# 2) Download and verify OpenOnload from Solarflare's site\n# 3) Extract, build, and install onload\n# 4) Cleanup\n\nRUN \\\n    DEBIAN_FRONTEND=noninteractive apt-get update -y \\\n    && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \\\n        autoconf \\\n        automake \\\n        coreutils \\\n        ca-certificates \\\n        curl \\\n        ethtool \\\n        gcc \\\n        gcc-multilib \\\n        kmod \\\n        libc6-dev-i386 \\\n        libpcap0.8-dev \\\n        libtool-bin \\\n        make \\\n        net-tools \\\n        patch \\\n        perl \\\n        python-dev \\\n        sed \\\n        tar \\\n        valgrind \\\n        wget \\\n    && cd /tmp \\\n    && curl -fSL https://www.openonload.org/download/openonload-${ONLOAD_VERSION}.tgz -o /tmp/openonload-${ONLOAD_VERSION}.tgz \\\n    && echo \"${ONLOAD_MD5SUM} openonload-${ONLOAD_VERSION}.tgz\" | md5sum --check \\\n    && tar -zxf openonload-${ONLOAD_VERSION}.tgz \\\n    && cd /tmp/openonload-${ONLOAD_VERSION} \\\n    && if [ -n ${ONLOAD_DISABLE_SYSCALL_HOOK} ] ; then \\\n        echo 'ONLOAD_DISABLE_SYSCALL_HOOK set, disabling CI_CFG_USERSPACE_SYSCALL' \\\n        && sed -i 's/#define CI_CFG_USERSPACE_SYSCALL        1/#define CI_CFG_USERSPACE_SYSCALL        0 \\/\\/ disabled by ONLOAD_DISABLE_SYSCALL_HOOK/' ./src/include/ci/internal/transport_config_opt.h ; \\\n    fi \\\n    && if [ -n ${ONLOAD_USERSPACE_ID} ] ; then \\\n        echo \"ONLOAD_USERSPACE_ID set, applying userspace interface id '${ONLOAD_USERSPACE_ID}'\" \\\n        && sed -i \"s/\\$\\$md5/${ONLOAD_USERSPACE_ID}/\" src/lib/transport/ip/mmake.mk ; \\\n\n    fi \\\n    && cd scripts \\\n    && ./onload_build --user \\\n    && ./onload_install --userfiles --nobuild \\\n    && cd /tmp \\\n    && rm -rf openonload-${ONLOAD_VERSION}.tgz openonload-${ONLOAD_VERSION} \\\n    && if [ -z ${ONLOAD_WITHZF} ] ; then \\\n        rm -rf /usr/include/zf /usr/bin/zf_stackdump /usr/bin/zf_debug /usr/lib/x86_64-linux-gnu/zf /usr/lib/x86_64-linux-gnu/libonload_zf* ; \\\n    fi \\\n    && DEBIAN_FRONTEND=noninteractive apt-get remove -y --purge \\\n        curl \\\n        patch \\\n    && DEBIAN_FRONTEND=noninteractive apt-get autoremove -y && rm -rf /var/lib/apt/lists/*;\n\n# TODO: which apt packages can we remove?\n\n# Labels for introspection\nLABEL maintainer=\"Evan Wies <evan@neomantra.net>\"\nLABEL ONLOAD_DEBIAN_BASE=\"${ONLOAD_DEBIAN_BASE}\"\nLABEL ONLOAD_DEBIAN_TAG=\"${ONLOAD_DEBIAN_TAG}\"\nLABEL ONLOAD_VERSION=\"${ONLOAD_VERSION}\"\nLABEL ONLOAD_MD5SUM=\"${ONLOAD_MD5SUM}\"\nLABEL ONLOAD_WITHZF=\"${ONLOAD_WITHZF}\"\nLABEL ONLOAD_DISABLE_SYSCALL_HOOK=\"${ONLOAD_DISABLE_SYSCALL_HOOK}\"\nLABEL ONLOAD_USERSPACE_ID=\"${ONLOAD_USERSPACE_ID}\"\n"
}