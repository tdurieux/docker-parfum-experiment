{
  "user": "microdc",
  "name": "auto-jenkins",
  "namespace": "microdc",
  "repository_type": "image",
  "status": 1,
  "status_description": "active",
  "description": "",
  "is_private": false,
  "is_automated": false,
  "can_edit": false,
  "star_count": 0,
  "pull_count": 20111,
  "last_updated": "2019-08-26T09:57:34.487613Z",
  "date_registered": "2019-08-09T11:06:37.773128Z",
  "collaborator_count": 0,
  "affiliation": null,
  "hub_user": "microdc",
  "has_starred": false,
  "full_description": "# auto-jenkins\nAutomated Jenkins build with sensible plugins and no setup wizard intended to run CI/CD on Kubernetes\n\nAvailable on [Docker hub](https://hub.docker.com/r/microdc/auto-jenkins/)\n\n  * [auto-jenkins](#auto-jenkins)\n    * [Build](#build)\n    * [Local run example](#local-run-example)\n    * [Generate plugins.txt](#generate-pluginstxt)\n    * [Deploy on Kubernetes](#deploy-on-kubernetes)\n    * [Testing using Minikube](#testing-using-minikube)\n    * [Accessing Jenkins externally](#accessing-jenkins-externally)\n\n##Â Pull\nThe image is built at Dockerhub: https://hub.docker.com/r/microdc/auto-jenkins/\nThis is a public repo so can be launched as microdc/auto-jenkins:<tag>, e.g.\nmicrodc/auto-jenkins:2.6.12\n\n## Build\n\n```\nexport VERSION='local'\ndocker build --rm -t \"microdc/auto-jenkins:${VERSION}\" .\n# OR\n./build.sh\n\n```\n\n## Local run example\nThis is only useful for testing changes to jenkins config. If you want to test kubernetes specific functionality follow the procedure below.  See step 3 below to generate the config files.\n```\ndocker run --rm -p 8080:8080 -p 50000:50000 \\\n                -v \"${PWD}/repos.txt\":/usr/share/jenkins/data/repos.txt \\\n                -v \"${PWD}/ssh_config/config\":/var/jenkins_home/.ssh/config \\\n                -v \"${HOME}/.ssh/id_rsa\":/var/jenkins_home/.ssh/id_rsa \\\n                microdc/auto-jenkins:local\n```\n\n## Generate plugins.txt\nFrom time to time we may need to generate a complete plugins list. This was generated from a container\nfollowing the original jenkins documentation [here](https://github.com/jenkinsci/docker/blob/master/README.md), like so:\n```\nJENKINS_HOST=admin:admin@localhost:8080\ncurl -sSL \"http://$JENKINS_HOST/pluginManager/api/xml?depth=1&xpath=/*/*/shortName|/*/*/version&wrapper=plugins\" | \\\n          perl -pe 's/.*?<shortName>([\\w-]+).*?<version>([^<]+)()(<\\/\\w+>)+/\\1 \\2\\n/g'|sed 's/ /:/' | \\\n          sort\n```\n\n## Deploy on Kubernetes\n1. Run kubectl to create the deployment and Jenkins Namespace. The containers wont run until the config is created below.\n```\nkubectl apply -f https://raw.githubusercontent.com/microdc/auto-jenkins/master/k8s.yaml\n```\n2. Create a config map for the git repos you will use (example file repos.txt)\n```\nkubectl create configmap jenkins-git-repos -n jenkins --from-file=repos.txt\n```\n3. Create Jenkins ssh config and keys secrets in Kubernetes\nSSH keys are for git repos. The public keys generated here will need to be uploaded to your git provider.\n```\nexport DATE=$(date '+%Y-%m-%d')\nmkdir -vp \"${HOME}/.ssh/jenkins\"\nssh-keygen \\\n    -t rsa -b 4096 -C \"Jenkins ${DATE}\" \\\n    -f \"${HOME}/.ssh/jenkins/id_rsa\"\ncat > \"${HOME}/.ssh/jenkins/config\" << EOF\nHost *\n  StrictHostKeyChecking no\n  UserKnownHostsFile /dev/null\nEOF\n```\n4. Add the ssh configuration to Kubernetes\n```\nkubectl create secret generic jenkins-ssh-config -n jenkins \\\n                                                 --from-file=\"${HOME}/.ssh/jenkins/config\" \\\n                                                 --from-file=\"${HOME}/.ssh/jenkins/id_rsa\" \\\n                                                 --from-file=\"${HOME}/.ssh/jenkins/id_rsa.pub\"\n```\n5. Set Jenkins password\n```\nkubectl create secret generic jenkins-admin-creds -n jenkins --from-literal=username=admin --from-literal=password=admin\n```\n\n6. Add additional secrets to jenkins environment variables (key=value)\n```\nkubectl create secret generic jenkins-secret-env-vars -n jenkins --from-file=\"secrets.properties\"\n```\n\n7. Access using the jenkins UI\n`kubectl port-forward service/jenkins 8080 -n jenkins`\n\n## Testing using Minikube\n1. [Install Minikube](https://kubernetes.io/docs/tasks/tools/install-minikube/)\n2. Start Minikube with a decent amount of memory\n```\nminikube start --memory 8192\n```\n3. Point your docker env to the MiniKube docker instance\n```\neval $(minikube docker-env)\n```\n4. Build your image for minikube to use\n```\ndocker build --rm -t \"microdc/auto-jenkins:local\" .\n```\n5. Follow the instruction for 'Deploy on Kubernetes'\n\n**_Minikube tip_**\n_To upload a container you've already built on your laptop to your minikube deploy run the following. This is also means your builds persist across destruction of your minikube cluster_\n`docker save microdc/auto-jenkins:local | (eval $(minikube docker-env) && docker load)`\n\n## Accessing Jenkins externally\nIf you need to access Jenkins externally I recommend you use an [oauth2 proxy](https://github.com/microdc/oauth2-proxy).\nIt's more secure than Jenkins and allows you to utilise the user management features of a 3rd party service like google or github.\nOnce you've chosen how Jenkins will be exposed you will need to set up a service or ingress to allow access. Jenkins should be configured with an external url so that links work etc.\nThis is set when Jenkins starts by a groovy script that looks for the EXTERNAL_URL variable below. We also need to set the hudson.TcpSlaveAgentListener.hostName option to the name jenkins will use internally.\nIf you are following the k8s.yaml config example this will be jenkins as below. If this is not set jenkins wont accept connections on anything other than what you set EXTERNAL_URL to.\n```\n    env:\n      - name: EXTERNAL_URL\n        value: https://jenkins.microdc.example/\n      - name: JAVA_OPTS\n        value: '-Xmx1400m -Dhudson.TcpSlaveAgentListener.hostName=jenkins'\n```\n",
  "permissions": {
    "read": true,
    "write": false,
    "admin": false
  },
  "media_types": [
    "application/vnd.docker.container.image.v1+json"
  ],
  "content_types": [
    "image"
  ]
}