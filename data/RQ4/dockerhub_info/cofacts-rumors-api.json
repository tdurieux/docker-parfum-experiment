{
  "user": "cofacts",
  "name": "rumors-api",
  "namespace": "cofacts",
  "repository_type": "image",
  "status": 1,
  "status_description": "active",
  "description": "Cofacts website API",
  "is_private": false,
  "is_automated": false,
  "can_edit": false,
  "star_count": 0,
  "pull_count": 685,
  "last_updated": "2022-12-12T18:19:47.786565Z",
  "date_registered": "2020-01-27T11:06:52.625198Z",
  "collaborator_count": 0,
  "affiliation": null,
  "hub_user": "cofacts",
  "has_starred": false,
  "full_description": "# rumors-api\n\n[![Build Status](https://travis-ci.org/cofacts/rumors-api.svg?branch=master)](https://travis-ci.org/cofacts/rumors-api) [![Coverage Status](https://coveralls.io/repos/github/cofacts/rumors-api/badge.svg?branch=master)](https://coveralls.io/github/cofacts/rumors-api?branch=master)\n\nGraphQL API server for clients like rumors-site and rumors-line-bot\n\n## Configuration\n\nFor development, copy `.env.sample` to `.env` and make necessary changes.\n\nFor production via [rumors-deploy](http://github.com/cofacts/rumors-deploy), do setups in `docker-compose.yml`.\n\n## Development\n\n### Prerequisite\n\n* Docker & [docker-compose](https://docs.docker.com/compose/install/)\n\n### First-time setup\n\nAfter cloning this repository & cd into project directory, then install the dependencies.\n\n```\n$ git clone --recursive git@github.com:MrOrz/rumors-api.git # --recursive for the submodules\n$ cd rumors-api\n\n# This ensures gRPC binary package are installed under correct platform during development\n$ docker-compose run --rm --entrypoint=\"npm i\" api\n```\n\nIf you want to test OAuth2 authentication, you will need to fill in login credentials in `.env`. Please apply for the keys in Facebook, Twitter and Github respectively.\n\n### Start development servers\n\n```\n$ mkdir esdata # For elasticsearch DB\n$ docker-compose up\n```\n\nThis will:\n\n* rumors-api server on `http://localhost:5000`. It will be re-started when you update anyfile.\n* rumors-site on `http://localhost:3000`. You can populate session cookie by \"logging-in\" using the site\n  (when credentials are in-place in `.env`).\n  However, it cannot do server-side rendering properly because rumors-site container cannot access\n  localhost URLs.\n* Kibana on `http://localhost:6222`.\n* ElasticSearch DB on `http://localhost:62222`.\n* [URL resolver](https://github.com/cofacts/url-resolver) on `http://localhost:4000`\n\nTo stop the servers, just `ctrl-c` and all docker containers will be stopped.\n\n### Populate ElasticSearch with data\n\nAsk a team member to send you `nodes` directory, then run:\n```\n$ docker-compose stop db\n```\nto stop db instance.\n\nput the `nodes` directory right inside the `esdata` directory created in the previous step, then restart the database using:\n\n```\n$ docker-compose start db\n```\n\n### Detached mode & Logs\n\nIf you do not want a console occupied by docker-compose, you may use detached mode:\n\n```\n$ docker-compose up -d\n```\n\nAccess the logs using:\n\n```\n$ docker-compose logs api     # `api' can also be `db', `kibana'.\n$ docker-compose logs -f api  # Tail mode\n```\n\n### About `test/rumors-db`\n\nThis directory is managed by git submodule. Use the following command to update:\n\n```\n$ npm run rumors-db:pull\n```\n\n## Lint\n\n```\n# Please check lint before you pull request\n$ npm run lint\n# Automatically fixes format error\n$ npm run lint:fix\n```\n\n## Test\n\nTo prepare test DB, first start an elastic search server on port 62223:\n\n```\n$ docker run -d -p \"62223:9200\" --name \"rumors-test-db\" docker.elastic.co/elasticsearch/elasticsearch-oss:6.3.2\n# If it says 'The name \"rumors-test-db\" is already in use',\n# Just run:\n$ docker start rumors-test-db\n```\n\nThen run this to start testing:\n\n```\n$ npm t\n```\n\nIf you get \"Elasticsearch ERROR : DELETE http://localhost:62223/replies => socket hang up\", please check if test database is running. It takes some time for elasticsearch to boot.\n\nIf you want to run test on a specific file (ex: `src/xxx/__tests__/ooo.js`), run:\n\n```\n$ npm t -- src/xxx/__tests__/ooo.js\n```\n\n\nWhen you want to update jest snapshot, run:\n\n```\n$ npm t -- -u\n```\n\n## Deploy\n\nBuild docker image. The following are basically the same, but with different docker tags.\n\n```\n$ docker build -t cofacts/rumors-api:latest .\n```\n\nRun the docker image on local machine, then visit `http://localhost:5000`.\n(To test functions involving DB, ElasticSearch DB must work as `.env` specified.)\n\n```\n$ docker run --rm -it -p 5000:5000 --env-file .env cofacts/rumors-api\n```\n\n## Cronjob scripts\n\n### Clean up old `urls` entries that are not referenced by any article & reply\n\nThe `urls` index serves as a cache of URL scrapper and will enlarge as `ListArticle` is invoked with\nURLs. The following script cleans up those `urls` that no article & reply currently uses.\n\n```\n$ docker-compose exec api node_modules/.bin/babel-node src/scripts/cleanupUrls.js\n```\n\n### Fetching user activities from Google Analytics\n-  First make sure the following params are set in `.env`:\n  `GOOGLE_OAUTH_KEY_PATH`,  `GA_WEB_VIEW_ID`, `GA_LINE_VIEW_ID`\n\n-  To fetch stats for the current date, run:\n```\n$ node_modules/.bin/babel-node src/scripts/fetchStatsFromGA.js\n```\n\n-  For more options, run the above script with `--help` or see the file level comments.\n\n### Removing article-reply from database\n-  To set an article-reply to deleted state on production, run:\n```\n$ node build/scripts/removeArticleReply.js --userId=<userId> --articleId=<articleId> --replyId=<replyId>\n```\n\n-  For more options, run the above script with `--help` or see the file level comments.\n\n\n## One-off migration scripts\n\n### Fill in `urls` index and `hyperlinks` field for all articles & replies\n\nFirst, make sure `.env` is configured so that the correct DB is specified.\nThen at project root, run:\n```\n$ node_modules/.bin/babel-node src/scripts/migrations/fillAllHyperlinks.js\n```\n\nThis script would scan for all articles & replies to fill in their `hyperlinks` field, also populates\n`urls` index. The `urls` index is used as cache. If an URL already exists in `urls`, it will not trigger\nHTTP request.\n\n\n### Generate User instances for backend users\n\nFirst, make sure `.env` is configured so that the correct DB is specified, you might want to create a snapshot before running the script.\nThen at project root, run:\n```\n$ node_modules/.bin/babel-node src/scripts/migrations/createBackendUsers.js\n```\n\nThis script would scan for all the user references in `analytics`, `articlecategoryfeedbacks`, `articlereplyfeedbacks`,\n`articles`, `replies`, `replyrequests`, create users for those that are not already in db and updates all the docs.\nSee the comments at the top of the script for how users are referenced in each doc.\n\n\n## Troubleshooting\n\n### Failed to load gRPC binary on Mac\n\nIf `rumors-api` server fails to start due to the following error:\n```\nCannot find module '/srv/www/node_modules/grpc/src/node/extension_binary/node-v72-linux-x64-glibc/grpc_node.node'\n```\ntry running:\n```\nnpm rebuild --target_platform=linux --target_arch=x64 --target_libc=glibc --update-binary\n```\n\n## Legal\n\n`LICENSE` defines the license agreement for the source code in this repository.\n\n`LEGAL.md` is the user agreement for Cofacts data users that leverages Cofacts data provided by API or via cofacts/opendata.\n",
  "permissions": {
    "read": true,
    "write": false,
    "admin": false
  },
  "media_types": [
    "application/vnd.docker.container.image.v1+json"
  ],
  "content_types": [
    "image"
  ]
}