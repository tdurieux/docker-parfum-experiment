{
  "startTime": 1674252187516,
  "endTime": 1674252188792,
  "originalSmells": [
    {
      "rule": "curlUseFlagF",
      "position": {
        "lineStart": 75,
        "lineEnd": 75,
        "columnStart": 4,
        "columnEnd": 48
      }
    },
    {
      "rule": "tarSomethingRmTheSomething",
      "position": {
        "lineStart": 61,
        "lineEnd": 61,
        "columnStart": 4,
        "columnEnd": 42
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "ARG CUDA_DOCKER_VERSION=11.2.2-devel-ubuntu20.04\nFROM nvidia/cuda:${CUDA_DOCKER_VERSION}\n\n# Arguments for the build. CUDA_DOCKER_VERSION needs to be repeated because\n# the first usage only applies to the FROM tag.\n# TensorFlow version is tightly coupled to CUDA and cuDNN so it should be selected carefully\nARG CUDA_DOCKER_VERSION=11.2.2-devel-ubuntu18.04\nARG TENSORFLOW_VERSION=2.6.5\nARG PYTORCH_VERSION=1.8.1+cu111\nARG PYTORCH_LIGHTNING_VERSION=1.5.9\nARG TORCHVISION_VERSION=0.9.1+cu111\nARG CUDNN_VERSION=8.1.1.33-1+cuda11.2\nARG NCCL_VERSION=2.8.4-1+cuda11.2\nARG MXNET_VERSION=1.8.0.post0\n\nARG PYSPARK_PACKAGE=pyspark==3.1.1\nARG SPARK_PACKAGE=spark-3.1.1/spark-3.1.1-bin-hadoop2.7.tgz\n\nARG PYTHON_VERSION=3.8\n\n# to avoid interaction with apt-get\nENV DEBIAN_FRONTEND=noninteractive\n\n# Set default shell to /bin/bash\nSHELL [\"/bin/bash\", \"-euo\", \"pipefail\", \"-c\"]\n\n# Extract ubuntu distribution version and download the corresponding key.\n# This is to fix CI failures caused by the new rotating key mechanism rolled out by Nvidia.\n# Refer to https://forums.developer.nvidia.com/t/notice-cuda-linux-repository-key-rotation/212771 for more details.\nRUN DIST=$(echo ${CUDA_DOCKER_VERSION#*ubuntu} | sed 's/\\.//'); \\\n    apt-key adv --fetch-keys https://developer.download.nvidia.com/compute/cuda/repos/ubuntu${DIST}/x86_64/3bf863cc.pub && \\\n    apt-key adv --fetch-keys https://developer.download.nvidia.com/compute/machine-learning/repos/ubuntu${DIST}/x86_64/7fa2af80.pub\n\nRUN apt-get update && apt-get install -y --allow-downgrades --allow-change-held-packages --no-install-recommends \\\n        build-essential \\\n        cmake \\\n        g++-7 \\\n        git \\\n        curl \\\n        vim \\\n        wget \\\n        ca-certificates \\\n        libcudnn8=${CUDNN_VERSION} \\\n        libnccl2=${NCCL_VERSION} \\\n        libnccl-dev=${NCCL_VERSION} \\\n        libjpeg-dev \\\n        libpng-dev \\\n        python${PYTHON_VERSION} \\\n        python${PYTHON_VERSION}-dev \\\n        python${PYTHON_VERSION}-distutils \\\n        librdmacm1 \\\n        libibverbs1 \\\n        ibverbs-providers \\\n        openjdk-8-jdk-headless \\\n        openssh-client \\\n        openssh-server \\\n    && apt-get clean && rm -rf /var/lib/apt/lists/*\n\n# Install Open MPI\nRUN wget --progress=dot:mega -O /tmp/openmpi-3.0.0-bin.tar.gz https://github.com/horovod/horovod/files/1596799/openmpi-3.0.0-bin.tar.gz && \\\n    cd /usr/local && \\\n    tar -zxf /tmp/openmpi-3.0.0-bin.tar.gz && \\\n    ldconfig && \\\n    mpirun --version && rm /tmp/openmpi-3.0.0-bin.tar.gz\n\n# Allow OpenSSH to talk to containers without asking for confirmation\nRUN mkdir -p /var/run/sshd\nRUN cat /etc/ssh/ssh_config | grep -v StrictHostKeyChecking > /etc/ssh/ssh_config.new && \\\n    echo \"    StrictHostKeyChecking no\" >> /etc/ssh/ssh_config.new && \\\n    mv /etc/ssh/ssh_config.new /etc/ssh/ssh_config\n\nRUN ln -s /usr/bin/python${PYTHON_VERSION} /usr/bin/python\n\n# pinning pip to 21.0.0 as 22.0.0 cannot fetch pytorch packages from html linl\n# https://github.com/pytorch/pytorch/issues/72045\nRUN curl -f -O https://bootstrap.pypa.io/get-pip.py && \\\n    python get-pip.py && \\\n    rm get-pip.py && \\\n    pip install --no-cache-dir -U --force pip~=21.0.0\n\n# Install PyTorch, TensorFlow, Keras and MXNet\nRUN pip install --no-cache-dir \\\n    torch==${PYTORCH_VERSION} \\\n    torchvision==${TORCHVISION_VERSION} \\\n    -f https://download.pytorch.org/whl/${PYTORCH_VERSION/*+/}/torch_stable.html\nRUN pip install --no-cache-dir pytorch_lightning==${PYTORCH_LIGHTNING_VERSION}\n\nRUN pip install --no-cache-dir future typing packaging\nRUN pip install --no-cache-dir \\\n    tensorflow==${TENSORFLOW_VERSION} \\\n    keras \\\n    h5py\n\nRUN pip install --no-cache-dir mxnet-cu112==${MXNET_VERSION}\n\n# Install Spark stand-alone cluster.\nRUN wget --progress=dot:giga \"https://www.apache.org/dyn/closer.lua/spark/${SPARK_PACKAGE}?action=download\" -O - | tar -xzC /tmp; \\\n    archive=$(basename \"${SPARK_PACKAGE}\") bash -c \"mv -v /tmp/\\${archive/%.tgz/} /spark\"\n\n# Install PySpark.\nRUN pip install --no-cache-dir ${PYSPARK_PACKAGE}\n\n# Install Horovod, temporarily using CUDA stubs\nWORKDIR /horovod\nCOPY . .\nRUN python setup.py sdist && \\\n    ldconfig /usr/local/cuda/targets/x86_64-linux/lib/stubs && \\\n    bash -c \"HOROVOD_GPU_OPERATIONS=NCCL HOROVOD_WITH_TENSORFLOW=1 HOROVOD_WITH_PYTORCH=1 HOROVOD_WITH_MXNET=1 pip install --no-cache-dir -v $(ls /horovod/dist/horovod-*.tar.gz)[spark,ray]\" && \\\n    horovodrun --check-build && \\\n    ldconfig\n\n# Check all frameworks are working correctly. Use CUDA stubs to ensure CUDA libs can be found correctly\n# when running on CPU machine\nWORKDIR \"/horovod/examples\"\nRUN ldconfig /usr/local/cuda/targets/x86_64-linux/lib/stubs && \\\n    python -c \"import horovod.tensorflow as hvd; hvd.init()\" && \\\n    python -c \"import horovod.torch as hvd; hvd.init()\" && \\\n    python -c \"import horovod.mxnet as hvd; hvd.init()\" && \\\n    ldconfig\n"
}