{
  "startTime": 1674255706348,
  "endTime": 1674255707713,
  "originalSmells": [
    {
      "rule": "curlUseFlagF",
      "position": {
        "lineStart": 60,
        "lineEnd": 60,
        "columnStart": 4,
        "columnEnd": 78
      }
    },
    {
      "rule": "curlUseFlagF",
      "position": {
        "lineStart": 83,
        "lineEnd": 83,
        "columnStart": 4,
        "columnEnd": 79
      }
    },
    {
      "rule": "curlUseFlagF",
      "position": {
        "lineStart": 104,
        "lineEnd": 104,
        "columnStart": 4,
        "columnEnd": 75
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "# Dockerfile for ELK stack\n# Elasticsearch, Logstash, Kibana 8.1.0\n\n# Build with:\n# docker build -t <repo-user>/elk .\n\n# Run with:\n# docker run -p 5601:5601 -p 9200:9200 -p 5044:5044 -it --name elk <repo-user>/elk\n\n# replace with master-arm64 for ARM64\nARG IMAGE=focal-1.1.0\n\nFROM phusion/baseimage:${IMAGE}\nMAINTAINER Sebastien Pujadas http://pujadas.net\nENV \\\n REFRESHED_AT=2020-06-20\n\n\n###############################################################################\n#                                INSTALLATION\n###############################################################################\n\n### install prerequisites (cURL, gosu, tzdata, JDK for Logstash)\n\nRUN set -x \\\n && apt update -qq \\\n && apt install -qqy --no-install-recommends ca-certificates curl gosu tzdata openjdk-11-jdk-headless \\\n && apt clean \\\n && rm -rf /var/lib/apt/lists/* \\\n && gosu nobody true \\\n && set +x\n\n\n### set current package version\n\nARG ELK_VERSION=8.1.0\n\n# base version (i.e. remove OSS prefix) for Elasticsearch and Kibana (no OSS version since 7.11.0)\nARG ELK_BASE_VERSION=8.1.0\n\n# replace with aarch64 for ARM64 systems\nARG ARCH=x86_64\n\n\n### install Elasticsearch\n\n# predefine env vars, as you can't define an env var that references another one in the same block\nENV \\\n ES_VERSION=${ELK_BASE_VERSION} \\\n ES_HOME=/opt/elasticsearch\n\nENV \\\n ES_PACKAGE=elasticsearch-${ES_VERSION}-linux-${ARCH}.tar.gz \\\n ES_GID=991 \\\n ES_UID=991 \\\n ES_PATH_CONF=/etc/elasticsearch \\\n ES_PATH_BACKUP=/var/backups\n\nRUN DEBIAN_FRONTEND=noninteractive \\\n && mkdir ${ES_HOME} \\\n && curl -f -O https://artifacts.elastic.co/downloads/elasticsearch/${ES_PACKAGE} \\\n && tar xzf ${ES_PACKAGE} -C ${ES_HOME} --strip-components=1 \\\n && rm -f ${ES_PACKAGE} \\\n && groupadd -r elasticsearch -g ${ES_GID} \\\n && useradd -r -s /usr/sbin/nologin -M -d ${ES_HOME} -c \"Elasticsearch service user\" -u ${ES_UID} -g elasticsearch elasticsearch \\\n && mkdir -p /var/log/elasticsearch ${ES_PATH_CONF} ${ES_PATH_CONF}/scripts ${ES_PATH_CONF}/jvm.options.d /var/lib/elasticsearch ${ES_PATH_BACKUP} \\\n && chown -R elasticsearch:elasticsearch ${ES_HOME} /var/log/elasticsearch /var/lib/elasticsearch ${ES_PATH_CONF} ${ES_PATH_BACKUP}\n\n\n### install Logstash\n\nENV \\\n LOGSTASH_VERSION=${ELK_VERSION} \\\n LOGSTASH_HOME=/opt/logstash\n\nENV \\\n LOGSTASH_PACKAGE=logstash-${LOGSTASH_VERSION}-linux-${ARCH}.tar.gz \\\n LOGSTASH_GID=992 \\\n LOGSTASH_UID=992 \\\n LOGSTASH_PATH_CONF=/etc/logstash \\\n LOGSTASH_PATH_SETTINGS=${LOGSTASH_HOME}/config\n\nRUN mkdir ${LOGSTASH_HOME} \\\n && curl -f -O https://artifacts.elastic.co/downloads/logstash/${LOGSTASH_PACKAGE} \\\n && tar xzf ${LOGSTASH_PACKAGE} -C ${LOGSTASH_HOME} --strip-components=1 \\\n && rm -f ${LOGSTASH_PACKAGE} \\\n && groupadd -r logstash -g ${LOGSTASH_GID} \\\n && useradd -r -s /usr/sbin/nologin -M -d ${LOGSTASH_HOME} -c \"Logstash service user\" -u ${LOGSTASH_UID} -g logstash logstash \\\n && mkdir -p /var/log/logstash ${LOGSTASH_PATH_CONF}/conf.d \\\n && chown -R logstash:logstash ${LOGSTASH_HOME} /var/log/logstash ${LOGSTASH_PATH_CONF}\n\n\n### install Kibana\n\nENV \\\n KIBANA_VERSION=${ELK_BASE_VERSION} \\\n KIBANA_HOME=/opt/kibana\n\nENV \\\n KIBANA_PACKAGE=kibana-${KIBANA_VERSION}-linux-${ARCH}.tar.gz \\\n KIBANA_GID=993 \\\n KIBANA_UID=993\n\nRUN mkdir ${KIBANA_HOME} \\\n && curl -f -O https://artifacts.elastic.co/downloads/kibana/${KIBANA_PACKAGE} \\\n && tar xzf ${KIBANA_PACKAGE} -C ${KIBANA_HOME} --strip-components=1 \\\n && rm -f ${KIBANA_PACKAGE} \\\n && groupadd -r kibana -g ${KIBANA_GID} \\\n && useradd -r -s /usr/sbin/nologin -d ${KIBANA_HOME} -c \"Kibana service user\" -u ${KIBANA_UID} -g kibana kibana \\\n && mkdir -p /var/log/kibana \\\n && chown -R kibana:kibana ${KIBANA_HOME} /var/log/kibana\n\n\n###############################################################################\n#                              START-UP SCRIPTS\n###############################################################################\n\n### Elasticsearch\n\nADD ./elasticsearch-init /etc/init.d/elasticsearch\nRUN sed -i -e 's#^ES_HOME=$#ES_HOME='$ES_HOME'#' /etc/init.d/elasticsearch \\\n && chmod +x /etc/init.d/elasticsearch\n\n\n### Logstash\n\nADD ./logstash-init /etc/init.d/logstash\nRUN sed -i -e 's#^LS_HOME=$#LS_HOME='$LOGSTASH_HOME'#' /etc/init.d/logstash \\\n && chmod +x /etc/init.d/logstash\n\n\n### Kibana\n\nADD ./kibana-init /etc/init.d/kibana\nRUN sed -i -e 's#^KIBANA_HOME=$#KIBANA_HOME='$KIBANA_HOME'#' /etc/init.d/kibana \\\n && chmod +x /etc/init.d/kibana\n\n\n###############################################################################\n#                               CONFIGURATION\n###############################################################################\n\n### configure Elasticsearch\n\nADD ./elasticsearch.yml ${ES_PATH_CONF}/elasticsearch.yml\nADD ./elasticsearch-default /etc/default/elasticsearch\nRUN cp ${ES_HOME}/config/log4j2.properties ${ES_HOME}/config/jvm.options \\\n    ${ES_PATH_CONF} \\\n && chown -R elasticsearch:elasticsearch ${ES_PATH_CONF} \\\n && chmod -R +r ${ES_PATH_CONF}\n\n\n### configure Logstash\n\n# certs/keys for Beats and Lumberjack input\nRUN mkdir -p /etc/pki/tls/{certs,private}\nADD ./logstash-beats.crt /etc/pki/tls/certs/logstash-beats.crt\nADD ./logstash-beats.key /etc/pki/tls/private/logstash-beats.key\n\n# pipelines\nADD pipelines.yml ${LOGSTASH_PATH_SETTINGS}/pipelines.yml\n\n# filters\nADD ./logstash-conf/*.conf ${LOGSTASH_PATH_CONF}/conf.d/\n\n# patterns\nADD ./nginx.pattern ${LOGSTASH_HOME}/patterns/nginx\nRUN chown -R logstash:logstash ${LOGSTASH_HOME}/patterns\n\n# Fix permissions\nRUN chmod -R +r ${LOGSTASH_PATH_CONF} ${LOGSTASH_PATH_SETTINGS} \\\n && chown -R logstash:logstash ${LOGSTASH_PATH_SETTINGS}\n\n\n### configure logrotate\n\nADD ./elasticsearch-logrotate /etc/logrotate.d/elasticsearch\nADD ./logstash-logrotate /etc/logrotate.d/logstash\nADD ./kibana-logrotate /etc/logrotate.d/kibana\nRUN chmod 644 /etc/logrotate.d/elasticsearch \\\n && chmod 644 /etc/logrotate.d/logstash \\\n && chmod 644 /etc/logrotate.d/kibana\n\n\n### configure Kibana\n\nADD ./kibana.yml ${KIBANA_HOME}/config/kibana.yml\n\n\n###############################################################################\n#                                   START\n###############################################################################\n\nADD ./start.sh /usr/local/bin/start.sh\nRUN chmod +x /usr/local/bin/start.sh\n\nEXPOSE 5601 9200 9300 9600 5044\nVOLUME /var/lib/elasticsearch\n\nCMD [ \"/usr/local/bin/start.sh\" ]\n"
}