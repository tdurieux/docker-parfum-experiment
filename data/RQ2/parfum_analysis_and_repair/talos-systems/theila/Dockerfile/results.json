{
  "startTime": 1674221055049,
  "endTime": 1674221056417,
  "originalSmells": [
    {
      "rule": "npmCacheCleanAfterInstall",
      "position": {
        "lineStart": 24,
        "lineEnd": 24,
        "columnStart": 4,
        "columnEnd": 36
      }
    },
    {
      "rule": "npmCacheCleanAfterInstall",
      "position": {
        "lineStart": 25,
        "lineEnd": 25,
        "columnStart": 4,
        "columnEnd": 34
      }
    },
    {
      "rule": "npmCacheCleanAfterInstall",
      "position": {
        "lineStart": 74,
        "lineEnd": 74,
        "columnStart": 4,
        "columnEnd": 51
      }
    },
    {
      "rule": "npmCacheCleanAfterInstall",
      "position": {
        "lineStart": 81,
        "lineEnd": 81,
        "columnStart": 48,
        "columnEnd": 59
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "# THIS FILE WAS AUTOMATICALLY GENERATED, PLEASE DO NOT EDIT.\n#\n# Generated on 2022-03-24T12:29:51Z by kres latest.\n\nARG JS_TOOLCHAIN\nARG TOOLCHAIN\n\nFROM ghcr.io/siderolabs/ca-certificates:v1.0.0 AS image-ca-certificates\n\nFROM ghcr.io/siderolabs/fhs:v1.0.0 AS image-fhs\n\n# base toolchain image\nFROM ${JS_TOOLCHAIN} AS js-toolchain\nCOPY --from=golang:1.17-alpine /usr/local/go /usr/local/go\nRUN apk --update --no-cache add bash curl protoc protobuf-dev\nCOPY ./go.mod .\nCOPY ./go.sum .\nENV GOPATH /go\nENV PATH ${PATH}:/usr/local/go/bin\n\n# runs markdownlint\nFROM node:14.8.0-alpine AS lint-markdown\nRUN npm i -g markdownlint-cli@0.23.2 && npm cache clean --force;\nRUN npm i sentences-per-line@0.2.1 && npm cache clean --force;\nWORKDIR /src\nCOPY .markdownlint.json .\nCOPY ./docs ./docs\nCOPY ./CHANGELOG.md ./CHANGELOG.md\nCOPY ./CONTRIBUTING.md ./CONTRIBUTING.md\nCOPY ./README.md ./README.md\nRUN markdownlint --ignore \"CHANGELOG.md\" --ignore \"**/node_modules/**\" --ignore '**/hack/chglog/**' --rules /node_modules/sentences-per-line/index.js .\n\n# collects proto specs\nFROM scratch AS proto-specs\nADD api/socket/message.proto /api/socket/message/\nADD api/common/theila.proto /api/common/\nADD api/rpc/resource.proto /api/rpc/\nADD api/rpc/context.proto /api/rpc/\nADD api/rpc/management.proto /api/rpc/\nADD https://raw.githubusercontent.com/googleapis/googleapis/master/google/rpc/status.proto /api/google/rpc/\nADD https://raw.githubusercontent.com/siderolabs/talos/master/api/common/common.proto /api/common/\nADD https://raw.githubusercontent.com/siderolabs/talos/master/api/resource/resource.proto /api/talos/resource/\nADD https://raw.githubusercontent.com/siderolabs/talos/master/api/machine/machine.proto /api/talos/machine/\nADD https://raw.githubusercontent.com/cosi-project/runtime/master/api/v1alpha1/state.proto /api/v1alpha1/\nADD https://raw.githubusercontent.com/cosi-project/runtime/master/api/v1alpha1/resource.proto /api/v1alpha1/\n\n# collects proto specs\nFROM scratch AS proto-specs-frontend\nADD api/common/theila.proto /frontend/src/api/common/\nADD api/socket/message.proto /frontend/src/api/socket/\nADD api/rpc/resource.proto /frontend/src/api/rpc/\nADD api/rpc/context.proto /frontend/src/api/rpc/\nADD api/rpc/management.proto /frontend/src/api/rpc/\nADD https://raw.githubusercontent.com/googleapis/googleapis/master/google/rpc/status.proto /frontend/src/api/google/rpc/\nADD https://raw.githubusercontent.com/siderolabs/talos/master/api/resource/resource.proto /frontend/src/api/talos/resource/\nADD https://raw.githubusercontent.com/siderolabs/talos/master/api/machine/machine.proto /frontend/src/api/talos/machine/\nADD https://raw.githubusercontent.com/protocolbuffers/protobuf/master/src/google/protobuf/any.proto /frontend/src/api/google/protobuf/\nADD https://raw.githubusercontent.com/protocolbuffers/protobuf/master/src/google/protobuf/duration.proto /frontend/src/api/google/protobuf/\nADD https://raw.githubusercontent.com/protocolbuffers/protobuf/master/src/google/protobuf/empty.proto /frontend/src/api/google/protobuf/\nADD https://raw.githubusercontent.com/protocolbuffers/protobuf/master/src/google/protobuf/timestamp.proto /frontend/src/api/google/protobuf/\nADD https://raw.githubusercontent.com/googleapis/googleapis/master/google/rpc/code.proto /frontend/src/api/google/rpc/\nADD https://raw.githubusercontent.com/siderolabs/talos/master/api/common/common.proto /frontend/src/api/common/\nADD https://raw.githubusercontent.com/cosi-project/runtime/master/api/v1alpha1/resource.proto /frontend/src/api/v1alpha1/\n\n# base toolchain image\nFROM ${TOOLCHAIN} AS toolchain\nRUN apk --update --no-cache add bash curl build-base protoc protobuf-dev\n\n# tools and sources\nFROM js-toolchain AS js\nWORKDIR /src\nARG PROTOBUF_TS_VERSION\nRUN npm install -g ts-proto@^${PROTOBUF_TS_VERSION} && npm cache clean --force;\nARG PROTOBUF_GRPC_GATEWAY_TS_VERSION\nRUN go install github.com/grpc-ecosystem/protoc-gen-grpc-gateway-ts@v${PROTOBUF_GRPC_GATEWAY_TS_VERSION}\nRUN mv /go/bin/protoc-gen-grpc-gateway-ts /bin\nCOPY frontend/package.json ./\nCOPY frontend/package-lock.json ./\nRUN --mount=type=cache,target=/src/node_modules npm version ${VERSION}\nRUN --mount=type=cache,target=/src/node_modules npm install && npm cache clean --force;\nCOPY .eslintrc.yaml ./\nCOPY frontend/babel.config.js ./\nCOPY frontend/jest.config.js ./\nCOPY frontend/tsconfig.json ./\nCOPY ./frontend/src ./src\nCOPY ./frontend/tests ./tests\nCOPY ./frontend/public ./public\nCOPY ./frontend/babel.config.js ./babel.config.js\nCOPY ./frontend/jest.config.js ./jest.config.js\nCOPY ./frontend/postcss.config.js ./postcss.config.js\nCOPY ./frontend/tailwind.config.js ./tailwind.config.js\nCOPY ./frontend/vue.config.js ./vue.config.js\n\n# build tools\nFROM toolchain AS tools\nENV GO111MODULE on\nENV CGO_ENABLED 0\nENV GOPATH /go\nRUN curl -sfL https://install.goreleaser.com/github.com/golangci/golangci-lint.sh | bash -s -- -b /bin v1.42.1\nARG GOFUMPT_VERSION\nRUN go install mvdan.cc/gofumpt/gofumports@${GOFUMPT_VERSION} \\\n\t&& mv /go/bin/gofumports /bin/gofumports\nARG PROTOBUF_GO_VERSION\nRUN go install google.golang.org/protobuf/cmd/protoc-gen-go@v${PROTOBUF_GO_VERSION}\nRUN mv /go/bin/protoc-gen-go /bin\nARG GRPC_GO_VERSION\nRUN go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v${GRPC_GO_VERSION}\nRUN mv /go/bin/protoc-gen-go-grpc /bin\nARG GRPC_GATEWAY_VERSION\nRUN go install github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-grpc-gateway@v${GRPC_GATEWAY_VERSION}\nRUN mv /go/bin/protoc-gen-grpc-gateway /bin\n\n# builds frontend\nFROM js AS frontend\nRUN --mount=type=cache,target=/src/node_modules npm run build\nRUN mkdir -p /internal/frontend/dist\nRUN cp -rf ./dist/* /internal/frontend/dist\n\n# runs eslint\nFROM js AS lint-eslint\nRUN --mount=type=cache,target=/src/node_modules npm run lint\n\n# runs protobuf compiler\nFROM js AS proto-compile-frontend\nCOPY --from=proto-specs-frontend / /\nRUN protoc -I/frontend/src/api --grpc-gateway-ts_out=source_relative:/frontend/src/api --plugin=/root/.npm-global/.bin/protoc-gen-ts_proto.cmd --ts_proto_out=paths=source_relative:/frontend/src/api --ts_proto_opt=returnObservable=false --ts_proto_opt=outputClientImpl=false --ts_proto_opt=snakeToCamel=false /frontend/src/api/common/theila.proto\nRUN protoc -I/frontend/src/api --plugin=/root/.npm-global/.bin/protoc-gen-ts_proto.cmd --ts_proto_out=paths=source_relative:/frontend/src/api --ts_proto_opt=returnObservable=false --ts_proto_opt=outputClientImpl=false --ts_proto_opt=snakeToCamel=false /frontend/src/api/socket/message.proto\nRUN protoc -I/frontend/src/api --grpc-gateway-ts_out=source_relative:/frontend/src/api --plugin=/root/.npm-global/.bin/protoc-gen-ts_proto.cmd --ts_proto_out=paths=source_relative:/frontend/src/api --ts_proto_opt=returnObservable=false --ts_proto_opt=outputClientImpl=false --ts_proto_opt=snakeToCamel=false /frontend/src/api/rpc/resource.proto\nRUN protoc -I/frontend/src/api --grpc-gateway-ts_out=source_relative:/frontend/src/api --plugin=/root/.npm-global/.bin/protoc-gen-ts_proto.cmd --ts_proto_out=paths=source_relative:/frontend/src/api --ts_proto_opt=returnObservable=false --ts_proto_opt=outputClientImpl=false --ts_proto_opt=snakeToCamel=false /frontend/src/api/rpc/context.proto\nRUN protoc -I/frontend/src/api --grpc-gateway-ts_out=source_relative:/frontend/src/api --plugin=/root/.npm-global/.bin/protoc-gen-ts_proto.cmd --ts_proto_out=paths=source_relative:/frontend/src/api --ts_proto_opt=returnObservable=false --ts_proto_opt=outputClientImpl=false --ts_proto_opt=snakeToCamel=false /frontend/src/api/rpc/management.proto\nRUN protoc -I/frontend/src/api --grpc-gateway-ts_out=source_relative:/frontend/src/api --plugin=/root/.npm-global/.bin/protoc-gen-ts_proto.cmd --ts_proto_out=paths=source_relative:/frontend/src/api --ts_proto_opt=returnObservable=false --ts_proto_opt=outputClientImpl=false --ts_proto_opt=snakeToCamel=false /frontend/src/api/google/rpc/status.proto\nRUN protoc -I/frontend/src/api --grpc-gateway-ts_out=source_relative:/frontend/src/api --plugin=/root/.npm-global/.bin/protoc-gen-ts_proto.cmd --ts_proto_out=paths=source_relative:/frontend/src/api --ts_proto_opt=returnObservable=false --ts_proto_opt=outputClientImpl=false --ts_proto_opt=snakeToCamel=false /frontend/src/api/talos/resource/resource.proto\nRUN protoc -I/frontend/src/api --grpc-gateway-ts_out=source_relative:/frontend/src/api --plugin=/root/.npm-global/.bin/protoc-gen-ts_proto.cmd --ts_proto_out=paths=source_relative:/frontend/src/api --ts_proto_opt=returnObservable=false --ts_proto_opt=outputClientImpl=false --ts_proto_opt=snakeToCamel=false /frontend/src/api/talos/machine/machine.proto\nRUN protoc -I/frontend/src/api --grpc-gateway-ts_out=source_relative:/frontend/src/api --plugin=/root/.npm-global/.bin/protoc-gen-ts_proto.cmd --ts_proto_out=paths=source_relative:/frontend/src/api --ts_proto_opt=returnObservable=false --ts_proto_opt=outputClientImpl=false --ts_proto_opt=snakeToCamel=false /frontend/src/api/google/protobuf/any.proto\nRUN protoc -I/frontend/src/api --grpc-gateway-ts_out=source_relative:/frontend/src/api --plugin=/root/.npm-global/.bin/protoc-gen-ts_proto.cmd --ts_proto_out=paths=source_relative:/frontend/src/api --ts_proto_opt=returnObservable=false --ts_proto_opt=outputClientImpl=false --ts_proto_opt=snakeToCamel=false /frontend/src/api/google/protobuf/duration.proto\nRUN protoc -I/frontend/src/api --grpc-gateway-ts_out=source_relative:/frontend/src/api --plugin=/root/.npm-global/.bin/protoc-gen-ts_proto.cmd --ts_proto_out=paths=source_relative:/frontend/src/api --ts_proto_opt=returnObservable=false --ts_proto_opt=outputClientImpl=false --ts_proto_opt=snakeToCamel=false /frontend/src/api/google/protobuf/empty.proto\nRUN protoc -I/frontend/src/api --grpc-gateway-ts_out=source_relative:/frontend/src/api --plugin=/root/.npm-global/.bin/protoc-gen-ts_proto.cmd --ts_proto_out=paths=source_relative:/frontend/src/api --ts_proto_opt=returnObservable=false --ts_proto_opt=outputClientImpl=false --ts_proto_opt=snakeToCamel=false /frontend/src/api/google/protobuf/timestamp.proto\nRUN protoc -I/frontend/src/api --grpc-gateway-ts_out=source_relative:/frontend/src/api --plugin=/root/.npm-global/.bin/protoc-gen-ts_proto.cmd --ts_proto_out=paths=source_relative:/frontend/src/api --ts_proto_opt=returnObservable=false --ts_proto_opt=outputClientImpl=false --ts_proto_opt=snakeToCamel=false /frontend/src/api/google/rpc/code.proto\nRUN protoc -I/frontend/src/api --grpc-gateway-ts_out=source_relative:/frontend/src/api --plugin=/root/.npm-global/.bin/protoc-gen-ts_proto.cmd --ts_proto_out=paths=source_relative:/frontend/src/api --ts_proto_opt=returnObservable=false --ts_proto_opt=outputClientImpl=false --ts_proto_opt=snakeToCamel=false /frontend/src/api/common/common.proto\nRUN protoc -I/frontend/src/api --grpc-gateway-ts_out=source_relative:/frontend/src/api --plugin=/root/.npm-global/.bin/protoc-gen-ts_proto.cmd --ts_proto_out=paths=source_relative:/frontend/src/api --ts_proto_opt=returnObservable=false --ts_proto_opt=outputClientImpl=false --ts_proto_opt=snakeToCamel=false /frontend/src/api/v1alpha1/resource.proto\nRUN rm /frontend/src/api/common/theila.proto\nRUN rm /frontend/src/api/socket/message.proto\nRUN rm /frontend/src/api/rpc/resource.proto\nRUN rm /frontend/src/api/rpc/context.proto\nRUN rm /frontend/src/api/rpc/management.proto\n\n# runs js unit-tests\nFROM js AS unit-tests-frontend\nRUN --mount=type=cache,target=/src/node_modules CI=true npm run test\n\n# runs protobuf compiler\nFROM tools AS proto-compile\nCOPY --from=proto-specs / /\nRUN protoc -I/api --go_out=paths=source_relative:/api --go-grpc_out=paths=source_relative:/api /api/socket/message/message.proto\nRUN protoc -I/api --go_out=paths=source_relative:/api --go-grpc_out=paths=source_relative:/api /api/common/theila.proto\nRUN protoc -I/api --grpc-gateway_out=paths=source_relative:/api --grpc-gateway_opt=generate_unbound_methods=true --go_out=paths=source_relative:/api --go-grpc_out=paths=source_relative:/api /api/rpc/resource.proto\nRUN protoc -I/api --grpc-gateway_out=paths=source_relative:/api --grpc-gateway_opt=generate_unbound_methods=true --go_out=paths=source_relative:/api --go-grpc_out=paths=source_relative:/api /api/rpc/context.proto\nRUN protoc -I/api --grpc-gateway_out=paths=source_relative:/api --grpc-gateway_opt=generate_unbound_methods=true --go_out=paths=source_relative:/api --go-grpc_out=paths=source_relative:/api /api/rpc/management.proto\nRUN protoc -I/api --grpc-gateway_out=paths=source_relative:/api --grpc-gateway_opt=generate_unbound_methods=true --grpc-gateway_opt=standalone=true /api/google/rpc/status.proto\nRUN protoc -I/api --grpc-gateway_out=paths=source_relative:/api --grpc-gateway_opt=generate_unbound_methods=true --grpc-gateway_opt=standalone=true /api/common/common.proto\nRUN protoc -I/api --grpc-gateway_out=paths=source_relative:/api --grpc-gateway_opt=generate_unbound_methods=true --grpc-gateway_opt=standalone=true /api/talos/resource/resource.proto\nRUN protoc -I/api --grpc-gateway_out=paths=source_relative:/api --grpc-gateway_opt=generate_unbound_methods=true --grpc-gateway_opt=standalone=true /api/talos/machine/machine.proto\nRUN protoc -I/api --grpc-gateway_out=paths=source_relative:/api --grpc-gateway_opt=generate_unbound_methods=true --grpc-gateway_opt=standalone=true /api/v1alpha1/state.proto\nRUN protoc -I/api --grpc-gateway_out=paths=source_relative:/api --grpc-gateway_opt=generate_unbound_methods=true --grpc-gateway_opt=standalone=true /api/v1alpha1/resource.proto\nRUN rm /api/socket/message/message.proto\nRUN rm /api/common/theila.proto\nRUN rm /api/rpc/resource.proto\nRUN rm /api/rpc/context.proto\nRUN rm /api/rpc/management.proto\n\n# tools and sources\nFROM tools AS base\nWORKDIR /src\nCOPY ./go.mod .\nCOPY ./go.sum .\nRUN --mount=type=cache,target=/go/pkg go mod download\nRUN --mount=type=cache,target=/go/pkg go mod verify\nCOPY ./api ./api\nCOPY ./cmd ./cmd\nCOPY ./internal ./internal\nCOPY --from=frontend /internal/frontend/dist ./internal/frontend/dist\nRUN --mount=type=cache,target=/go/pkg go list -mod=readonly all >/dev/null\n\n# cleaned up specs and compiled versions\nFROM scratch AS generate-frontend\nCOPY --from=proto-compile-frontend frontend/ frontend/\n\n# cleaned up specs and compiled versions\nFROM scratch AS generate\nCOPY --from=proto-compile /api/ /api/\n\n# runs gofumpt\nFROM base AS lint-gofumpt\nRUN find . -name '*.pb.go' | xargs -r rm\nRUN find . -name '*.pb.gw.go' | xargs -r rm\nRUN FILES=\"$(gofumports -l -local github.com/siderolabs/theila .)\" && test -z \"${FILES}\" || (echo -e \"Source code is not formatted with 'gofumports -w -local github.com/siderolabs/theila .':\\n${FILES}\"; exit 1)\n\n# runs golangci-lint\nFROM base AS lint-golangci-lint\nCOPY .golangci.yml .\nENV GOGC 50\nRUN --mount=type=cache,target=/root/.cache/go-build --mount=type=cache,target=/root/.cache/golangci-lint --mount=type=cache,target=/go/pkg golangci-lint run --config .golangci.yml\n\n# runs unit-tests with race detector\nFROM base AS unit-tests-race\nARG TESTPKGS\nRUN --mount=type=cache,target=/root/.cache/go-build --mount=type=cache,target=/go/pkg --mount=type=cache,target=/tmp CGO_ENABLED=1 go test -v -race -count 1 ${TESTPKGS}\n\n# runs unit-tests\nFROM base AS unit-tests-run\nARG TESTPKGS\nRUN --mount=type=cache,target=/root/.cache/go-build --mount=type=cache,target=/go/pkg --mount=type=cache,target=/tmp go test -v -covermode=atomic -coverprofile=coverage.txt -coverpkg=${TESTPKGS} -count 1 ${TESTPKGS}\n\n# builds theila-darwin-amd64\nFROM base AS theila-darwin-amd64-build\nCOPY --from=generate / /\nWORKDIR /src/cmd/theila\nRUN --mount=type=cache,target=/root/.cache/go-build --mount=type=cache,target=/go/pkg GOARCH=amd64 GOOS=darwin go build -ldflags \"-s -w\" -o /theila-darwin-amd64\n\n# builds theila-darwin-arm64\nFROM base AS theila-darwin-arm64-build\nCOPY --from=generate / /\nWORKDIR /src/cmd/theila\nRUN --mount=type=cache,target=/root/.cache/go-build --mount=type=cache,target=/go/pkg GOARCH=arm64 GOOS=darwin go build -ldflags \"-s -w\" -o /theila-darwin-arm64\n\n# builds theila-linux-amd64\nFROM base AS theila-linux-amd64-build\nCOPY --from=generate / /\nWORKDIR /src/cmd/theila\nRUN --mount=type=cache,target=/root/.cache/go-build --mount=type=cache,target=/go/pkg GOARCH=amd64 GOOS=linux go build -ldflags \"-s -w\" -o /theila-linux-amd64\n\n# builds theila-linux-arm64\nFROM base AS theila-linux-arm64-build\nCOPY --from=generate / /\nWORKDIR /src/cmd/theila\nRUN --mount=type=cache,target=/root/.cache/go-build --mount=type=cache,target=/go/pkg GOARCH=arm64 GOOS=linux go build -ldflags \"-s -w\" -o /theila-linux-arm64\n\n# builds theila-linux-armv7\nFROM base AS theila-linux-armv7-build\nCOPY --from=generate / /\nWORKDIR /src/cmd/theila\nRUN --mount=type=cache,target=/root/.cache/go-build --mount=type=cache,target=/go/pkg GOARCH=arm GOARM=7 GOOS=linux go build -ldflags \"-s -w\" -o /theila-linux-armv7\n\n# builds theila-windows-amd64.exe\nFROM base AS theila-windows-amd64.exe-build\nCOPY --from=generate / /\nWORKDIR /src/cmd/theila\nRUN --mount=type=cache,target=/root/.cache/go-build --mount=type=cache,target=/go/pkg GOARCH=amd64 GOOS=windows go build -ldflags \"-s -w\" -o /theila-windows-amd64.exe\n\nFROM scratch AS unit-tests\nCOPY --from=unit-tests-run /src/coverage.txt /coverage.txt\n\nFROM scratch AS theila-darwin-amd64\nCOPY --from=theila-darwin-amd64-build /theila-darwin-amd64 /theila-darwin-amd64\n\nFROM scratch AS theila-darwin-arm64\nCOPY --from=theila-darwin-arm64-build /theila-darwin-arm64 /theila-darwin-arm64\n\nFROM scratch AS theila-linux-amd64\nCOPY --from=theila-linux-amd64-build /theila-linux-amd64 /theila-linux-amd64\n\nFROM scratch AS theila-linux-arm64\nCOPY --from=theila-linux-arm64-build /theila-linux-arm64 /theila-linux-arm64\n\nFROM scratch AS theila-linux-armv7\nCOPY --from=theila-linux-armv7-build /theila-linux-armv7 /theila-linux-armv7\n\nFROM scratch AS theila-windows-amd64.exe\nCOPY --from=theila-windows-amd64.exe-build /theila-windows-amd64.exe /theila-windows-amd64.exe\n\nFROM theila-linux-${TARGETARCH} AS theila\n\nFROM scratch AS image-theila\nARG TARGETARCH\nCOPY --from=theila theila-linux-${TARGETARCH} /theila\nCOPY --from=image-fhs / /\nCOPY --from=image-ca-certificates / /\nLABEL org.opencontainers.image.source https://github.com/siderolabs/theila\nENTRYPOINT [\"/theila\"]\n\n"
}