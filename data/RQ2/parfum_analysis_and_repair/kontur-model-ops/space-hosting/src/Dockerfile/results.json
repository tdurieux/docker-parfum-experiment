{
  "startTime": 1674215033535,
  "endTime": 1674215034597,
  "originalSmells": [
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 93,
        "lineEnd": 93,
        "columnStart": 22,
        "columnEnd": 47
      }
    },
    {
      "rule": "ruleAptGetInstallThenRemoveAptLists",
      "position": {
        "lineStart": 93,
        "lineEnd": 93,
        "columnStart": 22,
        "columnEnd": 47
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "#######################################################################################################################\n# Common ARGs\n# https://hub.docker.com/_/microsoft-dotnet\nARG DOTNET_REPO=mcr.microsoft.com/dotnet\nARG DOTNET_VERSION_TAG=6.0-bullseye-slim-amd64\n#######################################################################################################################\n\n\n#######################################################################################################################\n# FAISS binaries\nARG FAISS_VERSION=1.7.2.2\n\nFROM ghcr.io/vektonn/vektonn/faiss-lib:$FAISS_VERSION AS faiss-lib\n#######################################################################################################################\n\n\n#######################################################################################################################\n# Build stage\nFROM $DOTNET_REPO/sdk:$DOTNET_VERSION_TAG AS build\n\nARG DOTNET_TOOLS_PATH=/dotnet/tools\nRUN dotnet tool install dotnet-dump --tool-path $DOTNET_TOOLS_PATH && \\\n    dotnet tool install dotnet-trace --tool-path $DOTNET_TOOLS_PATH && \\\n    dotnet tool install dotnet-gcdump --tool-path $DOTNET_TOOLS_PATH && \\\n    dotnet tool install dotnet-counters --tool-path $DOTNET_TOOLS_PATH && \\\n    dotnet tool install JetBrains.dotTrace.GlobalTools --tool-path $DOTNET_TOOLS_PATH\n\nARG DOTNET_RID=linux-x64\nARG SHARED_LIB_API_CONTRACTS=Vektonn.ApiContracts\nARG SHARED_LIB_API_CLIENT=Vektonn.ApiClient\nARG SHARED_LIB_IMPL=Vektonn.SharedImpl\nARG SHARED_LIB_DATA_SOURCE=Vektonn.DataSource\nARG SHARED_LIB_INDEX_SHARD=Vektonn.IndexShard\nARG SHARED_LIB_HOSTING=Vektonn.Hosting\nARG SERVICE_API=Vektonn.ApiService\nARG SERVICE_INDEX_SHARD=Vektonn.IndexShardService\n\nWORKDIR /src\n\n# Copy csproj and restore as distinct layer\nCOPY global.json .\nCOPY nuget.config .\nCOPY Directory.Build.props .\nCOPY $SHARED_LIB_API_CONTRACTS/$SHARED_LIB_API_CONTRACTS.csproj $SHARED_LIB_API_CONTRACTS/\nCOPY $SHARED_LIB_API_CLIENT/$SHARED_LIB_API_CLIENT.csproj $SHARED_LIB_API_CLIENT/\nCOPY $SHARED_LIB_IMPL/$SHARED_LIB_IMPL.csproj $SHARED_LIB_IMPL/\nCOPY $SHARED_LIB_DATA_SOURCE/$SHARED_LIB_DATA_SOURCE.csproj $SHARED_LIB_DATA_SOURCE/\nCOPY $SHARED_LIB_INDEX_SHARD/$SHARED_LIB_INDEX_SHARD.csproj $SHARED_LIB_INDEX_SHARD/\nCOPY $SHARED_LIB_HOSTING/$SHARED_LIB_HOSTING.csproj $SHARED_LIB_HOSTING/\nCOPY $SERVICE_API/$SERVICE_API.csproj $SERVICE_API/\nCOPY $SERVICE_INDEX_SHARD/$SERVICE_INDEX_SHARD.csproj $SERVICE_INDEX_SHARD/\n\nRUN dotnet restore --runtime $DOTNET_RID $SERVICE_API/$SERVICE_API.csproj\nRUN dotnet restore --runtime $DOTNET_RID $SERVICE_INDEX_SHARD/$SERVICE_INDEX_SHARD.csproj\n\n# Copy shared sources\nCOPY $SHARED_LIB_API_CONTRACTS/ $SHARED_LIB_API_CONTRACTS/\nCOPY $SHARED_LIB_API_CLIENT/ $SHARED_LIB_API_CLIENT/\nCOPY $SHARED_LIB_IMPL/ $SHARED_LIB_IMPL/\nCOPY $SHARED_LIB_DATA_SOURCE/ $SHARED_LIB_DATA_SOURCE/\nCOPY $SHARED_LIB_INDEX_SHARD/ $SHARED_LIB_INDEX_SHARD/\nCOPY $SHARED_LIB_HOSTING/ $SHARED_LIB_HOSTING/\n\n# Publish ApiService\nCOPY $SERVICE_API/ $SERVICE_API/\nRUN dotnet publish \\\n    --no-restore \\\n    --configuration Release \\\n    --self-contained false \\\n    --runtime $DOTNET_RID \\\n    --output /app/$SERVICE_API \\\n    $SERVICE_API/$SERVICE_API.csproj\n\n# Publish IndexShardService\nCOPY $SERVICE_INDEX_SHARD/ $SERVICE_INDEX_SHARD/\nRUN dotnet publish \\\n    --no-restore \\\n    --configuration Release \\\n    --self-contained false \\\n    --runtime $DOTNET_RID \\\n    -p:PublishTrimmed=$PUBLISH_TRIMMED \\\n    --output /app/$SERVICE_INDEX_SHARD \\\n    $SERVICE_INDEX_SHARD/$SERVICE_INDEX_SHARD.csproj\n#######################################################################################################################\n\n\n#######################################################################################################################\n# Final stage/image base\nFROM $DOTNET_REPO/aspnet:$DOTNET_VERSION_TAG AS runtime\n\n# Install useful diagnostic tools\nARG DOTNET_TOOLS_PATH=/dotnet/tools\nCOPY --from=build $DOTNET_TOOLS_PATH $DOTNET_TOOLS_PATH\nRUN apt-get update && apt-get install --no-install-recommends -y procps && rm -rf /var/lib/apt/lists/*;\n\nRUN mkdir -p /vektonn/logs && \\\n    mkdir -p /vektonn/dumps\n\nENV PATH=$PATH:$DOTNET_TOOLS_PATH \\\n    DOTNET_DbgEnableMiniDump=1 \\\n    DOTNET_DbgMiniDumpType=2 \\\n    DOTNET_DbgMiniDumpName=/vektonn/dumps/crash.dmp \\\n    ASPNETCORE_ENVIRONMENT=Development \\\n    VEKTONN_KAFKA_BOOTSTRAP_SERVERS= \\\n    VEKTONN_CONFIG_BASE_DIRECTORY=config\n\nWORKDIR /vektonn\n#######################################################################################################################\n\n\n#######################################################################################################################\n# Final stage/image for ApiService (target this entrypoint with: docker build --target api-service)\nFROM runtime AS api-service\n\nARG VEKTONN_API_HTTP_PORT=8081\n\nEXPOSE $VEKTONN_API_HTTP_PORT\n\nCOPY --from=build /app/Vektonn.ApiService ./bin\n\nENV VEKTONN_HTTP_PORT=$VEKTONN_API_HTTP_PORT \\\n    VEKTONN_KAFKA_TOPIC_REPLICATION_FACTOR=\n\nENTRYPOINT [\"./bin/Vektonn.ApiService\"]\n#######################################################################################################################\n\n\n#######################################################################################################################\n# Final stage/image for IndexShardService (target this entrypoint with: docker build --target index-shard-service)\nFROM runtime AS index-shard-service\n\nARG VEKTONN_INDEX_SHARD_HTTP_PORT=8082\n\nEXPOSE $VEKTONN_INDEX_SHARD_HTTP_PORT\n\nCOPY --from=build /app/Vektonn.IndexShardService ./bin\nCOPY --from=faiss-lib /lib-faiss-native/ ./lib-faiss-native/\n\nENV LD_LIBRARY_PATH=/vektonn/lib-faiss-native \\\n    VEKTONN_HTTP_PORT=$VEKTONN_INDEX_SHARD_HTTP_PORT \\\n    VEKTONN_INDEX_NAME= \\\n    VEKTONN_INDEX_VERSION= \\\n    VEKTONN_INDEX_SHARD_ID=\n\nENTRYPOINT [\"./bin/Vektonn.IndexShardService\"]\n#######################################################################################################################\n"
}