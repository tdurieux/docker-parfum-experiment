{
  "startTime": 1674221229971,
  "endTime": 1674221230972,
  "originalSmells": [
    {
      "rule": "ruleAptGetInstallThenRemoveAptLists",
      "position": {
        "lineStart": 5,
        "lineEnd": 5,
        "columnStart": 22,
        "columnEnd": 112
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "ARG arch=armhf\nARG arch_qemu=arm\nARG release=bullseye\nFROM debian:${release}-slim AS qemu\n\nRUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends qemu-user-static && rm -rf /var/lib/apt/lists/*;\n\nFROM ${arch}/debian:${release}-slim as debian-ncp\n\nARG arch_qemu\n\nLABEL maintainer=\"Ignacio Núñez Hernanz <nacho@ownyourbits.com>\"\n\nCMD /bin/bash\n\nCOPY --from=qemu /usr/bin/qemu-${arch_qemu}-static /usr/bin/\n\nRUN mkdir -p /etc/services-available.d  /etc/services-enabled.d\n\nCOPY build/docker/debian-ncp/run-parts.sh /\n\n# syntax=docker/dockerfile:experimental\n\nFROM --platform=linux/${arch_qemu} debian-ncp as lamp\n\nLABEL maintainer=\"Ignacio Núñez Hernanz <nacho@ownyourbits.com>\"\n\nSHELL [\"/bin/bash\", \"-c\"]\n\nENV DOCKERBUILD 1\n\nCOPY etc/ncp.cfg etc/library.sh lamp.sh /usr/local/etc/\n\nRUN --mount=type=cache,target=/var/cache/apt --mount=type=cache,target=/var/lib/apt \\\nset -e; \\\n\n# installation\napt-get update; \\\napt-get install --no-install-recommends -y jq; \\\n\nsource /usr/local/etc/library.sh; \\\nset +x; \\\ninstall_app /usr/local/etc/lamp.sh; \\\n\n# stop mysqld\nmysqladmin -u root shutdown; \\\n\n# mariaDB fixups (move database to /data-ro, which will be in a persistent volume)\nmkdir -p /data-ro /data; \\\nmv /var/lib/mysql /data-ro/database; \\\nsed -i \"s|^datadir.*|datadir = /data-ro/database|\" /etc/mysql/mariadb.conf.d/90-ncp.cnf; \\\n\n# package cleanup\napt-get autoremove -y; \\\napt-get clean; \\\nfind /var/lib/apt/lists -type f | xargs rm; \\\nrm -rf /usr/share/man/*; \\\nrm -rf /usr/share/doc/*; \\\nrm /var/cache/debconf/*-old; \\\nrm -f /var/log/alternatives.log /var/log/apt/*; \\\n\n# specific cleanup\nrm /data-ro/database/ib_logfile*; \\\nrm /usr/local/etc/lamp.sh\n\nCOPY build/docker/lamp/010lamp /etc/services-enabled.d/\n\nENTRYPOINT [\"/run-parts.sh\"]\n\nEXPOSE 80 443\n\nFROM --platform=linux/${arch_qemu} lamp as nextcloud\n# syntax=docker/dockerfile:experimental\n\nARG arch_qemu\n\nLABEL maintainer=\"Ignacio Núñez Hernanz <nacho@ownyourbits.com>\"\n\nSHELL [\"/bin/bash\", \"-c\"]\n\nENV DOCKERBUILD 1\n\nCOPY etc/library.sh /usr/local/etc/\nCOPY bin/ncp/CONFIG/nc-nextcloud.sh /\nCOPY etc/ncp-config.d/nc-nextcloud.cfg /usr/local/etc/ncp-config.d/\nCOPY etc/ncp-templates /usr/local/etc/ncp-templates\n\nRUN --mount=type=cache,target=/var/cache/apt --mount=type=cache,target=/var/lib/apt \\\nset -e; \\\n\n# mark as image build\ntouch /.ncp-image; \\\n\n# mark as docker image\ntouch /.docker-image; \\\n\n# installation ( /var/www/nextcloud -> /data/app which will be in a volume )\napt-get update; \\\napt-get install --no-install-recommends -y wget ca-certificates sudo jq; \\\nsource /usr/local/etc/library.sh; \\\ninstall_app /nc-nextcloud.sh; \\\nrun_app_unsafe /nc-nextcloud.sh; \\\nmv /var/www/nextcloud /data-ro/nextcloud; \\\nln -s /data-ro/nextcloud /var/www/nextcloud; \\\n\n# package cleanup\napt-get autoremove -y; \\\napt-get clean; \\\nfind /var/lib/apt/lists -type f | xargs rm; \\\nrm -rf /usr/share/man/*; \\\nrm -rf /usr/share/doc/*; \\\nrm /var/cache/debconf/*-old; \\\nrm -f /var/log/alternatives.log /var/log/apt/*; \\\n\n# specific cleanup\napt-get purge -y wget ca-certificates; \\\nrm /nc-nextcloud.sh /usr/local/etc/ncp-config.d/nc-nextcloud.cfg; \\\nrm /.ncp-image;\n\nCOPY build/docker/nextcloud/020nextcloud /etc/services-enabled.d/\nCOPY bin/ncp-provisioning.sh /usr/local/bin/\n# syntax=docker/dockerfile:experimental\n\nFROM --platform=linux/${arch_qemu} nextcloud as nextcloudpi\n\nARG ncp_ver=v0.0.0\n\nLABEL maintainer=\"Ignacio Núñez Hernanz <nacho@ownyourbits.com>\"\n\nSHELL [\"/bin/bash\", \"-c\"]\n\nENV DOCKERBUILD 1\n\nRUN mkdir -p /tmp/ncp-build\nCOPY bin/                          /tmp/ncp-build/bin/\nCOPY etc                           /tmp/ncp-build/etc/\nCOPY ncp-web                       /tmp/ncp-build/ncp-web/\nCOPY ncp-app                       /tmp/ncp-build/ncp-app/\nCOPY ncp-previewgenerator          /tmp/ncp-build/ncp-previewgenerator/\nCOPY build/docker                  /tmp/ncp-build/build/docker/\nCOPY ncp.sh update.sh post-inst.sh /tmp/ncp-build/\nCOPY etc/ncp-config.d/nc-init.cfg /usr/local/etc/ncp-config.d/nc-init-copy.cfg\n\nRUN --mount=type=cache,target=/var/cache/apt --mount=type=cache,target=/var/lib/apt \\\nset -e; \\\n\n# make sure we don't accidentally disable first run wizard\nrm -f ncp-web/{wizard.cfg,ncp-web.cfg}; \\\n\n# mark as image build\ntouch /.ncp-image; \\\n\n# mark as docker image\ntouch /.docker-image; \\\n\napt-get update; \\\napt-get install --no-install-recommends -y wget ca-certificates; \\\n\n# install nextcloudpi\nsource /usr/local/etc/library.sh; \\\ncd /tmp/ncp-build/; \\\ninstall_app ncp.sh; \\\n\nmv /usr/local/etc/ncp-config.d/nc-init-copy.cfg /usr/local/etc/ncp-config.d/nc-init.cfg; \\\nrun_app_unsafe bin/ncp/CONFIG/nc-init.sh; \\\nsed -i 's|data-ro|data|' /data-ro/nextcloud/config/config.php; \\\n\n# fix default paths\nsed -i 's|/media/USBdrive|/data/backups|' /usr/local/etc/ncp-config.d/nc-backup.cfg; \\\nsed -i 's|/media/USBdrive|/data/backups|' /usr/local/etc/ncp-config.d/nc-backup-auto.cfg; \\\n\n# cleanup all NCP extras\nrun_app_unsafe post-inst.sh; \\\n\n# specific cleanup\ncd /; rm -r /tmp/ncp-build; \\\nrm /usr/local/etc/ncp-config.d/nc-init.cfg; \\\n\n# package installation clean up\nrm -rf /usr/share/man/*; \\\nrm -rf /usr/share/doc/*; \\\nrm -f /var/log/alternatives.log /var/log/apt/*; \\\nrm /var/cache/debconf/*-old; \\\n\n# set version\necho \"${ncp_ver}\" > /usr/local/etc/ncp-version\n\nCOPY build/docker/nextcloudpi/000ncp /etc/services-enabled.d/\n\nFROM --platform=linux/${arch_qemu} nextcloudpi as ncp-qemu-fix\n\nRUN echo 'Mutex posixsem' >> /etc/apache2/mods-available/ssl.conf\n"
}