{
  "startTime": 1674217813068,
  "endTime": 1674217814518,
  "originalSmells": [
    {
      "rule": "apkAddUseNoCache",
      "position": {
        "lineStart": 9,
        "lineEnd": 9,
        "columnStart": 4,
        "columnEnd": 94
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "FROM alpine:3.12 as compile_stage\n\nENV LUCI_BIN_ROOT='/tmp/internal/000luci-bin/root' LUCI_BIN='/tmp/internal/000luci-bin' INTERNAL_PLUGIN_DIR='/tmp/internal'\n\nCOPY luci $INTERNAL_PLUGIN_DIR/\nCOPY src /tmp/\n#sed -i 's/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g' /etc/apk/repositories && \\\n#sed -i -e '/^http:\\/\\/.*\\/main/h' -e'$G' -e '${s|\\(^http://.*/\\)main|\\1testing|}' /etc/apk/repositories && \\\nRUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g' /etc/apk/repositories && apk update && \\\n    apk add --no-cache git cmake make gcc libc-dev json-c-dev lua5.1 lua5.1-dev openssl-dev linux-headers && \\\n    # libubox\n    cd /tmp && git clone --depth=1 https://git.openwrt.org/project/libubox.git && \\\n    cd /tmp/libubox && \\\n    # git checkout 43a103ff17ee5872669f8712606578c90c14591d && \\\n    cmake . && make && make install && \\\n    # uci\n    cd /tmp && git clone --depth=1 https://git.openwrt.org/project/uci.git && \\\n    cd /tmp/uci && \\\n    # git checkout 165b444131453d63fc78c1d86f23c3ca36a2ffd7 && \\\n    cmake . && make && \\\n    # ustream-ssl\n    cd /tmp && git clone --depth=1 https://git.openwrt.org/project/ustream-ssl.git && \\\n    cd /tmp/ustream-ssl && \\\n    # git checkout 30cebb4fc78e49e0432a404f7c9dd8c9a93b3cc3 && \\\n    cmake . && make && make install && \\\n    # uhttpd\n    cd /tmp && git clone --depth=1 https://git.openwrt.org/project/uhttpd.git && \\\n    cd /tmp/uhttpd && \\\n    # git checkout 5f9ae5738372aaa3a6be2f0a278933563d3f191a && \\\n    sed -i 's/clearenv();/\\/\\/clearenv();/g' cgi.c && \\\n    cmake -DUBUS_SUPPORT=OFF -DUCODE_SUPPORT=OFF . && make && cd /tmp && \\\n    # libnl-tiny\n    cd /tmp && git clone --depth=1 https://git.openwrt.org/project/libnl-tiny.git && \\\n    cd /tmp/libnl-tiny && \\\n    # git checkout 0219008cc8767655d7e747497e8e1133a3e8f840 && \\\n    cmake . && make && \\\n    mkdir -p /usr/lib && cp *.so /usr/lib/ && cp -R /tmp/libnl-tiny/include/* /usr/include/ && \\\n    # liblucihttp\n    cd /tmp/ && git clone --depth=1 https://github.com/jow-/lucihttp.git && \\\n    cd /tmp/lucihttp && \\\n    # git checkout a34a17d501c0e23f0a91dd9d3e87697347c861ba && \\\n    cmake . && make && \\\n    # luci\n    cd /tmp && git clone --depth=1 https://github.com/openwrt/luci.git && \\\n    # cd /tmp/luci && git checkout openwrt-21.02 && \\\n    # luci-lib-ip\n    cd /tmp/luci/libs/luci-lib-ip/src && make && \\\n    # luci-lib-jsonc\n    cd /tmp/luci/libs/luci-lib-jsonc/src && \\\n    sed -i 's/return json_object_new_int(nd);/return json_object_new_int64(nd);/g' jsonc.c && make && \\\n    # luci-lib-nixio\n    cd /tmp/luci/libs/luci-lib-nixio/src && \\\n    sed -i 's/^CFLAGS *+=/CFLAGS       += -fPIC /g' Makefile && make && \\\n    # parser.so & po2lmo\n    cd /tmp/luci/modules/luci-base/src && sed -i '1i\\CFLAGS += -fPIC' Makefile && \\\n    make parser.so && \\\n    make po2lmo && \\\n    make jsmin && \\\n    # cgi-io\n    cd /tmp/cgi-io && \\\n    cmake . && make && \\\n    # copy to dst\n    mkdir -p $LUCI_BIN_ROOT/usr/lib $LUCI_BIN_ROOT/usr/lib/lua $LUCI_BIN_ROOT/usr/sbin $LUCI_BIN_ROOT/usr/bin $LUCI_BIN_ROOT/usr/local/share/libubox/ $LUCI_BIN_ROOT/usr/lib/lua/luci/template $LUCI_BIN_ROOT/www/cgi-bin && \\\n    touch $LUCI_BIN/Makefile && \\\n    cp /tmp/libubox/*.so $LUCI_BIN_ROOT/usr/lib/ && cp /tmp/libubox/lua/*.so $LUCI_BIN_ROOT/usr/lib/lua/ && cp /tmp/libubox/jshn $LUCI_BIN_ROOT/usr/bin && cp /tmp/libubox/sh/jshn.sh $LUCI_BIN_ROOT/usr/local/share/libubox/ && \\\n    cp /tmp/ustream-ssl/*.so $LUCI_BIN_ROOT/usr/lib/ && \\\n    cp /tmp/uci/*.so $LUCI_BIN_ROOT/usr/lib/ && cp /tmp/uci/lua/*.so $LUCI_BIN_ROOT/usr/lib/lua/ && cp /tmp/uci/uci $LUCI_BIN_ROOT/usr/sbin/ && \\\n    cp /tmp/uhttpd/*.so $LUCI_BIN_ROOT/usr/lib/ && cp /tmp/uhttpd/uhttpd $LUCI_BIN_ROOT/usr/sbin/ && \\\n    cp /tmp/libnl-tiny/*.so $LUCI_BIN_ROOT/usr/lib/ && \\\n    cp /tmp/luci/libs/luci-lib-ip/src/*.so $LUCI_BIN_ROOT/usr/lib/lua/luci/ && \\\n    cp /tmp/luci/libs/luci-lib-jsonc/src/*.so $LUCI_BIN_ROOT/usr/lib/lua/luci/ && \\\n    cp /tmp/luci/libs/luci-lib-nixio/src/*.so  $LUCI_BIN_ROOT/usr/lib/lua/ && \\\n    cp /tmp/lucihttp/lucihttp.so $LUCI_BIN_ROOT/usr/lib/lua && cp /tmp/lucihttp/liblucihttp.so* $LUCI_BIN_ROOT/usr/lib && \\\n    cp /tmp/luci/modules/luci-base/src/po2lmo $LUCI_BIN_ROOT/usr/sbin/ && \\\n    cp /tmp/luci/modules/luci-base/src/jsmin $LUCI_BIN_ROOT/usr/sbin/ && \\\n    cp /tmp/luci/modules/luci-base/src/parser.so $LUCI_BIN_ROOT/usr/lib/lua/luci/template && \\\n    cp /tmp/cgi-io/cgi-io $LUCI_BIN_ROOT/www/cgi-bin/ && \\\n    cd $LUCI_BIN_ROOT/www/cgi-bin/ && \\\n    ln -s cgi-io cgi-exec && ln -s cgi-io cgi-download && ln -s cgi-io cgi-upload\n\nFROM alpine:latest\n\nLABEL maintainer='lisaac <lisaac.cn@gmail.com>'\n\nENV PLUGIN_DIR='/external/plugin' CONFIG_DIR='/external/cfg.d' INTERNAL_PLUGIN_DIR='/internal/plugin' TZ='Asia/Shanghai' LUCI_SYSROOT='/tmp/.luci'\nENV IPKG_INSTROOT=$LUCI_SYSROOT LD_LIBRARY_PATH=$LUCI_SYSROOT/usr/lib:$LD_LIBRARY_PATH PATH=$LUCI_SYSROOT/bin:$LUCI_SYSROOT/sbin:$LUCI_SYSROOT/usr/sbin:$LUCI_SYSROOT/usr/bin:$PATH LUA_PATH=$LUCI_SYSROOT/usr/lib/lua/?.lua;$LUCI_SYSROOT/usr/lib/lua/?/init.lua;; LUA_CPATH=$LUCI_SYSROOT/usr/lib/lua/?.so;; DYLD_LIBRARY_PATH=$LUCI_SYSROOT/usr/lib:$DYLD_LIBRARY_PATH\n\nCOPY init.sh /\nCOPY --from=compile_stage /tmp/internal $INTERNAL_PLUGIN_DIR/000luci/\n\nRUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g' /etc/apk/repositories && \\\n    apk --no-cache update && \\\n    apk --no-cache add lua5.1 json-c libgcc tzdata ca-certificates tini && \\\n    mkdir -p $INTERNAL_PLUGIN_DIR $PLUGIN_DIR $CONFIG_DIR/config && \\\n    ln -s /usr/lib/liblua.so.5 /usr/lib/liblua.so.5.1.5 && \\\n    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone && \\\n    chmod +x /init.sh\n\nEXPOSE 80/tcp\n\nCMD [\"tini\", \"--\", \"/init.sh\", \"daemon\"]\n"
}