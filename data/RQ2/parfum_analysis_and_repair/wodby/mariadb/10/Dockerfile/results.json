{
  "startTime": 1674251856471,
  "endTime": 1674251857555,
  "originalSmells": [
    {
      "rule": "tarSomethingRmTheSomething",
      "position": {
        "lineStart": 58,
        "lineEnd": 58,
        "columnStart": 4,
        "columnEnd": 40
      }
    },
    {
      "rule": "tarSomethingRmTheSomething",
      "position": {
        "lineStart": 73,
        "lineEnd": 73,
        "columnStart": 8,
        "columnEnd": 43
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "ARG BASE_IMAGE_TAG\n\nFROM wodby/alpine:${BASE_IMAGE_TAG}\n\nARG MARIADB_VER\nARG GALERA_VER\nARG WSREP_VER\nARG NPROC\n\nENV MARIADB_VER=\"${MARIADB_VER}\" \\\n    GALERA_VER=\"${GALERA_VER}\" \\\n    BACKUPS_DIR=\"/mnt/backups\"\n\nCOPY patches /tmp/patches\n\nRUN set -xe; \\\n\n    addgroup -g 101 -S mysql; \\\n    adduser -u 100 -D -S -s /bin/bash -G mysql mysql; \\\n    echo \"PS1='\\w\\$ '\" >> /home/mysql/.bashrc; \\\n\n    apk add --update --no-cache -t .mariadb-run-deps \\\n        libaio \\\n        libstdc++ \\\n        libxml2 \\\n        linux-pam \\\n        make \\\n        $(test \"${MARIADB_VER:3:1}\" -ge 5 && echo 'pcre2' || echo 'pcre') \\\n        pwgen \\\n        sudo \\\n        tzdata \\\n        xz-libs \\\n        zlib; \\\n\n    apk add --update --no-cache -t .mariadb-build-deps \\\n        attr \\\n        autoconf \\\n        bison \\\n        build-base \\\n        cmake \\\n        coreutils \\\n        gnupg \\\n        libaio-dev \\\n        linux-pam-dev \\\n        openssl-dev \\\n        linux-headers \\\n        ncurses-dev \\\n        patch \\\n        $(test \"${MARIADB_VER:3:1}\" -ge 5 && echo 'pcre2-dev' || echo 'pcre-dev') \\\n        readline-dev \\\n        xz-dev \\\n        zlib-dev; \\\n\n    mariadb_url=\"https://downloads.mariadb.com/MariaDB/mariadb-${MARIADB_VER}/source/mariadb-${MARIADB_VER}.tar.gz\"; \\\n    curl -fSL \"${mariadb_url}\" -o /tmp/mariadb.tar.gz; \\\n    curl -fSL \"${mariadb_url}.asc\" -o /tmp/mariadb.tar.gz.asc; \\\n    GPG_KEYS=\"199369E5404BD5FC7D2FE43BCBCB082A1BB943DB;430BDF5C56E7C94E848EE60C1C4CBDCDCD2EFD2A;4D1BB29D63D98E422B2113B19334A25F8507EFA5\" gpg_verify /tmp/mariadb.tar.gz.asc /tmp/mariadb.tar.gz; \\\n\n    tar zxf /tmp/mariadb.tar.gz -C /tmp; rm /tmp/mariadb.tar.gz \\\n    #\n    # Optional Galera Build/Install\n    #\n    if [ -n \"${GALERA_VER}\" ]; then \\\n        apk add --update --no-cache -t .galera-run-deps \\\n            boost-program_options \\\n            rsync \\\n            socat; \\\n        apk add --update --no-cache -t .galera-build-deps \\\n            boost-dev \\\n            check-dev \\\n            scons; \\\n        galera_url=\"https://github.com/codership/galera/archive/release_${GALERA_VER}.tar.gz\"; \\\n        curl -fSL \"${galera_url}\" -o /tmp/galera.tar.gz; \\\n        tar zxf /tmp/galera.tar.gz -C /tmp; \\\n        rmdir \"/tmp/galera-release_${GALERA_VER}/wsrep/src\"; \\\n        ln -s \"/tmp/mariadb-${MARIADB_VER}/wsrep-lib/wsrep-API/v${WSREP_VER}\" \"/tmp/galera-release_${GALERA_VER}/wsrep/src\"; \\\n        \\\n        cd \"/tmp/galera-release_${GALERA_VER}\"; \\\n        for i in /tmp/patches/galera/\"${GALERA_VER:0:4}\"/*.patch; do patch -p1 -i \"${i}\"; done; \\\n        RUN_TESTS=0 scripts/build.sh -j \"${NPROC:-$(nproc)}\"; \\\n        apk del --purge .galera-build-deps; \\\n        \\\n        mkdir -p /usr/lib/galera; \\\n        cp -a \"/tmp/galera-release_${GALERA_VER}/libgalera_smm.so\" /usr/lib/galera; \\\n        chown -R mysql:mysql /usr/lib/galera; \\\n        \\\n        cp -a \"/tmp/galera-release_${GALERA_VER}/garb/garbd\" /usr/sbin; \\\n    fi; \\\n\n    #\n    # MariaDB Build\n    #\n    cd \"/tmp/mariadb-${MARIADB_VER}\"; \\\n    # From alpine repository https://git.alpinelinux.org/cgit/aports/tree/main/mariadb?h=3.6-stable\n    for i in /tmp/patches/\"${MARIADB_VER:0:4}\"/*.patch; do patch -p1 -i \"${i}\"; done; \\\n\n    cmake . -DBUILD_CONFIG=mysql_release \\\n    \t\t-DCMAKE_BUILD_TYPE=MinSizeRel \\\n    \t\t-DCMAKE_INSTALL_PREFIX=/usr \\\n    \t\t-DSYSCONFDIR=/etc/mysql \\\n    \t\t-DMYSQL_DATADIR=/var/lib/mysql \\\n    \t\t-DMYSQL_UNIX_ADDR=/run/mysqld/mysqld.sock \\\n\t\t    -DDEFAULT_CHARSET=utf8mb4 \\\n\t\t    -DDEFAULT_COLLATION=utf8mb4_general_ci \\\n    \t\t-DENABLED_LOCAL_INFILE=ON \\\n    \t\t-DINSTALL_INFODIR=share/mysql/docs \\\n    \t\t-DINSTALL_MANDIR=share/man \\\n    \t\t-DINSTALL_PLUGINDIR=lib/mysql/plugin \\\n    \t\t-DINSTALL_SCRIPTDIR=bin \\\n    \t\t-DINSTALL_INCLUDEDIR=include/mysql \\\n    \t\t-DINSTALL_DOCREADMEDIR=share/mysql \\\n    \t\t-DINSTALL_SUPPORTFILESDIR=share/mysql \\\n    \t\t-DINSTALL_MYSQLSHAREDIR=share/mysql \\\n    \t\t-DINSTALL_DOCDIR=share/mysql/docs \\\n    \t\t-DINSTALL_SHAREDIR=share/mysql \\\n    \t\t-DCONNECT_WITH_MYSQL=ON \\\n            -DCONNECT_WITH_LIBXML2=system \\\n            -DCONNECT_WITH_ODBC=NO \\\n            -DCONNECT_WITH_JDBC=NO \\\n    \t\t-DPLUGIN_ARCHIVE=YES \\\n            -DPLUGIN_ARIA=YES \\\n            -DPLUGIN_BLACKHOLE=YES \\\n            -DPLUGIN_CASSANDRA=NO \\\n            -DPLUGIN_CSV=YES \\\n            -DPLUGIN_MYISAM=YES \\\n            -DPLUGIN_MROONGA=NO \\\n            -DPLUGIN_OQGRAPH=NO \\\n            -DPLUGIN_PARTITION=YES \\\n            -DPLUGIN_ROCKSDB=NO \\\n            -DPLUGIN_SPHINX=NO \\\n            -DPLUGIN_TOKUDB=NO \\\n            -DPLUGIN_AUTH_GSSAPI=NO \\\n            -DPLUGIN_AUTH_GSSAPI_CLIENT=OFF \\\n            -DPLUGIN_CRACKLIB_PASSWORD_CHECK=NO \\\n    \t\t-DWITH_ASAN=OFF \\\n            -DWITH_EMBEDDED_SERVER=ON \\\n            -DWITH_EXTRA_CHARSETS=complex \\\n            -DWITH_INNODB_BZIP2=OFF \\\n            -DWITH_INNODB_LZ4=OFF \\\n            -DWITH_INNODB_LZMA=ON \\\n            -DWITH_INNODB_LZO=OFF \\\n            -DWITH_INNODB_SNAPPY=OFF \\\n            -DWITH_JEMALLOC=NO \\\n            -DWITH_LIBARCHIVE=system \\\n            -DWITH_LIBNUMA=NO \\\n            -DWITH_LIBWRAP=OFF \\\n            -DWITH_LIBWSEP=OFF \\\n            -DWITH_MARIABACKUP=ON \\\n            -DWITH_PCRE=system \\\n            -DWITH_READLINE=ON \\\n            -DWITH_SYSTEMD=no \\\n            -DWITH_SSL=system \\\n            -DWITH_VALGRIND=OFF \\\n            -DWITH_ZLIB=system; \\\n\n    make -j \"${NPROC:-$(nproc)}\"; \\\n    make install; \\\n\n    # Script to fix volumes permissions via sudo.\n    echo \"chown mysql:mysql /var/lib/mysql ${BACKUPS_DIR}\" > /usr/local/bin/init_volumes; \\\n    chmod +x /usr/local/bin/init_volumes; \\\n    echo 'mysql ALL=(root) NOPASSWD: /usr/local/bin/init_volumes' > /etc/sudoers.d/mysql; \\\n\n    mkdir -p \\\n        /var/run/mysqld \\\n        /var/lib/mysql \\\n        /etc/mysql/certificates \\\n        /docker-entrypoint-initdb.d \\\n        \"${BACKUPS_DIR}\"; \\\n\n    chown -R mysql:mysql \\\n        /var/run/mysqld \\\n        /var/lib/mysql \\\n        /usr/lib/mysql/plugin \\\n        /etc/mysql \\\n        /docker-entrypoint-initdb.d \\\n        \"${BACKUPS_DIR}\"; \\\n\n    # Remove dev, test, doc, benchmark related files.\n    rm -rf \\\n        /usr/bin/mysql_client_test \\\n        /usr/bin/mysql_client_test_embedded \\\n        /usr/bin/mysql_config \\\n        /usr/bin/mysqltest \\\n        /usr/bin/mysqltest_embedded \\\n        /usr/include/mysql \\\n        /usr/lib/libmariadb.so* \\\n        /usr/lib/libmariadbd.so.* \\\n        /usr/lib/libmysqlclient.so* \\\n        /usr/lib/libmysqlclient_r.so* \\\n        /usr/lib/libmysqld.so.* \\\n        /usr/mysql-test \\\n        /usr/share/man \\\n        /usr/sql-bench; \\\n\n    find /usr/lib -name '*.a' -maxdepth 1 -print0 | xargs -0 rm; \\\n    find /usr/lib -name '*.so' -type l -maxdepth 1 -print0 | xargs -0 rm; \\\n\n    # Stripping binaries and .so files.\n    scanelf --symlink --recursive --nobanner --osabi --etype \"ET_DYN,ET_EXEC\" \\\n        /usr/bin/* /usr/sbin/* /usr/lib/mysql/plugin/* /usr/lib/galera/* | while read type osabi filename; do \\\n        ([ \"$osabi\" != \"STANDALONE\" ] && [ \"${filename}\" != \"/usr/bin/strip\" ]) || continue; \\\n        XATTR=$(getfattr --match=\"\" --dump \"${filename}\"); \\\n        strip \"${filename}\"; \\\n        if [ -n \"$XATTR\" ]; then \\\n            echo \"$XATTR\" | setfattr --restore=-; \\\n        fi; \\\n    done; \\\n\n    # Clean up.\n    apk del --purge .mariadb-build-deps; \\\n    rm -rf /tmp/*; \\\n    rm -rf /var/cache/apk/*\n\nUSER mysql\n\nCOPY bin /usr/local/bin\nCOPY templates /etc/gotpl/\nCOPY docker-entrypoint.sh /\n\nWORKDIR /var/lib/mysql\nVOLUME /var/lib/mysql\n\nEXPOSE 3306\n\nENTRYPOINT [\"/docker-entrypoint.sh\"]\nCMD [\"mysqld\"]\n"
}