{
  "startTime": 1674254119321,
  "endTime": 1674254120613,
  "originalSmells": [
    {
      "rule": "gpgUseBatchFlag",
      "position": {
        "lineStart": 45,
        "lineEnd": 45,
        "columnStart": 6,
        "columnEnd": 61
      }
    },
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 12,
        "lineEnd": 12,
        "columnStart": 2,
        "columnEnd": 88
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "{{- $solr := index .Packages \"solr\" -}}\n\nFROM {{ .From }}\n\nARG SOLR_VERSION={{ $solr.Version }}\nARG SOLR_SHA512={{ $solr.Sha512 }}\nARG SOLR_KEYS={{ $solr.Gpg }}\n\nENV C2D_RELEASE={{ $solr.Version }}\n\nRUN set -ex; \\\n  apt-get update; \\\n  apt-get -y --no-install-recommends install default-jdk acl dirmngr gpg lsof procps wget curl netcat gosu tini; \\\n  rm -rf /var/lib/apt/lists/*; \\\n  cd /usr/local/bin; wget -nv https://github.com/apangin/jattach/releases/download/v1.5/jattach; chmod 755 jattach; \\\n  echo >jattach.sha512 \"d8eedbb3e192a8596c08efedff99b9acf1075331e1747107c07cdb1718db2abe259ef168109e46bd4cf80d47d43028ff469f95e6ddcbdda4d7ffa73a20e852f9  jattach\"; \\\n  sha512sum -c jattach.sha512; rm jattach.sha512\n\nENV SOLR_USER=\"solr\" \\\n    SOLR_UID=\"8983\" \\\n    SOLR_GROUP=\"solr\" \\\n    SOLR_GID=\"8983\" \\\n    SOLR_CLOSER_URL=\"http://www.apache.org/dyn/closer.lua?filename=lucene/solr/$SOLR_VERSION/solr-$SOLR_VERSION.tgz&action=download\" \\\n    SOLR_DIST_URL=\"https://www.apache.org/dist/lucene/solr/$SOLR_VERSION/solr-$SOLR_VERSION.tgz\" \\\n    SOLR_ARCHIVE_URL=\"https://archive.apache.org/dist/lucene/solr/$SOLR_VERSION/solr-$SOLR_VERSION.tgz\" \\\n    PATH=\"/opt/solr/bin:/opt/docker-solr/scripts:$PATH\" \\\n    SOLR_INCLUDE=/etc/default/solr.in.sh \\\n    SOLR_HOME=/var/solr/data \\\n    SOLR_PID_DIR=/var/solr \\\n    SOLR_LOGS_DIR=/var/solr/logs \\\n    LOG4J_PROPS=/var/solr/log4j2.xml\n\n# Workaround for CVE-2021-44228\n# https://www.docker.com/blog/apache-log4j-2-cve-2021-44228/\nENV JAVA_OPTS=\"-Dlog4j.formatMsgNoLookups=true\"\n\nRUN set -ex; \\\n  groupadd -r --gid \"$SOLR_GID\" \"$SOLR_GROUP\"; \\\n  useradd -r --uid \"$SOLR_UID\" --gid \"$SOLR_GID\" \"$SOLR_USER\"\n\nRUN set -ex; \\\n  export GNUPGHOME=\"/tmp/gnupg_home\"; \\\n  mkdir -p \"$GNUPGHOME\"; \\\n  chmod 700 \"$GNUPGHOME\"; \\\n  echo \"disable-ipv6\" >> \"$GNUPGHOME/dirmngr.conf\"; \\\n  {{ $( gpg --batch --no-tty --keyserver $server --recv-keys $SOLR_KEYS) | KeyServersRetryLoop \"\\t\" }} \\\n  && exit 0\n\nRUN set -ex; \\\n  export GNUPGHOME=\"/tmp/gnupg_home\"; \\\n  MAX_REDIRECTS=1; \\\n  for url in $SOLR_DOWNLOAD_URL $SOLR_CLOSER_URL $SOLR_DIST_URL $SOLR_ARCHIVE_URL; do \\\n    if [ -f \"/opt/solr-$SOLR_VERSION.tgz\" ]; then break; fi; \\\n    echo \"downloading $url\"; \\\n    if wget -t 10 --max-redirect $MAX_REDIRECTS --retry-connrefused -nv \"$url\" -O \"/opt/solr-$SOLR_VERSION.tgz\"; then break; else rm -f \"/opt/solr-$SOLR_VERSION.tgz\"; fi; \\\n  done; \\\n  if [ ! -f \"/opt/solr-$SOLR_VERSION.tgz\" ]; then echo \"failed all download attempts for solr-$SOLR_VERSION.tgz\"; exit 1; fi; \\\n  echo \"downloading $SOLR_ARCHIVE_URL.asc\"; \\\n  wget -nv \"$SOLR_ARCHIVE_URL.asc\" -O \"/opt/solr-$SOLR_VERSION.tgz.asc\"; \\\n  echo \"$SOLR_SHA512 */opt/solr-$SOLR_VERSION.tgz\" | sha512sum -c -; \\\n    (>&2 ls -l \"/opt/solr-$SOLR_VERSION.tgz\" \"/opt/solr-$SOLR_VERSION.tgz.asc\"); \\\n  gpg --batch --verify \"/opt/solr-$SOLR_VERSION.tgz.asc\" \"/opt/solr-$SOLR_VERSION.tgz\"; \\\n  tar -C /opt --extract --file \"/opt/solr-$SOLR_VERSION.tgz\"; \\\n  (cd /opt; ln -s \"solr-$SOLR_VERSION\" solr); \\\n  rm \"/opt/solr-$SOLR_VERSION.tgz\"*; \\\n  rm -Rf /opt/solr/docs/ /opt/solr/dist/{solr-core-$SOLR_VERSION.jar,solr-solrj-$SOLR_VERSION.jar,solrj-lib,solr-test-framework-$SOLR_VERSION.jar,test-framework}; \\\n  mkdir -p /opt/solr/server/solr/lib /docker-entrypoint-initdb.d /opt/docker-solr; \\\n  chown -R $SOLR_USER:$SOLR_GROUP \"/opt/solr-$SOLR_VERSION\"; \\\n  find \"/opt/solr-$SOLR_VERSION\" -type d -print0 | xargs -0 chmod 0755; \\\n  find \"/opt/solr-$SOLR_VERSION\" -type f -print0 | xargs -0 chmod 0644; \\\n  chmod -R 0755 \"/opt/solr-$SOLR_VERSION/bin\" \"/opt/solr-$SOLR_VERSION/contrib/prometheus-exporter/bin/solr-exporter\" /opt/solr-$SOLR_VERSION/server/scripts/cloud-scripts; \\\n  cp /opt/solr/bin/solr.in.sh /etc/default/solr.in.sh; \\\n  mv /opt/solr/bin/solr.in.sh /opt/solr/bin/solr.in.sh.orig; \\\n  mv /opt/solr/bin/solr.in.cmd /opt/solr/bin/solr.in.cmd.orig; \\\n  chown $SOLR_USER:$SOLR_GROUP /etc/default/solr.in.sh; \\\n  chmod 0664 /etc/default/solr.in.sh; \\\n  mkdir -p /var/solr/data /var/solr/logs; \\\n  (cd /opt/solr/server/solr; cp solr.xml zoo.cfg /var/solr/data/); \\\n  cp /opt/solr/server/resources/log4j2.xml /var/solr/log4j2.xml; \\\n  find /var/solr -type d -print0 | xargs -0 chmod 0770; \\\n  find /var/solr -type f -print0 | xargs -0 chmod 0660; \\\n  sed -i -e \"s/\\\"\\$(whoami)\\\" == \\\"root\\\"/\\$(id -u) == 0/\" /opt/solr/bin/solr; \\\n  sed -i -e 's/lsof -PniTCP:/lsof -t -PniTCP:/' /opt/solr/bin/solr; \\\n  chown -R \"$SOLR_USER:$SOLR_GROUP\" /opt/solr-$SOLR_VERSION /docker-entrypoint-initdb.d /opt/docker-solr; \\\n  chown -R \"$SOLR_USER:$SOLR_GROUP\" /var/solr; \\\n  { command -v gpgconf; gpgconf --kill all || :; }; \\\n  rm -r \"$GNUPGHOME\"\n\nCOPY --chown=$SOLR_USER:$SOLR_GROUP scripts /opt/docker-solr/scripts\n\nVOLUME /var/solr\nEXPOSE 8983\nWORKDIR /opt/solr\nUSER $SOLR_USER\n\nENTRYPOINT [\"docker-entrypoint.sh\"]\nCMD [\"solr-foreground\"]\n"
}