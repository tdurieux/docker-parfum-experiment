{
  "startTime": 1674246622808,
  "endTime": 1674246623892,
  "originalSmells": [
    {
      "rule": "yumInstallRmVarCacheYum",
      "position": {
        "lineStart": 33,
        "lineEnd": 33,
        "columnStart": 64,
        "columnEnd": 96
      }
    },
    {
      "rule": "yumInstallRmVarCacheYum",
      "position": {
        "lineStart": 33,
        "lineEnd": 33,
        "columnStart": 127,
        "columnEnd": 155
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "solarwinds/whd-embedded:[tag]\n=========\n\nThis is a Dockerized version of [WebHelpDesk](http://www.webhelpdesk.com/).  This is based on the RHEL rpm installed on a CentOS 6 base.\n\nThe primary purpose of the document is to explain the steps involved in deploying WHD Docker image on to Docker store/hub. This could be first step in exploring the feasibility of moving other products (related and non-related) to Containers to cut down the build and deploy time for products that are under maintenance. Please refer Docker Best Practices for creating Docker file.\n\nObjective\n---------\n\nThe initial objective was to create a WHD Docker image with preinstalled Web Help desk configured and ready to go with the embedded PostgreSQL. This would be offered only on RHEL Based Linux Containers since the WHD RPM is built for RHEL based Linux version. Hence, currently CentOS is being used as the base line OS image for WHD Containers. However, as the second step, PostgreSQL can be hosted on its own container and in that way, WHD can scale horizontally and need not be updated when new version of WHD is released. Also, Database containers can be backed up independent of WHD container and scaled. Basically, the main difference between option 1 and 2 is the environment variable \"EMBEDDED\". When you are creating the solarwinds/whd-embedded image, it sets EMBEDDED to true and as a result the container will start the PostgreSQL with in the same container. While building solarwinds/whd image using the compose, it sets the EMBEDDED to false and build the solarwinds/whd image using the same Dockerfile. When this is used to build the image, it does not start the PostgreSQL with in the same container and establishes port connectivity between PostgreSQL container that runs on alpine Linux and WHD container that runs tomcat on CentOS.\n\nOptions\n========\nOption - 1: Docker Image with Embedded PostgreSQL database\n---------------------------------------------------------\n\n#Docker File - Embedded PostgreSQL\n```Dockerfile\n# Version: 0.0.9\n\nFROM centos:latest\n\nMAINTAINER Solarwinds  \"vijay.veeraraghavan@solarwinds.com\"\n\nARG EMBEDDED\n\nENV CONSOLETYPE=serial PRODUCT_VERSION=12.5.0 PRODUCT_NAME=webhelpdesk-12.5.0.1257-1.x86_64.rpm.gz GZIP_FILE=webhelpdesk.rpm.gz RPM_FILE=webhelpdesk.rpm EMBEDDED=${EMBEDDED:-true} WHD_HOME=/usr/local/webhelpdesk\n\nRUN echo Environment :: $EMBEDDED\n\nADD functions /etc/rc.d/init.d/functions\nADD http://downloads.solarwinds.com/solarwinds/Release/WebHelpDesk/$PRODUCT_VERSION/Linux/$PRODUCT_NAME /$GZIP_FILE\nRUN gunzip -dv /$GZIP_FILE && yum clean all && yum update -y && yum install -y python-setuptools && easy_install supervisor && yum install -y -v /$RPM_FILE  && rm /$RPM_FILE && yum clean all && cp $WHD_HOME/conf/whd.conf.orig $WHD_HOME/conf/whd.conf && sed -i 's/^PRIVILEGED_NETWORKS=[[:space:]]*$/PRIVILEGED_NETWORKS=0.0.0.0\\/0/g' $WHD_HOME/conf/whd.conf && rm -rf /var/cache/yum\nADD whd_start_configure.sh $WHD_HOME/whd_start_configure.sh\nADD whd_start.sh $WHD_HOME/whd_start.sh\nADD whd_configure.sh $WHD_HOME/whd_configure.sh\nADD setup_whd_db.sh $WHD_HOME/setup_whd_db.sh\nADD whd-api-config-call.properties $WHD_HOME/whd-api-config-call.properties\nADD whd-api-create-call.properties $WHD_HOME/whd-api-create-call.properties\nADD run.sh /run.sh\nADD supervisord.conf /home/docker/whd/supervisord.conf\nADD whd $WHD_HOME/whd\nADD whd_bin $WHD_HOME/bin/whd\nRUN chmod 744 /run.sh && chmod 644 $WHD_HOME/*.properties && chmod 755 $WHD_HOME/whd && chmod 744 $WHD_HOME/*.sh && chmod 755 $WHD_HOME/bin/whd\nEXPOSE 8081\n\nENTRYPOINT [\"/run.sh\"]\n```\nHere is the docker build command that is used to create WHD Docker image. The tag or image name should match the namespace or username/respository name created on the docker hub account.\n\n#Docker Build\n```sh\ndocker build -t solarwinds/whd-embedded:latest .\n```\nThe command to login and push the image to docker hub repository is provided below.\n\n#Docker Push\n```sh\ndocker login --username={username}\n```\nThis will prompt you to enter the docker hub account password. On successfully logging in, you will be able to push the image to the repository\n\n```sh\ndocker push solarwinds/whd-embedded:latest\n```\n\n#Docker Pull\n```sh\ndocker pull solarwinds/whd-embedded[:latest]\n```\n\nOnce the docker image is built or pulled from docker hub, Here is the docker run command to start the container. This will create WHD container and start the PostgreSQL and start Web Help desk web application on 8081 port. This will run the container in the daemon mode.\n\n#Docker Run\n```sh\ndocker run -d -p 8081:8081 --name=whdinstance solarwinds/whd-embedded:latest\n```\n\nIdeally you would want the Data to be stored outside the Application container. So that when the container is upgraded or removed, the data still exists on the host. In order to create a seperate mount point for the Data directory, create a data volume to store data on the host\n\n```sh\ndocker volume create --name whd-data-volume\n```\n\nUse the following Docker run command to mount volume when launching the container instance\n\n#Docker Run with mount\n```sh\ndocker run -d -p 8081:8081 --name=whdinstance -v whd-data-volume:/usr/local/webhelpdesk/bin/pgsql/var/lib/pgsql/9.2/data  solarwinds/whd-embedded:latest\n```\n-v whd-data-volume:/usr/local/webhelpdesk/bin/pgsql/var/lib/pgsql/9.2/data means we mount whd-data-volume as a volume. This is very important. It's safe to keep database files in the host.\n\n\nConfigure WHD Through Browser:\n-----------------------------\n\nWeb Help Desk is automatically configured to run Embedded PostgreSQL Database that comes with the WebHelpDesk RPM.\nPostgreSQL is configured to run on the port 20293 and runs on the same container as the WebHelpDesk Application.\n\n\nSteps that happens when the container is launched\n-------------------------------------------------\nPostGreSQL is automatically installed and started by WebHelpDesk RPM on the same container and uses port 20293.\nWebhelpDesk gets installed on the same container with image named solarwinds/whd-embedded and exposes port 8081 for external use.\nThe Database name whd and DB Admin and Users are created automatically from solarwinds/whd-embedded container.\nThe WebhelpDesk application is started on the port 8081 and a API call is made to configure WHD Application to use embedded postgresql DB.\n\nImportant\n---------\nPlease allow couple of minutes after you launch the container to Start PostgreSQL and WHD Instance and create System Catalogs to keep the Database ready.\n"
}