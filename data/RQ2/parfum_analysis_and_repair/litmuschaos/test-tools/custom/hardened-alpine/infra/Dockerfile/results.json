{
  "startTime": 1674250340438,
  "endTime": 1674250341645,
  "originalSmells": [
    {
      "rule": "apkAddUseNoCache",
      "position": {
        "lineStart": 23,
        "lineEnd": 26,
        "columnStart": 4,
        "columnEnd": 12
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "# This Dockerfile contains the hardened alpine image that can be used in litmus components.\n# It is also made non-root with default litmus directory.\nFROM alpine:3.15.0\n\nLABEL maintainer=\"LitmusChaos\"\n\n# make a pipe fail on the first failure\nSHELL [\"/bin/sh\", \"-o\", \"pipefail\", \"-c\"]\n\n# ensure we only use apk repositories over HTTPS (altough APK contain an embedded signature)\nRUN echo \"https://alpine.global.ssl.fastly.net/alpine/v$(cut -d . -f 1,2 < /etc/alpine-release)/main\" > /etc/apk/repositories \\\n\t&& echo \"https://alpine.global.ssl.fastly.net/alpine/v$(cut -d . -f 1,2 < /etc/alpine-release)/community\" >> /etc/apk/repositories\n\n# The user the app should run as\nENV APP_USER=litmus\n# The home directory\nENV APP_DIR=\"/$APP_USER\"\n# Where persistent data (volume) should be stored\nENV DATA_DIR \"$APP_DIR/data\"\n# Where configuration should be stored\nENV CONF_DIR \"$APP_DIR/conf\"\n\n# Install generally useful things\nRUN apk --update --no-cache add \\\n        curl \\\n\tsudo \\\n        bash\n\n# Change default shell from ash to bash\nRUN sed -i -e \"s/bin\\/ash/bin\\/bash/\" /etc/passwd  \n\n# Update base system\n# hadolint ignore=DL3018\nRUN apk add --no-cache ca-certificates\n\n# Add custom user and setup home directory\nRUN adduser -s /bin/true -u 1000 -D -h $APP_DIR $APP_USER \\\n  && mkdir \"$DATA_DIR\" \"$CONF_DIR\" \\\n  && chown -R \"$APP_USER\" \"$APP_DIR\" \"$CONF_DIR\" \\\n  && chmod 700 \"$APP_DIR\" \"$DATA_DIR\" \"$CONF_DIR\" \\\n# change to 0(root) group because openshift will run container with arbitrary uid as a member of root group\n  && chgrp -R 0 \"$APP_DIR\" \"$DATA_DIR\" \"$CONF_DIR\" \\\n  && chmod -R g=u \"$APP_DIR\" \"$DATA_DIR\" \"$CONF_DIR\"\n\n# Remove existing crontabs, if any.\nRUN rm -fr /var/spool/cron \\\n\t&& rm -fr /etc/crontabs \\\n\t&& rm -fr /etc/periodic\n\n# Remove all but a handful of admin commands.\nRUN find /sbin /usr/sbin \\\n  ! -type d -a ! -name apk -a ! -name ln \\\n  -delete\n\n# Remove world-writeable permissions except for /tmp/\nRUN find / -xdev -type d -perm +0002 -exec chmod o-w {} + \\\n\t&& find / -xdev -type f -perm +0002 -exec chmod o-w {} + \\\n\t&& chmod 777 /tmp/ \\\n  && chown $APP_USER:root /tmp/\n\n# Remove unnecessary accounts, excluding current app user and root\nRUN sed -i -r \"/^($APP_USER|root|nobody)/!d\" /etc/group \\\n  && sed -i -r \"/^($APP_USER|root|nobody)/!d\" /etc/passwd\n\n# Remove interactive login shell for everybody\nRUN sed -i -r 's#^(.*):[^:]*$#\\1:/sbin/nologin#' /etc/passwd\n\n# Disable password login for everybody\nRUN while IFS=: read -r username _; do passwd -l \"$username\"; done < /etc/passwd || true\n\n# Remove apk configs. -> Commented out because we need apk to install other stuff\nRUN find /bin /etc /lib /sbin /usr \\\n -xdev -type f -regex '.*apk.*' \\\n ! -name apk \\\n -exec rm -fr {} +\n\n# Remove temp shadow,passwd,group\nRUN find /bin /etc /lib /sbin /usr -xdev -type f -regex '.*-$' -exec rm -f {} +\n\n# Ensure system dirs are owned by root and not writable by anybody else.\nRUN find /bin /etc /lib /sbin /usr -xdev -type d \\\n  -exec chown root:root {} \\; \\\n  -exec chmod 0755 {} \\;\n\n# Remove suid & sgid files\nRUN find /bin /etc /lib /sbin /usr -xdev -type f -a \\( -perm +4000 -o -perm +2000 \\) -delete\n\n# Remove dangerous commands\nRUN find /bin /etc /lib /sbin /usr -xdev \\( \\\n  -iname hexdump -o \\\n  -iname chgrp -o \\\n  -iname ln -o \\\n  -iname od -o \\\n  -iname strings -o \\\n  -iname su -o \\\n  -iname sudo \\\n  \\) -delete\n\n# Remove init scripts since we do not use them.\nRUN rm -fr /etc/init.d /lib/rc /etc/conf.d /etc/inittab /etc/runlevels /etc/rc.conf /etc/logrotate.d\n\n# Remove kernel tunables\nRUN rm -fr /etc/sysctl* /etc/modprobe.d /etc/modules /etc/mdev.conf /etc/acpi\n\n# Remove root home dir\nRUN rm -fr /root\n\n# Remove fstab\nRUN rm -f /etc/fstab\n\n# Remove any symlinks that we broke during previous steps\nRUN find /bin /etc /lib /sbin /usr -xdev -type l -exec test ! -e {} \\; -delete\n\n# default directory is /litmus\nWORKDIR $APP_DIR\nUSER ${APP_USER}\n"
}