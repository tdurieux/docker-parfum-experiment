{
  "startTime": 1674255653897,
  "endTime": 1674255654986,
  "originalSmells": [
    {
      "rule": "tarSomethingRmTheSomething",
      "position": {
        "lineStart": 56,
        "lineEnd": 56,
        "columnStart": 11,
        "columnEnd": 53
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "# 基础镜像\nFROM alpine\n\n# 作者信息\nLABEL MAINTAINER=\"qist Docker Maintainers 87984115@qq.com\"\n\n# 修改源\nRUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories\n\n# 安装ca 证书\nRUN apk update && \\\n    apk add --no-cache ca-certificates\n\n# 设置环境变量\n\nENV HAPROXY_VERSION 2.5.4\nENV HAPROXY_URL http://www.haproxy.org/download/2.5/src/haproxy-2.5.4.tar.gz\n\n# 代理\n# ENV http_proxy http://192.168.0.151:7890\n# ENV https_proxy http://192.168.0.151:7890\n# 工作目录\nWORKDIR /tmp\n\n# 编译安装HAPROXY\nRUN HAPROXY_CONFIG=\"\\\n     TARGET=\"linux-musl\" \\\n     USE_PCRE=1 \\\n     USE_PCRE_JIT=1 \\\n     USE_OPENSSL=1 \\\n     USE_ZLIB=1 \\\n     USE_REGPARM=1 \\\n     USE_LINUX_TPROXY=1 \\\n     USE_CPU_AFFINITY=1 \\\n     DEFINE=-DTCP_USER_TIMEOUT=18 \\\n     EXTRA_OBJS=\"addons/promex/service-prometheus.o\" \\\n     PREFIX=/usr \\\n     \" \\\n     && apk  add  --no-cache --virtual .build-deps \\\n        gcc \\\n\t\tlibc-dev \\\n\t\tlinux-headers \\\n\t\tpcre-dev \\\n\t\tmake \\\n\t\topenssl \\\n\t\topenssl-dev \\\n\t\tpcre2-dev \\\n\t\treadline-dev \\\n\t\ttar \\\n\t\tzlib-dev \\\n        curl \\\n        git \\\n        cmake \\\n        g++ \\\n        && curl -fSL \"$HAPROXY_URL\" -o /tmp/haproxy-${HAPROXY_VERSION}.tar.gz \\\n        && cd /tmp \\\n        && tar -xzf haproxy-${HAPROXY_VERSION}.tar.gz \\\n        && cd  /tmp/haproxy-${HAPROXY_VERSION} \\\n        && make -j$(getconf _NPROCESSORS_ONLN) all $HAPROXY_CONFIG \\\n        && make install-bin  $HAPROXY_CONFIG \\\n        && git clone https://github.com/microsoft/mimalloc.git /tmp/mimalloc \\\n        && mkdir -p /tmp/mimalloc/out/release \\\n        && cd /tmp/mimalloc/out/release \\\n        && cmake -DMI_SECURE=OFF ../.. \\\n        && make install \\\n        && apk del .build-deps && rm haproxy-${HAPROXY_VERSION}.tar.gz\n\n# 构建confd nginx 镜像\n\nFROM alpine\n# 作者信息\nLABEL MAINTAINER=\"qist Docker Maintainers 87984115@qq.com\"\n\n# 修改源\nRUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories\n\n# 安装ca 证书\nRUN apk update && \\\n    apk add --no-cache ca-certificates\n\n# 设置环境变量\n\nENV HAPROXY_VERSION 2.5.4\nENV HAPROXY_URL http://www.haproxy.org/download/2.5/src/haproxy-2.5.4.tar.gz\n# 监听端口\nENV HOST_PORT 6443\nENV LD_PRELOAD=/usr/local/lib/libmimalloc.so\n# 后端转发端口\nENV BACKEND_PORT 5443\nRUN  apk add  --no-cache  \\ \n           curl \\\n           wget \\\n           pcre \\\n        && addgroup -S haproxy \\\n        && adduser -D -S -s /sbin/nologin -G haproxy haproxy \\\n        && mkdir -p /etc/confd \\\n        && mkdir -p /etc/haproxy\n#COPY 编译结果 \n\nCOPY --from=0  /usr/sbin/haproxy /usr/sbin/haproxy\nCOPY --from=0  /usr/local/lib /usr/local/lib\nADD confd  /usr/sbin/confd\nADD conf.d /etc/confd/conf.d\nADD templates /etc/confd/templates\nADD haproxy-proxy /usr/bin/haproxy-proxy\n\n\n#添加执行权限\nRUN  chmod +x /usr/sbin/confd \\\n     && chmod +x /usr/bin/haproxy-proxy\n\nSTOPSIGNAL SIGUSR1\nEXPOSE 8404\n\nENTRYPOINT [\"/usr/bin/haproxy-proxy\"]\n\n"
}