{
  "startTime": 1674246782099,
  "endTime": 1674246783631,
  "originalSmells": [
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 74,
        "lineEnd": 76,
        "columnStart": 4,
        "columnEnd": 9
      }
    },
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 80,
        "lineEnd": 100,
        "columnStart": 4,
        "columnEnd": 14
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "FROM ubuntu:18.04\nMAINTAINER Przemyslaw Lis <przemek@concertoplatform.com>\n\nARG CRAN_MIRROR=https://cloud.r-project.org\n\nENV CONCERTO_PLATFORM_URL=/\nENV CONCERTO_PASSWORD=admin\nENV CONCERTO_API_ENABLED=true\nENV CONCERTO_API_ENABLED_OVERRIDABLE=true\nENV CONCERTO_DATA_API_ENABLED=true\nENV CONCERTO_SESSION_LIMIT=0\nENV CONCERTO_SESSION_LIMIT_OVERRIDABLE=true\nENV CONCERTO_CONTENT_URL=.\nENV CONCERTO_CONTENT_URL_OVERRIDABLE=true\nENV CONCERTO_CONTENT_TRANSFER_OPTIONS='[]'\nENV CONCERTO_CONTENT_TRANSFER_OPTIONS_OVERRIDABLE=true\nENV CONCERTO_SESSION_RUNNER_SERVICE=SerializedSessionRunnerService\nENV CONCERTO_SESSION_RUNNER_SERVICE_OVERRIDABLE=true\nENV CONCERTO_GIT_ENABLED=0\nENV CONCERTO_GIT_ENABLED_OVERRIDABLE=true\nENV CONCERTO_GIT_URL=''\nENV CONCERTO_GIT_URL_OVERRIDABLE=true\nENV CONCERTO_GIT_BRANCH=master\nENV CONCERTO_GIT_BRANCH_OVERRIDABLE=true\nENV CONCERTO_GIT_LOGIN=''\nENV CONCERTO_GIT_LOGIN_OVERRIDABLE=true\nENV CONCERTO_GIT_PASSWORD=''\nENV CONCERTO_GIT_PASSWORD_OVERRIDABLE=true\nENV CONCERTO_GIT_REPOSITORY_PATH=''\nENV CONCERTO_BEHIND_PROXY=false\nENV CONCERTO_CONTENT_IMPORT_AT_START=true\nENV CONCERTO_FAILED_AUTH_LOCK_TIME=300\nENV CONCERTO_FAILED_AUTH_LOCK_STREAK=3\nENV CONCERTO_SESSION_FILES_EXPIRATION=7\nENV CONCERTO_SESSION_LOG_LEVEL=1\nENV CONCERTO_SESSION_STORAGE=filesystem\nENV CONCERTO_COOKIES_SAME_SITE=strict\nENV CONCERTO_COOKIES_SECURE=false\nENV CONCERTO_KEEP_ALIVE_INTERVAL_TIME=900\nENV CONCERTO_KEEP_ALIVE_TOLERANCE_TIME=0\nENV CONCERTO_SESSION_TOKEN_EXPIRY_TIME=7200\nENV CONCERTO_R_ENVIRON_SESSION_PATH=null\nENV CONCERTO_R_PROFILE_SESSION_PATH=null\nENV CONCERTO_R_ENVIRON_SERVICE_PATH=null\nENV CONCERTO_R_PROFILE_SERVICE_PATH=null\nENV CONCERTO_R_SERVICES_NUM=0\nENV CONCERTO_R_FORCED_GC_INTERVAL=30\nENV CONCERTO_JWT_SECRET=changeme\nENV CONCERTO_PHP_SESSION_SAVE_PATH=/data/php/sessions\nENV REDIS_HOST=redis\nENV REDIS_PORT=6379\nENV REDIS_PASS=''\nENV DB_HOST=localhost\nENV DB_PORT=3306\nENV DB_NAME=concerto\nENV DB_USER=concerto\nENV DB_PASSWORD=changeme\nENV NGINX_PORT=80\nENV NGINX_SERVER_CONF=\"add_header X-Frame-Options sameorigin always;\\nadd_header X-Content-Type-Options nosniff always;\"\nENV PHP_FPM_PM=dynamic\nENV PHP_FPM_PM_MAX_CHILDREN=30\nENV PHP_FPM_PM_START_SERVERS=10\nENV PHP_FPM_PM_MIN_SPARE_SERVERS=5\nENV PHP_FPM_PM_MAX_SPARE_SERVERS=15\nENV PHP_FPM_PM_PROCESS_IDLE_TIMEOUT=10s\nENV PHP_FPM_PM_MAX_REQUESTS=300\nENV WEB_USER=www-data\nENV TZ=UTC\n\nCOPY . /app/concerto/\nADD https://raw.githubusercontent.com/vishnubob/wait-for-it/master/wait-for-it.sh /\n\nRUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone \\\n && apt-get update -y \\\n && apt-get -y --no-install-recommends install \\\n    ca-certificates \\\n    gnupg \\\n && echo \"deb $CRAN_MIRROR/bin/linux/ubuntu bionic-cran40/\" | tee -a /etc/apt/sources.list \\\n && apt-key adv --no-tty --keyserver keyserver.ubuntu.com --recv-keys E298A3A825C0D65DFD57CBB651716619E084DAB9 \\\n && apt-get update -y \\\n && apt-get -y --no-install-recommends install \\\n    cron \\\n    curl \\\n    gettext \\\n    git \\\n    libcurl4-openssl-dev \\\n    libhiredis-dev \\\n    libmariadbclient-dev \\\n    libxml2-dev \\\n    libssl-dev \\\n    locales \\\n    nginx \\\n    php7.2-curl \\\n    php7.2-mbstring \\\n    php7.2-mysql \\\n    php7.2-xml \\\n    php7.2-zip \\\n    php-fpm \\\n    procps \\\n    r-base \\\n    r-base-dev \\\n && rm -rf /var/lib/apt/lists/* \\\n && sed -i 's/# en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/' /etc/locale.gen \\\n && locale-gen \"en_US.UTF-8\" \\\n && Rscript -e \"install.packages(c('catR','digest','filelock','httr','jsonlite','redux','rjson','RMySQL','session','xml2'), repos='$CRAN_MIRROR')\" \\\n && R CMD INSTALL /app/concerto/src/Concerto/TestBundle/Resources/R/concerto5 \\\n && chmod +x /wait-for-it.sh \\\n && php /app/concerto/bin/console concerto:r:cache \\\n && crontab -l | { cat; echo \"* * * * * . /app/concerto/cron/concerto.schedule.tick.sh >> /var/log/cron.log 2>&1\"; } | crontab - \\\n && crontab -l | { cat; echo \"* * * * * . /app/concerto/cron/concerto.forker.guard.sh >> /var/log/cron.log 2>&1\"; } | crontab - \\\n && crontab -l | { cat; echo \"* * * * * . /app/concerto/cron/concerto.service.guard.sh >> /var/log/cron.log 2>&1\"; } | crontab - \\\n && crontab -l | { cat; echo \"0 0 * * * . /app/concerto/cron/concerto.session.clear.sh >> /var/log/cron.log 2>&1\"; } | crontab - \\\n && crontab -l | { cat; echo \"*/5 * * * * . /app/concerto/cron/concerto.session.log.sh >> /var/log/cron.log 2>&1\"; } | crontab - \\\n && rm -f /etc/nginx/sites-available/default \\\n && rm -f /etc/nginx/sites-enabled/default \\\n && ln -fs /etc/nginx/sites-available/concerto.conf /etc/nginx/sites-enabled/concerto.conf\n\nCOPY build/docker/php/php.ini /etc/php/7.2/fpm/php.ini\nCOPY build/docker/nginx/nginx.conf /etc/nginx/nginx.conf\nCOPY build/docker/nginx/concerto.conf.tpl /etc/nginx/sites-available/concerto.conf.tpl\nCOPY build/docker/php-fpm/php-fpm.conf /etc/php/7.2/fpm/php-fpm.conf\nCOPY build/docker/php-fpm/www.conf /etc/php/7.2/fpm/pool.d/www.conf\n\nRUN rm -rf /app/concerto/src/Concerto/PanelBundle/Resources/public/files \\\n && rm -rf /app/concerto/src/Concerto/TestBundle/Resources/sessions \\\n && rm -rf /app/concerto/src/Concerto/PanelBundle/Resources/import\n\nEXPOSE 80 9000\nWORKDIR /app/concerto\nHEALTHCHECK --interval=1m --start-period=1m CMD curl -f http://localhost/api/check/health || exit 1\n\nCMD if [ \"$CONCERTO_COOKIES_SECURE\" = \"true\" ]; \\\n    then export CONCERTO_COOKIES_SECURE_PHP=1; \\\n    else export CONCERTO_COOKIES_SECURE_PHP=0; \\\n    fi \\\n && printenv | sed 's/^\\([a-zA-Z0-9_]*\\)=\\(.*\\)$/export \\1=\"\\2\"/g' > /root/env.sh \\\n && mkdir -p /data/files \\\n && mkdir -p /data/sessions \\\n && mkdir -p /data/git \\\n && mkdir -p /data/import \\\n && mkdir -p /data/php/sessions \\\n && ln -sf /data/files /app/concerto/src/Concerto/PanelBundle/Resources/public \\\n && ln -sf /data/sessions /app/concerto/src/Concerto/TestBundle/Resources \\\n && ln -sf /app/concerto/src/Concerto/PanelBundle/Resources/public/files /app/concerto/web \\\n && ln -sf /data/import /app/concerto/src/Concerto/PanelBundle/Resources \\\n && chown $WEB_USER /data/sessions \\\n && chown $WEB_USER /data/import \\\n && chown $WEB_USER /data/php/sessions \\\n && /wait-for-it.sh $DB_HOST:$DB_PORT -t 300 \\\n && php bin/console concerto:setup --env=prod --admin-pass=$CONCERTO_PASSWORD \\\n && if [ \"$CONCERTO_CONTENT_IMPORT_AT_START\" = \"true\" ]; \\\n    then php bin/console concerto:content:import --env=prod --sc; \\\n    fi \\\n && chown -R $WEB_USER /data/files \\\n && rm -rf var/cache/* \\\n && php bin/console cache:warmup --env=prod \\\n && chown $WEB_USER var/R/session_fifo \\\n && chown $WEB_USER var/R/service_fifo \\\n && chown -R $WEB_USER var/cache \\\n && chown -R $WEB_USER var/logs \\\n && chown -R $WEB_USER var/sessions \\\n && chown -R $WEB_USER var/git \\\n && chown -R $WEB_USER src/Concerto/PanelBundle/Resources/export \\\n && chown -R $WEB_USER /data/git \\\n && cat /etc/nginx/sites-available/concerto.conf.tpl | sed \"s/{{nginx_port}}/$NGINX_PORT/g\" | sed \"s/{{nginx_server_conf}}/$NGINX_SERVER_CONF/g\" > /etc/nginx/sites-available/concerto.conf \\\n && service nginx start \\\n && . /app/concerto/cron/concerto.forker.guard.sh \\\n && . /app/concerto/cron/concerto.service.guard.sh \\\n && /etc/init.d/php7.2-fpm start \\\n && cron \\\n && tail -F -n 0 var/logs/prod.log var/logs/forker.log var/logs/service.log"
}