{
  "startTime": 1674254408202,
  "endTime": 1674254409097,
  "originalSmells": [
    {
      "rule": "pipUseNoCacheDir",
      "position": {
        "lineStart": 84,
        "lineEnd": 84,
        "columnStart": 4,
        "columnEnd": 29
      }
    },
    {
      "rule": "pipUseNoCacheDir",
      "position": {
        "lineStart": 85,
        "lineEnd": 85,
        "columnStart": 4,
        "columnEnd": 30
      }
    },
    {
      "rule": "pipUseNoCacheDir",
      "position": {
        "lineStart": 113,
        "lineEnd": 113,
        "columnStart": 4,
        "columnEnd": 22
      }
    },
    {
      "rule": "aptGetInstallUseY",
      "position": {
        "lineStart": 101,
        "lineEnd": 101,
        "columnStart": 4,
        "columnEnd": 95
      }
    },
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 21,
        "lineEnd": 21,
        "columnStart": 4,
        "columnEnd": 49
      }
    },
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 22,
        "lineEnd": 43,
        "columnStart": 4,
        "columnEnd": 4
      }
    },
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 46,
        "lineEnd": 56,
        "columnStart": 4,
        "columnEnd": 17
      }
    },
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 59,
        "lineEnd": 62,
        "columnStart": 4,
        "columnEnd": 13
      }
    },
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 67,
        "lineEnd": 78,
        "columnStart": 4,
        "columnEnd": 7
      }
    },
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 101,
        "lineEnd": 101,
        "columnStart": 4,
        "columnEnd": 95
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 21,
        "lineEnd": 21,
        "columnStart": 4,
        "columnEnd": 49
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 22,
        "lineEnd": 43,
        "columnStart": 4,
        "columnEnd": 4
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 46,
        "lineEnd": 56,
        "columnStart": 4,
        "columnEnd": 17
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 59,
        "lineEnd": 62,
        "columnStart": 4,
        "columnEnd": 13
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 67,
        "lineEnd": 78,
        "columnStart": 4,
        "columnEnd": 7
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 101,
        "lineEnd": 101,
        "columnStart": 4,
        "columnEnd": 95
      }
    },
    {
      "rule": "ruleAptGetInstallThenRemoveAptLists",
      "position": {
        "lineStart": 21,
        "lineEnd": 21,
        "columnStart": 4,
        "columnEnd": 49
      }
    },
    {
      "rule": "ruleAptGetInstallThenRemoveAptLists",
      "position": {
        "lineStart": 22,
        "lineEnd": 43,
        "columnStart": 4,
        "columnEnd": 4
      }
    },
    {
      "rule": "ruleAptGetInstallThenRemoveAptLists",
      "position": {
        "lineStart": 46,
        "lineEnd": 56,
        "columnStart": 4,
        "columnEnd": 17
      }
    },
    {
      "rule": "ruleAptGetInstallThenRemoveAptLists",
      "position": {
        "lineStart": 59,
        "lineEnd": 62,
        "columnStart": 4,
        "columnEnd": 13
      }
    },
    {
      "rule": "ruleAptGetInstallThenRemoveAptLists",
      "position": {
        "lineStart": 67,
        "lineEnd": 78,
        "columnStart": 4,
        "columnEnd": 7
      }
    },
    {
      "rule": "ruleAptGetInstallThenRemoveAptLists",
      "position": {
        "lineStart": 101,
        "lineEnd": 101,
        "columnStart": 4,
        "columnEnd": 95
      }
    }
  ],
  "repairedSmells": [
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 21,
        "lineEnd": 21,
        "columnStart": 4,
        "columnEnd": 73
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 22,
        "lineEnd": 43,
        "columnStart": 4,
        "columnEnd": 4
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 46,
        "lineEnd": 56,
        "columnStart": 4,
        "columnEnd": 17
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 59,
        "lineEnd": 62,
        "columnStart": 4,
        "columnEnd": 13
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 67,
        "lineEnd": 78,
        "columnStart": 4,
        "columnEnd": 7
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 101,
        "lineEnd": 101,
        "columnStart": 4,
        "columnEnd": 122
      }
    }
  ],
  "repairedDockerfile": "#FROM debian:buster\nFROM ubuntu:16.04\n#LABEL de.dcso.misp-server.version=\"0.0.1-alpha\"\nLABEL vendor=\"DCSO GmbH <www.dcso.de>\"\nLABEL de.dcso.misp-server.release-date=\"2018-01-02\"\nLABEL de.dcso.misp-server.is-production=\"false\"\nLABEL maintainer=\"DCSO MISP <misp@dcso.de>\"\n\n# Variables:\nARG MISP_TAG=v2.4.88\nARG python_cybox_TAG=v2.1.0.12\nARG python_stix_TAG=v1.1.1.4\nARG mixbox_TAG=v1.0.2\nARG cake_resque_TAG=4.1.2\n\n#########################################\n#       Start of MISP Config Part\n\n# Install core components\nENV DEBIAN_FRONTEND noninteractive\nRUN apt-get update -y && apt-get autoremove -y && apt-get clean -y\nRUN apt-get install --no-install-recommends -y software-properties-common && rm -rf /var/lib/apt/lists/*;\nRUN apt-get install --no-install-recommends -y \\\nsupervisor \\\nnano \\\nvim \\\ncurl \\\ngcc \\\nmake \\\npython \\\npython-pip \\\npython3 \\\npython3-pip \\\nlocales \\\nzip \\\niputils-ping \\\ncurl \\\ngit \\\nmake \\\nopenssl \\\nvim \\\nzip \\\nnet-tools \\\nsudo && rm -rf /var/lib/apt/lists/*;\n\n# Install additional dependencies\nRUN apt-get install --no-install-recommends -y \\\nmariadb-client \\\npython-mysqldb \\\npython-dev \\\npython-pip \\\npython3-setuptools \\\npython-setuptools \\\nlibxml2-dev \\\nlibxslt1-dev \\\nzlib1g-dev \\\npython-setuptools && rm -rf /var/lib/apt/lists/*;\n\n# Install Apache\nRUN apt-get install --no-install-recommends -y \\\napache2 \\\napache2-doc \\\napache2-utils && rm -rf /var/lib/apt/lists/*;\n\n# ATTENTION the part about a2enmod/a2dismod, a2ensite/a2dissite is moved to step 7.\n\n# Install PHP and depedencies\nRUN apt-get install --no-install-recommends -y \\\nlibapache2-mod-php \\\nphp \\\nphp-cli \\\nphp-crypt-gpg \\\nphp-dev \\\nphp-json \\\nphp-mysql \\\nphp-opcache \\\nphp-readline \\\nphp-redis \\\nphp-xml && rm -rf /var/lib/apt/lists/*;\n# Set locals\nRUN locale-gen en_US.UTF-8\nENV LANG en_US.UTF-8\n\n# Update PIP\nRUN pip install --no-cache-dir --upgrade pip\nRUN pip3 install --no-cache-dir --upgrade pip\n\n##################################\n### Install and configure MISP ###\n##################################\n### 3/ MISP code ###\n# Download MISP using git in the /var/www/ directory.\n# Attention: we replaced the fixed tag with a variable\nRUN mkdir /var/www/MISP; chown www-data:www-data /var/www/MISP;\nRUN git clone https://github.com/MISP/MISP.git /var/www/MISP\nRUN cd /var/www/MISP; git checkout tags/${MISP_TAG};\n\n# Make git ignore filesystem permission differences\nRUN cd /var/www/MISP; git config core.filemode false;\n# install Mitre's STIX and its dependencies by running the following commands:\n# Attention: we replaced the fixed tag with a variable\nRUN apt-get install -y --no-install-recommends python-dev python-pip libxml2-dev libxslt1-dev zlib1g-dev python-setuptools && rm -rf /var/lib/apt/lists/*;\nRUN cd /var/www/MISP/app/files/scripts; git clone https://github.com/CybOXProject/python-cybox.git;\nRUN cd /var/www/MISP/app/files/scripts; git clone https://github.com/STIXProject/python-stix.git;\nRUN cd /var/www/MISP/app/files/scripts/python-cybox; git checkout ${python_cybox_TAG}; sudo python setup.py install;\nRUN cd /var/www/MISP/app/files/scripts/python-stix; git checkout ${python_stix_TAG}; sudo python setup.py install;\n\n# install mixbox to accomodate the new STIX dependencies:\n# Attention: we replaced the fixed tag with a variable\nRUN cd /var/www/MISP/app/files/scripts/; git clone https://github.com/CybOXProject/mixbox.git\nRUN cd /var/www/MISP/app/files/scripts/mixbox; git checkout ${mixbox_TAG}; sudo python setup.py install\n\n# install support for STIX 2.0 (Python 3 is required)\nRUN pip3 install --no-cache-dir stix2\n\n### 4/ CakePHP ###\n# CakePHP is included as a submodule of MISP, execute the following commands to let git fetch it:\nRUN cd /var/www/MISP; git submodule init; git submodule update;\n# Make git ignore filesystem permission differences for submodules\nRUN cd /var/www/MISP; git submodule foreach git config core.filemode false\n\n# Once done, install CakeResque along with its dependencies if you intend to use the built in background jobs:\nRUN cd /var/www/MISP/app; sudo -u www-data php composer.phar require kamisama/cake-resque:${cake_resque_TAG}; \\\nphp composer.phar config vendor-dir Vendor; \\\nphp composer.phar install;\n\n# Enable CakeResque with php-redis\nRUN sudo phpenmod redis\n\n# To use the scheduler worker for scheduled tasks, do the following:\nRUN cp -fa /var/www/MISP/INSTALL/setup/config.php /var/www/MISP/app/Plugin/CakeResque/Config/config.php\n# If you have multiple MISP instances on the same system, don't forget to have a different Redis per MISP instance for the CakeResque workers\n# The default Redis port can be updated in Plugin/CakeResque/Config/config.php\n\n### 5/ Set the permissions\n# Check if the permissions are set correctly using the following commands:\nRUN chown -R www-data:www-data /var/www/MISP; \\\nchmod -R 750 /var/www/MISP; \\\nchmod -R g+ws /var/www/MISP/app/tmp; \\ \nchmod -R g+ws /var/www/MISP/app/files; \\\nchmod -R g+ws /var/www/MISP/app/files/scripts/tmp;\n\n### 6 Create a database and user\n# At the moment this will be done via misp-robot.\n#RUN mysql -u misp -p`cat /run/secrets/mysql_password` -h misp-db misp < /var/www/MISP/INSTALL/MYSQL.sql\n\n\n### 7 Configure Apache\n# add HTTP MISP Config\nRUN rm /etc/apache2/sites-available/*; rm /etc/apache2/sites-enabled/*;\nCOPY --chown=www-data:www-data files/misp.conf /etc/apache2/sites-available/misp.conf\nCOPY --chown=www-data:www-data files/misp.ssl.conf /etc/apache2/sites-available/misp.ssl.conf\nCOPY --chown=root:root files/ports.conf /etc/apache2/ports.conf\nRUN chmod 644 /etc/apache2/ports.conf\n# add HTTPS MISP Config - THIS SHOULD BE DONE IN ROBOT\n#RUN mkdir /etc/apache2/ssl\n#RUN openssl req -x509 -newkey rsa:4096 -keyout /etc/apache2/ssl/key.pem -out /etc/apache2/ssl/cert.pem -days 3650 -nodes -subj '/CN=misp-server'\n#RUN openssl dhparam -out /etc/apache2/ssl/dhparams.pem 2048\n#RUN chmod -R 644 /etc/apache2/ssl\n\n# Configure Apache\nRUN sudo a2dismod status; \\\nsudo a2enmod ssl; \\\nsudo a2enmod rewrite; \\\nsudo a2enmod headers; \\\n#sudo a2ensite misp.ssl; \\\nsudo a2ensite misp;\n\n### 8/ Log rotation\n# MISP saves the stdout and stderr of its workers in /var/www/MISP/app/tmp/logs\n# To rotate these logs install the supplied logrotate script:\nRUN sudo cp /var/www/MISP/INSTALL/misp.logrotate /etc/logrotate.d/misp\n\n### 9/ MISP configuration\n# There are 4 sample configuration files in /var/www/MISP/app/Config that need to be copied\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/bootstrap.default.php /var/www/MISP/app/Config/bootstrap.php\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/database.default.php /var/www/MISP/app/Config/database.php\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/core.default.php /var/www/MISP/app/Config/core.php\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/config.default.php /var/www/MISP/app/Config/config.php\n\n### 5/ Set the permissions\n# Check if the permissions are set correctly using the following commands:\nRUN chown -R www-data:www-data /var/www/MISP; \\\nchmod -R 750 /var/www/MISP; \\\nchmod -R g+ws /var/www/MISP/app/tmp; \\ \nchmod -R g+ws /var/www/MISP/app/files; \\\nchmod -R g+ws /var/www/MISP/app/files/scripts/tmp;\n\n#       END of MISP Config Part\n#########################################\n\n#########################################\n#       Start of DCSO MISP Config Part\nCOPY files/php.ini /etc/php/7.0/apache2/\n\n# define the WORKDIR if you use docker exec\nWORKDIR /var/www/MISP\n\n# Environment Variable for Proxy\nENV HTTP_PROXY=\"\"\nENV NO_PROXY=\"0.0.0.0\"\n\n# Add Healthcheck Config\nHEALTHCHECK --interval=1m --timeout=15s --retries=3 CMD curl -f http://localhost/ || exit 1\n\n# CMD\nCOPY files/entrypoint.sh /srv/entrypoint.sh\nRUN chmod +x /srv/entrypoint.sh\nENTRYPOINT [ \"/srv/entrypoint.sh\" ]\n# CMD [\"/usr/sbin/apache2ctl\", \"-D\", \"FOREGROUND\"]\n\n#       End of DCSO MISP Config Part\n#########################################\n"
}