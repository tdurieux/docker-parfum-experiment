{
  "startTime": 1674254447336,
  "endTime": 1674254448484,
  "originalSmells": [
    {
      "rule": "curlUseFlagF",
      "position": {
        "lineStart": 86,
        "lineEnd": 86,
        "columnStart": 4,
        "columnEnd": 117
      }
    },
    {
      "rule": "pipUseNoCacheDir",
      "position": {
        "lineStart": 83,
        "lineEnd": 83,
        "columnStart": 4,
        "columnEnd": 43
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "# Copyright 2019 The Kubernetes Authors.\n#\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n#\n#     http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\n\n################################################################################\n##                               BUILD ARGS                                   ##\n################################################################################\n# The golang image is used to create the project's module and build caches\n# and is also the image on which this image is based.\nARG GOLANG_IMAGE=golang:1.18\n\n################################################################################\n##                            GO MOD CACHE STAGE                              ##\n################################################################################\n# Create a Go module cache.\nFROM ${GOLANG_IMAGE} as mod-cache\nWORKDIR /build\nCOPY go.mod go.sum ./\nCOPY pkg ./pkg/\nCOPY cmd ./cmd/\nARG GOOS\nARG GOARCH\nARG GOPROXY\nENV GOOS=${GOOS:-linux} GOARCH=${GOARCH:-amd64}\nENV GOPROXY ${GOPROXY:-https://proxy.golang.org}\nRUN go mod download && go mod verify\n\n################################################################################\n##                           GO BUILD CACHE STAGE                             ##\n################################################################################\n# Create a Go build cache. Please note the reason the Makefile is not used and\n# \"go build\" is invoked directly is to avoid having to rebuild this stage as a\n# result of the Makefile changing.\nFROM ${GOLANG_IMAGE} as build-cache\nWORKDIR /build\nCOPY --from=mod-cache /go/pkg/mod /go/pkg/mod/\nCOPY go.mod go.sum hack/make/ldflags.txt ./\nCOPY pkg ./pkg/\nCOPY cmd ./cmd/\nARG GOOS\nARG GOARCH\nARG GOPROXY\nENV CGO_ENABLED=0 GOOS=${GOOS:-linux} GOARCH=${GOARCH:-amd64}\nENV GOPROXY ${GOPROXY:-https://proxy.golang.org}\nRUN LDFLAGS=$(cat ldflags.txt) && \\\n    go build -ldflags \"${LDFLAGS}\" ./cmd/vsphere-csi\nRUN LDFLAGS=$(cat ldflags.txt) && \\\n    go build -ldflags \"${LDFLAGS}\" ./cmd/syncer\n\n################################################################################\n##                               MAIN STAGE                                   ##\n################################################################################\nFROM ${GOLANG_IMAGE}\nLABEL \"maintainers\"=\"Divyen Patel <divyenp@vmware.com>, Sandeep Pissay Srinivasa Rao <ssrinivas@vmware.com>, Xing Yang <yangxi@vmware.com>\"\n\n################################################################################\n##                             PACKAGE UPDATES                                ##\n################################################################################\n# Install the dependencies. The list is a union of the dependencies required\n# by the following images:\n#   * https://github.com/kubernetes/test-infra/blob/master/images/bootstrap/Dockerfile\nRUN apt-get update && \\\n    apt-get install -y --no-install-recommends \\\n      ca-certificates \\\n      curl \\\n      git \\\n      jq \\\n      mercurial \\\n      python3 \\\n      python3-pip \\\n      unzip \\\n      zip && \\\n    rm -rf /var/cache/apt/* /var/lib/apt/lists/* && \\\n    pip3 install --no-cache-dir setuptools wheel --upgrade\n\n# Download the Google Cloud SDK\nRUN curl -f -sSL https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-265.0.0-linux-x86_64.tar.gz | \\\n    tar xzC / && \\\n    /google-cloud-sdk/bin/gcloud components update\n\n################################################################################\n##                             DOCKER-IN-DOCKER                               ##\n################################################################################\n# Again, copied from test-infra's bootstrap image:\n# https://github.com/kubernetes/test-infra/blob/master/images/bootstrap/Dockerfile\n\n# Install Docker deps, some of these are already installed in the image but\n# that's fine since they won't re-install and we can reuse the code below\n# for another image someday.\nRUN apt-get update && \\\n    apt-get install -y --no-install-recommends \\\n      apt-transport-https \\\n      ca-certificates \\\n      curl \\\n      gnupg2 \\\n      software-properties-common \\\n      lsb-release && \\\n    rm -rf /var/cache/apt/* /var/lib/apt/lists/*\n\n# Add the Docker apt-repository\nRUN curl -fsSL https://download.docker.com/linux/$(. /etc/os-release; echo \"${ID}\")/gpg | apt-key add - && \\\n    add-apt-repository \\\n      \"deb [arch=amd64] https://download.docker.com/linux/$(. /etc/os-release; echo \"${ID}\") \\\n      $(lsb_release -cs) stable\"\n\n# Install Docker\n# TODO(bentheelder): the `sed` is a bit of a hack, look into alternatives.\n# Why this exists: `docker service start` on debian runs a `cgroupfs_mount` method,\n# We're already inside docker though so we can be sure these are already mounted.\n# Trying to remount these makes for a very noisy error block in the beginning of\n# the pod logs, so we just comment out the call to it... :shrug:\n# TODO(benthelder): update docker version. This is pinned because of\n# https://github.com/kubernetes/test-infra/issues/6187\nRUN apt-get update && \\\n    apt-get install -y --no-install-recommends docker-ce=18.06.* && \\\n    rm -rf /var/cache/apt/* /var/lib/apt/lists/* && \\\n    sed -i 's/cgroupfs_mount$/#cgroupfs_mount\\n/' /etc/init.d/docker\n\n# Move Docker's storage location\nRUN echo 'DOCKER_OPTS=\"${DOCKER_OPTS} --data-root=/docker-graph\"' | \\\n    tee --append /etc/default/docker\n\n# NOTE this should be mounted and persisted as a volume ideally (!)\n# We will make a fallback one now just in case\nRUN mkdir /docker-graph\n\n# Setting this environment variable is an easy way for processes running\n# in the container to know DinD is enabled.\nENV DOCKER_IN_DOCKER_ENABLED=true\n\n################################################################################\n##                       CONFIGURE GOOGLE CLOUD SDK                           ##\n################################################################################\n# Update the PATH to include the Google Cloud SDK and disable its prompts and\n# update the gcloud components.\nENV PATH=\"/google-cloud-sdk/bin:${PATH}\" CLOUDSDK_CORE_DISABLE_PROMPTS=1\n\n################################################################################\n##                         PRIME GO MOD & BUILD CACHES                        ##\n################################################################################\nCOPY --from=mod-cache   /go/pkg/mod           /go/pkg/mod/\nCOPY --from=build-cache /root/.cache/go-build /root/.cache/go-build/\nRUN  mkdir -p /home/prow/go/pkg && ln -s /go/pkg/mod /home/prow/go/pkg/mod\n\n################################################################################\n##                           ADD LOCAL SOURCES                                ##\n################################################################################\n# Copy the sources into the project's traditional Gopath location in the\n# image. It's possible to bind mount up-to-date sources over the ones in\n# the image when the latter is run as a container.\nWORKDIR /go/src/sigs.k8s.io/vsphere-csi-driver/v2/\nCOPY . ./\n"
}