{
  "startTime": 1674248283754,
  "endTime": 1674248284840,
  "originalSmells": [
    {
      "rule": "configureShouldUseBuildFlag",
      "position": {
        "lineStart": 39,
        "lineEnd": 39,
        "columnStart": 20,
        "columnEnd": 31
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "#  This Source Code Form is subject to the terms of the Mozilla Public\n#  License, v. 2.0. If a copy of the MPL was not distributed with this\n#  file, You can obtain one at http://mozilla.org/MPL/2.0/.\n\nARG CARDANO_NODE_VERSION=1.27.0\nARG CARDANO_OGMIOS_SNAPSHOT=46004deac7fb66a778ee9d684b70a105dbcf63ec\nARG IOHK_LIBSODIUM_GIT_REV=66f017f16633f2060db25e17c170c2afa0f2a8a1\n\n#                                                                              #\n# ------------------------------- SETUP  ------------------------------------- #\n#                                                                              #\n\nFROM haskell:8.10.4 as setup\nWORKDIR /build\nRUN apt-get update && apt-get install --no-install-recommends -y \\\n  automake=1:1.16.* \\\n  build-essential=12.6 \\\n  g++=4:8.3.* \\\n  git=1:2.20.* \\\n  libffi-dev=3.* \\\n  libgmp-dev=2:6.1.* \\\n  libpcre3-dev=2:8.* \\\n  libncursesw5=6.* \\\n  libssl-dev=1.1.* \\\n  libsystemd-dev=241-* \\\n  libtool=2.4.* \\\n  make=4.2.* \\\n  pkg-config=0.29-* \\\n  zlib1g-dev=1:1.2.* \\\n  && rm -rf /var/lib/apt/lists/*\n\nRUN cabal update\n\n# Build IOHK's libsodium fork, needed by cardano-node\nWORKDIR /app/src/libsodium\nRUN git clone https://github.com/input-output-hk/libsodium.git /app/src/libsodium &&\\\n  git fetch --all --tags &&\\\n  git checkout ${IOHK_LIBSODIUM_GIT_REV}\nWORKDIR /app/src/libsodium\nRUN ./autogen.sh && ./configure --build=\"$(dpkg-architecture --query DEB_BUILD_GNU_TYPE)\" && make && make install\nENV LD_LIBRARY_PATH=\"/usr/local/lib:$LD_LIBRARY_PATH\"\nENV PKG_CONFIG_PATH=\"/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH\"\n\n# Build cardano-node.\nWORKDIR /app/src/cardano-node\nRUN git clone https://github.com/input-output-hk/cardano-node.git /app/src/cardano-node &&\\\n  git fetch --all --tags &&\\\n  git checkout ${CARDANO_NODE_VERSION}\nWORKDIR /app/src/cardano-node\nRUN cabal install cardano-node \\\n  --overwrite-policy=always \\\n  --install-method=copy \\\n  --installdir=/app/bin\n\n# Pre-build latest release of ogmios, to speed up the actual image build later.\nWORKDIR /app/src/cardano-ogmios\nRUN git clone https://github.com/KtorZ/cardano-ogmios.git /app/src/cardano-ogmios &&\\\n  git fetch --all --tags &&\\\n  git checkout ${CARDANO_OGMIOS_SNAPSHOT}\nWORKDIR /app/src/cardano-ogmios/server\nRUN cabal install exe:ogmios \\\n  --overwrite-policy=always \\\n  --install-method=copy \\\n  --installdir=/app/bin\n\n#                                                                              #\n# ----------------------- BUILD (cardano-ogmios) ----------------------------- #\n#                                                                              #\n\nFROM setup as build\n\nWORKDIR /app/src/cardano-ogmios/server\n\nCOPY server/ .\n\nRUN cabal install exe:ogmios \\\n  --overwrite-policy=always \\\n  --install-method=copy \\\n  --installdir=/app/bin\n\n#                                                                              #\n# --------------------------- RUN (ogmios-only) ------------------------------ #\n#                                                                              #\n\nFROM debian:buster-slim as ogmios\n\nLABEL name=ogmios\nLABEL description=\"A JSON-WSP WebSocket client for cardano-node\"\n\nCOPY --from=build /usr/local/lib/libsodium.so.23 /usr/lib/x86_64-linux-gnu/libsodium.so.23\nCOPY --from=build /app/bin/ogmios /bin/ogmios\n\nRUN mkdir -p /etc/bash_completion.d\nRUN ogmios --bash-completion-script ogmios > /etc/bash_completion.d/ogmios\nRUN echo \"source /etc/bash_completion.d/ogmios\" >> ~/.bashrc\n\nEXPOSE 1337/tcp\nENTRYPOINT [\"ogmios\"]\n\n#                                                                              #\n# --------------------- RUN (cardano-node & ogmios) -------------------------- #\n#                                                                              #\n\nFROM debian:buster-slim as cardano-node-ogmios\n\nARG CARDANO_CONFIG_URL=https://hydra.iohk.io/build/5821110/download/1\n\nSHELL [\"/bin/bash\", \"-o\", \"pipefail\", \"-c\"]\n\nLABEL name=cardano-node-ogmios\nLABEL description=\"A JSON-WSP WebSocket client for cardano-node w/ a cardano-node\"\n\n# Ogmios, cardano-node, ekg, prometheus\nEXPOSE 1337/tcp 3000/tcp 12788/tcp 12798/tcp\n\nRUN apt-get update && apt-get install --no-install-recommends -y \\\n  wget=1.20.1-* \\\n  netbase=5.6 \\\n  ca-certificates=20200601* \\\n  && rm -rf /var/lib/apt/lists/*\nRUN apt-get -y purge && apt-get -y clean && apt-get -y autoremove\n\nCOPY --from=setup /usr/local/lib/libsodium.so.23 /usr/lib/x86_64-linux-gnu/libsodium.so.23\nCOPY --from=setup /app/bin/cardano-node /bin/cardano-node\nCOPY --from=build /app/bin/ogmios /bin/ogmios\n\nWORKDIR /config\n\nRUN wget -q ${CARDANO_CONFIG_URL}/mainnet-config.json\nRUN wget -q ${CARDANO_CONFIG_URL}/mainnet-byron-genesis.json\nRUN wget -q ${CARDANO_CONFIG_URL}/mainnet-shelley-genesis.json\nRUN wget -q ${CARDANO_CONFIG_URL}/mainnet-topology.json\n\nRUN wget -q ${CARDANO_CONFIG_URL}/testnet-config.json\nRUN wget -q ${CARDANO_CONFIG_URL}/testnet-byron-genesis.json\nRUN wget -q ${CARDANO_CONFIG_URL}/testnet-shelley-genesis.json\nRUN wget -q ${CARDANO_CONFIG_URL}/testnet-topology.json\n\nRUN find . -name \"*config*.json\" -print0 | xargs -0 sed -i 's/127.0.0.1/0.0.0.0/g' > /dev/null 2>&1\n\nWORKDIR /root\nCOPY scripts/cardano-node-ogmios.sh cardano-node-ogmios.sh\nCMD [\"bash\", \"cardano-node-ogmios.sh\" ]\n"
}