{
  "startTime": 1674253222073,
  "endTime": 1674253223175,
  "originalSmells": [
    {
      "rule": "npmCacheCleanAfterInstall",
      "position": {
        "lineStart": 15,
        "lineEnd": 15,
        "columnStart": 2,
        "columnEnd": 27
      }
    },
    {
      "rule": "npmCacheCleanAfterInstall",
      "position": {
        "lineStart": 16,
        "lineEnd": 16,
        "columnStart": 2,
        "columnEnd": 24
      }
    },
    {
      "rule": "npmCacheCleanAfterInstall",
      "position": {
        "lineStart": 30,
        "lineEnd": 30,
        "columnStart": 4,
        "columnEnd": 33
      }
    },
    {
      "rule": "npmCacheCleanAfterInstall",
      "position": {
        "lineStart": 31,
        "lineEnd": 31,
        "columnStart": 2,
        "columnEnd": 32
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "# we can not use the pre-built tar because the distribution is\n# platform specific, it makes sense to build it in the docker\n\n#### Builder\nFROM hexpm/elixir:1.13.4-erlang-24.3.3-alpine-3.15.3 as buildcontainer\n\n# preparation\nENV MIX_ENV=prod\nENV NODE_ENV=production\n\nRUN mkdir /app\nWORKDIR /app\n\n# install build dependencies\nRUN apk add --no-cache git nodejs yarn python3 npm ca-certificates wget gnupg make erlang gcc libc-dev && \\\n  npm install npm@latest -g && \\\n  npm install -g webpack && npm cache clean --force;\n\nRUN wget https://s3.eu-central-1.wasabisys.com/plausible-application/geonames.csv -q\n\nCOPY mix.exs ./\nCOPY mix.lock ./\nRUN mix local.hex --force && \\\n  mix local.rebar --force && \\\n  mix deps.get --only prod && \\\n  mix deps.compile\n\nCOPY assets/package.json assets/package-lock.json ./assets/\nCOPY tracker/package.json tracker/package-lock.json ./tracker/\n\nRUN npm install --prefix ./assets && \\\n  npm install --prefix ./tracker && npm cache clean --force;\n\nCOPY assets ./assets\nCOPY tracker ./tracker\nCOPY config ./config\nCOPY priv ./priv\nCOPY lib ./lib\n\nRUN npm run deploy --prefix ./assets && \\\n  npm run deploy --prefix ./tracker && \\\n  mix phx.digest priv/static && \\\n  mix download_country_database && \\\n  # https://hexdocs.pm/sentry/Sentry.Sources.html#module-source-code-storage\n  mix sentry_recompile && \\\n  mv geonames.csv ./priv/geonames.csv\n\nWORKDIR /app\nCOPY rel rel\nRUN mix release plausible\n\n# Main Docker Image\nFROM alpine:3.15.3\nLABEL maintainer=\"tckb <tckb@tgrthi.me>\"\n\nARG BUILD_METADATA={}\nENV BUILD_METADATA=$BUILD_METADATA\nENV LANG=C.UTF-8\n\nRUN apk upgrade --no-cache\n\nRUN apk add --no-cache openssl ncurses libstdc++ libgcc\n\nCOPY .gitlab/build-scripts/docker-entrypoint.sh /entrypoint.sh\n\nRUN chmod a+x /entrypoint.sh && \\\n  adduser -h /app -u 1000 -s /bin/sh -D plausibleuser\n\nCOPY --from=buildcontainer /app/_build/prod/rel/plausible /app\nRUN chown -R plausibleuser:plausibleuser /app\nUSER plausibleuser\nWORKDIR /app\nENV GEONAMES_SOURCE_FILE=/app/lib/plausible-0.0.1/priv/geonames.csv\nENV LISTEN_IP=0.0.0.0\nENTRYPOINT [\"/entrypoint.sh\"]\nEXPOSE 8000\nCMD [\"run\"]\n"
}