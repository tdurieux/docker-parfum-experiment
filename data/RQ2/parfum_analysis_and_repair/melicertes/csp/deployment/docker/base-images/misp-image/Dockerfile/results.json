{
  "startTime": 1674248550809,
  "endTime": 1674248552546,
  "originalSmells": [
    {
      "rule": "pipUseNoCacheDir",
      "position": {
        "lineStart": 30,
        "lineEnd": 30,
        "columnStart": 5,
        "columnEnd": 34
      }
    },
    {
      "rule": "pipUseNoCacheDir",
      "position": {
        "lineStart": 136,
        "lineEnd": 136,
        "columnStart": 4,
        "columnEnd": 29
      }
    },
    {
      "rule": "pipUseNoCacheDir",
      "position": {
        "lineStart": 142,
        "lineEnd": 142,
        "columnStart": 4,
        "columnEnd": 30
      }
    },
    {
      "rule": "pipUseNoCacheDir",
      "position": {
        "lineStart": 144,
        "lineEnd": 144,
        "columnStart": 4,
        "columnEnd": 53
      }
    },
    {
      "rule": "pipUseNoCacheDir",
      "position": {
        "lineStart": 145,
        "lineEnd": 145,
        "columnStart": 4,
        "columnEnd": 54
      }
    },
    {
      "rule": "pipUseNoCacheDir",
      "position": {
        "lineStart": 152,
        "lineEnd": 152,
        "columnStart": 4,
        "columnEnd": 35
      }
    },
    {
      "rule": "pipUseNoCacheDir",
      "position": {
        "lineStart": 153,
        "lineEnd": 153,
        "columnStart": 4,
        "columnEnd": 21
      }
    },
    {
      "rule": "pipUseNoCacheDir",
      "position": {
        "lineStart": 154,
        "lineEnd": 154,
        "columnStart": 4,
        "columnEnd": 25
      }
    },
    {
      "rule": "pipUseNoCacheDir",
      "position": {
        "lineStart": 155,
        "lineEnd": 155,
        "columnStart": 4,
        "columnEnd": 26
      }
    },
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 6,
        "lineEnd": 6,
        "columnStart": 5,
        "columnEnd": 150
      }
    },
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 13,
        "lineEnd": 13,
        "columnStart": 4,
        "columnEnd": 56
      }
    },
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 18,
        "lineEnd": 21,
        "columnStart": 4,
        "columnEnd": 66
      }
    },
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 29,
        "lineEnd": 29,
        "columnStart": 4,
        "columnEnd": 121
      }
    },
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 130,
        "lineEnd": 130,
        "columnStart": 12,
        "columnEnd": 77
      }
    },
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 134,
        "lineEnd": 134,
        "columnStart": 4,
        "columnEnd": 54
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 13,
        "lineEnd": 13,
        "columnStart": 4,
        "columnEnd": 56
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 18,
        "lineEnd": 21,
        "columnStart": 4,
        "columnEnd": 66
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 29,
        "lineEnd": 29,
        "columnStart": 4,
        "columnEnd": 121
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 130,
        "lineEnd": 130,
        "columnStart": 12,
        "columnEnd": 77
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 134,
        "lineEnd": 134,
        "columnStart": 4,
        "columnEnd": 54
      }
    },
    {
      "rule": "ruleAptGetInstallThenRemoveAptLists",
      "position": {
        "lineStart": 6,
        "lineEnd": 6,
        "columnStart": 5,
        "columnEnd": 150
      }
    },
    {
      "rule": "ruleAptGetInstallThenRemoveAptLists",
      "position": {
        "lineStart": 13,
        "lineEnd": 13,
        "columnStart": 4,
        "columnEnd": 56
      }
    },
    {
      "rule": "ruleAptGetInstallThenRemoveAptLists",
      "position": {
        "lineStart": 18,
        "lineEnd": 21,
        "columnStart": 4,
        "columnEnd": 66
      }
    },
    {
      "rule": "ruleAptGetInstallThenRemoveAptLists",
      "position": {
        "lineStart": 29,
        "lineEnd": 29,
        "columnStart": 4,
        "columnEnd": 121
      }
    },
    {
      "rule": "ruleAptGetInstallThenRemoveAptLists",
      "position": {
        "lineStart": 130,
        "lineEnd": 130,
        "columnStart": 12,
        "columnEnd": 77
      }
    },
    {
      "rule": "ruleAptGetInstallThenRemoveAptLists",
      "position": {
        "lineStart": 134,
        "lineEnd": 134,
        "columnStart": 4,
        "columnEnd": 54
      }
    }
  ],
  "repairedSmells": [
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 13,
        "lineEnd": 13,
        "columnStart": 4,
        "columnEnd": 80
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 18,
        "lineEnd": 21,
        "columnStart": 4,
        "columnEnd": 66
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 29,
        "lineEnd": 29,
        "columnStart": 4,
        "columnEnd": 145
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 130,
        "lineEnd": 130,
        "columnStart": 12,
        "columnEnd": 101
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 134,
        "lineEnd": 134,
        "columnStart": 4,
        "columnEnd": 78
      }
    }
  ],
  "repairedDockerfile": "FROM ubuntu:xenial\nMAINTAINER Christos Panagiotou\n\n# Install core components\nENV DEBIAN_FRONTEND noninteractive\nRUN apt-get update && apt-get dist-upgrade -y && apt-get autoremove -y \\\n  && apt-get install --no-install-recommends -y software-properties-common postfix mysql-client curl gcc git gnupg-agent make python openssl redis-server sudo vim zip locales && apt clean && rm -rf /var/lib/apt/lists/*;\n\nRUN locale-gen en_US.UTF-8\nENV LANG en_US.UTF-8\nRUN LC_ALL=C.UTF-8 add-apt-repository -y ppa:ondrej/php && apt-get update\n\n# Apache\nRUN apt-get install --no-install-recommends -y apache2 apache2-doc apache2-utils && rm -rf /var/lib/apt/lists/*;\nRUN a2dismod status\nRUN a2dissite 000-default\n\n# PHP 7.2\nRUN apt-get install --no-install-recommends -y libapache2-mod-php php7.2 php7.2-cli php-crypt-gpg \\\n      php7.2-dev php7.2-json php7.2-mysql php7.2-opcache \\\n      php7.2-readline php7.2-redis php7.2-xml php-pear pkg-config \\\n      libbson-1.0 libmongoc-1.0-0 php-xml php-dev php-gd php-mysql && apt clean && rm -rf /var/lib/apt/lists/*;\n\n# Fix php.ini with recommended settings\nRUN sed -i \"s/max_execution_time = 30/max_execution_time = 300/\" /etc/php/7.2/apache2/php.ini\nRUN sed -i \"s/memory_limit = 128M/memory_limit = 512M/\" /etc/php/7.2/apache2/php.ini\nRUN sed -i \"s/upload_max_filesize = 2M/upload_max_filesize = 50M/\" /etc/php/7.2/apache2/php.ini\nRUN sed -i \"s/post_max_size = 8M/post_max_size = 50M/\" /etc/php/7.2/apache2/php.ini\n\nRUN apt-get install --no-install-recommends -y python-dev python-pip libxml2-dev libxslt1-dev zlib1g-dev cron logrotate supervisor syslog-ng-core && apt-get clean \\\n  && pip install --no-cache-dir -U pip setuptools && rm -rf /var/lib/apt/lists/*;\n\nWORKDIR /var/www\nRUN chown www-data:www-data /var/www\nUSER www-data\nRUN git clone https://github.com/MISP/MISP.git\nWORKDIR /var/www/MISP\n#RUN git checkout tags/$(git describe --tags `git rev-list --tags --max-count=1`)\nRUN git checkout 2.4\nRUN git config core.filemode false\nRUN git submodule update --init --recursive\n# Make git ignore filesystem permission differences for submodules\nRUN git submodule foreach --recursive git config core.filemode false\n\nWORKDIR /var/www/MISP/app/files/scripts\nRUN git clone https://github.com/CybOXProject/python-cybox.git\nRUN git clone https://github.com/STIXProject/python-stix.git\n\nWORKDIR /var/www/MISP/app/files/scripts/python-cybox\nRUN git checkout v2.1.0.12\nUSER root\nRUN python setup.py install\n\nUSER www-data\nWORKDIR /var/www/MISP/app/files/scripts/python-stix\nRUN git checkout v1.1.1.4\nUSER root\nRUN python setup.py install\n\nUSER www-data\nWORKDIR /var/www/MISP\nRUN git submodule init\nRUN git submodule update\nWORKDIR /var/www/MISP/app\n\n\n# FIX COMPOSER\nRUN curl --fail --location -o composer-setup.php https://getcomposer.org/installer\nRUN php -r \"if (hash_file('sha384', 'composer-setup.php') === 'a5c698ffe4b8e849a443b120cd5ba38043260d5c4023dbf93e1558871f1f07f58274fc6f4c93bcfd858c6bd0775cd8d1') { echo 'Installer verified'; } else { echo 'Installer corrupt'; unlink('composer-setup.php'); } echo PHP_EOL;\"\nRUN php composer-setup.php\nRUN php -r \"unlink('composer-setup.php');\"\n# END FIX\n\nRUN php composer.phar config vendor-dir Vendor\nRUN php composer.phar install --ignore-platform-reqs\nUSER root\nRUN phpenmod redis\nUSER www-data\nRUN cp -fa /var/www/MISP/INSTALL/setup/config.php /var/www/MISP/app/Plugin/CakeResque/Config/config.php\n\n# Fix permissions\nUSER root\nRUN chown -R www-data:www-data /var/www/MISP\nRUN chmod -R 750 /var/www/MISP\nRUN chmod -R g+ws /var/www/MISP/app/tmp\nRUN chmod -R g+ws /var/www/MISP/app/files\nRUN chmod -R g+ws /var/www/MISP/app/files/scripts/tmp\n\nRUN cp /var/www/MISP/INSTALL/misp.logrotate /etc/logrotate.d/misp\n\n# Preconfigure setting for packages\nRUN echo \"postfix postfix/main_mailer_type string Local only\" | debconf-set-selections\nRUN echo \"postfix postfix/mailname string localhost.localdomain\" | debconf-set-selections\n\n# Redis Setup\nRUN sed -i 's/^\\(daemonize\\s*\\)yes\\s*$/\\1no/g' /etc/redis/redis.conf\n\n# Apache Setup\nRUN cp /var/www/MISP/INSTALL/apache.misp.ubuntu /etc/apache2/sites-available/misp.conf\nRUN sed -i -E 's/80/800/' /etc/apache2/sites-available/misp.conf\nRUN sed -i -E 's/80/800/' /etc/apache2/ports.conf\nRUN a2dissite 000-default\nRUN a2ensite misp\nRUN a2enmod rewrite\nRUN a2enmod headers\n\n# MISP base configuration\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/bootstrap.default.php /var/www/MISP/app/Config/bootstrap.php\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/database.default.php /var/www/MISP/app/Config/database.php\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/core.default.php /var/www/MISP/app/Config/core.php\nRUN sudo -u www-data cp -a /var/www/MISP/app/Config/config.default.php /var/www/MISP/app/Config/config.php\nRUN chown -R www-data:www-data /var/www/MISP/app/Config\nRUN chmod -R 750 /var/www/MISP/app/Config\n\n# Replace the default salt\nRUN sed -i -E \"s/'salt'\\s=>\\s'(\\S+)'/'salt' => '`openssl rand -base64 32|tr \"/\" \"-\"`'/\" /var/www/MISP/app/Config/config.php\n\n# Enable workers at boot time\nRUN chmod a+x /var/www/MISP/app/Console/worker/start.sh\nRUN echo \"sudo -u www-data bash /var/www/MISP/app/Console/worker/start.sh\" >>/etc/rc.local\n\n# Install templates & stuff\nWORKDIR /var/www/MISP/app/files\nRUN rm -rf misp-objects && git clone https://github.com/MISP/misp-objects.git\nRUN rm -rf misp-galaxy && git clone https://github.com/MISP/misp-galaxy.git\nRUN rm -rf warninglists && git clone https://github.com/MISP/misp-warninglists.git ./warninglists\nRUN rm -rf taxonomies && git clone https://github.com/MISP/misp-taxonomies.git ./taxonomies\nRUN chown -R www-data:www-data misp-objects misp-galaxy warninglists taxonomies\n\n# Install MISP build requirements\nRUN sudo -E apt-get -y --no-install-recommends install libpoppler58 libpoppler-dev libpoppler-cpp-dev && rm -rf /var/lib/apt/lists/*;\n\n# Install MISP Modules\nWORKDIR /opt\nRUN apt-get install --no-install-recommends -y python3 python3-pip libjpeg-dev && rm -rf /var/lib/apt/lists/*;\n# PIP3 fix\nRUN pip install --no-cache-dir --upgrade pip\n# END FIX\nRUN git clone https://github.com/MISP/misp-modules.git\nWORKDIR /opt/misp-modules\n# fix pip3 caching\nRUN echo \"[global]\" > /etc/pip.conf && echo \"no-cache-dir = false\" >> /etc/pip.conf\nRUN pip3 install --no-cache-dir --upgrade pip\nRUN cat REQUIREMENTS | sed 's/aiohttp==3.4.4/aiohttp/g' > REQUIREMENTS\nRUN pip3 install --no-cache-dir --upgrade --ignore-installed urllib3\nRUN pip3 install --no-cache-dir --upgrade --ignore-installed requests\nRUN sed -i 's/aiohttp.*/aiohttp/g' REQUIREMENTS\nRUN sed -i 's/functools.*//g' REQUIREMENTS\nRUN sed -i 's/async-timeout.*/async-timeout/g' REQUIREMENTS\nRUN sed -i 's/url-normalize.*/url-normalize/g' REQUIREMENTS\nRUN sed -i 's/^\\(yarl\\)\\=.*/\\1/g' REQUIREMENTS\nRUN sed -i 's/^\\(sigmatools\\)\\=.*/\\1/' REQUIREMENTS\nRUN pip3 install --no-cache-dir -I -r REQUIREMENTS\nRUN pip3 install --no-cache-dir -I .\nRUN pip install --no-cache-dir zmq redis\nRUN pip3 install --no-cache-dir zmq redis\nRUN echo \"sudo -u www-data misp-modules -s &\" >>/etc/rc.local\n\n# Supervisord Setup\nRUN echo '[supervisord]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'nodaemon = true' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:postfix]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'process_name = master' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'directory = /etc/postfix' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command = /usr/sbin/postfix -c /etc/postfix start' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'startsecs = 0' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'autorestart = false' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:redis-server]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command=redis-server /etc/redis/redis.conf' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:apache2]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command=/bin/bash -c \"source /etc/apache2/envvars && exec /usr/sbin/apache2 -D FOREGROUND\"' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:resque]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command=/bin/bash /var/www/MISP/app/Console/worker/start.sh' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'user = www-data' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'startsecs = 0' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'autorestart = false' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo '[program:misp-modules]' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'command=/bin/bash -c \"cd /opt/misp-modules/bin && /usr/bin/python3 misp-modules.py\"' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'user = root' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'startsecs = 0' >> /etc/supervisor/conf.d/supervisord.conf\nRUN echo 'autorestart = false' >> /etc/supervisor/conf.d/supervisord.conf\n# Modify syslog configuration\nRUN sed -i -E 's/^(\\s*)system\\(\\);/\\1unix-stream(\"\\/dev\\/log\");/' /etc/syslog-ng/syslog-ng.conf\n\n# Add run script\nADD run.sh /run.sh\nADD csp_configuration /csp_configuration\nRUN chmod 0755 /run.sh\nRUN touch /var/www/MISP/app/tmp/logs/error.log\nRUN touch /var/www/MISP/app/tmp/logs/debug.log\nRUN chmod -R 777 /var/www/MISP/app/tmp/logs/\n\n# Make a backup of /var/www/MISP to restore it to the local moint point at first boot\nWORKDIR /var/www/MISP\n\n# Add misp-objects for CSP support\nCOPY csp-misp-objects/ app/files/misp-objects/objects/\n# Final archive\nRUN tar czpf /root/MISP.tgz .\n\nRUN chown -R www-data:www-data /var/www/MISP/app/files/\nRUN chown -R www-data:www-data /var/www/MISP/app/tmp/logs/\nVOLUME [\"/var/www/MISP/app/tmp/logs\"]\n\nEXPOSE 80\nENTRYPOINT [\"/run.sh\"]\n"
}