{
  "startTime": 1674254692742,
  "endTime": 1674254693880,
  "originalSmells": [
    {
      "rule": "gpgUseBatchFlag",
      "position": {
        "lineStart": 47,
        "lineEnd": 47,
        "columnStart": 62,
        "columnEnd": 125
      }
    },
    {
      "rule": "gpgUseBatchFlag",
      "position": {
        "lineStart": 51,
        "lineEnd": 51,
        "columnStart": 74,
        "columnEnd": 136
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "#\n#====================================================================\n# Zimagi Docker image\n#\n#\n# Base image\n#\nARG ZIMAGI_PARENT_IMAGE=\"ubuntu:20.04\"\nFROM ${ZIMAGI_PARENT_IMAGE}\n#\n# Dockerfile arguments\n#\nARG ZIMAGI_USER_UID=1000\nARG ZIMAGI_USER_PASSWORD=\"zimagi\"\n\nARG ZIMAGI_CA_KEY\nARG ZIMAGI_CA_CERT\nARG ZIMAGI_KEY\nARG ZIMAGI_CERT\n\nARG ZIMAGI_DATA_KEY=\"zimagi\"\n#\n#====================================================================\n# Core system configuration\n#\n#\n# Core environment variables\n#\nENV LANG C.UTF-8\nENV PYTHONUNBUFFERED 1\nENV REQUESTS_CA_BUNDLE /etc/ssl/certs/ca-certificates.crt\n\nENV LIBGIT_VERSION 1.3.0\n#\n# Shell environment\n#\nSHELL [\"/bin/bash\", \"--login\", \"-c\"]\nRUN echo 'debconf debconf/frontend select Noninteractive' | debconf-set-selections\n#\n# Package repository management\n#\nCOPY ./docker/packages.core.txt /root/packages.core.txt\nRUN apt-get update -y \\\n    && apt-get upgrade -y \\\n    && sed '/^\\s*\\#.*$/d' /root/packages.core.txt | xargs -r apt-get install -y --no-install-recommends \\\n    && rm -rf /var/lib/apt/lists/*\n\nRUN curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --batch --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg \\\n    && echo \"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] \\\n            https://download.docker.com/linux/ubuntu/ $(lsb_release -cs) stable\" > /etc/apt/sources.list.d/docker.list\n\nRUN curl -fsSL https://repo.anaconda.com/pkgs/misc/gpgkeys/anaconda.asc | gpg --batch --dearmor -o /usr/share/keyrings/conda-archive-keyring.gpg \\\n    && echo \"deb [arch=amd64 signed-by=/usr/share/keyrings/conda-archive-keyring.gpg] \\\n            https://repo.anaconda.com/pkgs/misc/debrepo/conda stable main\" > /etc/apt/sources.list.d/conda.list\n#\n# System dependencies\n#\nCOPY ./docker/packages.app.txt /root/packages.app.txt\nRUN apt-get update -y \\\n    && sed '/^\\s*\\#.*$/d' /root/packages.app.txt | xargs -r apt-get install -y --no-install-recommends \\\n    && rm -rf /var/lib/apt/lists/*\n\nRUN wget --quiet https://github.com/libgit2/libgit2/archive/v${LIBGIT_VERSION}.tar.gz \\\n    && tar xzf v${LIBGIT_VERSION}.tar.gz \\\n    && cd libgit2-${LIBGIT_VERSION}/ \\\n    && cmake . \\\n    && make \\\n    && make install \\\n    && cd .. \\\n    && rm -Rf libgit2-${LIBGIT_VERSION}/ \\\n    && rm -f v${LIBGIT_VERSION}.tar.gz \\\n    && ldconfig\n#\n# User initialization\n#\nRUN groupadd -f --system --gid ${ZIMAGI_USER_UID} zimagi \\\n    && useradd --system --create-home \\\n        --home-dir /home/zimagi \\\n        --shell /bin/bash \\\n        --uid ${ZIMAGI_USER_UID} \\\n        --gid zimagi \\\n        --groups sudo \\\n        zimagi \\\n    && echo \"zimagi:${ZIMAGI_USER_PASSWORD}\" | chpasswd\n#\n#====================================================================\n# Python setup\n#\n#\n# Python environment variables\n#\nENV PYTHON_VERSION 3.10\n\nENV CONDA_HOME /opt/conda\nENV CONDA_BIN ${CONDA_HOME}/bin\nENV CONDA_ENV_HOME ${CONDA_HOME}/envs/zimagi\n#\n# Python environment initialization\n#\nRUN chown -R zimagi:zimagi ${CONDA_HOME}\nUSER zimagi\n\nRUN echo \"export PATH=${CONDA_BIN}:${PATH}\" >> /home/zimagi/.profile \\\n    && echo \"source ${CONDA_HOME}/etc/profile.d/conda.sh\" >> /home/zimagi/.profile\n\nRUN conda create --name zimagi python=${PYTHON_VERSION} \\\n    && echo \"conda activate zimagi\" >> /home/zimagi/.profile \\\n    && find ${CONDA_HOME}/ -follow -type f -name '*.a' -delete \\\n    && find ${CONDA_HOME}/ -follow -type f -name '*.js.map' -delete \\\n    && conda clean -afy\n#\n# Python dependencies\n#\nCOPY --chown=zimagi:zimagi ./app/requirements.txt /home/zimagi/requirements.txt\nRUN pip install --no-cache-dir -r /home/zimagi/requirements.txt\n#\n#====================================================================\n# Application configuration\n#\n#\n# Application environment variables\n#\nENV DATA_DIR /var/local/zimagi\nENV LIB_DIR /usr/local/lib/zimagi\nENV MODULE_DIR ${LIB_DIR}/modules\nENV APP_DIR /usr/local/share/zimagi\nENV PACKAGE_DIR /usr/local/share/zimagi-client\nENV KEY_DIR /var/local/keys\n#\n# Application directory\n#\nCOPY --chown=zimagi:zimagi ./app ${APP_DIR}\nVOLUME ${APP_DIR}\nWORKDIR ${APP_DIR}\n#\n# Client package\n#\nCOPY --chown=zimagi:zimagi ./package ${PACKAGE_DIR}\nVOLUME ${PACKAGE_DIR}\nRUN cd ${PACKAGE_DIR} \\\n    && cp -f ${APP_DIR}/VERSION VERSION \\\n    && rm -Rf build dist \\\n    && python setup.py sdist bdist_wheel --universal \\\n    && pip install \"dist/zimagi-`cat VERSION`-py2.py3-none-any.whl\" --no-cache-dir \\\n    && rm -f ${CONDA_ENV_HOME}/bin/zimagi\n\nUSER root\n#\n# Data directory\n#\nRUN mkdir ${DATA_DIR} && chown zimagi:zimagi ${DATA_DIR}\nVOLUME ${DATA_DIR}\n#\n# Library directory\n#\nRUN mkdir ${LIB_DIR} && chown zimagi:zimagi ${LIB_DIR}\nCOPY --chown=zimagi:zimagi ./lib/modules ${MODULE_DIR}\nVOLUME ${LIB_DIR}\n#\n# Application entrypoints and dependencies\n#\nRUN ln -s ${APP_DIR}/scripts/cli.sh /usr/local/bin/zimagi \\\n    && ln -s ${APP_DIR}/scripts/install.sh /usr/local/bin/zimagi-install \\\n    && ln -s ${APP_DIR}/scripts/gateway.sh /usr/local/bin/zimagi-gateway \\\n    && ln -s ${APP_DIR}/scripts/command.sh /usr/local/bin/zimagi-command \\\n    && ln -s ${APP_DIR}/scripts/data.sh /usr/local/bin/zimagi-data \\\n    && ln -s ${APP_DIR}/scripts/scheduler.sh /usr/local/bin/zimagi-scheduler \\\n    && ln -s ${APP_DIR}/scripts/worker.sh /usr/local/bin/zimagi-worker \\\n    && ln -s ${APP_DIR}/scripts/celery-flower.sh /usr/local/bin/celery-flower\n#\n# Application certificates\n#\nRUN ln -s ${APP_DIR}/scripts/store-key.py /usr/local/bin/store-key \\\n    && ln -s ${APP_DIR}/scripts/store-cert.py /usr/local/bin/store-cert \\\n    && store-key /etc/ssl/private/zimagi-ca.key \"${ZIMAGI_CA_KEY}\" \\\n    && store-cert /usr/local/share/ca-certificates/zimagi-ca.crt \"${ZIMAGI_CA_CERT}\" \\\n    && update-ca-certificates \\\n    && store-key /etc/ssl/private/zimagi.key \"${ZIMAGI_KEY}\" \\\n    && store-cert /etc/ssl/certs/zimagi.crt \"${ZIMAGI_CERT}\" \\\n    && chown -R zimagi:zimagi /etc/ssl/private \\\n    && chown -R zimagi:zimagi /usr/local/share/ca-certificates \\\n    && chown -R zimagi:zimagi /etc/ssl/certs\n#\n# Encryption keys\n#\nRUN mkdir ${KEY_DIR} \\\n    && echo \"${ZIMAGI_DATA_KEY}\" > \"${KEY_DIR}/data.key\" \\\n    && chown -R zimagi:zimagi ${KEY_DIR}\n#\n# Execution gateway\n#\nEXPOSE 5000\nUSER zimagi\nRUN zimagi-install\nENTRYPOINT [\"zimagi\"]\n"
}