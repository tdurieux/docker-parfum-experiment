{
  "startTime": 1674251410584,
  "endTime": 1674251411446,
  "originalSmells": [
    {
      "rule": "npmCacheCleanAfterInstall",
      "position": {
        "lineStart": 235,
        "lineEnd": 235,
        "columnStart": 4,
        "columnEnd": 37
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "FROM ubuntu:22.04\nLABEL maintainer=\"wekan\"\n\n# 2022-04-25:\n# - gyp does not yet work with Ubuntu 22.04 ubuntu:rolling,\n#   so changing to 21.10. https://github.com/wekan/wekan/issues/4488\n\n# 2021-09-18:\n# - Above Ubuntu base image copied from Docker Hub ubuntu:hirsute-20210825\n#   to Quay to avoid Docker Hub rate limits.\n\n# Set the environment variables (defaults where required)\n# DOES NOT WORK: paxctl fix for alpine linux: https://github.com/wekan/wekan/issues/1303\n# ENV BUILD_DEPS=\"paxctl\"\nARG DEBIAN_FRONTEND=noninteractive\n\nENV BUILD_DEPS=\"apt-utils libarchive-tools gnupg gosu wget curl bzip2 g++ build-essential git ca-certificates python3\" \\\n    DEBUG=false \\\n    NODE_VERSION=v14.20.0 \\\n    METEOR_RELEASE=1.10.2 \\\n    USE_EDGE=false \\\n    METEOR_EDGE=1.5-beta.17 \\\n    NPM_VERSION=latest \\\n    FIBERS_VERSION=4.0.1 \\\n    ARCHITECTURE=linux-x64 \\\n    SRC_PATH=./ \\\n    WITH_API=true \\\n    RESULTS_PER_PAGE=\"\" \\\n    ACCOUNTS_LOCKOUT_KNOWN_USERS_FAILURES_BEFORE=3 \\\n    ACCOUNTS_LOCKOUT_KNOWN_USERS_PERIOD=60 \\\n    ACCOUNTS_LOCKOUT_KNOWN_USERS_FAILURE_WINDOW=15 \\\n    ACCOUNTS_LOCKOUT_UNKNOWN_USERS_FAILURES_BERORE=3 \\\n    ACCOUNTS_LOCKOUT_UNKNOWN_USERS_LOCKOUT_PERIOD=60 \\\n    ACCOUNTS_LOCKOUT_UNKNOWN_USERS_FAILURE_WINDOW=15 \\\n    ACCOUNTS_COMMON_LOGIN_EXPIRATION_IN_DAYS=90 \\\n    RICHER_CARD_COMMENT_EDITOR=false \\\n    CARD_OPENED_WEBHOOK_ENABLED=false \\\n    MAX_IMAGE_PIXEL=\"\" \\\n    IMAGE_COMPRESS_RATIO=\"\" \\\n    NOTIFICATION_TRAY_AFTER_READ_DAYS_BEFORE_REMOVE=\"\" \\\n    BIGEVENTS_PATTERN=NONE \\\n    NOTIFY_DUE_DAYS_BEFORE_AND_AFTER=\"\" \\\n    NOTIFY_DUE_AT_HOUR_OF_DAY=\"\" \\\n    EMAIL_NOTIFICATION_TIMEOUT=30000 \\\n    MATOMO_ADDRESS=\"\" \\\n    MATOMO_SITE_ID=\"\" \\\n    MATOMO_DO_NOT_TRACK=true \\\n    MATOMO_WITH_USERNAME=false \\\n    BROWSER_POLICY_ENABLED=true \\\n    TRUSTED_URL=\"\" \\\n    WEBHOOKS_ATTRIBUTES=\"\" \\\n    OAUTH2_ENABLED=false \\\n    OIDC_REDIRECTION_ENABLED=false \\\n    OAUTH2_CA_CERT=\"\" \\\n    OAUTH2_ADFS_ENABLED=false \\\n    OAUTH2_LOGIN_STYLE=redirect \\\n    OAUTH2_CLIENT_ID=\"\" \\\n    OAUTH2_SECRET=\"\" \\\n    OAUTH2_SERVER_URL=\"\" \\\n    OAUTH2_AUTH_ENDPOINT=\"\" \\\n    OAUTH2_USERINFO_ENDPOINT=\"\" \\\n    OAUTH2_TOKEN_ENDPOINT=\"\" \\\n    OAUTH2_ID_MAP=\"\" \\\n    OAUTH2_USERNAME_MAP=\"\" \\\n    OAUTH2_FULLNAME_MAP=\"\" \\\n    OAUTH2_ID_TOKEN_WHITELIST_FIELDS=\"\" \\\n    OAUTH2_REQUEST_PERMISSIONS='openid profile email' \\\n    OAUTH2_EMAIL_MAP=\"\" \\\n    LDAP_ENABLE=false \\\n    LDAP_PORT=389 \\\n    LDAP_HOST=\"\" \\\n    LDAP_AD_SIMPLE_AUTH=\"\" \\\n    LDAP_USER_AUTHENTICATION=false \\\n    LDAP_USER_AUTHENTICATION_FIELD=uid \\\n    LDAP_BASEDN=\"\" \\\n    LDAP_LOGIN_FALLBACK=false \\\n    LDAP_RECONNECT=true \\\n    LDAP_TIMEOUT=10000 \\\n    LDAP_IDLE_TIMEOUT=10000 \\\n    LDAP_CONNECT_TIMEOUT=10000 \\\n    LDAP_AUTHENTIFICATION=false \\\n    LDAP_AUTHENTIFICATION_USERDN=\"\" \\\n    LDAP_AUTHENTIFICATION_PASSWORD=\"\" \\\n    LDAP_LOG_ENABLED=false \\\n    LDAP_BACKGROUND_SYNC=false \\\n    LDAP_BACKGROUND_SYNC_INTERVAL=\"\" \\\n    LDAP_BACKGROUND_SYNC_KEEP_EXISTANT_USERS_UPDATED=false \\\n    LDAP_BACKGROUND_SYNC_IMPORT_NEW_USERS=false \\\n    LDAP_ENCRYPTION=false \\\n    LDAP_CA_CERT=\"\" \\\n    LDAP_REJECT_UNAUTHORIZED=false \\\n    LDAP_USER_SEARCH_FILTER=\"\" \\\n    LDAP_USER_SEARCH_SCOPE=\"\" \\\n    LDAP_USER_SEARCH_FIELD=\"\" \\\n    LDAP_SEARCH_PAGE_SIZE=0 \\\n    LDAP_SEARCH_SIZE_LIMIT=0 \\\n    LDAP_GROUP_FILTER_ENABLE=false \\\n    LDAP_GROUP_FILTER_OBJECTCLASS=\"\" \\\n    LDAP_GROUP_FILTER_GROUP_ID_ATTRIBUTE=\"\" \\\n    LDAP_GROUP_FILTER_GROUP_MEMBER_ATTRIBUTE=\"\" \\\n    LDAP_GROUP_FILTER_GROUP_MEMBER_FORMAT=\"\" \\\n    LDAP_GROUP_FILTER_GROUP_NAME=\"\" \\\n    LDAP_UNIQUE_IDENTIFIER_FIELD=\"\" \\\n    LDAP_UTF8_NAMES_SLUGIFY=true \\\n    LDAP_USERNAME_FIELD=\"\" \\\n    LDAP_FULLNAME_FIELD=\"\" \\\n    LDAP_MERGE_EXISTING_USERS=false \\\n    LDAP_EMAIL_FIELD=\"\" \\\n    LDAP_EMAIL_MATCH_ENABLE=false \\\n    LDAP_EMAIL_MATCH_REQUIRE=false \\\n    LDAP_EMAIL_MATCH_VERIFIED=false \\\n    LDAP_SYNC_USER_DATA=false \\\n    LDAP_SYNC_USER_DATA_FIELDMAP=\"\" \\\n    LDAP_SYNC_GROUP_ROLES=\"\" \\\n    LDAP_DEFAULT_DOMAIN=\"\" \\\n    LDAP_SYNC_ADMIN_STATUS=\"\" \\\n    LDAP_SYNC_ADMIN_GROUPS=\"\" \\\n    HEADER_LOGIN_ID=\"\" \\\n    HEADER_LOGIN_FIRSTNAME=\"\" \\\n    HEADER_LOGIN_LASTNAME=\"\" \\\n    HEADER_LOGIN_EMAIL=\"\" \\\n    LOGOUT_WITH_TIMER=false \\\n    LOGOUT_IN=\"\" \\\n    LOGOUT_ON_HOURS=\"\" \\\n    LOGOUT_ON_MINUTES=\"\" \\\n    CORS=\"\" \\\n    CORS_ALLOW_HEADERS=\"\" \\\n    CORS_EXPOSE_HEADERS=\"\" \\\n    DEFAULT_AUTHENTICATION_METHOD=\"\" \\\n    PASSWORD_LOGIN_ENABLED=true \\\n    CAS_ENABLED=false \\\n    CAS_BASE_URL=\"\" \\\n    CAS_LOGIN_URL=\"\" \\\n    CAS_VALIDATE_URL=\"\" \\\n    SAML_ENABLED=false \\\n    SAML_PROVIDER=\"\" \\\n    SAML_ENTRYPOINT=\"\" \\\n    SAML_ISSUER=\"\" \\\n    SAML_CERT=\"\" \\\n    SAML_IDPSLO_REDIRECTURL=\"\" \\\n    SAML_PRIVATE_KEYFILE=\"\" \\\n    SAML_PUBLIC_CERTFILE=\"\" \\\n    SAML_IDENTIFIER_FORMAT=\"\" \\\n    SAML_LOCAL_PROFILE_MATCH_ATTRIBUTE=\"\" \\\n    SAML_ATTRIBUTES=\"\" \\\n    ORACLE_OIM_ENABLED=false \\\n    WAIT_SPINNER=\"\" \\\n    NODE_OPTIONS=\"--max_old_space_size=4096\" \\\n    WRITABLE_PATH=/data\n\n#---------------------------------------------\n# == at docker-compose.yml: AUTOLOGIN WITH OIDC/OAUTH2 ====\n# https://github.com/wekan/wekan/wiki/autologin\n#- OIDC_REDIRECTION_ENABLED=true\n#---------------------------------------------------------------------\n# https://github.com/wekan/wekan/issues/3585#issuecomment-1021522132\n# Add more Node heap:\n#   NODE_OPTIONS=\"--max_old_space_size=4096\"\n# Add more stack:\n#   bash -c \"ulimit -s 65500; exec node --stack-size=65500 main.js\"\n#---------------------------------------------------------------------\n\n# Copy the app to the image\nCOPY ${SRC_PATH} /home/wekan/app\n\nRUN \\\n    set -o xtrace && \\\n    # Add non-root user wekan\n    useradd --user-group --system --home-dir /home/wekan wekan && \\\n    \\\n    # OS dependencies\n    apt-get update -y && apt-get install -y --no-install-recommends ${BUILD_DEPS} && \\\n    #pip3 install -U pip setuptools wheel && \\\n    \\\n    # Meteor installer doesn't work with the default tar binary, so using bsdtar while installing.\n    # https://github.com/coreos/bugs/issues/1095#issuecomment-350574389\n    cp $(which tar) $(which tar)~ && \\\n    ln -sf $(which bsdtar) $(which tar) && \\\n    \\\n    # Download nodejs\n    wget https://nodejs.org/dist/${NODE_VERSION}/node-${NODE_VERSION}-${ARCHITECTURE}.tar.gz && \\\n    wget https://nodejs.org/dist/${NODE_VERSION}/SHASUMS256.txt.asc && \\\n    #---------------------------------------------------------------------------------------------\n    # Node Fibers 100% CPU usage issue:\n    # https://github.com/wekan/wekan-mongodb/issues/2#issuecomment-381453161\n    # https://github.com/meteor/meteor/issues/9796#issuecomment-381676326\n    # https://github.com/sandstorm-io/sandstorm/blob/0f1fec013fe7208ed0fd97eb88b31b77e3c61f42/shell/server/00-startup.js#L99-L129\n    # Also see beginning of wekan/server/authentication.js\n    #   import Fiber from \"fibers\";\n    #   Fiber.poolSize = 1e9;\n    # OLD: Download node version 8.12.0 prerelease that has fix included, => Official 8.12.0 has been released\n    # Description at https://releases.wekan.team/node.txt\n    #wget https://releases.wekan.team/node-${NODE_VERSION}-${ARCHITECTURE}.tar.gz && \\\n    #echo \"1ed54adb8497ad8967075a0b5d03dd5d0a502be43d4a4d84e5af489c613d7795  node-v8.12.0-linux-x64.tar.gz\" >> SHASUMS256.txt.asc && \\\n    \\\n    # Verify nodejs authenticity\n    grep ${NODE_VERSION}-${ARCHITECTURE}.tar.gz SHASUMS256.txt.asc | shasum -a 256 -c - && \\\n    #export GNUPGHOME=\"$(mktemp -d)\" && \\\n    #\\\n    # Try other key servers if ha.pool.sks-keyservers.net is unreachable\n    # Code from https://github.com/chorrell/docker-node/commit/2b673e17547c34f17f24553db02beefbac98d23c\n    # gpg keys listed at https://github.com/nodejs/node#release-team\n    # and keys listed here from previous version of this Dockerfile\n    #for key in \\\n    #9554F04D7259F04124DE6B476D5A82AC7E37093B \\\n    #94AE36675C464D64BAFA68DD7434390BDBE9B9C5 \\\n    #FD3A5288F042B6850C66B31F09FE44734EB7990E \\\n    #71DCFD284A79C3B38668286BC97EC7A07EDE3FC1 \\\n    #DD8F2338BAE7501E3DD5AC78C273792F7D83545D \\\n    #C4F0DFFF4E8C1A8236409D08E73BC641CC11F4C8 \\\n    #B9AE9905FFD7803F25714661B63B535A4C206CA9 \\\n    #; do \\\n    #gpg --keyserver ha.pool.sks-keyservers.net --recv-keys \"$key\" || \\\n    #gpg --keyserver pgp.mit.edu --recv-keys \"$key\" || \\\n    #gpg --keyserver keyserver.pgp.com --recv-keys \"$key\" ; \\\n    #done && \\\n    #gpg --verify SHASUMS256.txt.asc && \\\n    # Ignore socket files then delete files then delete directories\n    #find \"$GNUPGHOME\" -type f | xargs rm -f && \\\n    #find \"$GNUPGHOME\" -type d | xargs rm -fR && \\\n    rm -f SHASUMS256.txt.asc && \\\n    \\\n    # Install Node\n    tar xvzf node-${NODE_VERSION}-${ARCHITECTURE}.tar.gz && \\\n    rm node-${NODE_VERSION}-${ARCHITECTURE}.tar.gz && \\\n    mv node-${NODE_VERSION}-${ARCHITECTURE} /opt/nodejs && \\\n    ln -s /opt/nodejs/bin/node /usr/bin/node && \\\n    ln -s /opt/nodejs/bin/npm /usr/bin/npm && \\\n    mkdir -p /opt/nodejs/lib/node_modules/fibers/.node-gyp /root/.node-gyp/${NODE_VERSION} /home/wekan/.config && \\\n    chown wekan --recursive /home/wekan/.config && \\\n    \\\n    #DOES NOT WORK: paxctl fix for alpine linux: https://github.com/wekan/wekan/issues/1303\n    #paxctl -mC `which node` && \\\n    \\\n    # Install Node dependencies. Python path for node-gyp.\n    npm install -g npm@${NPM_VERSION} && \\\n    #npm config set python python2.7 && \\\n    #npm install -g node-gyp && \\\n    #npm install -g fibers@${FIBERS_VERSION} && \\\n    \\\n    # Change user to wekan and install meteor\n    cd /home/wekan/ && \\\n    chown wekan --recursive /home/wekan && \\\n    #curl \"https://install.meteor.com\" -o /home/wekan/install_meteor.sh && \\\n    #curl \"https://install.meteor.com/?release=${METEOR_RELEASE}\" -o /home/wekan/install_meteor.sh && \\\n    # OLD: sed -i \"s|RELEASE=.*|RELEASE=${METEOR_RELEASE}\\\"\\\"|g\" ./install_meteor.sh && \\\n    # Install Meteor forcing its progress\n    #sed -i 's/VERBOSITY=\"--silent\"/VERBOSITY=\"--progress-bar\"/' ./install_meteor.sh && \\\n    echo \"Starting meteor ${METEOR_RELEASE} installation...   \\n\" && \\\n    gosu wekan:wekan curl https://install.meteor.com/ | /bin/sh && \\\n    mv /root/.meteor /home/wekan/ && \\\n    chown wekan --recursive /home/wekan/.meteor && \\\n    \\\n    # Check if opting for a release candidate instead of major release\n    #if [ \"$USE_EDGE\" = false ]; then \\\n      #gosu wekan:wekan sh /home/wekan/install_meteor.sh; \\\n    #  gosu wekan:wekan curl https://install.meteor.com/ | sh; \\\n    #else \\\n    #  gosu wekan:wekan git clone --recursive --depth 1 -b release/METEOR@${METEOR_EDGE} https://github.com/meteor/meteor.git /home/wekan/.meteor; \\\n    #fi; \\\n    #\\\n    # Get additional packages\n    #mkdir -p /home/wekan/app/packages && \\\n    #chown wekan:wekan --recursive /home/wekan && \\\n    # REPOS BELOW ARE INCLUDED TO WEKAN REPO\n    #cd /home/wekan/app/packages && \\\n    #gosu wekan:wekan git clone --depth 1 -b master https://github.com/wekan/flow-router.git kadira-flow-router && \\\n    #gosu wekan:wekan git clone --depth 1 -b master https://github.com/meteor-useraccounts/core.git meteor-useraccounts-core && \\\n    #gosu wekan:wekan git clone --depth 1 -b master https://github.com/wekan/meteor-accounts-cas.git && \\\n    #gosu wekan:wekan git clone --depth 1 -b master https://github.com/wekan/wekan-ldap.git && \\\n    #gosu wekan:wekan git clone --depth 1 -b master https://github.com/wekan/wekan-scrollbar.git && \\\n    #gosu wekan:wekan git clone --depth 1 -b master https://github.com/wekan/meteor-accounts-oidc.git && \\\n    #gosu wekan:wekan git clone --depth 1 -b master --recurse-submodules https://github.com/wekan/markdown.git && \\\n    #gosu wekan:wekan mv meteor-accounts-oidc/packages/switch_accounts-oidc wekan-accounts-oidc && \\\n    #gosu wekan:wekan mv meteor-accounts-oidc/packages/switch_oidc wekan-oidc && \\\n    #gosu wekan:wekan rm -rf meteor-accounts-oidc && \\\n    sed -i 's/api\\.versionsFrom/\\/\\/api.versionsFrom/' /home/wekan/app/packages/meteor-useraccounts-core/package.js && \\\n    cd /home/wekan/.meteor && \\\n    gosu wekan:wekan /home/wekan/.meteor/meteor -- help; npm cache clean --force; \\\n\n    # extract the OpenAPI specification\n    #npm install -g api2html@0.3.3 && \\\n    #mkdir -p /home/wekan/python && \\\n    #chown wekan --recursive /home/wekan/python && \\\n    #cd /home/wekan/python && \\\n    #gosu wekan:wekan git clone --depth 1 -b master https://github.com/Kronuz/esprima-python && \\\n    #cd /home/wekan/python/esprima-python && \\\n    #python3 setup.py install --record files.txt && \\\n    #cd /home/wekan/app && \\\n    #mkdir -p /home/wekan/app/public/api && \\\n    #chown wekan --recursive /home/wekan/app && \\\n    #gosu wekan:wekan python3 ./openapi/generate_openapi.py --release $(git describe --tags --abbrev=0) > ./public/api/wekan.yml && \\\n    #gosu wekan:wekan /opt/nodejs/bin/api2html -c ./public/logo-header.png -o ./public/api/wekan.html ./public/api/wekan.yml; \\\n    # Build app\n    cd /home/wekan/app && \\\n    mkdir -p /home/wekan/.npm && \\\n    chown wekan --recursive /home/wekan/.npm /home/wekan/.config /home/wekan/.meteor && \\\n    #gosu wekan:wekan /home/wekan/.meteor/meteor add standard-minifier-js && \\\n    chmod u+w *.json && \\\n    gosu wekan:wekan npm install && \\\n    gosu wekan:wekan /home/wekan/.meteor/meteor build --directory /home/wekan/app_build && \\\n    #rm /home/wekan/app_build/bundle/programs/server/npm/node_modules/meteor/rajit_bootstrap3-datepicker/lib/bootstrap-datepicker/node_modules/phantomjs-prebuilt/lib/phantom/bin/phantomjs && \\\n    #Removed binary version of bcrypt because of security vulnerability that is not fixed yet.\n    #https://github.com/wekan/wekan/commit/4b2010213907c61b0e0482ab55abb06f6a668eac\n    #https://github.com/wekan/wekan/commit/7eeabf14be3c63fae2226e561ef8a0c1390c8d3c\n    #cd /home/wekan/app_build/bundle/programs/server/npm/node_modules/meteor/npm-bcrypt && \\\n    #gosu wekan:wekan rm -rf node_modules/bcrypt && \\\n    #gosu wekan:wekan npm install bcrypt && \\\n    #\n    # Delete phantomjs\n    #cd /home/wekan/app_build/bundle && \\\n    #find . -name \"*phantomjs*\" | xargs rm -rf && \\\n    #\n    cd /home/wekan/app_build/bundle/programs/server/ && \\\n    chmod u+w *.json && \\\n    gosu wekan:wekan npm install && \\\n    cd node_modules/fibers && \\\n    node build.js && \\\n    cd ../.. && \\\n    #gosu wekan:wekan npm install bcrypt && \\\n    # Remove legacy webbroser bundle, so that Wekan works also at Android Firefox, iOS Safari, etc.\n    rm -rf /home/wekan/app_build/bundle/programs/web.browser.legacy && \\\n    mv /home/wekan/app_build/bundle /build && \\\n    \\\n    # Put back the original tar\n    mv $(which tar)~ $(which tar) && \\\n    \\\n    # Cleanup\n    apt-get remove --purge -y ${BUILD_DEPS} && \\\n    apt-get autoremove -y && \\\n    npm uninstall -g api2html &&\\\n    rm -R /tmp/* && \\\n    rm -R /var/lib/apt/lists/* && \\\n    rm -R /home/wekan/.meteor && \\\n    rm -R /home/wekan/app && \\\n    rm -R /home/wekan/app_build && \\\n    mkdir /data && \\\n    chown wekan --recursive /data\n    #cat /home/wekan/python/esprima-python/files.txt | xargs rm -R && \\\n    #rm -R /home/wekan/python\n    #rm /home/wekan/install_meteor.sh\n\nENV PORT=8080\nEXPOSE $PORT\nUSER wekan\n\n#---------------------------------------------------------------------\n# https://github.com/wekan/wekan/issues/3585#issuecomment-1021522132\n# Add more Node heap:\n#   NODE_OPTIONS=\"--max_old_space_size=4096\"\n# Add more stack:\n#   bash -c \"ulimit -s 65500; exec node --stack-size=65500 main.js\"\n#---------------------------------------------------------------------\n#\n# CMD [\"node\", \"/build/main.js\"]\n\nCMD [\"bash\", \"-c\", \"ulimit -s 65500; exec node --stack-size=65500 /build/main.js\"]\n"
}