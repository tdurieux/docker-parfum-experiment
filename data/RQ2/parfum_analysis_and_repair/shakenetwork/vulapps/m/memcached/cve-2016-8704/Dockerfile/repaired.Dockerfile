FROM ubuntu:16.04
MAINTAINER xiao-xing <xiao_xing@hansight.com>

# ADD sources.list /etc/apt/sources.list

RUN apt-get update
RUN apt-get install --no-install-recommends -y gcc make wget libevent-dev libc6-dev perl && rm -rf /var/lib/apt/lists/*;

WORKDIR /opt
RUN apt-get remove -y libmemcached-dev \
    && apt-get -y autoremove \
    && apt-get install --no-install-recommends -y libsasl2-dev build-essential \
    && wget -qO /opt/libmemcached.tar.gz https://launchpad.net/libmemcached/1.0/1.0.18/+download/libmemcached-1.0.18.tar.gz \
    && tar zxf libmemcached.tar.gz \
    && cd libmemcached-1.0.18/ \
    && ./configure --build="$(dpkg-architecture --query DEB_BUILD_GNU_TYPE)" --enable-sasl \
    && make \
    && make install && rm libmemcached.tar.gz && rm -rf /var/lib/apt/lists/*;

RUN wget https://www.memcached.org/files/memcached-1.4.31.tar.gz \
    && tar zxvf memcached-1.4.31.tar.gz && rm memcached-1.4.31.tar.gz

WORKDIR /opt/memcached-1.4.31
RUN ./configure --build="$(dpkg-architecture --query DEB_BUILD_GNU_TYPE)" --enable-sasl \
    && make \
    # && make test \
    && make install

RUN groupadd -r memcache \
    && useradd -r -g memcache memcache

COPY valgrind.sh /valgrind.sh
RUN apt-get install --no-install-recommends -y valgrind \
    && chmod a+x /valgrind.sh && rm -rf /var/lib/apt/lists/*;

USER memcache

EXPOSE 11211

CMD ["./memcached", "-vv"]
