FROM ubuntu:18.04 AS builder

RUN export DEBIAN_FRONTEND="noninteractive" && \
    apt-get update -qq && \
    apt-get install --no-install-recommends -y build-essential autotools-dev automake autoconf libtool git libssl-dev && rm -rf /var/lib/apt/lists/*;

WORKDIR /sthttpd
RUN git clone https://github.com/blueness/sthttpd . && \
    git checkout c0dc63a49d8605649f1d8e4a96c9b468b0bff660 && \
    git checkout HEAD^

RUN ./autogen.sh && ./configure --build="$(dpkg-architecture --query DEB_BUILD_GNU_TYPE)" && make

FROM ubuntu:18.04

RUN apt-get update && \
    apt-get install --no-install-recommends -y libssl1.1 libc6-dbg && \
    apt-get clean all && rm -rf /var/lib/apt/lists/*;

WORKDIR /fuzz
COPY --from=builder /sthttpd/src/thttpd .
