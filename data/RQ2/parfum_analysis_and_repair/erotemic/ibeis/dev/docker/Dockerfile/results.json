{
  "startTime": 1674217450881,
  "endTime": 1674217453445,
  "originalSmells": [
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 5,
        "lineEnd": 33,
        "columnStart": 22,
        "columnEnd": 30
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "FROM nvidia/cuda:9.1-cudnn7-devel-ubuntu16.04 as com.wildme.wildbook-image-curation.base\n\nMAINTAINER Jason Parham <parham@wildme.org>\n\n# Install apt packages\nRUN apt-get update && apt-get install --no-install-recommends -y \\\n    build-essential \\\n    ca-certificates \\\n    cmake=3.5.1-1ubuntu3 \\\n    git=1:2.7.4-0ubuntu1.3 \\\n    tmux=2.1-3build1 \\\n    ipython=2.4.1-1 \\\n    ipython3=2.4.1-1 \\\n    python=2.7.12-1~16.04 \\\n    python-dev=2.7.12-1~16.04 \\\n    python-pip=8.1.1-2ubuntu0.4 \\\n    python3=3.5.1-3 \\\n    python3-dev=3.5.1-3 \\\n    python3-pip=8.1.1-2ubuntu0.4 \\\n    graphviz=2.38.0-12ubuntu2.1 \\\n    graphviz-dev=2.38.0-12ubuntu2.1 \\\n    libeigen3-dev=3.3~beta1-2 \\\n    libfreetype6-dev=2.6.1-0.1ubuntu2.3 \\\n    libgdal-dev=1.11.3+dfsg-3build2 \\\n    libgl1-mesa-glx=17.2.8-0ubuntu0~16.04.1 \\\n    libgoogle-glog-dev=0.3.4-0.1 \\\n    libharfbuzz-dev=1.0.1-1ubuntu0.1 \\\n    libhdf5-dev=1.8.16+docs-4ubuntu1 \\\n    liblapack-dev=3.6.0-2ubuntu2 \\\n    liblapacke-dev=3.6.0-2ubuntu2 \\\n    libleptonica-dev=1.73-1 \\\n    libopenblas-dev=0.2.18-1ubuntu1 \\\n    libtbb-dev=4.4~20151115-0ubuntu3 \\\n    libtesseract-dev=3.04.01-4 \\\n    && rm -rf /var/lib/apt/lists/*\n\n# Install CNMeM\nRUN git clone https://github.com/NVIDIA/cnmem.git /src/cnmem \\\n    && cd /src/cnmem/ \\\n    && git checkout v1.0.0 \\\n    && mkdir -p /src/cnmem/build \\\n    && cd /src/cnmem/build \\\n    && cmake .. \\\n    && make -j4 \\\n    && make install \\\n    && cd .. \\\n    && rm -rf /src/cnmem\n\n# Install virtualenv PyPI package\nRUN /usr/bin/pip3 install \\\n    virtualenv==15.2.0\n\n# Create virtualenv location\nRUN mkdir -p /virtualenv\n\n# Create virtualenvs for Python2 and Python3\nRUN    virtualenv -p $(which python2) /virtualenv/env2 \\\n    && virtualenv -p $(which python3) /virtualenv/env3\n\n# Set CUDA-specific environment paths\nENV PATH \"/usr/local/cuda/bin:${PATH}\"\n\nENV LD_LIBRARY_PATH \"/usr/local/cuda/lib64:${LD_LIBRARY_PATH}\"\n\nENV CUDA_HOME \"/usr/local/cuda\"\n\n##########################################################################################\nFROM com.wildme.wildbook-image-curation.base as com.wildme.wildbook-image-curation.build\n\nRUN mkdir -p /root/.ssh\n\n# Add deploy keys and SSH keys for Github with this container\nADD dev/keys/deploy-ibeis /root/.ssh/deploy-ibeis\n\nADD dev/keys/deploy-ibeis_cnn /root/.ssh/deploy-ibeis_cnn\n\nADD dev/keys/deploy-ibeis-flukematch-module /root/.ssh/deploy-ibeis-flukematch-module\n\nADD dev/keys/deploy-ibeis-curvrank-module /root/.ssh/deploy-ibeis-curvrank-module\n\nRUN ssh-keyscan github.com >> /root/.ssh/known_hosts\n\nRUN echo \"\"\"\\n\\\nHost ibeis.github.com\\n\\\nHostName github.com\\n\\\nIdentityFile /root/.ssh/deploy-ibeis\\n\\\nUser git\\n\\n\\\nHost ibeis_cnn.github.com\\n\\\nHostName github.com\\n\\\nIdentityFile /root/.ssh/deploy-ibeis_cnn\\n\\\nUser git\\n\\n\\\nHost ibeis-flukematch-module.github.com\\n\\\nHostName github.com\\n\\\nIdentityFile /root/.ssh/deploy-ibeis-flukematch-module\\n\\\nUser git\\n\\n\\\nHost ibeis-curvrank-module.github.com\\n\\\nHostName github.com\\n\\\nIdentityFile /root/.ssh/deploy-ibeis-curvrank-module\\n\\\nUser git\\\n\"\"\" >> /root/.ssh/config\n\nRUN chmod -R 600 /root/.ssh/\n\n# Clone\nRUN    git clone https://github.com/opencv/opencv.git               /ibeis/opencv \\\n    && git clone https://github.com/opencv/opencv_contrib.git       /ibeis/opencv_contrib \\\n    && git clone https://github.com/Theano/libgpuarray.git          /ibeis/libgpuarray \\\n    && git clone https://github.com/Theano/Theano.git               /ibeis/Theano \\\n    && git clone https://github.com/Lasagne/Lasagne.git             /ibeis/Lasagne \\\n    && git clone https://github.com/networkx/networkx.git           /ibeis/networkx \\\n    && git clone https://github.com/WildbookOrg/utool.git           /ibeis/utool \\\n    && git clone https://github.com/WildbookOrg/ubelt.git           /ibeis/ubelt\n\nRUN    git clone git@ibeis.github.com:WildbookOrg/ibeis.git         /ibeis/ibeis \\\n    && git clone git@ibeis_cnn.github.com:WildbookOrg/ibeis_cnn.git /ibeis/ibeis_cnn \\\n    && git clone git@ibeis-flukematch-module.github.com:WildbookOrg/ibeis-flukematch-module.git /ibeis/ibeis-flukematch-module \\\n    && git clone git@ibeis-curvrank-module.github.com:WildbookOrg/ibeis-curvrank-module.git /ibeis/ibeis-curvrank-module\n\n# Build and install utool and ubelt\nRUN cd /ibeis/utool \\\n    && /virtualenv/env3/bin/pip install -e . \\\n    && cd /ibeis/ubelt \\\n    && /virtualenv/env3/bin/pip install -e .\n\n# Clone all other public ibeis repositories and update\nRUN cd /ibeis/ibeis \\\n    && /virtualenv/env3/bin/python super_setup.py --pull \\\n    && /virtualenv/env3/bin/python super_setup.py --checkout next \\\n    && /virtualenv/env3/bin/python super_setup.py --pull\n\n# Install Numpy to Python2 environment for OpenCV build\nRUN /virtualenv/env2/bin/pip install \\\n    numpy==1.14.2\n\n# Install basic Python3 dependencies (and ones that were missing in IBEIS install)\nRUN /virtualenv/env3/bin/pip install \\\n    numpy==1.14.2\n\n# Install OpenCV\nRUN    cd /ibeis/opencv \\\n    && git checkout 3.4.0 \\\n    && cd /ibeis/opencv_contrib \\\n    && git checkout 3.4.0 \\\n    && mkdir -p /ibeis/opencv/build \\\n    && cd /ibeis/opencv/build \\\n    && cmake -j4 \\\n        -D CMAKE_BUILD_TYPE=RELEASE \\\n        -D CMAKE_INSTALL_PREFIX=/virtualenv/env3 \\\n        -D BUILD_TBB=ON \\\n        -D BUILD_EXAMPLES=OFF \\\n        -D BUILD_opencv_java=OFF \\\n        -D WITH_MATLAB=OFF \\\n        -D WITH_TBB=ON \\\n        -D WITH_CUDA=ON \\\n        -D WITH_CUBLAS=1 \\\n        -D WITH_GDAL=ON \\\n        -D PYTHON2_LIBRARY=/usr/lib/python2.7/config-x86_64-linux-gnu/libpython2.7.so \\\n        -D PYTHON2_INCLUDE_DIR=/virtualenv/env2/include/python2.7 \\\n        -D PYTHON2_EXECUTABLE=/virtualenv/env2/bin/python \\\n        -D PYTHON2_PACKAGES_PATH=/virtualenv/env2/lib/python2.7/site-packages \\\n        -D PYTHON2_NUMPY_INCLUDE_DIRS=/virtualenv/env2/lib/python2.7/site-packages/numpy/core/include \\\n        -D PYTHON3_LIBRARY=/usr/lib/python3.5/config-3.5m-x86_64-linux-gnu/libpython3.5m.so \\\n        -D PYTHON3_INCLUDE_DIR=/virtualenv/env3/include/python3.5m \\\n        -D PYTHON3_EXECUTABLE=/virtualenv/env3/bin/python \\\n        -D PYTHON3_PACKAGES_PATH=/virtualenv/env3/lib/python3.5/site-packages \\\n        -D PYTHON3_NUMPY_INCLUDE_DIRS=/virtualenv/env3/lib/python3.5/site-packages/numpy/core/include \\\n        -D ENABLE_FAST_MATH=1 \\\n        -D CUDA_FAST_MATH=1 \\\n        -D INSTALL_C_EXAMPLES=OFF \\\n        -D INSTALL_PYTHON_EXAMPLES=OFF \\\n        -D OPENCV_EXTRA_MODULES_PATH=/ibeis/opencv_contrib/modules \\\n        .. \\\n    && make -j4 \\\n    && make install \\\n    && cd .. \\\n    && rm -rf /ibeis/opencv/build\n\nRUN /virtualenv/env3/bin/pip install \\\n    cython==0.28.1\n\n# Install libgpuarray (pygpu)\nRUN    cd /ibeis/libgpuarray \\\n    && git checkout 04c2892 \\\n    && mkdir -p /ibeis/libgpuarray/build \\\n    && cd /ibeis/libgpuarray/build \\\n    && cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/virtualenv/env3 \\\n    && make -j4 \\\n    && make install \\\n    && cd .. \\\n    && /virtualenv/env3/bin/python setup.py build_ext -L /virtualenv/env3/lib -I /virtualenv/env3/include \\\n    && /virtualenv/env3/bin/pip install -e . \\\n    && rm -rf /ibeis/libgpuarray/build\n\n# Install basic Python3 dependencies (and ones that were missing in IBEIS install)\nRUN /virtualenv/env3/bin/pip install \\\n    ipython==6.2.1 \\\n    pyqt5==5.10.1 \\\n    futures_actors==0.0.5 \\\n    scikit-image==0.13.1 \\\n    mako \\\n    boto\n\n# Install other PyPI dependencies\nRUN    /virtualenv/env3/bin/pip install git+https://github.com/cameronbwhite/Flask-CAS.git@10ee70466ac9e71cec3602c1cd46f0566618f67e \\\n    && /virtualenv/env3/bin/pip install git+https://github.com/pwaller/pyfiglet.git@6dabdb0e720b5a61d81ff819faf0ad86127275fc \\\n    && /virtualenv/env3/bin/pip install pygraphviz --install-option=\"--include-path=/usr/include/graphviz\" --install-option=\"--library-path=/usr/lib/graphviz/\"\n\n# Checkout specific versions of each repository\nRUN    cd /ibeis/ibeis \\\n    && git checkout next \\\n    && /virtualenv/env3/bin/python super_setup.py --pull \\\n    # Double pull is important because super_setup.py could have just been updated as well\n    && /virtualenv/env3/bin/python super_setup.py --pull \\\n    # Checkout specific version of ibeis\n    && git checkout 2cfb0ac4 \\\n    # Checkout specific version of all other repos\n    && cd /ibeis/Theano \\\n    && git checkout 61b514a \\\n    && cd /ibeis/Lasagne \\\n    && git checkout 37ca134 \\\n    && cd /ibeis/networkx \\\n    && git checkout networkx-2.1 \\\n    && cd /ibeis/utool \\\n    && git checkout 6ec8e7b \\\n    && cd /ibeis/vtool \\\n    && git checkout 123ef03 \\\n    && cd /ibeis/dtool \\\n    && git checkout fcf7345 \\\n    && cd /ibeis/ubelt \\\n    && git checkout c0eb1c7  \\\n    && cd /ibeis/detecttools \\\n    && git checkout f885410 \\\n    && cd /ibeis/plottool \\\n    && git checkout c3be3ec \\\n    && cd /ibeis/guitool \\\n    && git checkout 5107bd0 \\\n    && cd /ibeis/flann \\\n    && git checkout 6146453 \\\n    && cd /ibeis/hesaff \\\n    && git checkout 28e8ef5 \\\n    && cd /ibeis/ibeis_cnn \\\n    && git checkout 09d166c \\\n    && cd /ibeis/pydarknet \\\n    && git checkout f36e935 \\\n    && cd /ibeis/ibeis-flukematch-module \\\n    && git checkout fd1e028 \\\n    && cd /ibeis/ibeis-curvrank-module \\\n    && git checkout 99b6115 \\\n    && cd /ibeis/pyrf \\\n    && git checkout 8802d3a\n\n# Install Python dependencies\nRUN    cd /ibeis/Theano \\\n    && /virtualenv/env3/bin/pip install -e . \\\n    && cd /ibeis/Lasagne \\\n    && /virtualenv/env3/bin/pip install -e . \\\n    && cd /ibeis/networkx \\\n    && /virtualenv/env3/bin/pip install -e .\n\n# Build Python repositories with external codebases\nRUN . /virtualenv/env3/bin/activate \\\n    && cd /ibeis/flann \\\n    && /bin/bash unix_build.sh \\\n    && cd /ibeis/hesaff \\\n    && /bin/bash unix_build.sh \\\n    && cd /ibeis/ibeis-flukematch-module \\\n    && /bin/bash unix_build.sh \\\n    && cd /ibeis/ibeis-curvrank-module \\\n    && /bin/bash unix_build.sh \\\n    && cd /ibeis/pydarknet \\\n    && /bin/bash unix_build.sh \\\n    && cd /ibeis/pyrf \\\n    && /bin/bash unix_build.sh \\\n    && cd /ibeis/vtool \\\n    && /bin/bash unix_build.sh\n\n# Install Python repositories\nRUN    cd /ibeis/detecttools \\\n    && /virtualenv/env3/bin/pip install -e . \\\n    && cd /ibeis/dtool \\\n    && /virtualenv/env3/bin/pip install -e . \\\n    && cd /ibeis/ibeis_cnn \\\n    && /virtualenv/env3/bin/pip install -e . \\\n    && cd /ibeis/guitool \\\n    && /virtualenv/env3/bin/pip install -e . \\\n    && cd /ibeis/hesaff \\\n    && /virtualenv/env3/bin/pip install -e . \\\n    && cd /ibeis/ibeis-flukematch-module \\\n    && /virtualenv/env3/bin/pip install -e . \\\n    && cd /ibeis/ibeis-curvrank-module \\\n    && /virtualenv/env3/bin/pip install -e . \\\n    && cd /ibeis/plottool \\\n    && /virtualenv/env3/bin/pip install -e . \\\n    && cd /ibeis/pydarknet \\\n    && /virtualenv/env3/bin/pip install -e . \\\n    && cd /ibeis/pyrf \\\n    && /virtualenv/env3/bin/pip install -e . \\\n    && cd /ibeis/ubelt \\\n    && /virtualenv/env3/bin/pip install -e . \\\n    && cd /ibeis/vtool \\\n    && /virtualenv/env3/bin/pip install -e . \\\n    && cd /ibeis/ibeis \\\n    && /virtualenv/env3/bin/pip install -e .\n\n##########################################################################################\nFROM com.wildme.wildbook-image-curation.base as com.wildme.wildbook-image-curation.install\n\nCOPY --from=com.wildme.wildbook-image-curation.build /virtualenv /virtualenv\n\nCOPY --from=com.wildme.wildbook-image-curation.build /ibeis /ibeis\n\nRUN    ln -s /virtualenv/env3/lib/libgpuarray.so     /usr/lib/libgpuarray.so \\\n    && ln -s /virtualenv/env3/lib/libgpuarray.so.3   /usr/lib/libgpuarray.so.3 \\\n    && ln -s /virtualenv/env3/lib/libgpuarray.so.3.0 /usr/lib/libgpuarray.so.3.0\n\nRUN echo \"\"\" \\\n[global]\\n\\\nfloatX = float32\\n\\\ndevice = cuda0\\n\\\nopenmp = True\\n\\\nallow_gc = True\\n\\\noptimizer = fast_run\\n\\\nenable_initial_driver_test = False\\n\\n\\\n[cuda]\\n\\\nroot = /usr/local/cuda/\\n\\n\\\n[lib]\\n\\\ncnmem = 0.01\\n\\n\\\n[dnn]\\n\\\nenabled = True\\n\\n\\\n[dnn.conv]\\n\\\nalgo_fwd = time_once\\n\\\nalgo_bwd_data = time_once\\n\\\nalgo_bwd_filter = time_once\\n\\n\\\n[nvcc]\\n\\\nfastmath = True\\n\\\noptimizer_including = cudnn\\n\\n\\\n[blas]\\n\\\nldflags = -llapack -lblas\\n\\\n\"\"\" >> /root/.theanorc\n\nRUN mkdir /data\n\nRUN /virtualenv/env3/bin/python /ibeis/ibeis/dev.py --set-workdir /data\n\n##########################################################################################\nFROM com.wildme.wildbook-image-curation.install as com.wildme.wildbook-image-curation.test\n\nRUN /virtualenv/env3/bin/python /ibeis/ibeis/reset_dbs.py --reset-all\n\nVOLUME /data\n\nENTRYPOINT [\"/virtualenv/env3/bin/python\", \"/ibeis/ibeis/run_tests.py\"]\n\n##########################################################################################\nFROM com.wildme.wildbook-image-curation.install as com.wildme.wildbook-image-curation.deploy\n\nENTRYPOINT [\"/virtualenv/env3/bin/python\", \"/ibeis/ibeis/dev.py\"]\n\nCMD [\"--dbdir\", \"/data/container\", \"--web\", \"--port\", \"5000\", \"--web-deterministic-ports\"]\n\n# Ports for the frontend web server\nEXPOSE 5000\n\n# Ports for the backend job engine\nEXPOSE 51381\n\nEXPOSE 51382\n\nEXPOSE 51383\n\nEXPOSE 51384\n\nEXPOSE 51385\n\nSTOPSIGNAL SIGTERM\n"
}