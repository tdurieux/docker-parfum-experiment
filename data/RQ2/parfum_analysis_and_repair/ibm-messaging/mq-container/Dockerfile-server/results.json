{
  "startTime": 1674252839207,
  "endTime": 1674252840689,
  "originalSmells": [
    {
      "rule": "yumInstallRmVarCacheYum",
      "position": {
        "lineStart": 128,
        "lineEnd": 128,
        "columnStart": 4,
        "columnEnd": 106
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "# © Copyright IBM Corporation 2015, 2022\n#\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n#\n# http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\n\nARG BASE_IMAGE=registry.access.redhat.com/ubi8/ubi-minimal\nARG BASE_TAG=8.6-751.1655117800\nARG BUILDER_IMAGE=registry.access.redhat.com/ubi8/go-toolset\nARG BUILDER_TAG=1.17.7-13.1655148239\nARG GO_WORKDIR=/opt/app-root/src/go/src/github.com/ibm-messaging/mq-container\nARG MQ_URL=\"https://public.dhe.ibm.com/ibmdl/export/pub/software/websphere/messaging/mqadv/9.3.0.0-IBM-MQ-Advanced-for-Developers-Non-Install-LinuxX64.tar.gz\"\n###############################################################################\n# Build stage to build Go code\n###############################################################################\nFROM $BUILDER_IMAGE:$BUILDER_TAG as builder\n# The URL to download the MQ installer from in tar.gz format\n# This assumes an archive containing the MQ Non-Install packages\nARG MQ_URL\nARG IMAGE_REVISION=\"Not specified\"\nARG IMAGE_SOURCE=\"Not specified\"\nARG IMAGE_TAG=\"Not specified\"\nARG GO_WORKDIR\nUSER 0\nWORKDIR /opt/mqm\n# Download and extract MQ files, to get the MQ client needed to compile.\n# Only extract certain MQ files to make the build quicker\nRUN curl --fail --location $MQ_URL | tar --extract --gunzip \\\n  && chown -R 1001:root /opt/mqm/*\nWORKDIR $GO_WORKDIR/\nCOPY go.mod go.sum ./\nCOPY cmd/ ./cmd\nCOPY internal/ ./internal\nCOPY pkg/ ./pkg\nCOPY vendor/ ./vendor\nENV CGO_CFLAGS=\"-I/opt/mqm/inc/\" \\\n    CGO_LDFLAGS_ALLOW=\"-Wl,-rpath.*\" \\\n    PATH=\"${PATH}:/opt/mqm/bin\"\nRUN go build -ldflags \"-X \\\"main.ImageCreated=$(date --iso-8601=seconds)\\\" -X \\\"main.ImageRevision=$IMAGE_REVISION\\\" -X \\\"main.ImageSource=$IMAGE_SOURCE\\\" -X \\\"main.ImageTag=$IMAGE_TAG\\\"\" ./cmd/runmqserver/ \\\n  && go build ./cmd/chkmqready/ \\\n  && go build ./cmd/chkmqhealthy/ \\\n  && go build ./cmd/chkmqstarted/ \\\n  && go build ./cmd/runmqdevserver/ \\\n  && go test -v ./cmd/runmqdevserver/... \\\n  && go test -v ./cmd/runmqserver/ \\\n  && go test -v ./cmd/chkmqready/ \\\n  && go test -v ./cmd/chkmqhealthy/ \\\n  && go test -v ./cmd/chkmqstarted/ \\\n  && go test -v ./pkg/... \\\n  && go test -v ./internal/... \\\n  && go vet ./cmd/... ./internal/...\n\n###############################################################################\n# Main build stage, to build MQ image\n###############################################################################\nFROM $BASE_IMAGE:$BASE_TAG AS mq-server\n# The MQ packages to install - see install-mq.sh for default value\nARG MQ_URL\nARG BASE_IMAGE\nARG BASE_TAG\nARG GO_WORKDIR\nLABEL summary=\"IBM MQ Advanced Server\" \\\n      description=\"Simplify, accelerate and facilitate the reliable exchange of data with a security-rich messaging solution — trusted by the world’s most successful enterprises\" \\\n      vendor=\"IBM\" \\\n      maintainer=\"IBM\" \\\n      distribution-scope=\"private\" \\\n      authoritative-source-url=\"https://www.ibm.com/software/passportadvantage/\" \\\n      url=\"https://www.ibm.com/products/mq/advanced\" \\\n      io.openshift.tags=\"mq messaging\" \\\n      io.k8s.display-name=\"IBM MQ Advanced Server\" \\\n      io.k8s.description=\"Simplify, accelerate and facilitate the reliable exchange of data with a security-rich messaging solution — trusted by the world’s most successful enterprises\" \\\n      base-image=$BASE_IMAGE \\\n      base-image-release=$BASE_TAG\nCOPY install-mq.sh /usr/local/bin/\nCOPY install-mq-server-prereqs.sh /usr/local/bin/\n# Install MQ.  To avoid a \"text file busy\" error here, we sleep before installing.\nRUN env \\\n  && mkdir /opt/mqm \\\n  && chmod u+x /usr/local/bin/install-*.sh \\\n  && sleep 1 \\\n  && install-mq-server-prereqs.sh \\\n  && install-mq.sh \\\n  && /opt/mqm/bin/security/amqpamcf \\\n  && chown -R 1001:root /opt/mqm/*\nCOPY --from=builder $GO_WORKDIR/runmqserver /usr/local/bin/\nCOPY --from=builder $GO_WORKDIR/chkmq* /usr/local/bin/\nCOPY NOTICES.txt /opt/mqm/licenses/notices-container.txt\nCOPY ha/native-ha.ini.tpl /etc/mqm/native-ha.ini.tpl\n# Copy web XML files\nCOPY web /etc/mqm/web\nCOPY etc/mqm/*.tpl /etc/mqm/\nRUN chmod ug+x /usr/local/bin/runmqserver \\\n  && chown 1001:root /usr/local/bin/*mq* \\\n  && chmod ug+x /usr/local/bin/chkmq* \\\n  && chown -R 1001:root /etc/mqm/* \\\n  && install --directory --mode 2775 --owner 1001 --group root /run/runmqserver \\\n  && touch /run/termination-log \\\n  && chown 1001:root /run/termination-log \\\n  && chmod 0660 /run/termination-log \\\n  && chmod -R g+w /etc/mqm/web\n# Always use port 1414 for MQ & 9157 for the metrics\nEXPOSE 1414 9157 9443\nENV MQ_OVERRIDE_DATA_PATH=/mnt/mqm/data MQ_OVERRIDE_INSTALLATION_NAME=Installation1 MQ_USER_NAME=\"mqm\" PATH=\"${PATH}:/opt/mqm/bin\"\nENV MQ_GRACE_PERIOD=30\nENV LANG=en_US.UTF-8 AMQ_DIAGNOSTIC_MSG_SEVERITY=1 AMQ_ADDITIONAL_JSON_LOG=1 LOG_FORMAT=basic\n# We can run as any UID\nUSER 1001\nENV MQ_CONNAUTH_USE_HTP=false\nENTRYPOINT [\"runmqserver\"]\n\n###############################################################################\n# Build stage to build C code for custom authorization service (developer-only)\n###############################################################################\n# Use the Go toolset image, which already includes gcc and the MQ SDK\nFROM builder as cbuilder\n# The URL to download the MQ installer from in tar.gz format\n# This assumes an archive containing the MQ Non-Install packages\nARG MQ_URL\nUSER 0\n# Install the Apache Portable Runtime code (used for htpasswd hash checking)\nRUN yum --assumeyes --disableplugin=subscription-manager install apr-devel apr-util-openssl apr-util-devel && rm -rf /var/cache/yum\nCOPY authservice/ /opt/app-root/src/authservice/\nWORKDIR /opt/app-root/src/authservice/mqhtpass\nRUN make all\n\n###############################################################################\n# Add default developer config\n###############################################################################\nFROM mq-server AS mq-dev-server\nARG BASE_IMAGE\nARG BASE_TAG\nARG GO_WORKDIR\nLABEL summary=\"IBM MQ Advanced for Developers Server\" \\\n      description=\"Simplify, accelerate and facilitate the reliable exchange of data with a security-rich messaging solution — trusted by the world’s most successful enterprises\" \\\n      vendor=\"IBM\" \\\n      distribution-scope=\"private\" \\\n      authoritative-source-url=\"https://www.ibm.com/software/passportadvantage/\" \\\n      url=\"https://www.ibm.com/products/mq/advanced\" \\\n      io.openshift.tags=\"mq messaging\" \\\n      io.k8s.display-name=\"IBM MQ Advanced for Developers Server\" \\\n      io.k8s.description=\"Simplify, accelerate and facilitate the reliable exchange of data with a security-rich messaging solution — trusted by the world’s most successful enterprises\" \\\n      base-image=$BASE_IMAGE \\\n      base-image-release=$BASE_TAG\nUSER 0\nCOPY --from=cbuilder /opt/app-root/src/authservice/mqhtpass/build/mqhtpass.so /opt/mqm/lib64/\nCOPY etc/mqm/*.ini /etc/mqm/\nCOPY etc/mqm/mq.htpasswd /etc/mqm/\nCOPY incubating/mqadvanced-server-dev/install-extra-packages.sh /usr/local/bin/\nRUN chmod u+x /usr/local/bin/install-extra-packages.sh \\\n  && sleep 1 \\\n  && install-extra-packages.sh\nCOPY --from=builder $GO_WORKDIR/runmqdevserver /usr/local/bin/\n# Copy template files\nCOPY incubating/mqadvanced-server-dev/*.tpl /etc/mqm/\n# Copy web XML files for default developer configuration\nCOPY incubating/mqadvanced-server-dev/web /etc/mqm/web\nRUN chown -R 1001:root /etc/mqm/* \\\n  && chmod -R g+w /etc/mqm/web \\\n  && chmod +x /usr/local/bin/runmq* \\\n  && chmod 0660 /etc/mqm/mq.htpasswd \\\n  && install --directory --mode 2775 --owner 1001 --group root /run/runmqdevserver\nENV MQ_DEV=true \\\n    MQ_ENABLE_EMBEDDED_WEB_SERVER=1 \\\n    MQ_GENERATE_CERTIFICATE_HOSTNAME=localhost \\\n    LD_LIBRARY_PATH=/opt/mqm/lib64 \\\n    MQ_CONNAUTH_USE_HTP=true \\\n    MQS_PERMIT_UNKNOWN_ID=true\nUSER 1001\nENTRYPOINT [\"runmqdevserver\"]\n"
}