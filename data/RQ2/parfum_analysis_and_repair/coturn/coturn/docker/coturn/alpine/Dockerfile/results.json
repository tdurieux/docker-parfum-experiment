{
  "startTime": 1674250798838,
  "endTime": 1674250799777,
  "originalSmells": [
    {
      "rule": "configureShouldUseBuildFlag",
      "position": {
        "lineStart": 135,
        "lineEnd": 142,
        "columnStart": 4,
        "columnEnd": 50
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "#\n# Dockerfile of coturn/coturn:alpine Docker image.\n#\n\nARG alpine_ver=3.16\n\n\n\n\n#\n# Stage 'dist-libprom' creates prometheus-client-c distribution.\n#\n\n# We compile prometheus-client-c from sources, because Alpine doesn't provide\n# it as its package yet.\n#\n# TODO: Re-check this to be present in packages on next Alpine major version update.\n\n# https://hub.docker.com/_/alpine\nFROM alpine:${alpine_ver} AS dist-libprom\n\n# Install tools for building.\nRUN apk update \\\n && apk add --no-cache \\\n        ca-certificates cmake g++ git make \\\n && update-ca-certificates\n\n# Install prometheus-client-c build dependencies.\nRUN apk add --no-cache \\\n        libmicrohttpd-dev\n\n# Prepare prometheus-client-c sources for building.\nARG prom_ver=0.1.3\nRUN mkdir -p /build/ && cd /build/ \\\n && git init \\\n && git remote add origin https://github.com/digitalocean/prometheus-client-c \\\n && git fetch --depth=1 origin \"v${prom_ver}\" \\\n && git checkout FETCH_HEAD\n\n# Build libprom.so from sources.\nRUN mkdir -p /build/prom/build/ && cd /build/prom/build/ \\\n && TEST=0 cmake -G \"Unix Makefiles\" \\\n                 -DCMAKE_INSTALL_PREFIX=/usr \\\n                 -DCMAKE_SKIP_BUILD_RPATH=TRUE \\\n                 -DCMAKE_C_FLAGS=\"-DPROM_LOG_ENABLE -g -O3\" \\\n                 .. \\\n && make\n\n# Build libpromhttp.so from sources.\nRUN mkdir -p /build/promhttp/build/ && cd /build/promhttp/build/ \\\n # Fix compiler warning: -Werror=incompatible-pointer-types\n && sed -i 's/\\&promhttp_handler/(MHD_AccessHandlerCallback)\\&promhttp_handler/' \\\n           /build/promhttp/src/promhttp.c \\\n && TEST=0 cmake -G \"Unix Makefiles\" \\\n                 -DCMAKE_INSTALL_PREFIX=/usr \\\n                 -DCMAKE_SKIP_BUILD_RPATH=TRUE \\\n                 -DCMAKE_C_FLAGS=\"-g -O3\" \\\n                 .. \\\n && make VERBOSE=1\n\n# Install prometheus-client-c.\nRUN LIBS_DIR=/out/$(dirname $(find /usr/ -name libc.so)) \\\n && mkdir -p $LIBS_DIR/ \\\n && cp -rf /build/prom/build/libprom.so \\\n           /build/promhttp/build/libpromhttp.so \\\n       $LIBS_DIR/ \\\n && mkdir -p /out/usr/include/ \\\n && cp -rf /build/prom/include/* \\\n           /build/promhttp/include/* \\\n       /out/usr/include/ \\\n # Preserve license file.\n && mkdir -p /out/usr/share/licenses/prometheus-client-c/ \\\n && cp /build/LICENSE /out/usr/share/licenses/prometheus-client-c/\n\n\n\n\n#\n# Stage 'dist-coturn' creates Coturn distribution.\n#\n\n# https://hub.docker.com/_/alpine\nFROM alpine:${alpine_ver} AS dist-coturn\n\n# Install tools for building.\nRUN apk update \\\n && apk add --no-cache \\\n        autoconf ca-certificates coreutils g++ git libtool make \\\n && update-ca-certificates\n\n# Install Coturn build dependencies.\nRUN apk add --no-cache \\\n        linux-headers \\\n        libevent-dev \\\n        openssl-dev \\\n        postgresql-dev mariadb-connector-c-dev sqlite-dev \\\n        hiredis-dev \\\n        mongo-c-driver-dev \\\n        libmicrohttpd-dev\n\n# Install prometheus-client-c distribution.\nCOPY --from=dist-libprom /out/ /\n\n# Prepare local Coturn sources for building.\nCOPY CMakeLists.txt \\\n     configure \\\n     INSTALL \\\n     LICENSE LICENSE.OpenSSL \\\n     make-man.sh Makefile.in \\\n     postinstall.txt \\\n     README.turn* \\\n     /app/\nCOPY cmake/ /app/cmake/\nCOPY examples/ /app/examples/\nCOPY man/ /app/man/\nCOPY src/ /app/src/\nCOPY turndb/ /app/turndb/\nWORKDIR /app/\n\n# Use Coturn sources from Git if `coturn_git_ref` is specified.\nARG coturn_git_ref=HEAD\nARG coturn_github_url=https://github.com\nARG coturn_github_repo=coturn/coturn\n\nRUN if [ \"${coturn_git_ref}\" != 'HEAD' ]; then true \\\n && rm -rf /app/* \\\n && git init \\\n && git remote add origin ${coturn_github_url}/${coturn_github_repo} \\\n && git fetch --depth=1 origin \"${coturn_git_ref}\" \\\n && git checkout FETCH_HEAD \\\n && true; fi\n\n# Build Coturn from sources.\n# TODO: Remove this symlink with next Coturn release detecting MySQL libs correctly.\nRUN ln -s /usr/lib/pkgconfig/libmariadb.pc /usr/lib/pkgconfig/mariadb.pc \\\n && ./configure --build=\"$(dpkg-architecture --query DEB_BUILD_GNU_TYPE)\" --prefix=/usr \\\n                --turndbdir=/var/lib/coturn \\\n                --disable-rpath \\\n                --sysconfdir=/etc/coturn \\\n                # No documentation included to keep image size smaller.\n                --mandir=/tmp/coturn/man \\\n                --docsdir=/tmp/coturn/docs \\\n                --examplesdir=/tmp/coturn/examples \\\n && make\n\n# Install and configure Coturn.\nRUN mkdir -p /out/ \\\n && DESTDIR=/out make install \\\n # Remove redundant files.\n && rm -rf /out/tmp/ \\\n # Preserve license file.\n && mkdir -p /out/usr/share/licenses/coturn/ \\\n && cp LICENSE /out/usr/share/licenses/coturn/ \\\n # Remove default config file.\n && rm -f /out/etc/coturn/turnserver.conf.default\n\n# Install helper tools of Docker image.\nCOPY docker/coturn/rootfs/ /out/\nCOPY docker/coturn/alpine/rootfs/ /out/\nRUN chmod +x /out/usr/local/bin/docker-entrypoint.sh \\\n             /out/usr/local/bin/detect-external-ip.sh\nRUN ln -s /usr/local/bin/detect-external-ip.sh \\\n          /out/usr/local/bin/detect-external-ip\nRUN chown -R nobody:nogroup /out/var/lib/coturn/\n\n# Re-export prometheus-client-c distribution.\nCOPY --from=dist-libprom /out/ /out/\n\n\n\n\n#\n# Stage 'runtime' creates final Docker image to use in runtime.\n#\n\n# https://hub.docker.com/_/alpine\nFROM alpine:${alpine_ver} AS runtime\n\n# Update system packages.\nRUN apk update \\\n && apk upgrade \\\n && apk add --no-cache ca-certificates \\\n && update-ca-certificates \\\n # Install Coturn dependencies.\n && apk add --no-cache \\\n        libevent \\\n        libcrypto1.1 libssl1.1 \\\n        libpq mariadb-connector-c sqlite-libs \\\n        hiredis \\\n        mongo-c-driver \\\n        libmicrohttpd \\\n # Install `dig` tool for `detect-external-ip.sh`.\n && apk add --no-cache \\\n        bind-tools \\\n # Cleanup unnecessary stuff.\n && rm -rf /var/cache/apk/*\n\n# Install Coturn distribution.\nCOPY --from=dist-coturn /out/ /\n\n# Allow non-root using privileged ports.\nRUN apk add --no-cache libcap \\\n && setcap CAP_NET_BIND_SERVICE=+ep /usr/bin/turnserver \\\n # Cleanup unnecessary stuff.\n && apk del libcap \\\n && rm -rf /var/cache/apk/*\n\nUSER nobody:nogroup\n\nEXPOSE 3478 3478/udp 5349 5349/udp\n\nVOLUME [\"/var/lib/coturn\"]\n\nENTRYPOINT [\"docker-entrypoint.sh\"]\n\nCMD [\"--log-file=stdout\", \"--external-ip=$(detect-external-ip)\"]\n"
}