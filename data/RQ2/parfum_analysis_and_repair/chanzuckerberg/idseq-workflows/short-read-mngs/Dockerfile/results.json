{
  "startTime": 1674251471748,
  "endTime": 1674251473292,
  "originalSmells": [
    {
      "rule": "curlUseFlagF",
      "position": {
        "lineStart": 65,
        "lineEnd": 65,
        "columnStart": 17,
        "columnEnd": 133
      }
    },
    {
      "rule": "curlUseFlagF",
      "position": {
        "lineStart": 70,
        "lineEnd": 70,
        "columnStart": 4,
        "columnEnd": 125
      }
    },
    {
      "rule": "curlUseFlagF",
      "position": {
        "lineStart": 86,
        "lineEnd": 86,
        "columnStart": 4,
        "columnEnd": 149
      }
    },
    {
      "rule": "curlUseFlagF",
      "position": {
        "lineStart": 89,
        "lineEnd": 89,
        "columnStart": 4,
        "columnEnd": 125
      }
    },
    {
      "rule": "curlUseFlagF",
      "position": {
        "lineStart": 102,
        "lineEnd": 102,
        "columnStart": 4,
        "columnEnd": 117
      }
    },
    {
      "rule": "curlUseFlagF",
      "position": {
        "lineStart": 108,
        "lineEnd": 108,
        "columnStart": 4,
        "columnEnd": 67
      }
    },
    {
      "rule": "curlUseFlagF",
      "position": {
        "lineStart": 125,
        "lineEnd": 125,
        "columnStart": 4,
        "columnEnd": 93
      }
    },
    {
      "rule": "curlUseFlagF",
      "position": {
        "lineStart": 131,
        "lineEnd": 131,
        "columnStart": 4,
        "columnEnd": 92
      }
    },
    {
      "rule": "pipUseNoCacheDir",
      "position": {
        "lineStart": 53,
        "lineEnd": 53,
        "columnStart": 4,
        "columnEnd": 47
      }
    },
    {
      "rule": "pipUseNoCacheDir",
      "position": {
        "lineStart": 54,
        "lineEnd": 54,
        "columnStart": 4,
        "columnEnd": 91
      }
    },
    {
      "rule": "pipUseNoCacheDir",
      "position": {
        "lineStart": 55,
        "lineEnd": 55,
        "columnStart": 4,
        "columnEnd": 109
      }
    },
    {
      "rule": "pipUseNoCacheDir",
      "position": {
        "lineStart": 56,
        "lineEnd": 56,
        "columnStart": 4,
        "columnEnd": 77
      }
    },
    {
      "rule": "pipUseNoCacheDir",
      "position": {
        "lineStart": 141,
        "lineEnd": 141,
        "columnStart": 4,
        "columnEnd": 31
      }
    },
    {
      "rule": "pipUseNoCacheDir",
      "position": {
        "lineStart": 144,
        "lineEnd": 144,
        "columnStart": 4,
        "columnEnd": 33
      }
    },
    {
      "rule": "configureShouldUseBuildFlag",
      "position": {
        "lineStart": 126,
        "lineEnd": 126,
        "columnStart": 4,
        "columnEnd": 70
      }
    },
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 11,
        "lineEnd": 44,
        "columnStart": 4,
        "columnEnd": 16
      }
    },
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 47,
        "lineEnd": 50,
        "columnStart": 4,
        "columnEnd": 19
      }
    },
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 79,
        "lineEnd": 79,
        "columnStart": 4,
        "columnEnd": 30
      }
    },
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 82,
        "lineEnd": 82,
        "columnStart": 4,
        "columnEnd": 37
      }
    },
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 92,
        "lineEnd": 92,
        "columnStart": 4,
        "columnEnd": 54
      }
    },
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 96,
        "lineEnd": 96,
        "columnStart": 4,
        "columnEnd": 31
      }
    },
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 101,
        "lineEnd": 101,
        "columnStart": 4,
        "columnEnd": 29
      }
    },
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 113,
        "lineEnd": 119,
        "columnStart": 4,
        "columnEnd": 28
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 11,
        "lineEnd": 44,
        "columnStart": 4,
        "columnEnd": 16
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 47,
        "lineEnd": 50,
        "columnStart": 4,
        "columnEnd": 19
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 79,
        "lineEnd": 79,
        "columnStart": 4,
        "columnEnd": 30
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 82,
        "lineEnd": 82,
        "columnStart": 4,
        "columnEnd": 37
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 92,
        "lineEnd": 92,
        "columnStart": 4,
        "columnEnd": 54
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 96,
        "lineEnd": 96,
        "columnStart": 4,
        "columnEnd": 31
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 101,
        "lineEnd": 101,
        "columnStart": 4,
        "columnEnd": 29
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 113,
        "lineEnd": 119,
        "columnStart": 4,
        "columnEnd": 28
      }
    },
    {
      "rule": "ruleAptGetInstallThenRemoveAptLists",
      "position": {
        "lineStart": 11,
        "lineEnd": 44,
        "columnStart": 4,
        "columnEnd": 16
      }
    },
    {
      "rule": "ruleAptGetInstallThenRemoveAptLists",
      "position": {
        "lineStart": 47,
        "lineEnd": 50,
        "columnStart": 4,
        "columnEnd": 19
      }
    },
    {
      "rule": "ruleAptGetInstallThenRemoveAptLists",
      "position": {
        "lineStart": 79,
        "lineEnd": 79,
        "columnStart": 4,
        "columnEnd": 30
      }
    },
    {
      "rule": "ruleAptGetInstallThenRemoveAptLists",
      "position": {
        "lineStart": 82,
        "lineEnd": 82,
        "columnStart": 4,
        "columnEnd": 37
      }
    },
    {
      "rule": "ruleAptGetInstallThenRemoveAptLists",
      "position": {
        "lineStart": 92,
        "lineEnd": 92,
        "columnStart": 4,
        "columnEnd": 54
      }
    },
    {
      "rule": "ruleAptGetInstallThenRemoveAptLists",
      "position": {
        "lineStart": 96,
        "lineEnd": 96,
        "columnStart": 4,
        "columnEnd": 31
      }
    },
    {
      "rule": "ruleAptGetInstallThenRemoveAptLists",
      "position": {
        "lineStart": 101,
        "lineEnd": 101,
        "columnStart": 4,
        "columnEnd": 29
      }
    },
    {
      "rule": "ruleAptGetInstallThenRemoveAptLists",
      "position": {
        "lineStart": 113,
        "lineEnd": 119,
        "columnStart": 4,
        "columnEnd": 28
      }
    }
  ],
  "repairedSmells": [
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 11,
        "lineEnd": 44,
        "columnStart": 4,
        "columnEnd": 16
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 47,
        "lineEnd": 50,
        "columnStart": 4,
        "columnEnd": 19
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 79,
        "lineEnd": 79,
        "columnStart": 4,
        "columnEnd": 54
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 82,
        "lineEnd": 82,
        "columnStart": 4,
        "columnEnd": 61
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 92,
        "lineEnd": 92,
        "columnStart": 4,
        "columnEnd": 78
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 96,
        "lineEnd": 96,
        "columnStart": 4,
        "columnEnd": 55
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 101,
        "lineEnd": 101,
        "columnStart": 4,
        "columnEnd": 53
      }
    },
    {
      "rule": "aptGetUpdatePrecedesInstall",
      "position": {
        "lineStart": 113,
        "lineEnd": 116,
        "columnStart": 4,
        "columnEnd": 12
      }
    }
  ],
  "repairedDockerfile": "FROM ubuntu:18.04\nARG DEBIAN_FRONTEND=noninteractive\nARG MINIWDL_VERSION=1.1.5\n\nLABEL maintainer=\"IDseq Team <idseq-tech@chanzuckerberg.com>\"\n\nRUN sed -i s/archive.ubuntu.com/us-west-2.ec2.archive.ubuntu.com/ /etc/apt/sources.list; \\\n        echo 'APT::Install-Recommends \"false\";' > /etc/apt/apt.conf.d/98idseq; \\\n        echo 'APT::Install-Suggests \"false\";' > /etc/apt/apt.conf.d/99idseq\n\nRUN apt-get -q update\nRUN apt-get -q --no-install-recommends install -y \\\n        jq \\\n        moreutils \\\n        pigz \\\n        pixz \\\n        aria2 \\\n        httpie \\\n        curl \\\n        wget \\\n        zip \\\n        unzip \\\n        zlib1g-dev \\\n        pkg-config \\\n        apt-utils \\\n        libbz2-dev \\\n        liblzma-dev \\\n        software-properties-common \\\n        libarchive-tools \\\n        liblz4-tool \\\n        lbzip2 \\\n        docker.io \\\n        python3-pip \\\n        python3-setuptools \\\n        python3-wheel \\\n        python3-requests \\\n        python3-yaml \\\n        python3-dateutil \\\n        python3-psutil \\\n        python3-cutadapt \\\n        python3-scipy \\\n        samtools \\\n        fastx-toolkit \\\n        seqtk \\\n        bedtools && rm -rf /var/lib/apt/lists/*;\n\n# The following packages pull in python2.7\nRUN apt-get -q --no-install-recommends install -y \\\n        bowtie2 \\\n        spades \\\n        ncbi-blast+ && rm -rf /var/lib/apt/lists/*;\n\n# Match versions from Ubuntu 20.04 LTS (please do not upgrade except to fix bugs)\nRUN pip3 install --no-cache-dir awscli==1.17.14 boto3==1.9.253\nRUN pip3 install --no-cache-dir miniwdl==${MINIWDL_VERSION} miniwdl-s3parcp==0.0.5 miniwdl-s3upload==0.0.4\nRUN pip3 install --no-cache-dir https://github.com/chanzuckerberg/miniwdl-plugins/archive/f0465b0.zip#subdirectory=sfn-wdl\nRUN pip3 install --no-cache-dir https://github.com/chanzuckerberg/s3mi/archive/v0.8.0.tar.gz\n\nADD https://raw.githubusercontent.com/chanzuckerberg/miniwdl/v${MINIWDL_VERSION}/examples/clean_download_cache.sh /usr/local/bin\nRUN chmod +x /usr/local/bin/clean_download_cache.sh\n\n# docker.io is the largest package at 250MB+ / half of all package disk space usage.\n# The docker daemons never run inside the container - removing them saves 150MB+\nRUN rm -f /usr/bin/dockerd /usr/bin/containerd*\n\nRUN cd /usr/bin; curl -f -O https://amazon-ecr-credential-helper-releases.s3.amazonaws.com/0.4.0/linux-amd64/docker-credential-ecr-login\nRUN chmod +x /usr/bin/docker-credential-ecr-login\nRUN mkdir -p /root/.docker\nRUN jq -n '.credsStore=\"ecr-login\"' > /root/.docker/config.json\n\nRUN curl -f -L -o /usr/bin/idseq-dedup https://github.com/chanzuckerberg/idseq-dedup/releases/download/v0.1.0/idseq-dedup-Linux; chmod +x /usr/bin/idseq-dedup\n\n# Note: bsdtar is available in libarchive-tools\n# Note: python3-scipy pulls in gcc (fixed in Ubuntu 19.10)\n# TODO: kSNP3 (separate phylotree image?)\n\n# Note: the NonHostAlignment stage uses a different version of gmap custom to IDseq, installed here:\n# https://github.com/chanzuckerberg/idseq/blob/master/workflows/docker/gsnap/Dockerfile#L16-L20\n# TODO: migrate both to https://packages.ubuntu.com/focal/gmap (updates to gmap require revalidation)\nRUN apt-get -q --no-install-recommends install -y gmap && rm -rf /var/lib/apt/lists/*;\n\n# FIXME: replace trimmomatic with cutadapt (trimmomatic pulls in too many deps)\nRUN apt-get -q --no-install-recommends install -y trimmomatic && rm -rf /var/lib/apt/lists/*;\nRUN ln -sf /usr/share/java/trimmomatic-0.36.jar /usr/local/bin/trimmomatic-0.38.jar\n\n# FIXME: replace PriceSeqFilter with cutadapt quality/N-fraction cutoff\nRUN curl -f -s https://idseq-prod-pipeline-public-assets-us-west-2.s3-us-west-2.amazonaws.com/PriceSource140408/PriceSeqFilter > /usr/bin/PriceSeqFilter\nRUN chmod +x /usr/bin/PriceSeqFilter\n\nRUN curl -f -Ls https://github.com/chanzuckerberg/s3parcp/releases/download/v0.2.0-alpha/s3parcp_0.2.0-alpha_Linux_x86_64.tar.gz | tar -C /usr/bin -xz s3parcp\n\n# FIXME: check if use of pandas, pysam is necessary\nRUN apt-get -q --no-install-recommends install -y python3-pysam python3-pandas && rm -rf /var/lib/apt/lists/*;\n\n# Workaround for srst2 refusing to work with upstream bowtie2 and samtools\n# FIXME: replace srst2 with a more appropriate tool\nRUN apt-get -q --no-install-recommends install -y srst2 && rm -rf /var/lib/apt/lists/*;\nRUN sed -i '/Incorrect version/ s/\\w.*/return \"1.7\"/' /usr/bin/srst2\n\n# Picard for average fragment size https://github.com/broadinstitute/picard\n# r-base is a dependency of collecting input size metrics https://github.com/bioconda/bioconda-recipes/pull/16398\nRUN apt-get install --no-install-recommends -y r-base && rm -rf /var/lib/apt/lists/*;\nRUN curl -f -L -o /usr/local/bin/picard.jar https://github.com/broadinstitute/picard/releases/download/2.21.2/picard.jar\n# Create a single executable so we can use SingleCommand\nRUN printf '#!/bin/bash\\njava -jar /usr/local/bin/picard.jar \"$@\"\\n' > /usr/local/bin/picard\nRUN chmod +x /usr/local/bin/picard\n\n# install STAR, the package rna-star does not include STARlong\nRUN curl -f -L https://github.com/alexdobin/STAR/archive/2.5.3a.tar.gz | tar xz\nRUN mv STAR-2.5.3a/bin/Linux_x86_64_static/* /usr/local/bin\nRUN rm -rf STAR-2.5.3a\n\n# install gsnap and rapsearch2 for local alignment\nRUN apt-get install --no-install-recommends -y \\\n        g++ \\\n        libperl4-corelibs-perl \\\n        make \\\n\n\n        libboost1.62-all-dev && rm -rf /var/lib/apt/lists/*;\n\n\n# install gsnap, we are using a pinned version for alignment\n#  we are also using a different version for host filtering so we append -208-10-26 to each binary.\nWORKDIR /gmap-gsnap-2018-10-26\nRUN curl -f -L https://idseq-gsnap-prerelease.s3-us-west-2.amazonaws.com/gmap-2018-10-26.tar.gz | tar xz -C /gmap-gsnap-2018-10-26 --strip-components 1\nRUN ./configure --build=\"$(dpkg-architecture --query DEB_BUILD_GNU_TYPE)\" --prefix=/gmap-gsnap-2018-10-26 --with-simd-level=avx2 && make -j 8 && make install\nRUN ls bin | xargs -I % mv bin/% bin/%-2018-10-26\nENV PATH=\"${PATH}:/gmap-gsnap-2018-10-26/bin/\"\n\nWORKDIR /rapsearch2/Src\nRUN curl -f -L https://idseq-rapsearch2.s3-us-west-2.amazonaws.com/RAPSearch2.24_64bits.tar.gz | tar xz -C /rapsearch2 --strip-components 1\n# Use the version of boost we installed\nRUN sed -i -e 's|^INC.*|INC := -I /usr/include/boost|' -e 's|^LIB.*|LIB :=|' Makefile\nRUN make\nENV PATH=\"${PATH}:/rapsearch2/Src/\"\n# Uninstall build only dependencies\nRUN apt-get purge -y g++ libperl4-corelibs-perl make\nWORKDIR /\n\nCOPY idseq-dag /tmp/idseq-dag\nRUN pip3 install --no-cache-dir /tmp/idseq-dag && rm -rf /tmp/idseq-dag\n\nCOPY idseq_utils /tmp/idseq_utils\nRUN pip3 install --no-cache-dir /tmp/idseq_utils && rm -rf /tmp/idseq_utils"
}