{
  "startTime": 1674254939675,
  "endTime": 1674254941132,
  "originalSmells": [
    {
      "rule": "aptGetInstallUseNoRec",
      "position": {
        "lineStart": 3,
        "lineEnd": 3,
        "columnStart": 18,
        "columnEnd": 64
      }
    },
    {
      "rule": "ruleAptGetInstallThenRemoveAptLists",
      "position": {
        "lineStart": 3,
        "lineEnd": 3,
        "columnStart": 18,
        "columnEnd": 64
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "FROM golang:buster AS baseBuild\nARG OUT_PUT_DIR=/tmp/build/easydarwin\nWORKDIR /app\nRUN apt update && apt install --no-install-recommends -y git gcc g++ nodejs npm dos2unix; rm -rf /var/lib/apt/lists/*; \\\n        git clone https://github.com/bruce-qin/EasyDarwin.git --depth=1 EasyDarwin; \\\n        cd EasyDarwin; \\\n        go get -u; \\\n        npm run build:lin; \\\n        dos2unix easydarwin.ini; \\\n        mkdir -p ${OUT_PUT_DIR}; \\\n        cp -r easydarwin easydarwin.ini  www ${OUT_PUT_DIR}\n\n##二阶段 发布镜像\nFROM justtin/debian-ffmpeg:latest\nWORKDIR /app\n#install easydarwin\nENV \\\n    #系统登录账号（rtsp推拉流）\n    DEFAULT_USERNAME=admin \\\n    #系统登录密码（rtsp推拉流）\n    DEFAULT_PASSWORD=admin \\\n    #是否使能向服务器推流或者从服务器播放时验证用户名密码. [注意] 因为服务器端并不保存明文密码，所以推送或者播放时，客户端应该输入密码的md5后的值。\n    AUTHORIZATION_ENABLE=0 \\\n    #新的推流器连接时，如果已有同一个推流器（PATH相同）在推流，是否关闭老的推流器。\n    #如果为0，则不会关闭老的推流器，新的推流器会被响应406错误，否则会关闭老的推流器，新的推流器会响应成功。\n    CLOSE_OLD=0 \\\n    #当close_old为1时，是否保留被关闭的推流器对应的播放器。\n    #如果为0，则原推流器对应的播放器会被断开。否则会被保留下来。注意，如果该选项为1，可能某些播放器会有异常，因为RTP序列可能不一致了。\n    KEEP_PLAYERS=0 \\\n    #是否开启推送的同事进行本地存储，开启后则可以进行录像查询与回放。ts文件存储位置/media/hls\n    SAVE_STREAM_TO_LOCAL=0 \\\n    #rtp udp推送时服务端端口范围\n    RTPSERVER_UDPORT_RANGE=50000:55000 \\\n    #是否启用集群\n    ENABLE_MULTICAST=1 \\\n    #推流时执行ffmpeg命令错误重试次数\n    EASYDARWIN_CMD_ERROR_REPEAT_TIME=5 \\\n    #启用组播集群时绑定网卡\n    EAYDARWIN_MULTICST_BIND_INF_NAME=''\\\n    #tcp读超时（毫秒）0::永不超时\n    READ_TIMEOUT=40000\\\n    #tcp 写超时（毫秒），0::永不超时\n    WRITE_TIMEOUT=20000\nCOPY --from=0 /tmp/build/easydarwin /app/easydarwin\nRUN {\\\n        echo '#!/bin/sh';\\\n        echo 'if [ ! -f \"/app/easydarwin_home\" ];then';\\\n        echo 'EASYDARWIN_HOME=$(dirname $(find /app/easydarwin -name easydarwin.ini))';\\\n        echo 'sed -i \"s/^ffmpeg_path=.*/ffmpeg_path=\\/usr\\/bin\\/ffmpeg/g\" $EASYDARWIN_HOME/easydarwin.ini';\\\n        echo 'if [[ -n \"$DEFAULT_USERNAME\" ]];then';\\\n        echo '  sed -i \"s/^default_username=.*/default_username=$DEFAULT_USERNAME/g\" $EASYDARWIN_HOME/easydarwin.ini';\\\n        echo 'fi';\\\n        echo 'if [[ -n \"$DEFAULT_PASSWORD\" ]];then';\\\n        echo '  sed -i \"s/^default_password=.*/default_password=$DEFAULT_PASSWORD/g\" $EASYDARWIN_HOME/easydarwin.ini';\\\n        echo 'fi';\\\n        echo 'if [[ -n \"$READ_TIMEOUT\" ]];then';\\\n        echo '  sed -i \"s/^read_timeout=.*/read_timeout=$READ_TIMEOUT/g\" $EASYDARWIN_HOME/easydarwin.ini';\\\n        echo 'fi';\\\n        echo 'if [[ -n \"$WRITE_TIMEOUT\" ]];then';\\\n        echo '  sed -i \"s/^write_timeout=.*/write_timeout=$WRITE_TIMEOUT/g\" $EASYDARWIN_HOME/easydarwin.ini';\\\n        echo 'fi';\\\n        echo 'if [ \"$LOCAL_AUTHORIZATION_ENABLE\" == \"1\" ];then';\\\n        echo '  sed -i \"s/^local_authorization_enable=.*/local_authorization_enable=$LOCAL_AUTHORIZATION_ENABLE/g\" $EASYDARWIN_HOME/easydarwin.ini';\\\n        echo 'fi';\\\n        echo 'if [ \"$REMOTE_HTTP_AUTHORIZATION_ENABLE\" == \"1\" ];then';\\\n        echo '  sed -i \"s/^remote_http_authorization_enable=.*/remote_http_authorization_enable=$REMOTE_HTTP_AUTHORIZATION_ENABLE/g\" $EASYDARWIN_HOME/easydarwin.ini';\\\n        echo 'fi';\\\n        echo 'if [[ -n \"$AUTHORIZATION_TYPE\" ]];then';\\\n        echo '  sed -i \"s/^authorization_type=.*/authorization_type=$AUTHORIZATION_TYPE/g\" $EASYDARWIN_HOME/easydarwin.ini';\\\n        echo 'fi';\\\n        echo 'if [[ -n \"$REMOTE_HTTP_AUTHORIZATION_URL\" ]];then';\\\n        echo '  sed -i \"s/^remote_http_authorization_url=.*/remote_http_authorization_url=${REMOTE_HTTP_AUTHORIZATION_URL//\\//\\\\\\/}/g\" $EASYDARWIN_HOME/easydarwin.ini';\\\n        echo 'fi';\\\n        echo 'if [[ -n \"$EASYDARWIN_REST_API_ON_PLAY\" ]];then';\\\n        echo '  sed -i \"s/^on_play=.*/on_play=${EASYDARWIN_REST_API_ON_PLAY//\\//\\\\\\/}/g\" $EASYDARWIN_HOME/easydarwin.ini';\\\n        echo 'fi';\\\n        echo 'if [[ -n \"$EASYDARWIN_REST_API_ON_STOP\" ]];then';\\\n        echo '  sed -i \"s/^on_stop=.*/on_stop=${EASYDARWIN_REST_API_ON_STOP//\\//\\\\\\/}/g\" $EASYDARWIN_HOME/easydarwin.ini';\\\n        echo 'fi';\\\n        echo 'if [[ -n \"$EASYDARWIN_REST_API_ON_PUBLISH\" ]];then';\\\n        echo '  sed -i \"s/^on_publish=.*/on_publish=${EASYDARWIN_REST_API_ON_PUBLISH//\\//\\\\\\/}/g\" $EASYDARWIN_HOME/easydarwin.ini';\\\n        echo 'fi';\\\n        echo 'if [[ -n \"$EASYDARWIN_REST_API_ON_TEARDOWN\" ]];then';\\\n        echo '  sed -i \"s/^on_teardown=.*/on_teardown=${EASYDARWIN_REST_API_ON_TEARDOWN//\\//\\\\\\/}/g\" $EASYDARWIN_HOME/easydarwin.ini';\\\n        echo 'fi';\\\n        echo 'if [[ -n \"$ENABLE_HTTP_AUDIO_STREAM\" ]];then';\\\n        echo '  sed -i \"s/^enable_http_audio_stream=.*/enable_http_audio_stream=$ENABLE_HTTP_AUDIO_STREAM/g\" $EASYDARWIN_HOME/easydarwin.ini';\\\n        echo 'fi';\\\n        echo 'if [[ -n \"$HTTP_AUDIO_STREAM_PORT\" ]];then';\\\n        echo '  sed -i \"s/^http_audio_stream_port=.*/http_audio_stream_port=$HTTP_AUDIO_STREAM_PORT/g\" $EASYDARWIN_HOME/easydarwin.ini';\\\n        echo 'fi';\\\n        echo 'if [[ -n \"$ENABLE_HTTP_VIDEO_STREAM\" ]];then';\\\n        echo '  sed -i \"s/^enable_http_video_stream=.*/enable_http_video_stream=$ENABLE_HTTP_VIDEO_STREAM/g\" $EASYDARWIN_HOME/easydarwin.ini';\\\n        echo 'fi';\\\n        echo 'if [[ -n \"$HTTP_VIDEO_STREAM_PORT\" ]];then';\\\n        echo '  sed -i \"s/^http_video_stream_port=.*/http_video_stream_port=$HTTP_VIDEO_STREAM_PORT/g\" $EASYDARWIN_HOME/easydarwin.ini';\\\n        echo 'fi';\\\n        echo 'if [[ -n \"$NGINX_RTMP_HLS_DIR_MAP\" ]];then';\\\n        echo '  sed -i \"s/^nginx_rtmp_hls_dir_map=.*/nginx_rtmp_hls_dir_map=${NGINX_RTMP_HLS_DIR_MAP//\\//\\\\\\/}/g\" $EASYDARWIN_HOME/easydarwin.ini';\\\n        echo 'fi';\\\n        echo 'if [ \"$CLOSE_OLD\" == \"1\" ];then';\\\n        echo '  sed -i \"s/^close_old=.*/close_old=$CLOSE_OLD/g\" $EASYDARWIN_HOME/easydarwin.ini';\\\n        echo 'fi';\\\n        echo 'if [ \"$KEEP_PLAYERS\" == \"1\" ];then';\\\n        echo '  sed -i \"s/^keep_players=.*/keep_players=$KEEP_PLAYERS/g\" $EASYDARWIN_HOME/easydarwin.ini';\\\n        echo 'fi';\\\n        echo 'if [[ -n \"$STREAM_NOTEXIST_WAIT_SECOND\" ]];then';\\\n        echo '  sed -i \"s/^stream_notexist_wait_second=.*/stream_notexist_wait_second=$STREAM_NOTEXIST_WAIT_SECOND/g\" $EASYDARWIN_HOME/easydarwin.ini';\\\n        echo 'fi';\\\n        echo 'if [[ -n \"$RTPSERVER_UDPORT_RANGE\" ]];then';\\\n        echo '  sed -i \"s/^rtpserver_udport_range=.*/rtpserver_udport_range=$RTPSERVER_UDPORT_RANGE/g\" $EASYDARWIN_HOME/easydarwin.ini';\\\n        echo 'fi';\\\n        echo 'if [[ -n \"$ENABLE_MULTICAST\" ]];then';\\\n        echo '  sed -i \"s/^enable_multicast=.*/enable_multicast=$ENABLE_MULTICAST/g\" $EASYDARWIN_HOME/easydarwin.ini';\\\n        echo 'fi';\\\n        echo 'if [[ -n \"$EAYDARWIN_MULTICST_BIND_INF_NAME\" ]];then';\\\n        echo '  sed -i \"s/^multicast_svc_bind_inf=.*/multicast_svc_bind_inf=$EAYDARWIN_MULTICST_BIND_INF_NAME/g\" $EASYDARWIN_HOME/easydarwin.ini';\\\n        echo 'fi';\\\n        echo 'if [ \"$SAVE_STREAM_TO_LOCAL\" == \"1\" ];then';\\\n        echo '  sed -i \"s/^save_stream_to_local=.*/keep_players=$SAVE_STREAM_TO_LOCAL/g\" $EASYDARWIN_HOME/easydarwin.ini';\\\n        echo '  sed -i \"s/^m3u8_dir_path=.*/m3u8_dir_path=\\/home\\/media\\/hls/g\" $EASYDARWIN_HOME/easydarwin.ini';\\\n        echo 'fi';\\\n        echo 'chmod +x $EASYDARWIN_HOME/easydarwin';\\\n        echo 'echo \"$EASYDARWIN_HOME\" > /app/easydarwin_home';\\\n        echo 'else';\\\n        echo 'EASYDARWIN_HOME=$(cat /app/easydarwin_home)';\\\n        echo 'fi';\\\n        echo '$EASYDARWIN_HOME/easydarwin';\\\n        }>/app/start-easydarwin && chmod +x /app/start-easydarwin;\\\n        #ts存储文件位置\n        mkdir -p /home/media/hls\n#暴露容器rtsp端口\nEXPOSE 554\n#暴露容器http端口\nEXPOSE 10008\nVOLUME /home/media/hls\nENTRYPOINT [\"/app/start-easydarwin\"]\n"
}