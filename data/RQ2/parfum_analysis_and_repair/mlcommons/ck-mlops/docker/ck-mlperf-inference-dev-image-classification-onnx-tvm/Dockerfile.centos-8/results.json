{
  "startTime": 1674247036049,
  "endTime": 1674247040565,
  "originalSmells": [
    {
      "rule": "yumInstallRmVarCacheYum",
      "position": {
        "lineStart": 24,
        "lineEnd": 30,
        "columnStart": 4,
        "columnEnd": 15
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "# Adaptive container with the CK interface\n# Concept: https://arxiv.org/abs/2011.01149\n\n# DOESN'T WORK! Fails with:\n#INFO:main:starting TestScenario.Offline\n#/usr/include/c++/9/bits/atomic_base.h:416: std::__atomic_base<_IntTp>::__int_type std::__atomic_base<_IntTp>::load(std::memory_order) const [with _ITp = long int; std::__atomic_base<_IntTp>::__int_type = long int; std::memory_order = std::memory_order]: Assertion '__b != memory_order_release' failed.\n#./run_local.sh: line 19:    77 Aborted                 (core dumped) ${PYTHON} python/main.py --profile $profile $common_opt --model $model_path $dataset --output $OUTPUT_DIR $EXTRA_OPS $@\n#\n\nFROM centos:8\n\n# Contact\nLABEL maintainer=\"Grigori Fursin <grigori@octoml.ai>\"\n\n# Shell info\nSHELL [\"/bin/bash\", \"-c\"]\n#ENTRYPOINT [\"/bin/bash\", \"-c\"]\n\n# Set noninteractive mode for apt (do not use ENV)\nARG DEBIAN_FRONTEND=noninteractive\n\n# Notes: https://runnable.com/blog/9-common-dockerfile-mistakes\n# Install system dependencies with gcc-10 (gcc-8 doesn't compile loadgen)\nRUN yum update -y && \\\n    yum install -y \\\n           git wget zip bzip2 cmake curl unzip \\\n           vim mc tree patch \\\n           gcc-toolset-9-* autoconf libtool make \\\n           openssl-devel bzip2-devel libffi-devel \\\n           dnf dnf-plugins-core \\\n           sudo && rm -rf /var/cache/yum\n\nRUN yum config-manager --set-enabled powertools\nRUN dnf install -y python3 python3-pip python3-devel\nRUN dnf --enablerepo=powertools install -y libsndfile-devel\n\n# Prepare a user with a user group with a random id\nRUN groupadd -g 1111 ckuser\nRUN useradd -u 2222 -g ckuser --create-home --shell /bin/bash ckuser\nRUN echo \"ckuser:ckuser\" | chpasswd\nRUN echo \"ckuser   ALL=(ALL)  NOPASSWD:ALL\" >> /etc/sudoers\n\n# Set user\nUSER ckuser:ckuser\nWORKDIR /home/ckuser\nENV PATH=\"/home/ckuser/.local/bin:${PATH}\"\nRUN mkdir .ssh\n\nRUN python3 --version\n\n# Switch to gcc-10 for a user\n# Toolset gcc-9 doesn't seem to work well with clang/tvm\n#ENV PATH=/opt/rh/gcc-toolset-10/root/bin:$PATH\n# LIBRARY_PATH is needed to compile TVM via LLVM for std++ lib\n#ENV LIBRARY_PATH=/opt/rh/gcc-toolset-10/root/lib/gcc/x86_64-redhat-linux/10\n\n# Grigori tried different ways to enable GCC but they fail\n# on CentOS-8 with TVM. Here is another and not very elegant solution:\nRUN sudo cp -rf /opt/rh/gcc-toolset-9/root/usr/* /usr\n\nRUN gcc --version\nRUN g++ --version\n\n# Need to upgrade pip (otherwise different problems)\nRUN python3 -m pip install --upgrade pip --user\n\n# Install CK\nRUN export DUMMY_CK=A\nRUN ${DUMMY_CK} python3 -m pip install ck --user\nRUN ${DUMMY_CK} python3 -m pip install wheel  --user\n\n# Clone private CK repo\nRUN ck pull repo:mlcommons@ck-mlops\n\n# Install packages to CK env entries\nRUN ck setup kernel --var.install_to_env=yes\n\nRUN ck detect platform.os --platform_init_uoa=generic-linux-dummy\nRUN ck detect soft:compiler.python --full_path=/usr/bin/python3\n\nRUN ck detect soft:compiler.gcc --full_path=`which gcc`\n\nRUN python3 -m pip install protobuf --user\n\nRUN ck install package --tags=mlperf,inference,src,octoml.dev\n\nRUN ck install package --tags=lib,python-package,absl\n\nRUN ck install package --tags=lib,python-package,numpy\n\nRUN ck install package --tags=lib,python-package,mlperf,loadgen\n\nRUN ck install package --tags=lib,python-package,matplotlib\n\nRUN ck install package --tags=lib,python-package,cython\n\nRUN ck install package --tags=lib,python-package,opencv-python-headless\n\nRUN ck install package --tags=tool,coco,api\n\nRUN ck install package --tags=imagenet,2012,val,min,non-resized\nRUN ck install package --tags=imagenet,2012,aux,from.berkeley\n\nRUN ck install package --tags=lib,python-package,onnxruntime-cpu,1.7.0\nRUN ck install package --tags=lib,python-package,onnx,1.9.0\n\nRUN ck install package --tags=model,image-classification,mlperf,onnx,resnet50,v1.5-opset-11\n\nRUN ck install package --tags=lib,python-package,scipy\n\nRUN ck install package --tags=tool,cmake,prebuilt,v3.18.2\n\n# Prebuilt LLVM doesn't seem to work correctly via CK\nRUN ck install package --tags=compiler,llvm,src,v12.0.0\n\nRUN ck install package --tags=compiler,tvm,dev --env.CK_HOST_CPU_NUMBER_OF_PROCESSORS=4\n\n# Install MLPerf task requirements\nRUN ck run program:mlperf-inference-bench-image-classification-tvm-onnx-cpu --cmd_key=install-python-requirements\n\n# Run TVM-based MLPerf inference benchmark (Offline;Accuracy)\nCMD ck run program:mlperf-inference-bench-image-classification-tvm-onnx-cpu \\\n          --cmd_key=accuracy-offline \\\n          --env.EXTRA_OPS=\"--thread 1 --max-batchsize 1\"\n"
}