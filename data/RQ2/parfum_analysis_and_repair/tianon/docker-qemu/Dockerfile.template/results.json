{
  "startTime": 1674218612662,
  "endTime": 1674218613303,
  "originalSmells": [
    {
      "rule": "ruleAptGetInstallThenRemoveAptLists",
      "position": {
        "lineStart": 18,
        "lineEnd": 18,
        "columnStart": 1,
        "columnEnd": 60
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "FROM debian:bullseye-slim\n\nRUN set -eux; \\\n# add backports for (potentially) newer QEMU firmware packages\n\tsuite=\"$(awk '$1 == \"deb\" { print $3; exit }' /etc/apt/sources.list)\"; \\\n\techo \"deb http://deb.debian.org/debian $suite-backports main\" > /etc/apt/sources.list.d/backports.list; \\\n# and add APT pinning to ensure we don't accidentally get QEMU from Debian\n\t{ \\\n\t\techo 'Package: src:edk2'; \\\n\t\techo 'Pin: release a=*-backports'; \\\n\t\techo 'Pin-Priority: 600'; \\\n\t\techo; \\\n\t\techo 'Package: src:qemu'; \\\n\t\techo 'Pin: version *'; \\\n\t\techo 'Pin-Priority: -10'; \\\n\t} > /etc/apt/preferences.d/qemu.pref; \\\n\tapt-get update; \\\n# https://github.com/tianon/docker-qemu/issues/30\n\tapt-get install -y --no-install-recommends ca-certificates; rm -rf /var/lib/apt/lists/*; \\\n{{ def firmware_packages: {\n\tamd64: \"ovmf\",\n\tarm64: \"qemu-efi-aarch64\",\n\t\"armel | armhf\": \"qemu-efi-arm\",\n\ti386: \"ovmf-ia32\",\n# TODO add u-boot-qemu ?  https://packages.debian.org/bullseye/u-boot-qemu (not sure which arches to add this to since it contains all of them...  maybe every relevant one?)\n} -}}\n{{ if env.variant == \"native\" then ( -}}\n\tarch=\"$(dpkg --print-architecture)\"; \\\n\tcase \"$arch\" in \\\n{{\n\t[\n\t\tfirmware_packages\n\t\t| to_entries[]\n\t\t| (\n-}}\n\t\t{{ .key }}) apt-get install -y --no-install-recommends {{ .value }} ;; \\\n{{\n\t\t)\n\t] | add\n-}}\n\t\t*) echo >&2 \"warning: architecture '$arch' unknown ðŸ˜… (is there a 'QEMU firmware' package that should be installed here? likely candidates: https://packages.debian.org/source/$suite/edk2)\" ;; \\\n\tesac; \\\n{{ ) else ( -}}\n\tapt-get install -y --no-install-recommends \\\n{{\n\t[\n\t\t[ firmware_packages[] ]\n\t\t| sort[]\n\t\t| (\n-}}\n\t\t{{ . }} \\\n{{\n\t\t)\n\t] | add\n-}}\n\t; \\\n{{ ) end -}}\n\trm -rf /var/lib/apt/lists/*\n\nCOPY *.patch /qemu-patches/\n\n# https://wiki.qemu.org/SecurityProcess\nENV QEMU_KEYS \\\n# Michael Roth\n\t\tCEACC9E15534EBABB82D3FA03353C9CEF108B584\n# https://wiki.qemu.org/Planning/ReleaseProcess#Sign_the_resulting_tarball_with_GPG: (they get signed by whoever is making the release)\n\n# https://www.qemu.org/download/#source\n# https://download.qemu.org/?C=M;O=D\nENV QEMU_VERSION {{ .version }}\nENV QEMU_URL {{ .url }}\n\nRUN set -eux; \\\n\t\\\n\tsavedAptMark=\"$(apt-mark showmanual)\"; \\\n\t\\\n\tapt-get update; \\\n\tapt-get install -y --no-install-recommends \\\n\t\tgnupg dirmngr \\\n\t\twget \\\n\t\txz-utils \\\n\t\t\\\n\t\tpatch \\\n\t\t\\\n\t\tbzip2 \\\n\t\tgcc \\\n\t\tgnutls-dev \\\n\t\tlibaio-dev \\\n\t\tlibbz2-dev \\\n\t\tlibc-dev \\\n\t\tlibcap-dev \\\n\t\tlibcap-ng-dev \\\n\t\tlibcurl4-gnutls-dev \\\n\t\tlibglib2.0-dev \\\n\t\tlibiscsi-dev \\\n\t\tlibjpeg-dev \\\n\t\tlibncursesw5-dev \\\n\t\tlibnfs-dev \\\n\t\tlibnuma-dev \\\n\t\tlibpixman-1-dev \\\n\t\tlibpng-dev \\\n\t\tlibrbd-dev \\\n\t\tlibseccomp-dev \\\n\t\tlibssh-dev \\\n\t\tlibusb-1.0-0-dev \\\n\t\tlibusbredirparser-dev \\\n\t\tlibxen-dev \\\n\t\tmake \\\n\t\tpkg-config \\\n\t\tpython3 \\\n\t\tzlib1g-dev \\\n# https://wiki.qemu.org/ChangeLog/5.2#Build_Information\n\t\tninja-build \\\n\t\tpython3-setuptools \\\n# https://www.qemu.org/2021/08/22/fuse-blkexport/\n\t\tlibfuse3-dev \\\n\t; \\\n\trm -rf /var/lib/apt/lists/*; \\\n\t\\\n\ttarball=\"$(basename \"$QEMU_URL\")\"; \\\n\twget -O \"$tarball.sig\" \"$QEMU_URL.sig\"; \\\n\twget -O \"$tarball\" \"$QEMU_URL\" --progress=dot:giga; \\\n\t\\\n\texport GNUPGHOME=\"$(mktemp -d)\"; \\\n\tfor key in $QEMU_KEYS; do \\\n\t\tgpg --batch --keyserver keyserver.ubuntu.com --recv-keys \"$key\"; \\\n\tdone; \\\n\tgpg --batch --verify \"$tarball.sig\" \"$tarball\"; \\\n\tgpgconf --kill all; \\\n\trm -rf \"$GNUPGHOME\"; \\\n\t\\\n\tmkdir /usr/src/qemu; \\\n\ttar -xf \"$tarball\" -C /usr/src/qemu --strip-components=1; \\\n\trm \"$tarball\" \"$tarball.sig\"; \\\n\t\\\n\tcd /usr/src/qemu; \\\n\t\\\n\tfor p in /qemu-patches/*.patch; do \\\n\t\tpatch --strip 1 --input \"$p\"; \\\n\tdone; \\\n\trm -rf /qemu-patches; \\\n{{ if env.variant == \"native\" then ( -}}\n\t\\\n\tarch=\"$(dpkg --print-architecture)\"; \\\n\tcase \"$arch\" in \\\n\t\tamd64) targetList='x86_64-softmmu' ;; \\\n\t\tarm64) targetList='aarch64-softmmu' ;; \\\n\t\tarmel | armhf) targetList='arm-softmmu' ;; \\\n\t\ti386) targetList='i386-softmmu' ;; \\\n\t\tmips64el) targetList='mips64el-softmmu' ;; \\\n\t\tppc64el) targetList='ppc64-softmmu' ;; \\\n\t\ts390x) targetList='s390x-softmmu' ;; \\\n\t\t*) echo >&2 \"error: architecture '$arch' unimplemented ðŸ˜…\"; exit 1 ;; \\\n\tesac; \\\n{{ ) else \"\" end -}}\n\t\\\n\t./configure --help; \\\n\t./configure \\\n# let's add a link to our source code in the output of \"--version\" in case our users end up filing bugs against the QEMU project O:)\n\t\t--with-pkgversion='https://github.com/tianon/docker-qemu' \\\n{{ if env.variant == \"native\" then ( -}}\n\t\t--target-list=\"$targetList\" \\\n{{ ) else ( -}}\n\t\t--target-list=' \\\n# system targets\n# (https://sources.debian.org/src/qemu/buster/debian/rules/#L59-L63, slimmed)\n\t\t\ti386-softmmu x86_64-softmmu aarch64-softmmu arm-softmmu m68k-softmmu \\\n\t\t\tmips64-softmmu mips64el-softmmu ppc64-softmmu riscv64-softmmu \\\n\t\t\tsparc64-softmmu s390x-softmmu \\\n\t\t' \\\n{{ ) end -}}\n# let's point \"firmware path\" to Debian's value so we get access to \"OVMF.fd\" and friends more easily\n\t\t--firmwarepath=/usr/share/qemu:/usr/share/seabios:/usr/lib/ipxe/qemu \\\n# https://salsa.debian.org/qemu-team/qemu/-/blob/058ab4ec8623766b50055c8c56d0d5448d52fb0a/debian/rules#L38\n\t\t--disable-docs \\\n\t\t--disable-gtk --disable-vte \\\n\t\t--disable-sdl \\\n\t\t--enable-attr \\\n\t\t--enable-bzip2 \\\n\t\t--enable-cap-ng \\\n\t\t--enable-curl \\\n\t\t--enable-curses \\\n\t\t--enable-fdt \\\n\t\t--enable-gnutls \\\n\t\t--enable-kvm \\\n\t\t--enable-libiscsi \\\n\t\t--enable-libnfs \\\n\t\t--enable-libssh \\\n\t\t--enable-libusb \\\n\t\t--enable-linux-aio \\\n\t\t--enable-modules \\\n\t\t--enable-numa \\\n\t\t--enable-rbd \\\n\t\t--enable-seccomp \\\n\t\t--enable-tools \\\n\t\t--enable-usb-redir \\\n\t\t--enable-vhost-net \\\n\t\t--enable-vhost-user \\\n\t\t--enable-vhost-vsock \\\n\t\t--enable-virtfs \\\n\t\t--enable-vnc \\\n\t\t--enable-vnc-jpeg \\\n\t\t--enable-vnc-png \\\n\t\t--enable-xen \\\n# rbd support is enabled, but \"librbd1\" is not included since it adds ~60MB and is version-sensitive (https://github.com/tianon/docker-qemu/pull/11#issuecomment-689816553)\n#\t\t--enable-vde \\\n# https://www.qemu.org/2021/08/22/fuse-blkexport/\n\t\t--enable-fuse \\\n\t; \\\n\tmake -j \"$(nproc)\"; \\\n\tmake install; \\\n\t\\\n\tcd /; \\\n\trm -rf /usr/src/qemu; \\\n\t\\\n\tapt-mark auto '.*' > /dev/null; \\\n\t[ -z \"$savedAptMark\" ] || apt-mark manual $savedAptMark > /dev/null; \\\n\tfind /usr/local \\\n\t\t-type f \\\n\t\t\\( -executable -o -name '*.so' \\) \\\n# rbd support is enabled, but \"librbd1\" is not included since it adds ~60MB and is version-sensitive (https://github.com/tianon/docker-qemu/pull/11#issuecomment-689816553)\n\t\t-not -name 'block-rbd.so' \\\n\t\t-exec ldd '{}' ';' \\\n\t\t| awk '/=>/ { print $(NF-1) }' \\\n\t\t| sort -u \\\n\t\t| xargs -r dpkg-query --search \\\n\t\t| cut -d: -f1 \\\n\t\t| sort -u \\\n\t\t| xargs -r apt-mark manual \\\n\t; \\\n\tapt-get purge -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false; \\\n\t\\\n# basic smoke test\n\tqemu-img --version\n\nSTOPSIGNAL SIGHUP\n\nEXPOSE 22\nEXPOSE 5900\n\nCOPY start-qemu /usr/local/bin/\nCMD [\"start-qemu\"]\n"
}