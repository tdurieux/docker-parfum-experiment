{
  "startTime": 1674217319982,
  "endTime": 1674217320759,
  "originalSmells": [
    {
      "rule": "yumInstallRmVarCacheYum",
      "position": {
        "lineStart": 9,
        "lineEnd": 9,
        "columnStart": 122,
        "columnEnd": 147
      }
    }
  ],
  "repairedSmells": [],
  "repairedDockerfile": "# Build on top of the RHEL 8 image\nFROM registry.access.redhat.com/ubi8\n\nRUN groupadd -g 288 kdcproxy ; useradd -u 288 -g 288 -c 'IPA KDC Proxy User' -d '/var/lib/kdcproxy' -s '/sbin/nologin' kdcproxy\nRUN groupadd -g 289 ipaapi; useradd -u 289 -g 289 -c 'IPA Framework User' -r -d / -s '/sbin/nologin' ipaapi\n\n# Workaround 1615948\nRUN ln -s /bin/false /usr/sbin/systemd-machine-id-setup\nRUN sed -i 's!%_install_langs.*!%_install_langs all!' /etc/rpm/macros.image-language-conf\nRUN yum -y module enable idm:DL1 && yum -y module install --setopt=install_weak_deps=False idm:DL1/adtrust idm:DL1/dns && yum -y install patch sudo && yum clean all && rm -rf /var/cache/yum\n\n# debug: RUN test $( getent passwd | grep -E \"^(dirsrv:x:389|ipaapi:x:289|kdcproxy:x:288|pkiuser:x:17):\" | wc -l ) -eq 4\n\n# Container image which runs systemd\n# debug: RUN test -f /etc/machine-id && ! test -s /etc/machine-id\n# debug: RUN test \"$container\" = oci\n\n# Establish reasonably low open files limit in the container\nRUN echo \"DefaultLimitNOFILE=1024\" >> /etc/systemd/system.conf\n\nENTRYPOINT [ \"/usr/sbin/init\" ]\nSTOPSIGNAL RTMIN+3\n# test-addon: VOLUME [ \"/var/log/journal\" ]\n# test: systemd-container-failed.sh var-lib-nfs-rpc_pipefs.mount\n\n# Minimize the systemd setup\nRUN find /etc/systemd/system /usr/lib/systemd/system/{basic,multi-user,sysinit}.target.wants -type l \\! -lname /dev/null | xargs rm -v\nCOPY patches/minimal-fedora-26.patch /root/\nRUN patch --verbose -p0 --fuzz=0 < /root/minimal-fedora-26.patch\n# debug: RUN ! find /etc/systemd/system /usr/lib/systemd/system/{basic,multi-user,sysinit}.target.wants /etc/tmpfiles.d -type f | grep .\n\nCOPY container-ipa.target /usr/lib/systemd/system/\nRUN systemctl set-default container-ipa.target\nRUN rmdir -v /etc/systemd/system/multi-user.target.wants \\\n\t&& mkdir /etc/systemd/system/container-ipa.target.wants \\\n\t&& ln -s /etc/systemd/system/container-ipa.target.wants /etc/systemd/system/multi-user.target.wants\nRUN mkdir /var/log/journal\nRUN systemd-tmpfiles --remove --create\n# debug: RUN ! test -f /var/lib/systemd/random-seed\n# test-addon: VOLUME [ \"/var/log/journal\" ]\n# test: systemd-container-diff.sh list-dependencies-rhel-8.out /dev/null docker-diff-minimal-rhel-8.out\n\n# Prepare for basic ipa-server-install in container\n# Address failing nis-domainname.service in the ipa-client-install step\nRUN mv /usr/bin/nisdomainname /usr/bin/nisdomainname.orig\nADD hostnamectl-wrapper /usr/bin/nisdomainname\n\nCOPY patches/ipa-rhel-8.patch /root\nRUN set -o pipefail ; patch --verbose -p0 --fuzz=0 < /root/ipa-rhel-8.patch | tee /dev/stderr | sed -n 's/^patching file //;T;/\\.py$/p' | xargs /usr/libexec/platform-python -m compileall\n\n# test-addon: VOLUME [ \"/var/log/journal\" ]\n## # test: systemd-container-ipa-server-install.sh\n\n# Move configuration and data to data volume\nCOPY patches/ipa-data-rhel-8.patch /root\nRUN set -o pipefail ; patch --verbose -p0 --fuzz=0 < /root/ipa-data-rhel-8.patch | tee /dev/stderr | sed -n 's/^patching file //;T;/\\.py$/p' | xargs /usr/libexec/platform-python -m compileall\nCOPY ipaplatform-rhel.conf /usr/lib/systemd/system.conf.d/ipaplatform-override.conf\nENV IPAPLATFORM_OVERRIDE=rhel_container\n\nCOPY journald-storage.conf /usr/lib/systemd/journald.conf.d/storage.conf\n\nRUN mv /usr/sbin/ipa-join /usr/sbin/ipa-join.orig\nCOPY ipa-join /usr/sbin/ipa-join\n\nRUN authselect select sssd with-sudo --force && mv /usr/bin/authselect /usr/bin/authselect.orig\nCOPY authselect /usr/bin/authselect\n\nCOPY utils/prepare-volume-template utils/populate-volume-from-template utils/extract-rpm-upgrade-scriptlets /usr/local/bin/\nCOPY volume-data-list volume-tmp-list volume-data-autoupdate /etc/\nRUN /usr/local/bin/prepare-volume-template /etc/volume-data-list /data\nRUN /usr/local/bin/prepare-volume-template /etc/volume-tmp-list /tmp\nRUN /usr/local/bin/extract-rpm-upgrade-scriptlets\n\nRUN echo 2.0 > /etc/volume-version\nVOLUME [ \"/tmp\", \"/run\", \"/data\", \"/var/log/journal\" ]\n\nCOPY init-data-minimal /usr/local/sbin/init\nENTRYPOINT [ \"/usr/local/sbin/init\" ]\n# test: systemd-container-ipa-server-install-data.sh /dev/null\n\n# Configure master/replica upon the first invocation\nCOPY init-data /usr/local/sbin/init\nCOPY ipa-server-configure-first systemctl-exit-with-status ipa-volume-upgrade-* /usr/sbin/\nCOPY ipa-server-configure-first.service ipa-server-upgrade.service ipa-server-update-self-ip-address.service /usr/lib/systemd/system/\nCOPY service-success-poweroff.conf /usr/lib/systemd/system/ipa-server-configure-first.service.d/service-success-poweroff.conf.template\nRUN ln -sv /usr/lib/systemd/system/ipa-server-configure-first.service /data-template/etc/systemd/system/container-ipa.target.wants/ipa-server-configure-first.service\nCOPY exit-status.conf /usr/lib/systemd/system/systemd-poweroff.service.d/\n\nEXPOSE 53/udp 53 80 443 389 636 88 464 88/udp 464/udp 123/udp\n\nRUN uuidgen > /data-template/build-id\n\n# Invocation:\n# docker run -ti -v /sys/fs/cgroup:/sys/fs/cgroup:ro --tmpfs /run --tmpfs /tmp -v /opt/ipa-data:/data:Z -h ipa.example.test ${NAME} [ options ]\n\nLABEL maintainer=\"FreeIPA Developers <freeipa-devel@lists.fedorahosted.org>\"\n"
}