{"repository":"https://github.com/emicklei/gmig","dockerfilePath":"Dockerfile","startTime":1672600163059,"clone":{"stdout":"","stderr":"Cloning into '/tmp/dinghy-analysis/emicklei/gmig'...\n","error":null,"commit":"176399b1dda2c0436e1b2700ef47dfd85a29abd4"},"originalBuild":{"startTimestamp":1672600163942,"endTimestamp":1672600190965,"error":null,"stdout":"Sending build context to Docker daemon  409.6kB\r\r\nStep 1/12 : FROM golang\nlatest: Pulling from library/golang\nDigest: sha256:660f138b4477001d65324a51fa158c1b868651b44e43f0953bf062e9f38b72f3\nStatus: Downloaded newer image for golang:latest\n ---> 6650307efe4a\nStep 2/12 : RUN apt-get install -y ca-certificates\n ---> Running in 345e83931720\nReading package lists...\nBuilding dependency tree...\nReading state information...\nca-certificates is already the newest version (20210119).\n0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.\nRemoving intermediate container 345e83931720\n ---> f8c0378bffcb\nStep 3/12 : RUN update-ca-certificates\n ---> Running in 3fca95264110\nUpdating certificates in /etc/ssl/certs...\n0 added, 0 removed; done.\nRunning hooks in /etc/ca-certificates/update.d...\ndone.\nRemoving intermediate container 3fca95264110\n ---> c435de97b50b\nStep 4/12 : WORKDIR /go/src/github.com/emicklei/gmig\n ---> Running in b6542a54271f\nRemoving intermediate container b6542a54271f\n ---> f4f6ffd79a4e\nStep 5/12 : COPY . .\n ---> 33ef88495d4d\nStep 6/12 : ARG version\n ---> Running in f7c78eae0f4c\nRemoving intermediate container f7c78eae0f4c\n ---> dbb19879afd8\nStep 7/12 : RUN go test -v -cover\n ---> Running in 2b0b413e95ba\n\u001b[91mgo: downloading github.com/antonmedv/expr v1.9.0\n\u001b[0m\u001b[91mgo: downloading github.com/urfave/cli v1.22.10\ngo: downloading github.com/emicklei/tre v1.4.0\n\u001b[0m\u001b[91mgo: downloading gopkg.in/yaml.v2 v2.4.0\n\u001b[0m\u001b[91mgo: downloading github.com/marcacohen/gcslock v0.0.0-20180212104141-5782a95db7e2\n\u001b[0m\u001b[91mgo: downloading github.com/cpuguy83/go-md2man/v2 v2.0.2\n\u001b[0m\u001b[91mgo: downloading github.com/russross/blackfriday/v2 v2.1.0\n\u001b[0m\u001b[91mgo: downloading golang.org/x/oauth2 v0.0.0-20221014153046-6fdb5e3db783\n\u001b[0m\u001b[91mgo: downloading golang.org/x/net v0.0.0-20221014081412-f15817d10f9b\n\u001b[0m\u001b[91mgo: downloading cloud.google.com/go/compute v1.10.0\n\u001b[0m=== RUN   Test_loadbalancerURLMap_patchPathsAndService\n--- PASS: Test_loadbalancerURLMap_patchPathsAndService (0.00s)\n=== RUN   TestCmdTemplate\n/usr/local/go/bin:/go/bin:/usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\n--- PASS: TestCmdTemplate (0.00s)\n=== RUN   TestCmdInit\n--- PASS: TestCmdInit (0.00s)\n=== RUN   TestCmdInitMissingConfig\n2023/01/01 19:09:40 config file [ test/missing/gmig.yaml ] already present.\n2023/01/01 19:09:40 config [ bucket= my-bucket ,state= myapp-gmig-last-migration ,verbose= false ]\n--- PASS: TestCmdInitMissingConfig (0.00s)\n=== RUN   TestCmdStatusDemo\n2023/01/01 19:09:40 gmig version \n2023/01/01 19:09:40 BEGIN show status of migrations\n2023/01/01 19:09:40 \u001b[1;31mWARNING:\u001b[0m JSON configuration (gmig.json) is deprecated, your configuration (gmig.yaml)\n2023/01/01 19:09:40 loading configuration from /go/src/github.com/emicklei/gmig/test/demo/gmig.json\n2023/01/01 19:09:40 setting gcloud config [core/project] to [demo]\n2023/01/01 19:09:40 \n2023/01/01 19:09:40 gsutil -q cp gs://bucket/state state\n2023/01/01 19:09:40 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 --- applied --- 010 one\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ... pending ... 020 two\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ... pending ... 030 three\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ... pending ... 040 error\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ... pending ... 050 conditional\n2023/01/01 19:09:40 \u001b[1;31mWARNING:\u001b[0m if: expression is invalid: unknown name A (1:1)\n | A == \"ENV\"\n | ^\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ... if error .. 060 conditional fail\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 END show status of migrations completed in 1.954921ms\n--- PASS: TestCmdStatusDemo (0.00s)\n=== RUN   TestCmdStatusDemoWithMigrationsOption\n2023/01/01 19:09:40 gmig version \n2023/01/01 19:09:40 BEGIN show status of migrations\n2023/01/01 19:09:40 setting gcloud config [core/project] to [demo]\n2023/01/01 19:09:40 \n2023/01/01 19:09:40 gsutil -q cp gs://bucket/state state\n2023/01/01 19:09:40 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 override migrations path with [test] from [/go/src/github.com/emicklei/gmig/test] to [/go/src/github.com/emicklei/gmig/test] err:[<nil>]\n2023/01/01 19:09:40 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 --- applied --- 010 one\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ... pending ... 020 two\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ... pending ... 030 three\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ... pending ... 040 error\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ... pending ... 050 conditional\n2023/01/01 19:09:40 \u001b[1;31mWARNING:\u001b[0m if: expression is invalid: unknown name A (1:1)\n | A == \"ENV\"\n | ^\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ... if error .. 060 conditional fail\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 END show status of migrations completed in 1.109468ms\n--- PASS: TestCmdStatusDemoWithMigrationsOption (0.00s)\n=== RUN   TestCmdForceState\n2023/01/01 19:09:40 setting gcloud config [core/project] to [demo]\n2023/01/01 19:09:40 \n2023/01/01 19:09:40 gsutil -q cp gs://bucket/state state\n2023/01/01 19:09:40 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:09:40 writing local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 gsutil -q -h Content-Type:text/plain cp state gs://bucket/state\n2023/01/01 19:09:40 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 setting gcloud config [core/project] to [demo]\n2023/01/01 19:09:40 \n2023/01/01 19:09:40 gsutil -q cp gs://bucket/state state\n2023/01/01 19:09:40 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 --- applied --- 010 one\n2023/01/01 19:09:40 --- applied --- 020 two\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ... pending ... 030 three\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ... pending ... 040 error\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ... pending ... 050 conditional\n2023/01/01 19:09:40 \u001b[1;31mWARNING:\u001b[0m if: expression is invalid: unknown name A (1:1)\n | A == \"ENV\"\n | ^\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ... if error .. 060 conditional fail\n2023/01/01 19:09:40 ~-------------- ------------------~\n    commands_test.go:101: got [3] want [2]\n--- PASS: TestCmdForceState (0.00s)\n=== RUN   TestCmdForceStateNested\n2023/01/01 19:09:40 gmig version \n2023/01/01 19:09:40 BEGIN force last applied migration (state)\n2023/01/01 19:09:40 setting gcloud config [core/project] to [demo]\n2023/01/01 19:09:40 \n2023/01/01 19:09:40 gsutil -q cp gs://bucket/state state\n2023/01/01 19:09:40 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 override migrations path with [test] from [/go/src/github.com/emicklei/gmig/test/demo] to [/go/src/github.com/emicklei/gmig/test] err:[<nil>]\n2023/01/01 19:09:40 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:09:40 writing local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 gsutil -q -h Content-Type:text/plain cp state gs://bucket/state\n2023/01/01 19:09:40 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 setting gcloud config [core/project] to [demo]\n2023/01/01 19:09:40 \n2023/01/01 19:09:40 gsutil -q cp gs://bucket/state state\n2023/01/01 19:09:40 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 override migrations path with [test] from [/go/src/github.com/emicklei/gmig/test/demo] to [/go/src/github.com/emicklei/gmig/test] err:[<nil>]\n2023/01/01 19:09:40 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 --- applied --- 010 one\n2023/01/01 19:09:40 --- applied --- 020 two\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ... pending ... 030 three\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ... pending ... 040 error\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ... pending ... 050 conditional\n2023/01/01 19:09:40 \u001b[1;31mWARNING:\u001b[0m if: expression is invalid: unknown name A (1:1)\n | A == \"ENV\"\n | ^\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ... if error .. 060 conditional fail\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 END force last applied migration (state) completed in 1.030777ms\n    commands_test.go:140: got [3] want [2]\n--- PASS: TestCmdForceStateNested (0.00s)\n=== RUN   TestCmdUp\n2023/01/01 19:09:40 setting gcloud config [core/project] to [demo]\n2023/01/01 19:09:40 \n2023/01/01 19:09:40 \u001b[1;31mERROR:\u001b[0m go/src/github.com/emicklei/gmig/gcloud.go:38 gmig.gcloudConfigSetProject:error changing gcloud config core/project=demo \ncause: shell error\n    commands_test.go:172: got [1] want [4]\n--- PASS: TestCmdUp (0.00s)\n=== RUN   TestCmdUpAndStop\n2023/01/01 19:09:40 setting gcloud config [core/project] to [demo]\n2023/01/01 19:09:40 error\n2023/01/01 19:09:40 gsutil -q cp gs://bucket/state state\n2023/01/01 19:09:40 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ...      do ... 020 two (020_two.yaml)\nerror\n2023/01/01 19:09:40 writing local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 gsutil -q -h Content-Type:text/plain cp state gs://bucket/state\n2023/01/01 19:09:40 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 ... stopped ...\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 setting gcloud config [core/project] to [demo]\n2023/01/01 19:09:40 error\n2023/01/01 19:09:40 gsutil -q cp gs://bucket/state state\n2023/01/01 19:09:40 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 --- applied --- 010 one\n2023/01/01 19:09:40 --- applied --- 020 two\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ... pending ... 030 three\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ... pending ... 040 error\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ... pending ... 050 conditional\n2023/01/01 19:09:40 \u001b[1;31mWARNING:\u001b[0m if: expression is invalid: unknown name A (1:1)\n | A == \"ENV\"\n | ^\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ... if error .. 060 conditional fail\n2023/01/01 19:09:40 ~-------------- ------------------~\n--- PASS: TestCmdUpAndStop (0.00s)\n=== RUN   TestCmdUpAndStopAfterLastApplied\n2023/01/01 19:09:40 setting gcloud config [core/project] to [demo]\n2023/01/01 19:09:40 \n2023/01/01 19:09:40 \u001b[1;31mERROR:\u001b[0m go/src/github.com/emicklei/gmig/gcloud.go:38 gmig.gcloudConfigSetProject:error changing gcloud config core/project=demo \ncause: shell error\n--- PASS: TestCmdUpAndStopAfterLastApplied (0.00s)\n=== RUN   TestCmdUpAndStopAfterUnexistingFilename\n2023/01/01 19:09:40 setting gcloud config [core/project] to [demo]\n2023/01/01 19:09:40 \n2023/01/01 19:09:40 gsutil -q cp gs://bucket/state state\n2023/01/01 19:09:40 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:09:40 executing [up until stop] failed, error: [No such migration file: missing.yaml]\n\n2023/01/01 19:09:40 reporting environment variables ...\nPROJECT=demo\nREGION=\nZONE=\nENV=A\nGMIG_CONFIG_DIR=/go/src/github.com/emicklei/gmig/test/demo\n\n2023/01/01 19:09:40 checking gmig config ...\n{\n\t\"project\": \"demo\",\n\t\"bucket\": \"bucket\",\n\t\"state\": \"state\",\n\t\"env\": {\n\t\t\"ENV\": \"A\"\n\t}\n}\n\n2023/01/01 19:09:40 checking gcloud config list ...\n\n--- PASS: TestCmdUpAndStopAfterUnexistingFilename (0.00s)\n=== RUN   TestCmdDown\n2023/01/01 19:09:40 gmig version \n2023/01/01 19:09:40 BEGIN down = undo last applied migration\n2023/01/01 19:09:40 setting gcloud config [core/project] to [demo]\n2023/01/01 19:09:40 \n2023/01/01 19:09:40 gsutil -q cp gs://bucket/state state\n2023/01/01 19:09:40 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ...    undo ... 010 one\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 --- BEGIN gmig.sh:\n #!/bin/bash\n# temporary gmig execution script\nset -e -x\necho \"one down\"\n --- END gmig.sh\n\n2023/01/01 19:09:40 writing local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 gsutil -q -h Content-Type:text/plain cp state gs://bucket/state\n2023/01/01 19:09:40 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 setting gcloud config [core/project] to [demo]\n2023/01/01 19:09:40 \n2023/01/01 19:09:40 gsutil -q cp gs://bucket/state state\n2023/01/01 19:09:40 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ... pending ... 010 one\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ... pending ... 020 two\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ... pending ... 030 three\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ... pending ... 040 error\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ... pending ... 050 conditional\n2023/01/01 19:09:40 \u001b[1;31mWARNING:\u001b[0m if: expression is invalid: unknown name A (1:1)\n | A == \"ENV\"\n | ^\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ... if error .. 060 conditional fail\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 END down = undo last applied migration completed in 1.222726ms\n    commands_test.go:248: got [6] want [3]\n--- PASS: TestCmdDown (0.00s)\n=== RUN   TestCmdDownWhenNoLastMigration\n2023/01/01 19:09:40 setting gcloud config [core/project] to [demo]\n2023/01/01 19:09:40 \n2023/01/01 19:09:40 gsutil -q cp gs://bucket/state state\n2023/01/01 19:09:40 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:09:40 \u001b[1;31mWARNING:\u001b[0m There are no migrations to undo\n--- PASS: TestCmdDownWhenNoLastMigration (0.00s)\n=== RUN   TestCmdView\n2023/01/01 19:09:40 setting gcloud config [core/project] to [demo]\n2023/01/01 19:09:40 \n2023/01/01 19:09:40 gsutil -q cp gs://bucket/state state\n2023/01/01 19:09:40 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:09:40 ~---------------------------------------------------------------~\n2023/01/01 19:09:40  010 one (010_one.yaml)\n2023/01/01 19:09:40  --------------------------------------------------------------- \n2023/01/01 19:09:40 executing view section (1 commands)\n\n2023/01/01 19:09:40 ~---------------------------------------------------------------~\n2023/01/01 19:09:40  020 two (020_two.yaml)\n2023/01/01 19:09:40  --------------------------------------------------------------- \n2023/01/01 19:09:40  ** this migration is pending...\n--- PASS: TestCmdView (0.00s)\n=== RUN   TestCmdUpConditional\n2023/01/01 19:09:40 setting gcloud config [core/project] to [demo]\n2023/01/01 19:09:40 \n2023/01/01 19:09:40 gsutil -q cp gs://bucket/state state\n2023/01/01 19:09:40 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ...      do ... 050 conditional (050_conditional.yaml)\n\n2023/01/01 19:09:40 writing local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 gsutil -q -h Content-Type:text/plain cp state gs://bucket/state\n2023/01/01 19:09:40 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 ... stopped ...\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 setting gcloud config [core/project] to [demo]\n2023/01/01 19:09:40 \n2023/01/01 19:09:40 gsutil -q cp gs://bucket/state state\n2023/01/01 19:09:40 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 --- applied --- 010 one\n2023/01/01 19:09:40 --- applied --- 020 two\n2023/01/01 19:09:40 --- applied --- 030 three\n2023/01/01 19:09:40 --- applied --- 040 error\n2023/01/01 19:09:40 --- applied --- 050 conditional\n2023/01/01 19:09:40 \u001b[1;31mWARNING:\u001b[0m if: expression is invalid: unknown name A (1:1)\n | A == \"ENV\"\n | ^\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ... if error .. 060 conditional fail\n2023/01/01 19:09:40 ~-------------- ------------------~\n--- PASS: TestCmdUpConditional (0.00s)\n=== RUN   TestCmdUpConditionalFail\n2023/01/01 19:09:40 setting gcloud config [core/project] to [demo]\n2023/01/01 19:09:40 \n2023/01/01 19:09:40 gsutil -q cp gs://bucket/state state\n2023/01/01 19:09:40 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:09:40 ~-------------- ------------------~\n2023/01/01 19:09:40 ...      do ... 060 conditional fail (060_conditional_fail.yaml)\n2023/01/01 19:09:40 unable to evaluate condition [A == \"ENV\"] because:unknown name A (1:1)\n | A == \"ENV\"\n | ^\n2023/01/01 19:09:40 executing [do] failed, error: [gmig ABORTED]\n\n2023/01/01 19:09:40 reporting environment variables ...\nPROJECT=demo\nREGION=\nZONE=\nENV=A\nGMIG_CONFIG_DIR=/go/src/github.com/emicklei/gmig/test/demo\n\n2023/01/01 19:09:40 checking gmig config ...\n{\n\t\"project\": \"demo\",\n\t\"bucket\": \"bucket\",\n\t\"state\": \"state\",\n\t\"env\": {\n\t\t\"ENV\": \"A\"\n\t}\n}\n\n2023/01/01 19:09:40 checking gcloud config list ...\n\n--- PASS: TestCmdUpConditionalFail (0.00s)\n=== RUN   TestConfig\n--- PASS: TestConfig (0.00s)\n=== RUN   TestTryToLoadConfig\n    config_test.go:45: <nil> can not find any configuration\n--- PASS: TestTryToLoadConfig (0.00s)\n=== RUN   TestExportProjectsIAMPolicy\n2023/01/01 19:09:40 setting gcloud config [core/project] to [demo]\n2023/01/01 19:09:40 {\n\t\t\"bindings\": [{\n\t\t\t\"members\": [\n\t\t\t\t\"member\"\n\t\t\t],\n\t\t\t\"role\": \"role\"\n\t\t}]\n\t}\n2023/01/01 19:09:40 gsutil -q cp gs://bucket/state state\n2023/01/01 19:09:40 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:09:40 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:09:40 gcloud projects get-iam-policy demo --format json\n2023/01/01 19:09:40 writing 010_exported_project_iam_policy.yaml\n    export_iam_test.go:45: got [1] want [2]\n--- PASS: TestExportProjectsIAMPolicy (0.00s)\n=== RUN   TestGcloudConfigSetProject\n--- PASS: TestGcloudConfigSetProject (0.00s)\n=== RUN   TestParseMigration\n--- PASS: TestParseMigration (0.00s)\n=== RUN   TestSetupShellScriptNotVerbose\n--- PASS: TestSetupShellScriptNotVerbose (0.00s)\n=== RUN   TestSetupShellScriptVerbose\n--- PASS: TestSetupShellScriptVerbose (0.00s)\n=== RUN   TestNewFilenameWithIndex\n--- PASS: TestNewFilenameWithIndex (0.00s)\n=== RUN   TestEvaluateCondition\n--- PASS: TestEvaluateCondition (0.00s)\n=== RUN   TestMigrationContextWithMigrationsOverride\n    migration_test.go:138: \n--- SKIP: TestMigrationContextWithMigrationsOverride (0.00s)\n=== RUN   TestPrettyPrint\n--- PASS: TestPrettyPrint (0.00s)\nPASS\ncoverage: 50.7% of statements\nok  \tgithub.com/emicklei/gmig\t0.028s\nRemoving intermediate container 2b0b413e95ba\n ---> 272b4a4806a1\nStep 8/12 : RUN CGO_ENABLED=0 GOOS=linux go build -ldflags \"-X main.version=$version\" .\n ---> Running in 52c778413ebd\nRemoving intermediate container 52c778413ebd\n ---> 9c6a10339a99\nStep 9/12 : FROM alpine\n ---> 49176f190c7e\nStep 10/12 : COPY --from=0 /go/src/github.com/emicklei/gmig /usr/bin/\n ---> fd8a5c737b67\nStep 11/12 : COPY --from=0 /etc/ssl/certs/ /etc/ssl/certs/\n ---> a4e38a16c501\nStep 12/12 : ENTRYPOINT [\"gmig\"]\n ---> Running in 845170d92352\nRemoving intermediate container 845170d92352\n ---> a0bbe3f4a754\nSuccessfully built a0bbe3f4a754\nSuccessfully tagged gmig:latest\n","stderr":"","imageSize":18836658},"repair":{"violations":[{"name":"ruleAptGetInstallUseNoRec","position":{"start":2,"end":2,"columnStart":4,"columnEnd":38}},{"name":"ruleAptGetUpdatePrecedesInstall","position":{"start":2,"end":2,"columnStart":4,"columnEnd":38}},{"name":"ruleAptGetInstallThenRemoveAptLists","position":{"start":2,"end":2,"columnStart":4,"columnEnd":38}}],"repairedDockerfile":"FROM golang\n\nRUN apt-get install --no-install-recommends -y ca-certificates\nRUN update-ca-certificates\n\nWORKDIR /go/src/github.com/emicklei/gmig\nCOPY . .\nARG version\nRUN go test -v -cover\nRUN CGO_ENABLED=0 GOOS=linux go build -ldflags \"-X main.version=$version\" .\n\n\nFROM alpine\nCOPY --from=0 /go/src/github.com/emicklei/gmig /usr/bin/\nCOPY --from=0 /etc/ssl/certs/ /etc/ssl/certs/\n\nENTRYPOINT [\"gmig\"]"},"repairedBuild":{"startTimestamp":1672600191273,"endTimestamp":1672600215505,"error":null,"stdout":"Sending build context to Docker daemon  409.6kB\r\r\nStep 1/12 : FROM golang\n ---> 6650307efe4a\nStep 2/12 : RUN apt-get install --no-install-recommends -y ca-certificates\n ---> Running in 63452763875a\nReading package lists...\nBuilding dependency tree...\nReading state information...\nca-certificates is already the newest version (20210119).\n0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.\nRemoving intermediate container 63452763875a\n ---> 92ed3a3f958b\nStep 3/12 : RUN update-ca-certificates\n ---> Running in 48e3bfd8947d\nUpdating certificates in /etc/ssl/certs...\n0 added, 0 removed; done.\nRunning hooks in /etc/ca-certificates/update.d...\ndone.\nRemoving intermediate container 48e3bfd8947d\n ---> 0c1110899df5\nStep 4/12 : WORKDIR /go/src/github.com/emicklei/gmig\n ---> Running in 575d3e999235\nRemoving intermediate container 575d3e999235\n ---> a3bf7c6527ee\nStep 5/12 : COPY . .\n ---> 4b08fcc37169\nStep 6/12 : ARG version\n ---> Running in b54473296629\nRemoving intermediate container b54473296629\n ---> 32beeef949d8\nStep 7/12 : RUN go test -v -cover\n ---> Running in b37c36bc3785\n\u001b[91mgo: downloading github.com/antonmedv/expr v1.9.0\ngo: downloading gopkg.in/yaml.v2 v2.4.0\n\u001b[0m\u001b[91mgo: downloading github.com/emicklei/tre v1.4.0\n\u001b[0m\u001b[91mgo: downloading github.com/marcacohen/gcslock v0.0.0-20180212104141-5782a95db7e2\n\u001b[0m\u001b[91mgo: downloading github.com/urfave/cli v1.22.10\n\u001b[0m\u001b[91mgo: downloading golang.org/x/oauth2 v0.0.0-20221014153046-6fdb5e3db783\ngo: downloading golang.org/x/net v0.0.0-20221014081412-f15817d10f9b\n\u001b[0m\u001b[91mgo: downloading github.com/cpuguy83/go-md2man/v2 v2.0.2\n\u001b[0m\u001b[91mgo: downloading github.com/russross/blackfriday/v2 v2.1.0\n\u001b[0m\u001b[91mgo: downloading cloud.google.com/go/compute v1.10.0\n\u001b[0m=== RUN   Test_loadbalancerURLMap_patchPathsAndService\n--- PASS: Test_loadbalancerURLMap_patchPathsAndService (0.00s)\n=== RUN   TestCmdTemplate\n/usr/local/go/bin:/go/bin:/usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\n--- PASS: TestCmdTemplate (0.00s)\n=== RUN   TestCmdInit\n--- PASS: TestCmdInit (0.00s)\n=== RUN   TestCmdInitMissingConfig\n2023/01/01 19:10:01 config file [ test/missing/gmig.yaml ] already present.\n2023/01/01 19:10:01 config [ bucket= my-bucket ,state= myapp-gmig-last-migration ,verbose= false ]\n--- PASS: TestCmdInitMissingConfig (0.00s)\n=== RUN   TestCmdStatusDemo\n2023/01/01 19:10:01 gmig version \n2023/01/01 19:10:01 BEGIN show status of migrations\n2023/01/01 19:10:01 \u001b[1;31mWARNING:\u001b[0m JSON configuration (gmig.json) is deprecated, your configuration (gmig.yaml)\n2023/01/01 19:10:01 loading configuration from /go/src/github.com/emicklei/gmig/test/demo/gmig.json\n2023/01/01 19:10:01 setting gcloud config [core/project] to [demo]\n2023/01/01 19:10:01 \n2023/01/01 19:10:01 gsutil -q cp gs://bucket/state state\n2023/01/01 19:10:01 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 --- applied --- 010 one\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ... pending ... 020 two\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ... pending ... 030 three\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ... pending ... 040 error\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ... pending ... 050 conditional\n2023/01/01 19:10:01 \u001b[1;31mWARNING:\u001b[0m if: expression is invalid: unknown name A (1:1)\n | A == \"ENV\"\n | ^\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ... if error .. 060 conditional fail\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 END show status of migrations completed in 1.749658ms\n--- PASS: TestCmdStatusDemo (0.00s)\n=== RUN   TestCmdStatusDemoWithMigrationsOption\n2023/01/01 19:10:01 gmig version \n2023/01/01 19:10:01 BEGIN show status of migrations\n2023/01/01 19:10:01 setting gcloud config [core/project] to [demo]\n2023/01/01 19:10:01 \n2023/01/01 19:10:01 gsutil -q cp gs://bucket/state state\n2023/01/01 19:10:01 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 override migrations path with [test] from [/go/src/github.com/emicklei/gmig/test] to [/go/src/github.com/emicklei/gmig/test] err:[<nil>]\n2023/01/01 19:10:01 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 --- applied --- 010 one\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ... pending ... 020 two\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ... pending ... 030 three\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ... pending ... 040 error\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ... pending ... 050 conditional\n2023/01/01 19:10:01 \u001b[1;31mWARNING:\u001b[0m if: expression is invalid: unknown name A (1:1)\n | A == \"ENV\"\n | ^\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ... if error .. 060 conditional fail\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 END show status of migrations completed in 1.418139ms\n--- PASS: TestCmdStatusDemoWithMigrationsOption (0.00s)\n=== RUN   TestCmdForceState\n2023/01/01 19:10:01 setting gcloud config [core/project] to [demo]\n2023/01/01 19:10:01 \n2023/01/01 19:10:01 gsutil -q cp gs://bucket/state state\n2023/01/01 19:10:01 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:10:01 writing local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 gsutil -q -h Content-Type:text/plain cp state gs://bucket/state\n2023/01/01 19:10:01 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 setting gcloud config [core/project] to [demo]\n2023/01/01 19:10:01 \n2023/01/01 19:10:01 gsutil -q cp gs://bucket/state state\n2023/01/01 19:10:01 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 --- applied --- 010 one\n2023/01/01 19:10:01 --- applied --- 020 two\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ... pending ... 030 three\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ... pending ... 040 error\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ... pending ... 050 conditional\n2023/01/01 19:10:01 \u001b[1;31mWARNING:\u001b[0m if: expression is invalid: unknown name A (1:1)\n | A == \"ENV\"\n | ^\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ... if error .. 060 conditional fail\n2023/01/01 19:10:01 ~-------------- ------------------~\n    commands_test.go:101: got [3] want [2]\n--- PASS: TestCmdForceState (0.00s)\n=== RUN   TestCmdForceStateNested\n2023/01/01 19:10:01 gmig version \n2023/01/01 19:10:01 BEGIN force last applied migration (state)\n2023/01/01 19:10:01 setting gcloud config [core/project] to [demo]\n2023/01/01 19:10:01 \n2023/01/01 19:10:01 gsutil -q cp gs://bucket/state state\n2023/01/01 19:10:01 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 override migrations path with [test] from [/go/src/github.com/emicklei/gmig/test/demo] to [/go/src/github.com/emicklei/gmig/test] err:[<nil>]\n2023/01/01 19:10:01 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:10:01 writing local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 gsutil -q -h Content-Type:text/plain cp state gs://bucket/state\n2023/01/01 19:10:01 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 setting gcloud config [core/project] to [demo]\n2023/01/01 19:10:01 \n2023/01/01 19:10:01 gsutil -q cp gs://bucket/state state\n2023/01/01 19:10:01 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 override migrations path with [test] from [/go/src/github.com/emicklei/gmig/test/demo] to [/go/src/github.com/emicklei/gmig/test] err:[<nil>]\n2023/01/01 19:10:01 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 --- applied --- 010 one\n2023/01/01 19:10:01 --- applied --- 020 two\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ... pending ... 030 three\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ... pending ... 040 error\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ... pending ... 050 conditional\n2023/01/01 19:10:01 \u001b[1;31mWARNING:\u001b[0m if: expression is invalid: unknown name A (1:1)\n | A == \"ENV\"\n | ^\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ... if error .. 060 conditional fail\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 END force last applied migration (state) completed in 1.196449ms\n    commands_test.go:140: got [3] want [2]\n--- PASS: TestCmdForceStateNested (0.00s)\n=== RUN   TestCmdUp\n2023/01/01 19:10:01 setting gcloud config [core/project] to [demo]\n2023/01/01 19:10:01 \n2023/01/01 19:10:01 \u001b[1;31mERROR:\u001b[0m go/src/github.com/emicklei/gmig/gcloud.go:38 gmig.gcloudConfigSetProject:error changing gcloud config core/project=demo \ncause: shell error\n    commands_test.go:172: got [1] want [4]\n--- PASS: TestCmdUp (0.00s)\n=== RUN   TestCmdUpAndStop\n2023/01/01 19:10:01 setting gcloud config [core/project] to [demo]\n2023/01/01 19:10:01 error\n2023/01/01 19:10:01 gsutil -q cp gs://bucket/state state\n2023/01/01 19:10:01 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ...      do ... 020 two (020_two.yaml)\nerror\n2023/01/01 19:10:01 writing local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 gsutil -q -h Content-Type:text/plain cp state gs://bucket/state\n2023/01/01 19:10:01 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 ... stopped ...\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 setting gcloud config [core/project] to [demo]\n2023/01/01 19:10:01 error\n2023/01/01 19:10:01 gsutil -q cp gs://bucket/state state\n2023/01/01 19:10:01 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 --- applied --- 010 one\n2023/01/01 19:10:01 --- applied --- 020 two\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ... pending ... 030 three\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ... pending ... 040 error\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ... pending ... 050 conditional\n2023/01/01 19:10:01 \u001b[1;31mWARNING:\u001b[0m if: expression is invalid: unknown name A (1:1)\n | A == \"ENV\"\n | ^\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ... if error .. 060 conditional fail\n2023/01/01 19:10:01 ~-------------- ------------------~\n--- PASS: TestCmdUpAndStop (0.00s)\n=== RUN   TestCmdUpAndStopAfterLastApplied\n2023/01/01 19:10:01 setting gcloud config [core/project] to [demo]\n2023/01/01 19:10:01 \n2023/01/01 19:10:01 \u001b[1;31mERROR:\u001b[0m go/src/github.com/emicklei/gmig/gcloud.go:38 gmig.gcloudConfigSetProject:error changing gcloud config core/project=demo \ncause: shell error\n--- PASS: TestCmdUpAndStopAfterLastApplied (0.00s)\n=== RUN   TestCmdUpAndStopAfterUnexistingFilename\n2023/01/01 19:10:01 setting gcloud config [core/project] to [demo]\n2023/01/01 19:10:01 \n2023/01/01 19:10:01 gsutil -q cp gs://bucket/state state\n2023/01/01 19:10:01 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:10:01 executing [up until stop] failed, error: [No such migration file: missing.yaml]\n\n2023/01/01 19:10:01 reporting environment variables ...\nPROJECT=demo\nREGION=\nZONE=\nENV=A\nGMIG_CONFIG_DIR=/go/src/github.com/emicklei/gmig/test/demo\n\n2023/01/01 19:10:01 checking gmig config ...\n{\n\t\"project\": \"demo\",\n\t\"bucket\": \"bucket\",\n\t\"state\": \"state\",\n\t\"env\": {\n\t\t\"ENV\": \"A\"\n\t}\n}\n\n2023/01/01 19:10:01 checking gcloud config list ...\n\n--- PASS: TestCmdUpAndStopAfterUnexistingFilename (0.00s)\n=== RUN   TestCmdDown\n2023/01/01 19:10:01 gmig version \n2023/01/01 19:10:01 BEGIN down = undo last applied migration\n2023/01/01 19:10:01 setting gcloud config [core/project] to [demo]\n2023/01/01 19:10:01 \n2023/01/01 19:10:01 gsutil -q cp gs://bucket/state state\n2023/01/01 19:10:01 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ...    undo ... 010 one\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 --- BEGIN gmig.sh:\n #!/bin/bash\n# temporary gmig execution script\nset -e -x\necho \"one down\"\n --- END gmig.sh\n\n2023/01/01 19:10:01 writing local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 gsutil -q -h Content-Type:text/plain cp state gs://bucket/state\n2023/01/01 19:10:01 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 setting gcloud config [core/project] to [demo]\n2023/01/01 19:10:01 \n2023/01/01 19:10:01 gsutil -q cp gs://bucket/state state\n2023/01/01 19:10:01 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ... pending ... 010 one\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ... pending ... 020 two\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ... pending ... 030 three\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ... pending ... 040 error\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ... pending ... 050 conditional\n2023/01/01 19:10:01 \u001b[1;31mWARNING:\u001b[0m if: expression is invalid: unknown name A (1:1)\n | A == \"ENV\"\n | ^\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ... if error .. 060 conditional fail\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 END down = undo last applied migration completed in 1.474392ms\n    commands_test.go:248: got [6] want [3]\n--- PASS: TestCmdDown (0.00s)\n=== RUN   TestCmdDownWhenNoLastMigration\n2023/01/01 19:10:01 setting gcloud config [core/project] to [demo]\n2023/01/01 19:10:01 \n2023/01/01 19:10:01 gsutil -q cp gs://bucket/state state\n2023/01/01 19:10:01 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:10:01 \u001b[1;31mWARNING:\u001b[0m There are no migrations to undo\n--- PASS: TestCmdDownWhenNoLastMigration (0.00s)\n=== RUN   TestCmdView\n2023/01/01 19:10:01 setting gcloud config [core/project] to [demo]\n2023/01/01 19:10:01 \n2023/01/01 19:10:01 gsutil -q cp gs://bucket/state state\n2023/01/01 19:10:01 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:10:01 ~---------------------------------------------------------------~\n2023/01/01 19:10:01  010 one (010_one.yaml)\n2023/01/01 19:10:01  --------------------------------------------------------------- \n2023/01/01 19:10:01 executing view section (1 commands)\n\n2023/01/01 19:10:01 ~---------------------------------------------------------------~\n2023/01/01 19:10:01  020 two (020_two.yaml)\n2023/01/01 19:10:01  --------------------------------------------------------------- \n2023/01/01 19:10:01  ** this migration is pending...\n--- PASS: TestCmdView (0.00s)\n=== RUN   TestCmdUpConditional\n2023/01/01 19:10:01 setting gcloud config [core/project] to [demo]\n2023/01/01 19:10:01 \n2023/01/01 19:10:01 gsutil -q cp gs://bucket/state state\n2023/01/01 19:10:01 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ...      do ... 050 conditional (050_conditional.yaml)\n\n2023/01/01 19:10:01 writing local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 gsutil -q -h Content-Type:text/plain cp state gs://bucket/state\n2023/01/01 19:10:01 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 ... stopped ...\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 setting gcloud config [core/project] to [demo]\n2023/01/01 19:10:01 \n2023/01/01 19:10:01 gsutil -q cp gs://bucket/state state\n2023/01/01 19:10:01 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 --- applied --- 010 one\n2023/01/01 19:10:01 --- applied --- 020 two\n2023/01/01 19:10:01 --- applied --- 030 three\n2023/01/01 19:10:01 --- applied --- 040 error\n2023/01/01 19:10:01 --- applied --- 050 conditional\n2023/01/01 19:10:01 \u001b[1;31mWARNING:\u001b[0m if: expression is invalid: unknown name A (1:1)\n | A == \"ENV\"\n | ^\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ... if error .. 060 conditional fail\n2023/01/01 19:10:01 ~-------------- ------------------~\n--- PASS: TestCmdUpConditional (0.00s)\n=== RUN   TestCmdUpConditionalFail\n2023/01/01 19:10:01 setting gcloud config [core/project] to [demo]\n2023/01/01 19:10:01 \n2023/01/01 19:10:01 gsutil -q cp gs://bucket/state state\n2023/01/01 19:10:01 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:10:01 ~-------------- ------------------~\n2023/01/01 19:10:01 ...      do ... 060 conditional fail (060_conditional_fail.yaml)\n2023/01/01 19:10:01 unable to evaluate condition [A == \"ENV\"] because:unknown name A (1:1)\n | A == \"ENV\"\n | ^\n2023/01/01 19:10:01 executing [do] failed, error: [gmig ABORTED]\n\n2023/01/01 19:10:01 reporting environment variables ...\nPROJECT=demo\nREGION=\nZONE=\nENV=A\nGMIG_CONFIG_DIR=/go/src/github.com/emicklei/gmig/test/demo\n\n2023/01/01 19:10:01 checking gmig config ...\n{\n\t\"project\": \"demo\",\n\t\"bucket\": \"bucket\",\n\t\"state\": \"state\",\n\t\"env\": {\n\t\t\"ENV\": \"A\"\n\t}\n}\n\n2023/01/01 19:10:01 checking gcloud config list ...\n\n--- PASS: TestCmdUpConditionalFail (0.00s)\n=== RUN   TestConfig\n--- PASS: TestConfig (0.00s)\n=== RUN   TestTryToLoadConfig\n    config_test.go:45: <nil> can not find any configuration\n--- PASS: TestTryToLoadConfig (0.00s)\n=== RUN   TestExportProjectsIAMPolicy\n2023/01/01 19:10:01 setting gcloud config [core/project] to [demo]\n2023/01/01 19:10:01 {\n\t\t\"bindings\": [{\n\t\t\t\"members\": [\n\t\t\t\t\"member\"\n\t\t\t],\n\t\t\t\"role\": \"role\"\n\t\t}]\n\t}\n2023/01/01 19:10:01 gsutil -q cp gs://bucket/state state\n2023/01/01 19:10:01 reading local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 deleting local copy state ,cwd= /go/src/github.com/emicklei/gmig\n2023/01/01 19:10:01 reading migrations from /go/src/github.com/emicklei/gmig/test\n2023/01/01 19:10:01 gcloud projects get-iam-policy demo --format json\n2023/01/01 19:10:01 writing 010_exported_project_iam_policy.yaml\n    export_iam_test.go:45: got [1] want [2]\n--- PASS: TestExportProjectsIAMPolicy (0.00s)\n=== RUN   TestGcloudConfigSetProject\n--- PASS: TestGcloudConfigSetProject (0.00s)\n=== RUN   TestParseMigration\n--- PASS: TestParseMigration (0.00s)\n=== RUN   TestSetupShellScriptNotVerbose\n--- PASS: TestSetupShellScriptNotVerbose (0.00s)\n=== RUN   TestSetupShellScriptVerbose\n--- PASS: TestSetupShellScriptVerbose (0.00s)\n=== RUN   TestNewFilenameWithIndex\n--- PASS: TestNewFilenameWithIndex (0.00s)\n=== RUN   TestEvaluateCondition\n--- PASS: TestEvaluateCondition (0.00s)\n=== RUN   TestMigrationContextWithMigrationsOverride\n    migration_test.go:138: \n--- SKIP: TestMigrationContextWithMigrationsOverride (0.00s)\n=== RUN   TestPrettyPrint\n--- PASS: TestPrettyPrint (0.00s)\nPASS\ncoverage: 50.7% of statements\nok  \tgithub.com/emicklei/gmig\t0.031s\nRemoving intermediate container b37c36bc3785\n ---> 02209ecdaf58\nStep 8/12 : RUN CGO_ENABLED=0 GOOS=linux go build -ldflags \"-X main.version=$version\" .\n ---> Running in c4d8a89033f6\nRemoving intermediate container c4d8a89033f6\n ---> faefb79754bc\nStep 9/12 : FROM alpine\n ---> 49176f190c7e\nStep 10/12 : COPY --from=0 /go/src/github.com/emicklei/gmig /usr/bin/\n ---> a3d50ea78915\nStep 11/12 : COPY --from=0 /etc/ssl/certs/ /etc/ssl/certs/\n ---> 64c38e120ad2\nStep 12/12 : ENTRYPOINT [\"gmig\"]\n ---> Running in 1950d5718f75\nRemoving intermediate container 1950d5718f75\n ---> 1737e97cee50\nSuccessfully built 1737e97cee50\nSuccessfully tagged gmig:latest\n","stderr":"","imageSize":18836682},"endTime":1672600215738}