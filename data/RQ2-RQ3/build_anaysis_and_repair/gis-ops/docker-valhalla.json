{"repository":"https://github.com/gis-ops/docker-valhalla","dockerfilePath":"Dockerfile","startTime":1672983539826,"endTime":1672983695917,"clone":{"startTime":1672983539826,"stdout":"","stderr":"Cloning into '/tmp/dinghy-analysis/gis-ops/docker-valhalla'...\n","error":null,"endTime":1672983540884,"commit":"0ab12d494a7cd12bb6ebc0907269589c73c0d413"},"originalBuild":{"startTime":1672983540977,"endTime":1672983644171,"error":null,"stdout":"Sending build context to Docker daemon  39.42kB\r\r\nStep 1/24 : FROM valhalla/valhalla:run-latest as builder\nrun-latest: Pulling from valhalla/valhalla\n846c0b181fff: Already exists\n32a6279c36f1: Pulling fs layer\n6492f6bf0eeb: Pulling fs layer\n5350caca8a2e: Pulling fs layer\na7208f1d446d: Pulling fs layer\nf878438a6758: Pulling fs layer\na7208f1d446d: Waiting\nf878438a6758: Waiting\n5350caca8a2e: Verifying Checksum\n5350caca8a2e: Download complete\n6492f6bf0eeb: Verifying Checksum\n6492f6bf0eeb: Download complete\na7208f1d446d: Verifying Checksum\na7208f1d446d: Download complete\nf878438a6758: Verifying Checksum\nf878438a6758: Download complete\n32a6279c36f1: Verifying Checksum\n32a6279c36f1: Download complete\n32a6279c36f1: Pull complete\n6492f6bf0eeb: Pull complete\n5350caca8a2e: Pull complete\na7208f1d446d: Pull complete\nf878438a6758: Pull complete\nDigest: sha256:b156f2d67dbf53189846787156da4d57383714f494cedf7605fcbe26bc7e22bb\nStatus: Downloaded newer image for valhalla/valhalla:run-latest\n ---> c5495260d427\nStep 2/24 : MAINTAINER Nils Nolde <nils@gis-ops.com>\n ---> Running in 1efa0ceb9dbf\nRemoving intermediate container 1efa0ceb9dbf\n ---> c8f6c9675fe8\nStep 3/24 : RUN cd /usr/local/bin &&   preserve=\"valhalla_service valhalla_build_tiles valhalla_build_config valhalla_build_admins valhalla_build_timezones valhalla_build_elevation valhalla_ways_to_edges valhalla_build_extract valhalla_export_edges valhalla_add_predicted_traffic\" &&   mv $preserve .. &&   for f in valhalla*; do rm $f; done &&   cd .. && mv $preserve ./bin\n ---> Running in cee50b221c7d\nRemoving intermediate container cee50b221c7d\n ---> 837808e37c9c\nStep 4/24 : FROM ubuntu:20.04 as runner_base\n ---> d5447fc01ae6\nStep 5/24 : MAINTAINER Nils Nolde <nils@gis-ops.com>\n ---> Running in be164f691cd5\nRemoving intermediate container be164f691cd5\n ---> 618061a62f99\nStep 6/24 : RUN apt-get update > /dev/null &&     export DEBIAN_FRONTEND=noninteractive &&     apt-get install -y libluajit-5.1-2       libzmq5 libczmq4 spatialite-bin libprotobuf-lite17 sudo locales       libsqlite3-0 libsqlite3-mod-spatialite libgeos-3.8.0 libcurl4       python3.8-minimal python3-distutils curl unzip moreutils jq spatialite-bin > /dev/null &&     ln -sf /usr/bin/python3.8 /usr/bin/python &&     ln -sf /usr/bin/python3.8 /usr/bin/python3\n ---> Running in 7cb2e25dc432\n\u001b[91mdebconf: delaying package configuration, since apt-utils is not installed\n\u001b[0mRemoving intermediate container 7cb2e25dc432\n ---> 7c171dca9798\nStep 7/24 : COPY --from=builder /usr/local /usr/local\n ---> 056ddca0c8b3\nStep 8/24 : COPY --from=builder /usr/bin/prime_* /usr/bin/\n ---> 789557147c81\nStep 9/24 : COPY --from=builder /usr/lib/x86_64-linux-gnu/libprime* /usr/lib/x86_64-linux-gnu/\n ---> de2ced36252d\nStep 10/24 : COPY --from=builder /usr/lib/python3/dist-packages/valhalla/* /usr/lib/python3/dist-packages/valhalla/\n ---> bcabb0986861\nStep 11/24 : ENV LD_LIBRARY_PATH=\"/usr/local/lib:${LD_LIBRARY_PATH}\"\n ---> Running in 37018bb1ace3\nRemoving intermediate container 37018bb1ace3\n ---> 2fcbd7a0a343\nStep 12/24 : ENV use_tiles_ignore_pbf=True\n ---> Running in 07fad41182f8\nRemoving intermediate container 07fad41182f8\n ---> 0163bfde769b\nStep 13/24 : ENV build_tar=True\n ---> Running in 66ca0f066e91\nRemoving intermediate container 66ca0f066e91\n ---> a2bf177b2050\nStep 14/24 : ENV serve_tiles=True\n ---> Running in 52e25d1e12d0\nRemoving intermediate container 52e25d1e12d0\n ---> ea4c0680f3e5\nStep 15/24 : ARG VALHALLA_UID=59999\n ---> Running in ee9857c55a87\nRemoving intermediate container ee9857c55a87\n ---> 316e7fc6d167\nStep 16/24 : ARG VALHALLA_GID=59999\n ---> Running in 24f19486db96\nRemoving intermediate container 24f19486db96\n ---> 4eb586824915\nStep 17/24 : RUN groupadd -g ${VALHALLA_GID} valhalla &&   useradd -lmu ${VALHALLA_UID} -g valhalla valhalla &&   mkdir /custom_files &&   if [ $VALHALLA_UID != 59999 ] || [ $VALHALLA_GID != 59999 ]; then chmod 0775 custom_files && chown valhalla:valhalla /custom_files; else usermod -aG sudo valhalla && echo \"ALL            ALL = (ALL) NOPASSWD: ALL\" >> /etc/sudoers; fi\n ---> Running in eafa6e4f3cfb\nRemoving intermediate container eafa6e4f3cfb\n ---> 84cc3b5a1fa6\nStep 18/24 : COPY scripts/. /valhalla/scripts\n ---> 2153ec97fa2e\nStep 19/24 : USER valhalla\n ---> Running in afb18a33146c\nRemoving intermediate container afb18a33146c\n ---> 2cae3d685e19\nStep 20/24 : WORKDIR /custom_files\n ---> Running in 573353226c6f\nRemoving intermediate container 573353226c6f\n ---> 760b72656853\nStep 21/24 : RUN python3 -c \"import valhalla,sys; print (sys.version, valhalla)\"     && valhalla_build_config | jq type     && cat /usr/local/src/valhalla_version     && valhalla_build_tiles -v     && ls -la /usr/local/bin/valhalla*\n ---> Running in e1dc80b28a31\n3.8.10 (default, Nov 14 2022, 12:59:47) \n[GCC 9.4.0] <module 'valhalla' from '/usr/lib/python3/dist-packages/valhalla/__init__.py'>\n\"object\"\nhttps://github.com/valhalla/valhalla/tree/be8d17835a2eb3effbfa8be4f9725f29e3ce504d\nvalhalla_build_tiles 3.3.0\n-rwxr-xr-x 1 root root 2154144 Jan  5 20:00 /usr/local/bin/valhalla_add_predicted_traffic\n-rwxr-xr-x 1 root root 4371184 Jan  5 20:00 /usr/local/bin/valhalla_build_admins\n-rwxr-xr-x 1 root root   31617 Jan  5 19:26 /usr/local/bin/valhalla_build_config\n-rwxr-xr-x 1 root root   10960 Jan  5 19:26 /usr/local/bin/valhalla_build_elevation\n-rwxr-xr-x 1 root root   12528 Jan  5 19:26 /usr/local/bin/valhalla_build_extract\n-rwxr-xr-x 1 root root 4141808 Jan  5 20:00 /usr/local/bin/valhalla_build_tiles\n-rwxr-xr-x 1 root root    8279 Jan  5 19:26 /usr/local/bin/valhalla_build_timezones\n-rwxr-xr-x 1 root root 1920656 Jan  5 20:00 /usr/local/bin/valhalla_export_edges\n-rwxr-xr-x 1 root root 7882880 Jan  5 20:00 /usr/local/bin/valhalla_service\n-rwxr-xr-x 1 root root 1908360 Jan  5 20:00 /usr/local/bin/valhalla_ways_to_edges\nRemoving intermediate container e1dc80b28a31\n ---> 6592aaaae40e\nStep 22/24 : EXPOSE 8002\n ---> Running in dd14af8ca2d8\nRemoving intermediate container dd14af8ca2d8\n ---> de3d1f26d1db\nStep 23/24 : ENTRYPOINT [\"/valhalla/scripts/run.sh\"]\n ---> Running in 1e39c35d4464\nRemoving intermediate container 1e39c35d4464\n ---> 1f9a6d759aba\nStep 24/24 : CMD [\"build_tiles\"]\n ---> Running in ac60f63d9897\nRemoving intermediate container ac60f63d9897\n ---> 6bf374314c95\nSuccessfully built 6bf374314c95\nSuccessfully tagged docker-valhalla:latest\n","stderr":"","imageSize":443275511},"repair":{"startTime":1672983644226,"endTime":1672983644466,"violations":[{"name":"aptGetInstallUseNoRec","position":{"start":20,"end":23,"columnStart":4,"columnEnd":92}},{"name":"ruleAptGetInstallThenRemoveAptLists","position":{"start":20,"end":23,"columnStart":4,"columnEnd":92}}],"repairedDockerfile":"# Take the official valhalla runner image,\n# remove a few superfluous things and\n# create a new runner image from ubuntu:20.04\n# with the previous runner's artifacts\n\nFROM valhalla/valhalla:run-latest as builder\nMAINTAINER Nils Nolde <nils@gis-ops.com>\n\n# remove some stuff from the original image\nRUN cd /usr/local/bin && \\\n  preserve=\"valhalla_service valhalla_build_tiles valhalla_build_config valhalla_build_admins valhalla_build_timezones valhalla_build_elevation valhalla_ways_to_edges valhalla_build_extract valhalla_export_edges valhalla_add_predicted_traffic\" && \\\n  mv $preserve .. && \\\n  for f in valhalla*; do rm $f; done && \\\n  cd .. && mv $preserve ./bin\n\nFROM ubuntu:20.04 as runner_base\nMAINTAINER Nils Nolde <nils@gis-ops.com>\n\nRUN apt-get update > /dev/null && \\\n    export DEBIAN_FRONTEND=noninteractive && \\\n    apt-get install --no-install-recommends -y libluajit-5.1-2 \\\n      libzmq5 libczmq4 spatialite-bin libprotobuf-lite17 sudo locales \\\n      libsqlite3-0 libsqlite3-mod-spatialite libgeos-3.8.0 libcurl4 \\\n      python3.8-minimal python3-distutils curl unzip moreutils jq spatialite-bin > /dev/null && \\\n    ln -sf /usr/bin/python3.8 /usr/bin/python && \\\n    ln -sf /usr/bin/python3.8 /usr/bin/python3 && rm -rf /var/lib/apt/lists/*;\n\nCOPY --from=builder /usr/local /usr/local\nCOPY --from=builder /usr/bin/prime_* /usr/bin/\nCOPY --from=builder /usr/lib/x86_64-linux-gnu/libprime* /usr/lib/x86_64-linux-gnu/\nCOPY --from=builder /usr/lib/python3/dist-packages/valhalla/* /usr/lib/python3/dist-packages/valhalla/\n\nENV LD_LIBRARY_PATH=\"/usr/local/lib:${LD_LIBRARY_PATH}\"\n# export the True defaults\nENV use_tiles_ignore_pbf=True\nENV build_tar=True\nENV serve_tiles=True\n\n# what this does:\n# if the docker user specified a UID/GID (other than 0, would be a ludicrous instruction anyways) in the image build, we will use that to create the valhalla linux user in the image. that ensures that the docker user can edit the created files on the host without sudo and with 664/775 permissions, so that users of that group can also write. the default is to give the valhalla user passwordless sudo. that also means that all commands creating files in the entrypoint script need to be executed with sudo when built with defaults..\n# based on https://jtreminio.com/blog/running-docker-containers-as-current-host-user/, but this use case needed a more customized approach\n\n# with that we can properly test if the default was used or not\nARG VALHALLA_UID=59999\nARG VALHALLA_GID=59999\n\nRUN groupadd -g ${VALHALLA_GID} valhalla && \\\n  useradd -lmu ${VALHALLA_UID} -g valhalla valhalla && \\\n  mkdir /custom_files && \\\n  if [ $VALHALLA_UID != 59999 ] || [ $VALHALLA_GID != 59999 ]; then chmod 0775 custom_files && chown valhalla:valhalla /custom_files; else usermod -aG sudo valhalla && echo \"ALL            ALL = (ALL) NOPASSWD: ALL\" >> /etc/sudoers; fi\n\nCOPY scripts/. /valhalla/scripts\n\nUSER valhalla\n\nWORKDIR /custom_files\n\n# Smoke tests\nRUN python3 -c \"import valhalla,sys; print (sys.version, valhalla)\" \\\n    && valhalla_build_config | jq type \\\n    && cat /usr/local/src/valhalla_version \\\n    && valhalla_build_tiles -v \\\n    && ls -la /usr/local/bin/valhalla*\n\n# Expose the necessary port\nEXPOSE 8002\nENTRYPOINT [\"/valhalla/scripts/run.sh\"]\nCMD [\"build_tiles\"]\n"},"repairedBuild":{"startTime":1672983644796,"endTime":1672983695519,"error":null,"stdout":"Sending build context to Docker daemon  39.42kB\r\r\nStep 1/24 : FROM valhalla/valhalla:run-latest as builder\n ---> c5495260d427\nStep 2/24 : MAINTAINER Nils Nolde <nils@gis-ops.com>\n ---> Running in 671340d51aff\nRemoving intermediate container 671340d51aff\n ---> 58968aeb16fe\nStep 3/24 : RUN cd /usr/local/bin &&   preserve=\"valhalla_service valhalla_build_tiles valhalla_build_config valhalla_build_admins valhalla_build_timezones valhalla_build_elevation valhalla_ways_to_edges valhalla_build_extract valhalla_export_edges valhalla_add_predicted_traffic\" &&   mv $preserve .. &&   for f in valhalla*; do rm $f; done &&   cd .. && mv $preserve ./bin\n ---> Running in 814e14169fb2\nRemoving intermediate container 814e14169fb2\n ---> 47d4aeb594d6\nStep 4/24 : FROM ubuntu:20.04 as runner_base\n ---> d5447fc01ae6\nStep 5/24 : MAINTAINER Nils Nolde <nils@gis-ops.com>\n ---> Running in 011c28be16b8\nRemoving intermediate container 011c28be16b8\n ---> f8b1641e8182\nStep 6/24 : RUN apt-get update > /dev/null &&     export DEBIAN_FRONTEND=noninteractive &&     apt-get install --no-install-recommends -y libluajit-5.1-2       libzmq5 libczmq4 spatialite-bin libprotobuf-lite17 sudo locales       libsqlite3-0 libsqlite3-mod-spatialite libgeos-3.8.0 libcurl4       python3.8-minimal python3-distutils curl unzip moreutils jq spatialite-bin > /dev/null &&     ln -sf /usr/bin/python3.8 /usr/bin/python &&     ln -sf /usr/bin/python3.8 /usr/bin/python3 && rm -rf /var/lib/apt/lists/*;\n ---> Running in 365568aaed10\n\u001b[91mdebconf: delaying package configuration, since apt-utils is not installed\n\u001b[0mRemoving intermediate container 365568aaed10\n ---> dbdb9533c94c\nStep 7/24 : COPY --from=builder /usr/local /usr/local\n ---> f61474f842ed\nStep 8/24 : COPY --from=builder /usr/bin/prime_* /usr/bin/\n ---> faa29e03adf4\nStep 9/24 : COPY --from=builder /usr/lib/x86_64-linux-gnu/libprime* /usr/lib/x86_64-linux-gnu/\n ---> 4dd9b06a515d\nStep 10/24 : COPY --from=builder /usr/lib/python3/dist-packages/valhalla/* /usr/lib/python3/dist-packages/valhalla/\n ---> c87bf0390588\nStep 11/24 : ENV LD_LIBRARY_PATH=\"/usr/local/lib:${LD_LIBRARY_PATH}\"\n ---> Running in 65a8b8a02cb4\nRemoving intermediate container 65a8b8a02cb4\n ---> 867d233b0226\nStep 12/24 : ENV use_tiles_ignore_pbf=True\n ---> Running in 7b477da906ff\nRemoving intermediate container 7b477da906ff\n ---> ba416ff5f25f\nStep 13/24 : ENV build_tar=True\n ---> Running in c051c294318e\nRemoving intermediate container c051c294318e\n ---> 9dfe009ace4f\nStep 14/24 : ENV serve_tiles=True\n ---> Running in 30a21a59722e\nRemoving intermediate container 30a21a59722e\n ---> e92501d9e3b5\nStep 15/24 : ARG VALHALLA_UID=59999\n ---> Running in bba671c55244\nRemoving intermediate container bba671c55244\n ---> 8241340b0596\nStep 16/24 : ARG VALHALLA_GID=59999\n ---> Running in 51b6815fb323\nRemoving intermediate container 51b6815fb323\n ---> d759e384a07d\nStep 17/24 : RUN groupadd -g ${VALHALLA_GID} valhalla &&   useradd -lmu ${VALHALLA_UID} -g valhalla valhalla &&   mkdir /custom_files &&   if [ $VALHALLA_UID != 59999 ] || [ $VALHALLA_GID != 59999 ]; then chmod 0775 custom_files && chown valhalla:valhalla /custom_files; else usermod -aG sudo valhalla && echo \"ALL            ALL = (ALL) NOPASSWD: ALL\" >> /etc/sudoers; fi\n ---> Running in 261386cf7db7\nRemoving intermediate container 261386cf7db7\n ---> 6b0a490fd352\nStep 18/24 : COPY scripts/. /valhalla/scripts\n ---> 31ad87b3b21c\nStep 19/24 : USER valhalla\n ---> Running in 721f6f443063\nRemoving intermediate container 721f6f443063\n ---> e944b8549f7d\nStep 20/24 : WORKDIR /custom_files\n ---> Running in 439d750f9c78\nRemoving intermediate container 439d750f9c78\n ---> 5d409ff015d9\nStep 21/24 : RUN python3 -c \"import valhalla,sys; print (sys.version, valhalla)\"     && valhalla_build_config | jq type     && cat /usr/local/src/valhalla_version     && valhalla_build_tiles -v     && ls -la /usr/local/bin/valhalla*\n ---> Running in a0104d70409e\n3.8.10 (default, Nov 14 2022, 12:59:47) \n[GCC 9.4.0] <module 'valhalla' from '/usr/lib/python3/dist-packages/valhalla/__init__.py'>\n\"object\"\nhttps://github.com/valhalla/valhalla/tree/be8d17835a2eb3effbfa8be4f9725f29e3ce504d\nvalhalla_build_tiles 3.3.0\n-rwxr-xr-x 1 root root 2154144 Jan  5 20:00 /usr/local/bin/valhalla_add_predicted_traffic\n-rwxr-xr-x 1 root root 4371184 Jan  5 20:00 /usr/local/bin/valhalla_build_admins\n-rwxr-xr-x 1 root root   31617 Jan  5 19:26 /usr/local/bin/valhalla_build_config\n-rwxr-xr-x 1 root root   10960 Jan  5 19:26 /usr/local/bin/valhalla_build_elevation\n-rwxr-xr-x 1 root root   12528 Jan  5 19:26 /usr/local/bin/valhalla_build_extract\n-rwxr-xr-x 1 root root 4141808 Jan  5 20:00 /usr/local/bin/valhalla_build_tiles\n-rwxr-xr-x 1 root root    8279 Jan  5 19:26 /usr/local/bin/valhalla_build_timezones\n-rwxr-xr-x 1 root root 1920656 Jan  5 20:00 /usr/local/bin/valhalla_export_edges\n-rwxr-xr-x 1 root root 7882880 Jan  5 20:00 /usr/local/bin/valhalla_service\n-rwxr-xr-x 1 root root 1908360 Jan  5 20:00 /usr/local/bin/valhalla_ways_to_edges\nRemoving intermediate container a0104d70409e\n ---> 6f0b677685e5\nStep 22/24 : EXPOSE 8002\n ---> Running in cb172ca45a61\nRemoving intermediate container cb172ca45a61\n ---> d7fcaa1ed07e\nStep 23/24 : ENTRYPOINT [\"/valhalla/scripts/run.sh\"]\n ---> Running in 1f2591fbc0f0\nRemoving intermediate container 1f2591fbc0f0\n ---> 287443cb023d\nStep 24/24 : CMD [\"build_tiles\"]\n ---> Running in da777fa18c80\nRemoving intermediate container da777fa18c80\n ---> df19cd88e22d\nSuccessfully built df19cd88e22d\nSuccessfully tagged docker-valhalla:latest\n","stderr":"","imageSize":394963564}}