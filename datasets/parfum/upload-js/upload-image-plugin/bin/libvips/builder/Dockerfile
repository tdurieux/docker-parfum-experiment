# syntax=docker/dockerfile:1
FROM amazonlinux:2

#
# Emulates a similar environment to the EC2 instances Upload runs on, with '-devel' packages installed for some
# of the packages that come pre-installed (e.g. 'zlib' is installed on the EC2 instances by default, so this image
# installs 'zlib' _and_ 'zlib-devel', which is required for building binaries that depend on it).
#
# Originally we based these packages off an EC2 instance running 'ami-029c64b3c205e6cce' (Amazon Linux 2, 64-bit, Arm).
# However, it lacked many of the build tools required (e.g. automake, zlib-devel, etc.), so we instead base the packages
# off the 'lambci/lambda-base-2:build' docker image. We simply bash into it, then run the following to produce the list:
#
#    yum list installed | awk '{print $1" \\"}' | sed 's/\..* / /'
#
# (Q: Why not just use 'lambci/lambda-base-2:build'? A: Because it doesn't include an 'linux/arm64/v8' build, which we
# need since our EC2 instances run on ARM architectures.)

#
# Standard dependencies (see above).
#
RUN yum -y install \
    acl \
    amazon-linux-extras \
    apr \
    apr-util \
    apr-util-bdb \
    audit-libs \
    autoconf \
    automake \
    avahi-libs \
    basesystem \
    bash \
    binutils \
    bison \
    boost-date-time \
    boost-system \
    boost-thread \
    byacc \
    bzip2 \
    bzip2-libs \
    ca-certificates \
    chkconfig \
    clang \
    clang-libs \
    cmake \
    containerd \
    coreutils \
    cpio \
    cpp \
    cracklib \
    cracklib-dicts \
    cryptsetup-libs \
    cscope \
    ctags \
    curl \
    cyrus-sasl-lib \
    dbus \
    dbus-libs \
    device-mapper \
    device-mapper-libs \
    diffstat \
    diffutils \
    docker \
    doxygen \
    dwz \
    dyninst \
    efivar-libs \
    elfutils \
    elfutils-default-yama-scope \
    elfutils-libelf \
    elfutils-libelf-devel \
    elfutils-libs \
    emacs-filesystem \
    expat \
    file \
    file-libs \
    filesystem \
    findutils \
    fipscheck \
    fipscheck-lib \
    flex \
    gawk \
    gcc \
    gcc-c++ \
    gcc-gfortran \
    gdb \
    gdbm \
    gettext \
    gettext-common-devel \
    gettext-devel \
    gettext-libs \
    git \
    git-core \
    git-core-doc \
    glib2 \
    glibc \
    glibc-all-langpacks \
    glibc-common \
    glibc-devel \
    glibc-headers \
    glibc-langpack-en \
    glibc-minimal-langpack \
    gmp \
    gnupg2 \
    gnutls \
    gpgme \
    grep \
    groff-base \
    gzip \
    hardlink \
    indent \
    info \
    intltool \
    iptables \
    iptables-libs \
    json-c \
    kernel-devel \
    kernel-headers \
    keyutils-libs \
    kmod \
    kmod-libs \
    krb5-libs \
    less \
    libacl \
    libarchive \
    libassuan \
    libatomic \
    libattr \
    libblkid \
    libcap \
    libcap-ng \
    libcgroup \
    libcilkrts \
    libcom_err \
    libcroco \
    libcrypt \
    libcurl \
    libdb \
    libdb-utils \
    libdwarf \
    libedit \
    libfdisk \
    libffi \
    libgcc \
    libgcrypt \
    libgfortran \
    libgomp \
    libgpg-error \
    libicu \
    libidn2 \
    libitm \
    libmetalink \
    libmnl \
    libmodman \
    libmount \
    libmpc \
    libmpx \
    libnetfilter_conntrack \
    libnfnetlink \
    libnghttp2 \
    libpcap \
    libproxy \
    libpwquality \
    libquadmath \
    libsanitizer \
    libseccomp \
    libsecret \
    libselinux \
    libsemanage \
    libsepol \
    libsmartcols \
    libssh2 \
    libstdc++ \
    libtasn1 \
    libtirpc \
    libtool \
    libunistring \
    libutempter \
    libuuid \
    libverto \
    libxml2 \
    llvm-libs \
    lua \
    lz4 \
    lzo \
    m4 \
    make \
    mokutil \
    mpfr \
    ncurses \
    ncurses-base \
    ncurses-libs \
    neon \
    nettle \
    nspr \
    nss \
    nss-pem \
    nss-softokn \
    nss-softokn-freebl \
    nss-sysinit \
    nss-tools \
    nss-util \
    openldap \
    openssh \
    openssh-clients \
    openssl-libs \
    p11-kit \
    p11-kit-trust \
    pakchois \
    pam \
    patch \
    patchutils \
    pcre \
    pcre2 \
    perl \
    perl-Carp \
    perl-Data-Dumper \
    perl-Encode \
    perl-Error \
    perl-Exporter \
    perl-File-Path \
    perl-File-Temp \
    perl-Filter \
    perl-Getopt-Long \
    perl-Git \
    perl-HTTP-Tiny \
    perl-PathTools \
    perl-Pod-Escapes \
    perl-Pod-Perldoc \
    perl-Pod-Simple \
    perl-Pod-Usage \
    perl-Scalar-List-Utils \
    perl-Socket \
    perl-Storable \
    perl-TermReadKey \
    perl-Test-Harness \
    perl-Text-ParseWords \
    perl-Thread-Queue \
    perl-Time-HiRes \
    perl-Time-Local \
    perl-XML-Parser \
    perl-constant \
    perl-libs \
    perl-macros \
    perl-parent \
    perl-podlators \
    perl-srpm-macros \
    perl-threads \
    perl-threads-shared \
    pigz \
    pinentry \
    pkgconfig \
    popt \
    pth \
    pygpgme \
    pyliblzma \
    python \
    python-devel \
    python-iniparse \
    python-libs \
    python-pycurl \
    python-urlgrabber \
    python2-rpm \
    python3 \
    python3-devel \
    python3-libs \
    python3-pip \
    python3-rpm-macros \
    python3-setuptools \
    pyxattr \
    qrencode-libs \
    rcs \
    readline \
    rpm \
    rpm-build \
    rpm-build-libs \
    rpm-libs \
    rpm-sign \
    runc \
    @amzn2extra-docker \
    sed \
    setup \
    shadow-utils \
    shared-mime-info \
    sqlite \
    subversion \
    subversion-libs \
    swig \
    system-release \
    system-rpm-config \
    systemd \
    systemd-libs \
    systemd-sysv \
    systemtap \
    systemtap-client \
    systemtap-devel \
    systemtap-runtime \
    tar \
    trousers \
    tzdata \
    unzip \
    ustr \
    util-linux \
    which \
    xfsprogs \
    xz \
    xz-libs \
    yum \
    yum-metadata-parser \
    yum-plugin-ovl \
    yum-plugin-priorities \
    zip \
    zlib \
    zlib-devel &&\
    yum clean all

ENV PATH=/usr/local/bin:/usr/bin/:/bin:/opt/bin \
    LD_LIBRARY_PATH=/lib64:/usr/lib64:/var/runtime:/var/runtime/lib:/var/task:/var/task/lib:/opt/lib \
    LANG=en_US.UTF-8 \
    TZ=:UTC

WORKDIR /var/task
