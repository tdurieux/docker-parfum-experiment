Run eru-core in Docker container
================================

## Environments

* `DEBUG`, default to `False`, if using debug mode, set to `'1'`, else empty.

* `ERU_BIND`, default to `'0.0.0.0:5000'`.
* `ERU_DAEMON`, default to `False`, when running in container just leave it alone.
* `ERU_OPLOG_PATH`, operation log dir, default to `/var/log/eru/op.log`.
* `ERU_TIMEOUT`, the timeout of gunicorn workers, default to `300`.
* `ERU_WORKERS`, the worker class for gunicorn, default to `'geventwebsocket.gunicorn.workers.GeventWebSocketWorker'` because we use websockets.

* `DOCKER_CERT_PATH`, the path where docker certs stored. for eru to use to communicate with docker daemon on other hosts.
* `DOCKER_REGISTRY`, docker hub address, default to `'docker-registry.intra.hunantv.com'`, set value to the hub you will use.
* `DOCKER_REGISTRY_URL`, used to login, if you don't need to login, leave it alone.
* `DOCKER_REGISTRY_INSECURE`, default to `''`, which means `False`, if your docker hub use SSL, then set it to `'1'`.
* `DOCKER_REGISTRY_USERNAME`, username for login.
* `DOCKER_REGISTRY_PASSWORD`, password for login.
* `DOCKER_REGISTRY_EMAIL`, email for login.

* `MYSQL_HOST`, mysql host to connect, default to `127.0.0.1`.
* `MYSQ_PORT`, default to `3306`.
* `MYSQL_USER`, default to `eru`.
* `MYSQL_PASSWORD`, default to `''`.
* `MYSQL_DATABASE`, default to `eru`.

* `SQLALCHEMY_POOL_SIZE`, default to `100`.
* `SQLALCHEMY_POOL_TIMEOUT`, default to `3600`.
* `SQLALCHEMY_POOL_RECYCLE`, default to `2000`.

* `REDIS_HOST`, default to `127.0.0.1`.
* `REDIS_PORT`, default to `6379`.
* `REDIS_POOL_SIZE`, default to `100`.

* `CELERY_ACCEPT_CONTENT`, default to `'pickle,json,mgspack,yaml'`, will be split by `','` and the list will finally be used.
* `CELERY_ENABLE_UTC`, default to `''`, which means `False`.
* `CELERY_FORCE_ROOT`, default to `''`, which means `False`, if you wanna run celery under root user, set it to `'1'`.
* `CELERY_REDIS_MAX_CONNECTIONS`, default to `1024`.
* `CELERY_BROKER_URL`, generated by `REDIS_HOST` and `REDIS_PORT`.
* `CELERY_RESULT_BACKEND`, generated by `REDIS_HOST` and `REDIS_PORT`.
* `CELERY_TASK_RESULT_EXPIRES`, time for result to expire, in seconds, default to `604800`, which is a week.
* `CELERY_TRACK_STARTED`, default to `'1'`, which means `True`.
* `CELERY_TIMEZONE`, default to `Asia/Chongqing`.
* `CELERY_SEND_TASK_ERROR_EMAILS`, default to `'1'`.
* `CELERY_ADMINS`, names and emails to send to, like `'tonic:tonic@wolege.ca,tonic2:tonic@gmail.com'`.

* `SERVER_EMAIL`, default to `''`.
* `EMAIL_HOST`, default to `''`.
* `EMAIL_PORT`, default to `465`.
* `EMAIL_HOST_USER`, `EMAIL_HOST_PASSWORD`, default to `''`.
* `EMAIL_USE_SSL`, default to `'1'`.

* `ERU_HOST_PERMDIR`, if you mount local volume to container, set this. default to `'/mnt/mfs/permdirs/%s'`, don't forget this `'%s'`, which is used to format app name.
* `ERU_CONTAINER_PERMDIR`, in your container, this path will be mounted, default to `'/%s/permdir'`

## Get Started

Set environments of mysql and redis correctly, you can use it now.

* Start eru service:

    ```
    docker run --env MYSQL_HOST=10.1.201.58 \
               --env MYSQL_USER=erutest \
               --env MYSQL_PASSWORD=password \
               --env MYSQL_PASSWORD=erutest \
               --env REDIS_HOST=10.1.201.58 \
               --env REDIS_PORT=6379 \
               -p 5000:5000
               eru-core eru
    ```

* Start eru workers:

    ```
    docker run --env MYSQL_HOST=10.1.201.58 \
               --env MYSQL_USER=erutest \
               --env MYSQL_PASSWORD=password \
               --env MYSQL_PASSWORD=erutest \
               --env REDIS_HOST=10.1.201.58 \
               --env REDIS_PORT=6379 \
               -p 5000:5000
               eru-core celery -A eru.app.celery worker
    ```

* Flush database:

    ```
    docker run --env MYSQL_HOST=10.1.201.58 \
               --env MYSQL_USER=erutest \
               --env MYSQL_PASSWORD=password \
               --env MYSQL_PASSWORD=erutest \
               --env REDIS_HOST=10.1.201.58 \
               --env REDIS_PORT=6379 \
               -p 5000:5000
               eru-core python scripts/flushdb.py
    ```

For other storage or options, check environments above.
