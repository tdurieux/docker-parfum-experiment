FROM ubuntu:16.04

RUN apt-get update && \
    apt-get install -y \
        cmake \
        gcc \
        g++ \
        git \
    && \
    cd /opt && \
    git clone https://cmiclab.cs.ucl.ac.uk/mmodat/niftyreg.git niftyreg && \
    cd /opt/niftyreg && \
    mkdir build && \
    cd build && \
    cmake -D CMAKE_BUILD_TYPE=Release /opt/niftyreg && \
    make && \
    make install && \
    rm -r /opt/niftyreg && \
    apt-get remove -y \
        cmake \
        git \
    && \
    apt-get autoremove -y && \
    apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

ADD run.sh /usr/local/bin

LABEL org.nrg.commands="[{\"inputs\": [{\"command-line-flag\": \"--smooR\", \"name\": \"smoothReferenceWidth\", \"default-value\": \"0\", \"required\": true, \"type\": \"number\", \"description\": \"Standard deviation in mm (voxel if negative) of the Gaussian kernel used to smooth the reference image\"}, {\"command-line-flag\": \"--smooF\", \"name\": \"smoothFloatingWidth\", \"default-value\": \"0\", \"required\": true, \"type\": \"number\", \"description\": \"Standard deviation in mm (voxel if negative) of the Gaussian kernel used to smooth the Floating image\"}, {\"command-line-flag\": \"--refLowThr\", \"name\": \"referenceLowerThreshold\", \"default-value\": \"0\", \"required\": true, \"type\": \"number\", \"description\": \"Lower threshold value applied to the reference image\"}, {\"command-line-flag\": \"--refUpThr\", \"name\": \"referenceUpperThreshold\", \"default-value\": \"0\", \"required\": true, \"type\": \"number\", \"description\": \"Upper threshold value applied to the reference image\"}, {\"command-line-flag\": \"--floLowThr\", \"name\": \"floatingLowerThreshold\", \"default-value\": \"0\", \"required\": true, \"type\": \"number\", \"description\": \"Lower threshold value applied to the floating image\"}, {\"command-line-flag\": \"--floUpThr\", \"name\": \"floatingUpperThreshold\", \"default-value\": \"0\", \"required\": true, \"type\": \"number\", \"description\": \"Upper threshold value applied to the floating image\"}, {\"command-line-flag\": \"--inaff\", \"name\": \"inputAffineName\", \"default-value\": null, \"required\": true, \"type\": \"string\", \"description\": \"Affine registration matrix stored as a text file\"}, {\"command-line-flag\": \"--aff\", \"name\": \"outputAffineFileName\", \"default-value\": \"outputAffineResult.txt\", \"required\": true, \"type\": \"string\", \"description\": \"Affine registration matrix output, saved as a text file\"}, {\"command-line-flag\": \"--res\", \"name\": \"outputWarpedImageName\", \"default-value\": \"outputAffineResult.nii\", \"required\": true, \"type\": \"string\", \"description\": \"Warped floating image\"}, {\"command-line-flag\": \"--ln\", \"name\": \"levelPyramidNumber\", \"default-value\": \"3\", \"required\": true, \"type\": \"number\", \"description\": \"Number of levels to use to generate the pyramids for the coarse-to-fine approach\"}, {\"command-line-flag\": \"--lp\", \"name\": \"levelToPerformNumber\", \"default-value\": \"3\", \"required\": true, \"type\": \"number\", \"description\": \"Number of levels to use to run the registration once the pyramids have been created\"}, {\"command-line-flag\": \"--maxit\", \"name\": \"iterationNumber\", \"default-value\": \"5\", \"required\": true, \"type\": \"number\", \"description\": \"Maximal number of iterations of the trimmed least square approach to perform per level\"}, {\"command-line-flag\": \"--pv\", \"name\": \"blockPercentage\", \"default-value\": \"50\", \"required\": true, \"type\": \"number\", \"description\": \"Percentage of blocks to use in the optimisation scheme\"}, {\"command-line-flag\": \"--pi\", \"name\": \"inlierPercentage\", \"default-value\": \"50\", \"required\": true, \"type\": \"number\", \"description\": \"Percentage of blocks to consider as inlier in the optimisation scheme\"}, {\"name\": \"noSym\", \"default-value\": \"false\", \"required\": true, \"true-value\": \"noSym\", \"type\": \"boolean\", \"description\": \"The symmetric version of the algorithm is used by default. Use this flag to disable it\"}, {\"name\": \"rigidOnly\", \"default-value\": \"false\", \"required\": true, \"true-value\": \"rigOnly\", \"type\": \"boolean\", \"description\": \"Performs only a rigid registration, rigid then affine by default\"}, {\"name\": \"affineOnly\", \"default-value\": \"false\", \"required\": true, \"true-value\": \"affDirect\", \"type\": \"boolean\", \"description\": \"Performs only an affine registration, rigid then affine by default\"}, {\"name\": \"useHeaderOrigin\", \"default-value\": \"false\", \"required\": true, \"true-value\": \"nac\", \"type\": \"boolean\", \"description\": \"Use the nifti header origin to initialise the transformation. Image centres are used by default\"}, {\"name\": \"useMaskCenters\", \"default-value\": \"false\", \"required\": true, \"true-value\": \"cog\", \"type\": \"boolean\", \"description\": \"Use the centre of mass for the input masks files initialise the transformation. Image centres are used by default\"}, {\"name\": \"makeIsotropic\", \"default-value\": \"false\", \"required\": true, \"true-value\": \"iso\", \"type\": \"boolean\", \"description\": \"Make floating and reference images isotropic if required\"}, {\"command-line-flag\": \"--interp\", \"name\": \"interpolation\", \"default-value\": \"1\", \"required\": true, \"type\": \"number\", \"description\": \"Interpolation order to use internally to warp the floating image\"}], \"workdir\": \"/output\", \"description\": \"Module/executable for global registration (rigid and/or affine) based on a block-matching approach and a trimmed least squared optimisation.\", \"command-line\": \"run.sh /ref /float #smoothReferenceWidth# #smoothFloatingWidth# #referenceLowerThreshold# #referenceUpperThreshold# #floatingLowerThreshold# #floatingUpperThreshold# #inputAffineName# #outputAffineFileName# #outputWarpedImageName# #levelPyramidNumber# #levelToPerformNumber# #iterationNumber# #blockPercentage# #inlierPercentage# #noSym# #rigidOnly# #affineOnly# #useHeaderOrigin# #useMaskCenters# #makeIsotropic# #interpolation#\", \"outputs\": [{\"mount\": \"output-mount\", \"required\": true, \"name\": \"registered-output\", \"description\": \"The floating image registered to the reference image\"}], \"image\": \"xnat/niftyreg:1.0\", \"label\": \"RegAladin (NiftyReg)\", \"version\": \"1.0\", \"schema-version\": \"1.0\", \"xnat\": [{\"derived-inputs\": [{\"matcher\": \"'NIFTI' in @.resources[*].label\", \"derived-from-wrapper-input\": \"session\", \"type\": \"Scan\", \"name\": \"ref-scan\", \"description\": \"The reference scan, to which the floating scan is registered\"}, {\"name\": \"ref-scan-nifti\", \"matcher\": \"@.label == 'NIFTI'\", \"provides-files-for-command-mount\": \"ref-scan-mount\", \"derived-from-wrapper-input\": \"ref-scan\", \"type\": \"Resource\", \"description\": \"The reference scan's nifti resource\"}, {\"derived-from-xnat-object-property\": \"ID\", \"derived-from-wrapper-input\": \"ref-scan\", \"type\": \"string\", \"name\": \"ref-scan-id\", \"description\": \"The reference scan's id\"}, {\"matcher\": \"'NIFTI' in @.resources[*].label\", \"derived-from-wrapper-input\": \"session\", \"type\": \"Scan\", \"name\": \"float-scan\", \"description\": \"The flaoting scan, which is registered to the reference scan\"}, {\"name\": \"float-scan-nifti\", \"matcher\": \"@.label == 'NIFTI'\", \"provides-files-for-command-mount\": \"float-scan-mount\", \"derived-from-wrapper-input\": \"float-scan\", \"type\": \"Resource\", \"description\": \"The floating scan's nifti resource\"}], \"contexts\": [\"xnat:imageSessionData\"], \"description\": \"Run niftyreg from a Session\", \"output-handlers\": [{\"accepts-command-output\": \"registered-output\", \"label\": \"REG_#ref-scan-id#\", \"type\": \"Resource\", \"name\": \"registered\", \"as-a-child-of-wrapper-input\": \"float-scan\"}], \"external-inputs\": [{\"required\": true, \"type\": \"Session\", \"name\": \"session\", \"description\": \"Input session\"}], \"name\": \"niftyreg-session\"}], \"mounts\": [{\"writable\": \"false\", \"path\": \"/ref\", \"name\": \"ref-scan-mount\"}, {\"writable\": \"false\", \"path\": \"/float\", \"name\": \"float-scan-mount\"}, {\"writable\": \"true\", \"path\": \"/output\", \"name\": \"output-mount\"}], \"info-url\": \"http://cmic.cs.ucl.ac.uk/home/software/\", \"type\": \"docker\", \"name\": \"RegAladin (NiftyReg)\"}]"
