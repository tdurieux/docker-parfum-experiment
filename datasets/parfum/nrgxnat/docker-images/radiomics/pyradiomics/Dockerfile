FROM radiomics/pyradiomics:CLI

# To run one of our scripts, we need lxml.
# lxml can only run with a python which was
# installed with libxslt support.
# So we have to install a fresh python distro.
RUN yum -y update && yum -y install \
        gcc \
        libxslt-devel \
        epel-release \
    && \
    yum -y update && yum -y install \
        python34 \
        python34-devel \
        python34-setuptools \
    && \
    easy_install-3.4 pip && \
    pip3 install \
        docopt \
        lxml \
    && \
    pip3 uninstall -y pip && \
    yum clean all && \
    rm -rf /root/.cache/pip/*
    # wget https://www.python.org/ftp/python/3.7.0/Python-3.7.0.tgz && \
    # tar -xzvf Python-3.7.0.tgz && \
    # cd Python-3.7.0 && \
    # ./configure --prefix=/opt/python3 && \
    # make && \
    # make install && \
    # cd .. && \
    # rm -rf Python-3.7.0* && \


ADD run.sh /usr/local/bin/
ADD generate-pyradiomics-xml-from-csv /usr/local/bin/

ENTRYPOINT []
LABEL org.nrg.commands="[{\"inputs\": [{\"required\": true, \"name\": \"SCAN_FILE\", \"user-settable\": false}, {\"required\": true, \"name\": \"MASK_FILE\", \"user-settable\": false}, {\"required\": true, \"name\": \"PROJECT\", \"user-settable\": false}, {\"required\": true, \"name\": \"SESSION_ID\", \"user-settable\": false}, {\"required\": true, \"name\": \"SESSION_LABEL\", \"user-settable\": false}, {\"required\": true, \"name\": \"SCAN_ID\", \"user-settable\": false}, {\"required\": true, \"name\": \"MASK_FILE_URI\", \"user-settable\": false}], \"name\": \"pyradiomics\", \"command-line\": \"run.sh /input/scan/#SCAN_FILE# /input/mask/#MASK_FILE# /output #PROJECT# #SESSION_ID# #SESSION_LABEL# #SCAN_ID# #MASK_FILE_URI#\", \"outputs\": [{\"path\": \"pyradiomics.csv\", \"mount\": \"out\", \"required\": true, \"name\": \"csv\", \"description\": \"Pyradiomics stats (csv format)\"}, {\"path\": \"pyradiomics.xml\", \"mount\": \"out\", \"required\": true, \"name\": \"xml\", \"description\": \"Pyradiomics assessor (XML format)\"}], \"image\": \"xnat/pyradiomics:2.5\", \"version\": \"2.5\", \"schema-version\": \"1.0\", \"xnat\": [{\"description\": \"Run pyradiomics using an ROI Collection assessor as the source of the lesion mask\", \"contexts\": [\"xnat:imageSessionData\"], \"name\": \"pyradiomics-roi\", \"output-handlers\": [{\"accepts-command-output\": \"xml\", \"type\": \"Assessor\", \"name\": \"assessor\", \"as-a-child-of\": \"session\"}, {\"accepts-command-output\": \"csv\", \"type\": \"Resource\", \"name\": \"output-resource\", \"as-a-child-of\": \"assessor\", \"label\": \"DATA\"}], \"label\": \"Pyradiomics - one ROI Collection layer\", \"external-inputs\": [{\"required\": true, \"type\": \"Session\", \"name\": \"session\", \"description\": \"Input session\"}], \"derived-inputs\": [{\"provides-value-for-command-input\": \"PROJECT\", \"name\": \"project\", \"derived-from-xnat-object-property\": \"project-id\", \"required\": true, \"user-settable\": false, \"derived-from-wrapper-input\": \"session\", \"type\": \"string\"}, {\"provides-value-for-command-input\": \"SESSION_ID\", \"name\": \"session-id\", \"derived-from-xnat-object-property\": \"id\", \"required\": true, \"user-settable\": false, \"derived-from-wrapper-input\": \"session\", \"type\": \"string\"}, {\"provides-value-for-command-input\": \"SESSION_LABEL\", \"name\": \"session-label\", \"derived-from-xnat-object-property\": \"label\", \"required\": true, \"user-settable\": false, \"derived-from-wrapper-input\": \"session\", \"type\": \"string\"}, {\"derived-from-wrapper-input\": \"session\", \"matcher\": \"@.modality =~ /(?!RT).*/ && 'NRRD' in @.resources[*].label\", \"required\": true, \"type\": \"Scan\", \"name\": \"scan\"}, {\"provides-value-for-command-input\": \"SCAN_ID\", \"name\": \"scan-id\", \"derived-from-xnat-object-property\": \"id\", \"required\": true, \"user-settable\": false, \"derived-from-wrapper-input\": \"scan\", \"type\": \"string\"}, {\"name\": \"scan-resource\", \"matcher\": \"@.label == 'NRRD'\", \"required\": true, \"provides-files-for-command-mount\": \"scan-in\", \"derived-from-wrapper-input\": \"scan\", \"type\": \"Resource\"}, {\"derived-from-wrapper-input\": \"scan-resource\", \"type\": \"File\", \"name\": \"scan-file\", \"required\": true}, {\"provides-value-for-command-input\": \"SCAN_FILE\", \"name\": \"scan-file-name\", \"derived-from-xnat-object-property\": \"name\", \"required\": true, \"user-settable\": false, \"derived-from-wrapper-input\": \"scan-file\", \"type\": \"string\"}, {\"matcher\": \"@.xsiType == 'icr:roiCollectionData'\", \"derived-from-wrapper-input\": \"session\", \"type\": \"Assessor\", \"name\": \"mask-assessor\", \"required\": true}, {\"name\": \"mask-resource\", \"matcher\": \"@.label == 'NRRD'\", \"required\": true, \"provides-files-for-command-mount\": \"mask-in\", \"derived-from-wrapper-input\": \"mask-assessor\", \"type\": \"Resource\"}, {\"matcher\": \"@.name =~ /.*?nrrd/\", \"derived-from-wrapper-input\": \"mask-resource\", \"type\": \"File\", \"name\": \"mask-file\", \"required\": true}, {\"provides-value-for-command-input\": \"MASK_FILE_URI\", \"name\": \"mask-file-uri\", \"derived-from-xnat-object-property\": \"uri\", \"required\": true, \"user-settable\": false, \"derived-from-wrapper-input\": \"mask-file\", \"type\": \"string\"}, {\"provides-value-for-command-input\": \"MASK_FILE\", \"name\": \"mask-file-name\", \"derived-from-xnat-object-property\": \"name\", \"required\": true, \"user-settable\": false, \"derived-from-wrapper-input\": \"mask-file\", \"type\": \"string\"}]}, {\"description\": \"Run pyradiomics using an RTStruct scan as the source of the lesion mask\", \"contexts\": [\"xnat:imageSessionData\"], \"name\": \"pyradiomics-rtstruct\", \"output-handlers\": [{\"accepts-command-output\": \"xml\", \"type\": \"Assessor\", \"name\": \"assessor\", \"as-a-child-of\": \"session\"}, {\"accepts-command-output\": \"csv\", \"type\": \"Resource\", \"name\": \"output-resource\", \"as-a-child-of\": \"assessor\", \"label\": \"DATA\"}], \"label\": \"Pyradiomics - one RTStruct scan file\", \"external-inputs\": [{\"required\": true, \"type\": \"Session\", \"name\": \"session\", \"description\": \"Input session\"}], \"derived-inputs\": [{\"provides-value-for-command-input\": \"PROJECT\", \"name\": \"project\", \"derived-from-xnat-object-property\": \"project-id\", \"required\": true, \"user-settable\": false, \"derived-from-wrapper-input\": \"session\", \"type\": \"string\"}, {\"provides-value-for-command-input\": \"SESSION_ID\", \"name\": \"session-id\", \"derived-from-xnat-object-property\": \"id\", \"required\": true, \"user-settable\": false, \"derived-from-wrapper-input\": \"session\", \"type\": \"string\"}, {\"provides-value-for-command-input\": \"SESSION_LABEL\", \"name\": \"session-label\", \"derived-from-xnat-object-property\": \"label\", \"required\": true, \"user-settable\": false, \"derived-from-wrapper-input\": \"session\", \"type\": \"string\"}, {\"derived-from-wrapper-input\": \"session\", \"matcher\": \"@.modality =~ /(?!RT).*/ && 'NRRD' in @.resources[*].label\", \"required\": true, \"type\": \"Scan\", \"name\": \"scan\"}, {\"provides-value-for-command-input\": \"SCAN_ID\", \"name\": \"scan-id\", \"derived-from-xnat-object-property\": \"id\", \"required\": true, \"user-settable\": false, \"derived-from-wrapper-input\": \"scan\", \"type\": \"string\"}, {\"name\": \"scan-resource\", \"matcher\": \"@.label == 'NRRD'\", \"required\": true, \"provides-files-for-command-mount\": \"scan-in\", \"derived-from-wrapper-input\": \"scan\", \"type\": \"Resource\"}, {\"derived-from-wrapper-input\": \"scan-resource\", \"type\": \"File\", \"name\": \"scan-file\", \"required\": true}, {\"provides-value-for-command-input\": \"SCAN_FILE\", \"name\": \"scan-file-name\", \"derived-from-xnat-object-property\": \"name\", \"required\": true, \"user-settable\": false, \"derived-from-wrapper-input\": \"scan-file\", \"type\": \"string\"}, {\"matcher\": \"@.modality == 'RTSTRUCT' && 'NRRD' in @.resources[*].label\", \"derived-from-wrapper-input\": \"session\", \"type\": \"Scan\", \"name\": \"mask-scan\", \"required\": true}, {\"name\": \"mask-resource\", \"matcher\": \"@.label == 'NRRD'\", \"required\": true, \"provides-files-for-command-mount\": \"mask-in\", \"derived-from-wrapper-input\": \"mask-scan\", \"type\": \"Resource\"}, {\"matcher\": \"@.name =~ /.*?nrrd/\", \"derived-from-wrapper-input\": \"mask-resource\", \"type\": \"File\", \"name\": \"mask-file\", \"required\": true}, {\"provides-value-for-command-input\": \"MASK_FILE_URI\", \"name\": \"mask-file-uri\", \"derived-from-xnat-object-property\": \"uri\", \"required\": true, \"user-settable\": false, \"derived-from-wrapper-input\": \"mask-file\", \"type\": \"string\"}, {\"provides-value-for-command-input\": \"MASK_FILE\", \"name\": \"mask-file-name\", \"derived-from-xnat-object-property\": \"name\", \"required\": true, \"user-settable\": false, \"derived-from-wrapper-input\": \"mask-file\", \"type\": \"string\"}]}], \"mounts\": [{\"writable\": false, \"path\": \"/input/scan\", \"name\": \"scan-in\"}, {\"writable\": false, \"path\": \"/input/mask\", \"name\": \"mask-in\"}, {\"writable\": true, \"path\": \"/output\", \"name\": \"out\"}], \"type\": \"docker\", \"description\": \"Runs pyradiomics on lesion masks\"}]"
