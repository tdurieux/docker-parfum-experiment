FROM python:alpine3.10
MAINTAINER dxy

RUN mkdir /app
COPY ./poc.py /app
COPY ./requirements_poc.txt /app
COPY ./entrypoint_poc.sh /sbin/entrypoint.sh
COPY ./default.conf /etc/nginx/conf.d/default.conf
COPY ./index.html /app
COPY ./geckodriver-v0.26.0-linux64.tar.gz /app

WORKDIR /app
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories 
RUN apk update \
    && apk add nginx wget curl \
    && mkdir /run/nginx/ \
    && pip install --upgrade pip \
    && pip install -r requirements_poc.txt \
    && chmod 755 /sbin/entrypoint.sh 
RUN wget -q -O /etc/apk/keys/sgerrand.rsa.pub https://alpine-pkgs.sgerrand.com/sgerrand.rsa.pub \
    && wget https://github.com/sgerrand/alpine-pkg-glibc/releases/download/2.30-r0/glibc-2.30-r0.apk \
    && wget https://github.com/sgerrand/alpine-pkg-glibc/releases/download/2.30-r0/glibc-bin-2.30-r0.apk \
    && apk add glibc-2.30-r0.apk glibc-bin-2.30-r0.apk firefox-esr 
RUN tar -xvzf ./geckodriver-v0.26.0-linux64.tar.gz \
    && chmod a+x ./geckodriver \
    && cp ./geckodriver /usr/local/bin/ 

EXPOSE 80

CMD ["/sbin/entrypoint.sh"]
