FROM node:12.18.2-alpine

# RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g' /etc/apk/repositories
RUN apk update

RUN apk add --no-cache autoconf automake file g++ gcc libc-dev libtool make nasm pkgconfig python zlib-dev
ENV NODE_ENV production

COPY ./web/source /usr/local/app
COPY ./wait-for-it.sh /usr/local/app/wait-for-it.sh
COPY ./web/default.yml /etc/app/default.yml

WORKDIR /usr/local/app
RUN chmod 755 wait-for-it.sh

RUN npm config set registry https://registry.npm.taobao.org/
RUN rm -rf node_modules && npm install
# 包管理文件夹和包管理工具

# Replace app configuration
RUN cp -f /etc/app/default.yml ./.config/default.yml

RUN npm run build
# webpack && gulp build 
# gulp：处理html压缩/预处理/条件编译，图片压缩，精灵图自动合并等任务
# webpack：管理模块化，构建js/css。

EXPOSE 3000
CMD bash -c "./wait-for-it.sh db:5432 -- echo 1 && ./wait-for-it.sh rds:6379 -- echo 2 && npm run init && sleep 20 && npm start"